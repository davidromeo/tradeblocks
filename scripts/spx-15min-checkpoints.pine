//@version=6
indicator("SPX 15-Minute Checkpoints", overlay=true)

// =============================================================================
// SPX 15-MINUTE CHECKPOINT EXPORT
// =============================================================================
// Purpose: Export 15-minute interval prices for granular intraday analysis
//
// Usage:
//   1. Apply to SPX 5-minute chart (or 1-min for accuracy)
//   2. Set date range in TradingView (2022-01-01 to present recommended)
//   3. Right-click indicator pane -> "Export chart data..."
//   4. Save as spx_15min.csv to ~/backtests/_marketdata/
//
// Captures prices at 15-min intervals from 9:30 AM to 4:00 PM ET:
//   09:30, 09:45, 10:00, 10:15, 10:30, 10:45, 11:00, 11:15, 11:30, 11:45,
//   12:00, 12:15, 12:30, 12:45, 13:00, 13:15, 13:30, 13:45, 14:00, 14:15,
//   14:30, 14:45, 15:00, 15:15, 15:30, 15:45, 16:00 (close)
//
// Run on 5-min or 1-min timeframe for accurate checkpoint capture
// =============================================================================

// -----------------------------------------------------------------------------
// TIME DETECTION (Exchange timezone - ET for SPX)
// -----------------------------------------------------------------------------
int barHour = hour(time, "America/New_York")
int barMinute = minute(time, "America/New_York")

// 15-minute checkpoint detection
bool is_0930 = barHour == 9 and barMinute == 30
bool is_0945 = barHour == 9 and barMinute == 45
bool is_1000 = barHour == 10 and barMinute == 0
bool is_1015 = barHour == 10 and barMinute == 15
bool is_1030 = barHour == 10 and barMinute == 30
bool is_1045 = barHour == 10 and barMinute == 45
bool is_1100 = barHour == 11 and barMinute == 0
bool is_1115 = barHour == 11 and barMinute == 15
bool is_1130 = barHour == 11 and barMinute == 30
bool is_1145 = barHour == 11 and barMinute == 45
bool is_1200 = barHour == 12 and barMinute == 0
bool is_1215 = barHour == 12 and barMinute == 15
bool is_1230 = barHour == 12 and barMinute == 30
bool is_1245 = barHour == 12 and barMinute == 45
bool is_1300 = barHour == 13 and barMinute == 0
bool is_1315 = barHour == 13 and barMinute == 15
bool is_1330 = barHour == 13 and barMinute == 30
bool is_1345 = barHour == 13 and barMinute == 45
bool is_1400 = barHour == 14 and barMinute == 0
bool is_1415 = barHour == 14 and barMinute == 15
bool is_1430 = barHour == 14 and barMinute == 30
bool is_1445 = barHour == 14 and barMinute == 45
bool is_1500 = barHour == 15 and barMinute == 0
bool is_1515 = barHour == 15 and barMinute == 15
bool is_1530 = barHour == 15 and barMinute == 30
bool is_1545 = barHour == 15 and barMinute == 45

// -----------------------------------------------------------------------------
// CHECKPOINT PRICES - Use var to persist across bars within same day
// -----------------------------------------------------------------------------
var float p_0930 = na
var float p_0945 = na
var float p_1000 = na
var float p_1015 = na
var float p_1030 = na
var float p_1045 = na
var float p_1100 = na
var float p_1115 = na
var float p_1130 = na
var float p_1145 = na
var float p_1200 = na
var float p_1215 = na
var float p_1230 = na
var float p_1245 = na
var float p_1300 = na
var float p_1315 = na
var float p_1330 = na
var float p_1345 = na
var float p_1400 = na
var float p_1415 = na
var float p_1430 = na
var float p_1445 = na
var float p_1500 = na
var float p_1515 = na
var float p_1530 = na
var float p_1545 = na

var int currentDay = na

// Detect new day and reset
int today = dayofmonth(time, "America/New_York")
bool isNewDay = today != currentDay

if isNewDay
    currentDay := today
    p_0930 := na
    p_0945 := na
    p_1000 := na
    p_1015 := na
    p_1030 := na
    p_1045 := na
    p_1100 := na
    p_1115 := na
    p_1130 := na
    p_1145 := na
    p_1200 := na
    p_1215 := na
    p_1230 := na
    p_1245 := na
    p_1300 := na
    p_1315 := na
    p_1330 := na
    p_1345 := na
    p_1400 := na
    p_1415 := na
    p_1430 := na
    p_1445 := na
    p_1500 := na
    p_1515 := na
    p_1530 := na
    p_1545 := na

// Capture checkpoint prices
if is_0930
    p_0930 := close
if is_0945
    p_0945 := close
if is_1000
    p_1000 := close
if is_1015
    p_1015 := close
if is_1030
    p_1030 := close
if is_1045
    p_1045 := close
if is_1100
    p_1100 := close
if is_1115
    p_1115 := close
if is_1130
    p_1130 := close
if is_1145
    p_1145 := close
if is_1200
    p_1200 := close
if is_1215
    p_1215 := close
if is_1230
    p_1230 := close
if is_1245
    p_1245 := close
if is_1300
    p_1300 := close
if is_1315
    p_1315 := close
if is_1330
    p_1330 := close
if is_1345
    p_1345 := close
if is_1400
    p_1400 := close
if is_1415
    p_1415 := close
if is_1430
    p_1430 := close
if is_1445
    p_1445 := close
if is_1500
    p_1500 := close
if is_1515
    p_1515 := close
if is_1530
    p_1530 := close
if is_1545
    p_1545 := close

// -----------------------------------------------------------------------------
// DERIVED METRICS - Moves from key reference points
// -----------------------------------------------------------------------------
// Moves from open (9:30)
float pct_0930_to_1000 = p_0930 > 0 and p_1000 > 0 ? ((p_1000 - p_0930) / p_0930) * 100 : na
float pct_0930_to_1200 = p_0930 > 0 and p_1200 > 0 ? ((p_1200 - p_0930) / p_0930) * 100 : na
float pct_0930_to_1500 = p_0930 > 0 and p_1500 > 0 ? ((p_1500 - p_0930) / p_0930) * 100 : na
float pct_0930_to_close = p_0930 > 0 ? ((close - p_0930) / p_0930) * 100 : na

// MOC moves (last 15, 30, 45, 60 minutes)
float moc_15min = p_1545 > 0 ? ((close - p_1545) / p_1545) * 100 : na  // 3:45 to close
float moc_30min = p_1530 > 0 ? ((close - p_1530) / p_1530) * 100 : na  // 3:30 to close
float moc_45min = p_1515 > 0 ? ((close - p_1515) / p_1515) * 100 : na  // 3:15 to close
float moc_60min = p_1500 > 0 ? ((close - p_1500) / p_1500) * 100 : na  // 3:00 to close

// Afternoon session (12:00 to close)
float afternoon_move = p_1200 > 0 ? ((close - p_1200) / p_1200) * 100 : na

// -----------------------------------------------------------------------------
// EXPORT PLOTS - Checkpoint Prices
// -----------------------------------------------------------------------------
plot(p_0930, "P_0930", display=display.data_window)
plot(p_0945, "P_0945", display=display.data_window)
plot(p_1000, "P_1000", display=display.data_window)
plot(p_1015, "P_1015", display=display.data_window)
plot(p_1030, "P_1030", display=display.data_window)
plot(p_1045, "P_1045", display=display.data_window)
plot(p_1100, "P_1100", display=display.data_window)
plot(p_1115, "P_1115", display=display.data_window)
plot(p_1130, "P_1130", display=display.data_window)
plot(p_1145, "P_1145", display=display.data_window)
plot(p_1200, "P_1200", display=display.data_window)
plot(p_1215, "P_1215", display=display.data_window)
plot(p_1230, "P_1230", display=display.data_window)
plot(p_1245, "P_1245", display=display.data_window)
plot(p_1300, "P_1300", display=display.data_window)
plot(p_1315, "P_1315", display=display.data_window)
plot(p_1330, "P_1330", display=display.data_window)
plot(p_1345, "P_1345", display=display.data_window)
plot(p_1400, "P_1400", display=display.data_window)
plot(p_1415, "P_1415", display=display.data_window)
plot(p_1430, "P_1430", display=display.data_window)
plot(p_1445, "P_1445", display=display.data_window)
plot(p_1500, "P_1500", display=display.data_window)
plot(p_1515, "P_1515", display=display.data_window)
plot(p_1530, "P_1530", display=display.data_window)
plot(p_1545, "P_1545", display=display.data_window)

// -----------------------------------------------------------------------------
// EXPORT PLOTS - Derived Metrics
// -----------------------------------------------------------------------------
plot(pct_0930_to_1000, "Pct_0930_to_1000", display=display.data_window)
plot(pct_0930_to_1200, "Pct_0930_to_1200", display=display.data_window)
plot(pct_0930_to_1500, "Pct_0930_to_1500", display=display.data_window)
plot(pct_0930_to_close, "Pct_0930_to_Close", display=display.data_window)
plot(moc_15min, "MOC_15min", display=display.data_window)
plot(moc_30min, "MOC_30min", display=display.data_window)
plot(moc_45min, "MOC_45min", display=display.data_window)
plot(moc_60min, "MOC_60min", display=display.data_window)
plot(afternoon_move, "Afternoon_Move", display=display.data_window)

// -----------------------------------------------------------------------------
// VISUAL MARKERS
// -----------------------------------------------------------------------------
plotshape(is_0930, "Open", shape.circle, location.belowbar, color.blue, size=size.tiny)
plotshape(is_1200, "Noon", shape.circle, location.belowbar, color.gray, size=size.tiny)
plotshape(is_1500, "3PM", shape.circle, location.belowbar, color.orange, size=size.tiny)
plotshape(is_1545, "3:45", shape.circle, location.belowbar, color.red, size=size.tiny)
