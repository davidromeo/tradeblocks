name: Update Treasury Rates

on:
  schedule:
    # Run every Sunday at 6 AM UTC (1 AM EST, after markets close Friday)
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-rates:
    name: Fetch and Update Treasury Rates
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get current date range
        id: dates
        run: |
          # Get the last date in the file
          LAST_DATE=$(grep -oE '"[0-9]{4}-[0-9]{2}-[0-9]{2}"' lib/data/treasury-rates.ts | tail -1 | tr -d '"')
          # Start from the day after the last date
          START_DATE=$(date -d "$LAST_DATE + 1 day" +%Y-%m-%d)
          # End date is today
          END_DATE=$(date +%Y-%m-%d)
          echo "last_date=$LAST_DATE" >> $GITHUB_OUTPUT
          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
          echo "Last date in file: $LAST_DATE"
          echo "Fetching rates from $START_DATE to $END_DATE"

      - name: Fetch new rates from FRED
        id: fetch
        run: |
          START_DATE="${{ steps.dates.outputs.start_date }}"
          END_DATE="${{ steps.dates.outputs.end_date }}"

          # Fetch CSV from FRED API
          curl -s "https://fred.stlouisfed.org/graph/fredgraph.csv?id=DTB3&cosd=${START_DATE}&coed=${END_DATE}" -o new_rates.csv

          # Check if we got any data (more than just header)
          LINE_COUNT=$(wc -l < new_rates.csv)
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "No new rates available"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # FRED quirk: returns full history if requested dates don't exist
          # Filter to only include dates >= START_DATE using awk for portability
          echo "Raw response has $(($LINE_COUNT - 1)) entries, filtering to dates >= $START_DATE"

          head -1 new_rates.csv > filtered_rates.csv
          awk -F',' -v start="$START_DATE" 'NR>1 && $1 >= start' new_rates.csv >> filtered_rates.csv

          mv filtered_rates.csv new_rates.csv

          LINE_COUNT=$(wc -l < new_rates.csv)
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "No new rates in date range"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "Found $(($LINE_COUNT - 1)) new rate entries after filtering"
          cat new_rates.csv

      - name: Update treasury-rates.ts
        if: steps.fetch.outputs.has_updates == 'true'
        run: |
          # Convert CSV to TypeScript entries
          # Skip header, skip any "." or empty values (missing data/holidays)
          tail -n +2 new_rates.csv | while IFS=',' read -r date rate; do
            # Skip if rate is "." or empty (FRED uses these for holidays/missing data)
            if [ "$rate" != "." ] && [ -n "$rate" ] && [ "$rate" != "" ]; then
              echo "  \"$date\": $rate,"
            fi
          done > new_entries.txt

          if [ ! -s new_entries.txt ]; then
            echo "No valid rate entries to add (all were holidays)"
            exit 0
          fi

          echo "New entries to add:"
          cat new_entries.txt

          # Insert new entries before the closing brace
          CLOSE_LINE=$(grep -n '^};$' lib/data/treasury-rates.ts | cut -d: -f1)
          head -n $((CLOSE_LINE - 1)) lib/data/treasury-rates.ts > temp_rates.ts
          cat new_entries.txt >> temp_rates.ts
          echo "};" >> temp_rates.ts
          mv temp_rates.ts lib/data/treasury-rates.ts

          echo "Updated treasury-rates.ts"

      - name: Run tests to verify
        if: steps.fetch.outputs.has_updates == 'true'
        run: |
          npm ci
          npm test -- tests/unit/risk-free-rate.test.ts

      - name: Commit and push
        if: steps.fetch.outputs.has_updates == 'true'
        run: |
          # Check if there are actually changes to commit
          if git diff --quiet lib/data/treasury-rates.ts; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lib/data/treasury-rates.ts

          # Get the actual last date added
          LAST_NEW_DATE=$(grep -oE '"[0-9]{4}-[0-9]{2}-[0-9]{2}"' lib/data/treasury-rates.ts | tail -1 | tr -d '"')
          git commit -m "chore: update treasury rates through ${LAST_NEW_DATE}"
          git push
