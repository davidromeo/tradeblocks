# Milestone v2.2: Historical Risk-Free Rates

**Status:** SHIPPED 2026-01-18
**Phases:** 25-28
**Total Plans:** 6

## Overview

Replace fixed 2% risk-free rate with embedded historical Treasury rates (2013-2026) for accurate Sharpe/Sortino calculations that reflect actual market conditions.

**Background:** Amy's feature request - Sharpe ratio gets distorted when rates move meaningfully. Using a constant rate when actual rates varied significantly (e.g., 0% in 2020 vs 5%+ in 2023) skews risk-adjusted metrics.

**Approach:**
- Embed ~3,260 daily 3-month T-bill rates (2013-2026) as static data (~71KB)
- Lookup rate by trade date, fallback to last known rate for dates outside range
- Remove manual riskFreeRate input entirely (no override needed)
- Local-only: no external API calls, data bundled in app

## Phases

### Phase 25: Treasury Data

**Goal**: Create embedded rate data file and lookup utility
**Depends on**: Previous milestone complete
**Plans**: 1 plan (TDD)

Plans:
- [x] 25-01: Treasury rate data and lookup utility (TDD) — completed 2026-01-18

**Details:**
- Downloaded DTB3 series from FRED (Federal Reserve Economic Data)
- Created `lib/data/treasury-rates.ts` with 3,260 daily rate entries
- Implemented `lib/utils/risk-free-rate.ts` with O(1) hash lookup and O(log n) binary search fallback
- 20 test cases covering in-range, out-of-range, weekend/holiday scenarios

### Phase 26: Core Calculations

**Goal**: Update Sharpe/Sortino calculations to use date-based rate lookup
**Depends on**: Phase 25
**Plans**: 1 plan (TDD)

Plans:
- [x] 26-01: Date-based risk-free rates for Sharpe/Sortino (TDD) — completed 2026-01-18

**Details:**
- Added `DailyReturnWithDate` interface for date-paired returns
- Refactored `calculateSharpeRatio()` to compute per-day excess returns
- Refactored `calculateSortinoRatio()` with same date-based approach
- config.riskFreeRate parameter now ignored (date-based rates always used)

### Phase 27: Remove Manual Input

**Goal**: Remove riskFreeRate from types, stores, UI, and services
**Depends on**: Phase 26
**Plans**: 3 plans

Plans:
- [x] 27-01: Remove riskFreeRate from types/models — completed 2026-01-18
- [x] 27-02: Remove from stores/services/UI — completed 2026-01-18
- [x] 27-03: Remove from MCP/tests — completed 2026-01-19

**Details:**
- Removed riskFreeRate from AnalysisConfig interface
- Removed from Zustand stores and service layer
- Removed from UI components (no more manual input field)
- MCP server `get_performance_charts` tool no longer accepts riskFreeRate parameter
- All test files updated to not pass riskFreeRate in configs

### Phase 28: MCP & Tests

**Goal**: Fix pre-existing test failures and verify clean test suite
**Depends on**: Phase 27
**Plans**: 1 plan

Plans:
- [x] 28-01: Fix pre-existing test failures — completed 2026-01-19

**Details:**
- Fixed maxLoss fallback for single debit trades (use premium paid when maxLoss undefined)
- Fixed 5 calendar scaling tests by adding required strategyMatches parameter
- Achieved clean test run with all 989 tests passing

---

## Milestone Summary

**Key Decisions:**
- Embedded Treasury rates (no API calls) — Maintains 100% local data principle
- Date-based risk-free rates over fixed rate — Accurate Sharpe/Sortino reflecting market conditions
- config.riskFreeRate ignored — Date-based rates always used for consistency
- Rolling metrics Sharpe uses fixed 2.0% — Visualization simplification for MCP charts

**Issues Resolved:**
- Fixed maxLoss calculation for single debit trades (Long Call with undefined maxLoss)
- Fixed calendar scaling tests with correct strategyMatches API usage
- Added @/ path alias to MCP server for proper module resolution

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- MCP rolling metrics use fixed 2.0% rate for visualization (accurate date-based Sharpe in portfolio-stats.ts)

---

_For current project status, see .planning/ROADMAP.md_
