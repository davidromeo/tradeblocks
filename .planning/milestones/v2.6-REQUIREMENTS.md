# Requirements Archive: v2.6 DuckDB Analytics Layer

**Archived:** 2026-02-04
**Status:** SHIPPED

This is the archived requirements specification for v2.6.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: TradeBlocks v2.6

**Defined:** 2026-02-01
**Core Value:** Enable Claude to write arbitrary SQL against trades and market data for hypothesis generation

## v2.6 Requirements

### Database Infrastructure

- [x] **DB-01**: MCP server integrates `@duckdb/node-api` package
- [x] **DB-02**: DuckDB connection manager handles init, shutdown, and errors gracefully
- [x] **DB-03**: `trades.duckdb` stores all block trades with `block_id` column
- [x] **DB-04**: `market.duckdb` stores market data (spx_daily, vix, extensible)
- [x] **DB-05**: Security sandbox configured (disable filesystem access, read-only for queries)
- [x] **DB-06**: Resource limits set (memory, threads appropriate for MCP server)

### Sync Layer

- [x] **SYNC-01**: `_sync_metadata` table tracks block_id, csv_hash, synced_at
- [x] **SYNC-02**: Sync detects new blocks (folder exists, not in metadata)
- [x] **SYNC-03**: Sync detects changed blocks (hash differs from stored hash)
- [x] **SYNC-04**: Sync detects deleted blocks (in metadata, folder missing)
- [x] **SYNC-05**: Sync operations are transaction-safe (no partial state)
- [x] **SYNC-06**: Sync is lazy (triggered on query, not on server startup)
- [x] **SYNC-07**: Market data syncs from `_marketdata/` folder

### Query Interface

- [x] **SQL-01**: `run_sql` MCP tool accepts SQL query string
- [x] **SQL-02**: Queries can JOIN trades with market data tables
- [x] **SQL-03**: Queries can filter by block_id or query across all blocks
- [x] **SQL-04**: Results are limited to prevent excessive output (configurable limit)
- [x] **SQL-05**: SQL errors return helpful messages (not stack traces)
- [x] **SQL-06**: Dangerous SQL patterns blocked (COPY, EXPORT, ATTACH, etc.)

### Schema Discovery

- [x] **SCHEMA-01**: `describe_database` tool shows all available tables and columns
- [x] **SCHEMA-02**: `describe_database` provides column names, types for all tables
- [x] **SCHEMA-03**: Example queries documented for common hypothesis patterns

### Tool Rationalization

- [x] **DEPR-01**: Analysis of which tools `run_sql` can replace
- [x] **DEPR-02**: Deprecation plan documented (which tools, timeline)
- [x] **DEPR-03**: At least one tool deprecated or marked for deprecation

## Out of Scope

| Feature | Reason |
|---------|--------|
| Web UI SQL interface | MCP server only; web app remains client-side |
| Real-time sync | Lazy sync sufficient; no file watchers |
| ~~Full tool deprecation~~ | ~~v2.6 analyzes; actual removal in future versions~~ Completed in v2.6 |
| DuckDB extensions | Core functionality sufficient; extensions add complexity |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DB-01 | Phase 41 | Complete |
| DB-02 | Phase 41 | Complete |
| DB-03 | Phase 41 | Complete |
| DB-04 | Phase 41 | Complete |
| DB-05 | Phase 41 | Complete |
| DB-06 | Phase 41 | Complete |
| SYNC-01 | Phase 42 | Complete |
| SYNC-02 | Phase 42 | Complete |
| SYNC-03 | Phase 42 | Complete |
| SYNC-04 | Phase 42 | Complete |
| SYNC-05 | Phase 42 | Complete |
| SYNC-06 | Phase 42 | Complete |
| SYNC-07 | Phase 42 | Complete |
| SQL-01 | Phase 43 | Complete |
| SQL-02 | Phase 43 | Complete |
| SQL-03 | Phase 43 | Complete |
| SQL-04 | Phase 43 | Complete |
| SQL-05 | Phase 43 | Complete |
| SQL-06 | Phase 43 | Complete |
| SCHEMA-01 | Phase 44 | Complete |
| SCHEMA-02 | Phase 44 | Complete |
| SCHEMA-03 | Phase 44 | Complete |
| DEPR-01 | Phase 45 | Complete |
| DEPR-02 | Phase 45 | Complete |
| DEPR-03 | Phase 45 | Complete |

**Coverage:**
- v2.6 requirements: 24 total
- Mapped to phases: 24
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 24 of 24 requirements
**Adjusted:** DB-03/DB-04 originally envisioned separate files (trades.duckdb, market.duckdb); implemented as single analytics.duckdb with separate schemas. DEPR-03 exceeded expectations (7 tools removed vs "at least one").
**Dropped:** None

---
*Archived: 2026-02-04 as part of v2.6 milestone completion*
