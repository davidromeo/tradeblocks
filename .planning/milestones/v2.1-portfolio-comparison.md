# Milestone v2.1: Portfolio Comparison

**Status:** SHIPPED 2026-01-18
**Phases:** 17-24 (including 17.1)
**Total Plans:** 9

## Overview

Add 7 new MCP tools to improve portfolio comparison and analysis capabilities, addressing gaps in "what changed and why" analysis identified from real user feedback. Plus CLI test mode for verification and web platform integration documentation.

## Phases

### Phase 17: Block Diff

**Goal**: Compare two blocks showing strategies shared vs unique, per-strategy P/L attribution, and side-by-side metrics
**Depends on**: v2.0 complete
**Plans**: 1/1 complete

Plans:
- [x] 17-01: Implement block_diff tool with strategy overlap analysis

**Details:**
- Input: blockIdA, blockIdB, optional startDate/endDate, metricsToCompare
- Output: strategyOverlap (shared/uniqueToA/uniqueToB), perStrategyComparison, portfolioTotals
- 15 integration tests covering overlap detection, date filtering, edge cases

### Phase 17.1: CLI Test Mode (INSERTED)

**Goal**: Add --call flag to MCP server for direct tool invocation (enables subagent testing)
**Depends on**: Phase 17
**Plans**: 1/1 complete

Plans:
- [x] 17.1-01: Add --call CLI mode for direct tool invocation

**Details:**
- Mock MCP server captures tool registrations without modifying tool files
- Usage: `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call <tool> '<args>'`
- Enables real data verification for all v2.1 tools

### Phase 18: Stress Test

**Goal**: Show portfolio performance during named historical scenarios (COVID crash, 2022 bear, Aug 2024 VIX spike)
**Depends on**: Phase 17
**Plans**: 1/1 complete

Plans:
- [x] 18-01: Implement stress_test tool with 11 built-in scenarios

**Details:**
- 9 crash/correction scenarios: china_deval_2015, brexit, volmageddon, q4_2018, covid_crash, bear_2022, svb_crisis, vix_aug_2024, liberation_day
- 2 recovery scenarios: covid_recovery, liberation_recovery
- Custom scenario support with arbitrary date ranges
- 15 integration tests

### Phase 19: Drawdown Attribution

**Goal**: During max drawdown periods, identify which strategies contributed most to losses
**Depends on**: Phase 18
**Plans**: 1/1 complete

Plans:
- [x] 19-01: Implement drawdown_attribution tool with equity curve analysis

**Details:**
- Builds equity curve from trades sorted by close date/time
- Identifies max drawdown period (peak to trough)
- Per-strategy attribution with P/L, trade count, contribution percentage
- 16 integration tests

### Phase 20: Marginal Contribution

**Goal**: Calculate marginal Sharpe/Sortino contribution of adding a strategy to a portfolio
**Depends on**: Phase 19
**Plans**: 1/1 complete

Plans:
- [x] 20-01: Implement marginal_contribution tool with with/without comparison

**Details:**
- Calculates baseline portfolio metrics, then "without each strategy" metrics
- Marginal contribution = baseline - without (positive = improves portfolio)
- Interpretation thresholds: |delta| < 0.01 = negligible
- 23 integration tests

### Phase 21: Strategy Similarity

**Goal**: Flag strategies that may be redundant based on correlation, tail dependence, and overlap
**Depends on**: Phase 20
**Plans**: 1/1 complete

Plans:
- [x] 21-01: Implement strategy_similarity tool with composite scoring

**Details:**
- Composite score: 50% correlation (absolute), 30% tail dependence, 20% overlap
- Redundant flag requires BOTH high correlation AND high tail dependence
- Three recommendation types based on flag combinations
- 28 integration tests

### Phase 22: What-If Scaling

**Goal**: Project portfolio metrics if strategies were run at different sizes
**Depends on**: Phase 21
**Plans**: 1/1 complete

Plans:
- [x] 22-01: Implement what_if_scaling tool with strategy weights

**Details:**
- Strategy weights 0-2.0x (0 = exclude, 2.0 = double)
- Commissions scale proportionally with weight
- Per-strategy breakdown shows ALL strategies (not just scaled ones)
- Before/after comparison with delta percentages
- 24 integration tests

### Phase 23: Portfolio Health Check

**Goal**: Run correlation + tail risk + Monte Carlo in one call, return unified portfolio health assessment
**Depends on**: Phase 22
**Plans**: 1/1 complete

Plans:
- [x] 23-01: Implement portfolio_health_check tool with 4-layer response

**Details:**
- 4-layer response: verdict -> grades -> flags -> keyNumbers
- Grades A/B/C/F for diversification, tailRisk, robustness, consistency
- Verdict: HEALTHY (0 flags), MODERATE_CONCERNS (1-2), ISSUES_DETECTED (3+)
- Configurable thresholds with sensible defaults
- 26 integration tests

### Phase 24: Web Platform Integration Guide

**Goal**: Documentation for using TradeBlocks MCP with web-based AI platforms (ChatGPT, Google AI Studio, Julius)
**Depends on**: Phase 23 (all tools complete)
**Plans**: 1/1 complete

Plans:
- [x] 24-01: Web platform integration guide with ngrok tunnel setup

**Details:**
- ngrok tunnel approach keeps data local while enabling remote MCP URLs
- Platform-specific guides for ChatGPT Developer Mode, Google AI Studio, Julius
- Cloudflare Tunnel included as free alternative
- Security considerations and best practices

---

## Milestone Summary

**Decimal Phases:**
- Phase 17.1: CLI Test Mode (inserted after Phase 17 for subagent testing capability)

**Key Decisions:**

| Phase | Decision | Rationale |
|-------|----------|-----------|
| 17 | Trade-based calculations only for comparison tools | Daily logs represent full portfolio, not per-strategy |
| 17.1 | CLI test verification required for all v2.1 MCP tools | Real data validation catches issues unit tests miss |
| 18 | 11 built-in scenarios (9 crashes + 2 recoveries) | Cover major market events post-2013 |
| 18 | Return null stats for scenarios with no trades | Graceful handling, not errors |
| 19 | Equity curve from trades sorted by close date/time | Accurate chronological P/L tracking |
| 20 | Marginal contribution = baseline - without metric | Positive = strategy improves portfolio |
| 21 | Composite similarity: 50% correlation, 30% tail dep, 20% overlap | Balance correlation and tail risk signals |
| 21 | Redundant requires BOTH high correlation AND high tail dependence | Conservative flag to avoid false positives |
| 22 | Weight range 0-2.0 for realism | 2x leverage is reasonable, higher would be extreme |
| 22 | Commissions scale proportionally with weight | 0.5x size = 0.5x trading costs |
| 23 | 4-layer response: verdict -> grades -> flags -> keyNumbers | Progressive detail from quick verdict to actionable flags |
| 23 | Grades A/B/C/F (no +/- modifiers) | Simplicity over granularity |
| 24 | ngrok tunnel for web platform access | Keeps data local while enabling remote MCP URLs |

**Issues Resolved:**
- Portfolio comparison gap addressed (7 new tools for "what changed and why" analysis)
- CLI test verification now available for all MCP tools
- Web platform access documented for ChatGPT, Google AI Studio, Julius

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None identified

---

_For current project status, see .planning/ROADMAP.md_
