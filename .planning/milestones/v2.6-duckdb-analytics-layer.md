# Milestone v2.6: DuckDB Analytics Layer

**Status:** SHIPPED 2026-02-04
**Phases:** 41-45 (including 42.1)
**Total Plans:** 11

## Overview

This milestone adds SQL query capabilities to the MCP server, enabling Claude to write arbitrary SQL against trades and market data for hypothesis generation. The work proceeds through database foundation, CSV sync pipeline, query interface with security sandbox, schema discovery for Claude, and tool rationalization to replace rigid query tools with flexible SQL.

## Phases

### Phase 41: Database Infrastructure
**Goal**: Establish secure, properly configured DuckDB foundation for all subsequent features
**Depends on**: Nothing (first phase of v2.6)
**Requirements**: DB-01, DB-02, DB-03, DB-04, DB-05, DB-06
**Plans**: 1 plan

Plans:
- [x] 41-01-PLAN.md - DuckDB integration with connection manager and shutdown handling

**Success Criteria:**
  1. MCP server starts successfully with @duckdb/node-api integrated
  2. DuckDB connection initializes on first query and shuts down gracefully on server exit
  3. analytics.duckdb created with trades and market schemas (single file)
  4. Filesystem access is disabled (enable_external_access = false enforced)
  5. Memory and thread limits are configured (no OOM on large queries)

### Phase 42: Sync Layer
**Goal**: Reliable CSV-to-DuckDB synchronization that keeps cache fresh without manual intervention
**Depends on**: Phase 41
**Requirements**: SYNC-01, SYNC-02, SYNC-03, SYNC-04, SYNC-05, SYNC-06, SYNC-07
**Plans**: 4 plans

Plans:
- [x] 42-01-PLAN.md - Sync infrastructure (metadata tables, hasher, sync module skeleton)
- [x] 42-02-PLAN.md - Block sync logic (tradelog/dailylog CSV to DuckDB)
- [x] 42-03-PLAN.md - Market data sync (date-based merge for _marketdata/)
- [x] 42-04-PLAN.md - Tool integration (wire sync into list_blocks and per-block tools)

**Success Criteria:**
  1. Adding a new block folder triggers sync on next query
  2. Modifying a block's CSV triggers re-sync on next query
  3. Deleting a block folder removes its data from DuckDB on next query
  4. Sync errors roll back cleanly (no partial state in database)
  5. Market data from _marketdata/ folder is synced and queryable

### Phase 42.1: Sync Layer Hardening (INSERTED)
**Goal**: Solidify sync layer with tests, split oversized tool files, and add cleaner middleware pattern
**Depends on**: Phase 42
**Requirements**: None (technical debt / quality improvement)
**Plans**: 3 plans

Plans:
- [x] 42.1-01-PLAN.md - Integration tests for sync layer
- [x] 42.1-02-PLAN.md - Tool file splitting (blocks.ts, reports.ts)
- [x] 42.1-03-PLAN.md - Sync middleware pattern

**Success Criteria:**
  1. Integration tests verify sync detects new/changed/deleted blocks correctly
  2. Integration tests verify transaction rollback on failure (no partial state)
  3. blocks.ts (3,374 lines) split into logical modules (<800 lines each)
  4. reports.ts (3,338 lines) split into logical modules (<800 lines each)
  5. Sync middleware pattern eliminates boilerplate from tool handlers
  6. All sync-integrated tools use the middleware pattern

### Phase 43: Query Interface
**Goal**: Claude can execute arbitrary SQL queries against trades and market data
**Depends on**: Phase 42
**Requirements**: SQL-01, SQL-02, SQL-03, SQL-04, SQL-05, SQL-06
**Plans**: 1 plan

Plans:
- [x] 43-01-PLAN.md - run_sql tool with validation, timeout, and error handling

**Success Criteria:**
  1. run_sql MCP tool accepts SQL strings and returns results
  2. Queries can JOIN trades with market data tables
  3. Cross-block queries work (WHERE block_id IN (...) or no filter)
  4. Results are limited to prevent context overflow (default 100 rows)
  5. Dangerous SQL patterns (COPY, EXPORT, ATTACH) are blocked with helpful errors

### Phase 44: Schema Discovery
**Goal**: Claude has tools to discover what tables and columns are available for queries
**Depends on**: Phase 43
**Requirements**: SCHEMA-01, SCHEMA-02, SCHEMA-03
**Plans**: 1 plan

Plans:
- [x] 44-01-PLAN.md - describe_database tool with schema metadata and example queries

**Success Criteria:**
  1. Claude can list all available tables and their descriptions
  2. Claude can get column names and types for any table
  3. Example queries are documented for common hypothesis patterns

### Phase 45: Tool Rationalization
**Goal**: Remove MCP tools that run_sql can fully replace, completing the SQL analytics layer
**Depends on**: Phase 44
**Requirements**: DEPR-01, DEPR-02, DEPR-03
**Plans**: 1 plan

Plans:
- [x] 45-01-PLAN.md - Remove redundant tools, update examples, document changes

**Success Criteria:**
  1. Analysis document lists which tools run_sql replaces (7 tools) vs which stay (computational)
  2. Removed tools deleted from codebase (not soft-deprecated)
  3. CHANGELOG documents breaking changes with SQL migration patterns
  4. describe_database examples updated to cover removed tool functionality

---

## Milestone Summary

**Decimal Phases:**
- Phase 42.1: Sync Layer Hardening (inserted after Phase 42 for integration tests and middleware)

**Key Decisions:**
- Single DuckDB file (analytics.duckdb) with trades/market schemas
- SHA-256 hash-based change detection (not mtime)
- Lazy sync: triggered on query, not server startup
- Batch inserts: 500 rows per batch for performance
- Market data merge/preserve strategy: INSERT ON CONFLICT DO NOTHING
- Sync middleware: withSyncedBlock, withSyncedBlocks, withFullSync patterns
- Tool files split: blocks/ (7 modules), reports/ (10 modules)
- SQL validation via pattern blocklist (not parsing) for security
- 30s query timeout with Promise.race for protection
- describe_database: single tool replaces separate list_tables + get_schema
- Schema descriptions hardcoded + merged with DuckDB introspection
- Tool rationalization: remove query-only tools, keep computational tools
- SQL-first data access pattern: describe_database -> run_sql -> computational tool

**Issues Resolved:**
- PineScript day detection bug (var with na unreliable on historical bars)
- Market data sync column filtering (TradingView marker columns)
- DuckDB COUNT returns BigInt (requires Number() conversion)

**Issues Deferred:**
- Automating market data fetch (v2.7 idea: Yahoo Finance + local calculation)

**Technical Debt Incurred:**
- CSV parsing helpers duplicated in block-sync.ts (intentional: avoid circular imports)
- queries.ts kept as documentation shell (30 lines, no active tools)

---

_For current project status, see .planning/ROADMAP.md_
