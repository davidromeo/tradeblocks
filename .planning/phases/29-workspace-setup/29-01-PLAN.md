---
phase: 29-workspace-setup
plan: 01
type: execute
---

<objective>
Create `@tradeblocks/lib` workspace package to replace fragile path aliases with proper npm package imports.

Purpose: Enable clean `import { X } from '@tradeblocks/lib'` imports across the monorepo instead of `@lib/*` path aliases that require bundler-specific configuration.
Output: Working `packages/lib/` package with proper TypeScript configuration and exports.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./29-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current state:**
- Monorepo uses npm workspaces with `packages/*` pattern
- `lib/` at root contains all shared code (calculations, models, processing, db, stores, utils)
- MCP server uses `@lib/*` path aliases resolved via tsup esbuild aliases at build time
- Next.js app uses `@/*` path aliases via tsconfig

**Problem being solved:**
- Path aliases require bundler-specific configuration (tsup aliases, tsconfig paths)
- TypeScript IDE resolution depends on correct tsconfig paths setup
- No standard package imports - everything is path-alias based

**Relevant files:**
@package.json (workspaces config)
@tsconfig.json (current path aliases)
@packages/mcp-server/tsconfig.json (current @lib/* paths)
@packages/mcp-server/tsup.config.ts (current esbuild aliases)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create @tradeblocks/lib package structure</name>
  <files>packages/lib/package.json, packages/lib/tsconfig.json, packages/lib/index.ts</files>
  <action>
Create the lib package structure:

1. Create `packages/lib/package.json`:
   - name: "@tradeblocks/lib"
   - version: "0.0.1" (internal package, not published)
   - private: true (prevent accidental npm publish)
   - type: "module" (ESM)
   - main: "./index.ts" (direct TS source for internal workspace consumers)
   - types: "./index.ts"
   - exports: map key modules for selective imports (calculations, models, utils, etc.)

2. Create `packages/lib/tsconfig.json`:
   - extends root tsconfig for consistency
   - compilerOptions specific to the package
   - include lib files

3. Create `packages/lib/index.ts`:
   - Re-export from all subdirectories
   - Use barrel exports pattern: `export * from './calculations'` etc.

**Important:** This package will be consumed via TypeScript directly within the monorepo. No build step needed since consumers (Next.js, MCP server) handle their own compilation.
  </action>
  <verify>
- `ls packages/lib/` shows package.json, tsconfig.json, index.ts
- `cat packages/lib/package.json | grep name` shows "@tradeblocks/lib"
  </verify>
  <done>packages/lib/ has package.json, tsconfig.json, and index.ts with barrel exports</done>
</task>

<task type="auto">
  <name>Task 2: Move lib/ content to packages/lib/</name>
  <files>packages/lib/* (all moved content)</files>
  <action>
Move all content from root `lib/` to `packages/lib/`:

1. Move all subdirectories:
   - lib/calculations → packages/lib/calculations
   - lib/data → packages/lib/data
   - lib/db → packages/lib/db
   - lib/metrics → packages/lib/metrics
   - lib/models → packages/lib/models
   - lib/processing → packages/lib/processing
   - lib/services → packages/lib/services
   - lib/stores → packages/lib/stores
   - lib/types → packages/lib/types
   - lib/utils → packages/lib/utils
   - lib/utils.ts → packages/lib/utils.ts

2. Update internal imports within moved files:
   - Change any `@/lib/` imports to relative imports within the package
   - Change any `../` imports that cross module boundaries to use proper relative paths

3. Remove the old `lib/` directory after successful move

**What NOT to do:** Don't update imports in consumers yet (Next.js app, MCP server) - that's Phase 30.
  </action>
  <verify>
- `ls packages/lib/calculations/` shows the moved calculation files
- `ls lib/ 2>/dev/null` returns error (directory removed)
- No TypeScript errors in packages/lib files: check with grep for obvious import issues
  </verify>
  <done>All lib/ content moved to packages/lib/, old lib/ directory removed, internal imports updated</done>
</task>

<task type="auto">
  <name>Task 3: Update root package.json and verify workspace resolution</name>
  <files>package.json</files>
  <action>
Verify workspace configuration works:

1. The root package.json already has `"workspaces": ["packages/*"]` - confirm this
2. Run `npm install` to update workspace symlinks
3. Verify `node_modules/@tradeblocks/lib` symlink exists pointing to packages/lib

**Note:** The Next.js app and MCP server will still have broken imports at this point since they use `@/lib/` and `@lib/` paths. That's expected - Phase 30 handles import migration.
  </action>
  <verify>
- `ls -la node_modules/@tradeblocks/` shows `lib -> ../../packages/lib`
- `npm ls @tradeblocks/lib` shows it's linked from workspace
  </verify>
  <done>Workspace symlink established, @tradeblocks/lib resolvable via node_modules</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `packages/lib/package.json` exists with correct name and configuration
- [ ] `packages/lib/index.ts` exports from all subdirectories
- [ ] `ls lib/` returns "No such file or directory" (old location removed)
- [ ] `node_modules/@tradeblocks/lib` symlink exists
- [ ] No lingering files in old `lib/` location
</verification>

<success_criteria>

- `@tradeblocks/lib` package created with all lib code moved
- Package exports configured for selective imports
- Workspace symlink established
- Ready for Phase 30 (import migration)
</success_criteria>

<output>
After completion, create `.planning/phases/29-workspace-setup/29-01-SUMMARY.md`:

# Phase 29 Plan 01: Workspace Setup Summary

**[One-liner describing what shipped]**

## Accomplishments

- Created @tradeblocks/lib package structure
- Moved all lib/ code to packages/lib/
- Configured barrel exports
- Verified workspace resolution

## Files Created/Modified

- `packages/lib/package.json` - Package configuration
- `packages/lib/tsconfig.json` - TypeScript configuration
- `packages/lib/index.ts` - Barrel exports
- `packages/lib/*` - All moved lib code
- Deleted: `lib/` (old location)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 30: import-migration - Update all imports to use @tradeblocks/lib
</output>
