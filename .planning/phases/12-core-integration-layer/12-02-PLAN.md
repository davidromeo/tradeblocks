---
phase: 12-core-integration-layer
plan: 02
type: execute
domain: mcp-server
---

<objective>
Implement Tier 2 advanced analysis MCP tools for walk-forward analysis, Monte Carlo simulation, correlation, tail risk, and position sizing.

Purpose: Expose TradeBlocks' advanced analysis capabilities via MCP tools.
Output: 5 analysis tools (run_walk_forward, run_monte_carlo, get_correlation_matrix, get_tail_risk, get_position_sizing) callable from Claude.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-core-integration-layer/12-RESEARCH.md
@.planning/phases/12-core-integration-layer/12-01-SUMMARY.md (after 12-01 completes)

**IMPORTANT - Dual Output Format (from UAT feedback):**
All tools must return BOTH markdown (for display) AND structured JSON (for Claude reasoning):
```typescript
return {
  content: [
    { type: "text", text: "## Monte Carlo Results\n..." },  // Markdown for display
    { type: "resource", resource: { uri: "data:application/json", mimeType: "application/json", text: JSON.stringify(structuredData) } }  // JSON for reasoning
  ]
};
```
This enables Claude to parse numerical values without regex extraction from markdown tables.

# Key source files to import
@lib/calculations/walk-forward-analyzer.ts
@lib/calculations/walk-forward-verdict.ts
@lib/calculations/monte-carlo.ts
@lib/calculations/correlation.ts
@lib/calculations/tail-risk-analysis.ts
@lib/calculations/kelly.ts

# MCP server from Plan 01
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/utils/block-loader.ts
@packages/mcp-server/src/utils/output-formatter.ts

**Depends on:** Plan 12-01 (block loading utilities, formatters)

**Key calculation modules:**
- WalkForwardOptimizer - Multiple optimization targets, robustness metrics
- runMonteCarloSimulation - With worst-case testing, percentile bands
- calculateCorrelationMatrix - Kendall, Spearman, Pearson methods
- calculateTailDependence - Gaussian copula tail risk
- calculateKellyFraction - Per-strategy and portfolio Kelly sizing
</context>

<tasks>

<task type="auto">
  <name>Task 0: Add dual output pattern to existing block tools</name>
  <files>packages/mcp-server/src/tools/blocks.ts, packages/mcp-server/src/utils/output-formatter.ts</files>
  <action>
Refactor the 6 Tier 1 tools from Plan 12-01 to include structured JSON output alongside markdown:

**output-formatter.ts:**
- Add helper function `createDualOutput(markdown: string, data: object)` that returns:
```typescript
{
  content: [
    { type: "text", text: markdown },
    { type: "resource", resource: { uri: "data:application/json", mimeType: "application/json", text: JSON.stringify(data) } }
  ]
}
```

**blocks.ts:**
- Update all 6 tools to use createDualOutput
- For list_backtests: Include `{ blocks: [{id, tradeCount, dateRange, netPl}, ...] }`
- For get_block_info: Include `{ blockId, tradeCount, dailyLogCount, strategies, dateRange }`
- For get_statistics: Include full PortfolioStats object
- For get_strategy_comparison: Include `{ strategies: [{name, trades, winRate, pl, profitFactor}, ...] }`
- For compare_blocks: Include `{ comparisons: [{blockId, stats}, ...] }`
- For get_trades: Include `{ trades: [...], pagination: {page, pageSize, totalPages, totalTrades} }`

This establishes the pattern for all Phase 12 tools.
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; all 6 tools return both text and resource content</verify>
  <done>All Tier 1 tools return dual output (markdown + JSON); createDualOutput helper available for Tier 2 tools</done>
</task>

<task type="auto">
  <name>Task 1: Implement walk-forward and Monte Carlo tools</name>
  <files>packages/mcp-server/src/tools/analysis.ts</files>
  <action>
Create analysis.ts with tool registration functions:

**run_walk_forward** - Execute walk-forward analysis
Schema:
```typescript
{
  blockId: z.string(),
  strategy: z.string().optional(),
  isWindowCount: z.number().min(2).default(5).describe("Number of IS windows"),
  oosWindowCount: z.number().min(1).default(1).describe("Number of OOS windows"),
  optimizationTarget: z.enum(['netProfit', 'sharpeRatio', 'sortinoRatio', 'calmarRatio', 'winRate']).default('sharpeRatio')
}
```
- Import WalkForwardOptimizer from @lib/calculations
- Run analysis with provided configuration
- Include verdict from getWalkForwardVerdict
- Return: Summary with efficiency, stability, consistency, verdict, and per-window results

**run_monte_carlo** - Monte Carlo risk simulation
Schema:
```typescript
{
  blockId: z.string(),
  strategy: z.string().optional(),
  numSimulations: z.number().min(100).max(10000).default(1000),
  includeWorstCase: z.boolean().default(true)
}
```
- Import runMonteCarloSimulation from @lib/calculations
- Include worst-case scenarios when requested
- Return: Expected return, risk metrics, percentile bands (5th, 25th, 50th, 75th, 95th), worst-case summary
- **Include structured JSON resource** with all numerical values for Claude reasoning
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; tools appear in server tool list</verify>
  <done>run_walk_forward and run_monte_carlo tools registered with proper schemas and output formatting</done>
</task>

<task type="auto">
  <name>Task 2: Implement correlation, tail risk, and position sizing tools</name>
  <files>packages/mcp-server/src/tools/analysis.ts, packages/mcp-server/src/index.ts</files>
  <action>
Add remaining Tier 2 tools to analysis.ts:

**get_correlation_matrix** - Strategy correlation analysis
Schema:
```typescript
{
  blockId: z.string(),
  method: z.enum(['kendall', 'spearman', 'pearson']).default('kendall')
}
```
- Import calculateCorrelationMatrix from @lib/calculations
- Return: Correlation matrix as markdown table, highly correlated pairs warning

**get_tail_risk** - Gaussian copula tail dependence
Schema:
```typescript
{
  blockId: z.string()
}
```
- Import calculateTailDependence from @lib/calculations
- Return: Tail dependence metrics, risk interpretation

**get_position_sizing** - Kelly criterion capital allocation
Schema:
```typescript
{
  blockId: z.string(),
  capitalBase: z.number().positive().describe("Starting capital in dollars")
}
```
- Import calculateKellyFraction from @lib/calculations
- Calculate per-strategy Kelly fractions
- Return: Kelly fractions per strategy, recommended allocation, warnings about extreme fractions
- **Include structured JSON resource** with all numerical values for Claude reasoning

**All tools must follow dual output pattern:** markdown text + JSON resource (see context section)

**Update index.ts:**
- Import registerAnalysisTools from tools/analysis.ts
- Call registerAnalysisTools(server, resolvedDir) after block tools
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; all 5 analysis tools listed</verify>
  <done>All 5 Tier 2 analysis tools implemented with proper schemas, calculation imports, and markdown output</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter tradeblocks-mcp build` succeeds
- [ ] `pnpm run lint` passes
- [ ] All 5 analysis tools registered (run_walk_forward, run_monte_carlo, get_correlation_matrix, get_tail_risk, get_position_sizing)
- [ ] Tools import from @lib/calculations (not reimplementing calculations)
- [ ] Error handling for blocks with insufficient data (e.g., correlation needs 2+ strategies)
</verification>

<success_criteria>

- 5 Tier 2 analysis tools registered and callable
- All tools use existing lib/calculations modules (no custom calculation logic)
- Output formatted as BOTH structured markdown AND JSON resource (dual output pattern)
- Edge cases handled (single strategy for correlation, empty blocks)
</success_criteria>

<output>
After completion, create `.planning/phases/12-core-integration-layer/12-02-SUMMARY.md` using the summary template.
</output>
