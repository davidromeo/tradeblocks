---
phase: 12-core-integration-layer
plan: 02-FIX
type: fix
---

<objective>
Fix 1 UAT issue: Expand MCP tool schemas to expose all calculation parameters.

Source: 12-02-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/12-core-integration-layer/12-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/12-core-integration-layer/12-02-PLAN.md

**Key source files - calculation modules with full parameters:**
@lib/calculations/monte-carlo.ts (MonteCarloParams interface)
@lib/calculations/correlation.ts (CorrelationOptions interface)
@lib/models/tail-risk.ts (TailRiskAnalysisOptions interface)
@lib/models/walk-forward.ts (WalkForwardConfig interface)
@lib/calculations/kelly.ts (Kelly calculation options)

**MCP tools to expand:**
@packages/mcp-server/src/tools/analysis.ts
@packages/mcp-server/src/tools/blocks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand run_monte_carlo schema</name>
  <files>packages/mcp-server/src/tools/analysis.ts</files>
  <action>
Expand run_monte_carlo tool schema to expose all MonteCarloParams options:

**Current (limited):**
- blockId, strategy, numSimulations, includeWorstCase

**Expand to include:**
- `simulationLength: z.number().min(10).default(252).describe("Number of trades/days to project forward")`
- `resampleWindow: z.number().optional().describe("Size of resample pool (how many recent items to sample from)")`
- `resampleMethod: z.enum(['trades', 'daily', 'percentage']).default('trades').describe("What to resample: individual trades, daily returns, or percentage returns")`
- `initialCapital: z.number().positive().default(100000).describe("Starting capital for simulations")`
- `tradesPerYear: z.number().min(1).default(252).describe("Expected trades per year for annualization")`
- `randomSeed: z.number().optional().describe("Random seed for reproducibility")`
- `normalizeTo1Lot: z.boolean().default(false).describe("Normalize trades to 1-lot by scaling P&L")`
- `worstCasePercentage: z.number().min(0).max(100).default(5).describe("Percentage of max-loss scenarios (0-100)")`
- `worstCaseMode: z.enum(['pool', 'guarantee']).default('pool').describe("How to inject worst-case: add to pool or guarantee in every simulation")`
- `worstCaseSizing: z.enum(['absolute', 'relative']).default('absolute').describe("Worst-case sizing: absolute historical dollars or scale to account capital")`

Update the handler to pass all parameters to runMonteCarloSimulation.
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; run_monte_carlo schema shows all new parameters</verify>
  <done>run_monte_carlo exposes 12+ parameters matching MonteCarloParams interface</done>
</task>

<task type="auto">
  <name>Task 2: Expand get_correlation_matrix schema</name>
  <files>packages/mcp-server/src/tools/analysis.ts</files>
  <action>
Expand get_correlation_matrix tool schema to expose all CorrelationOptions:

**Current (limited):**
- blockId, method

**Expand to include:**
- `alignment: z.enum(['shared', 'zero-pad']).default('shared').describe("How to handle missing dates: only shared days, or zero-pad missing")`
- `normalization: z.enum(['raw', 'margin', 'notional']).default('raw').describe("How to normalize returns: absolute P&L, P&L/margin, or P&L/notional")`
- `dateBasis: z.enum(['opened', 'closed']).default('opened').describe("Which trade date to use for grouping")`
- `timePeriod: z.enum(['daily', 'weekly', 'monthly']).default('daily').describe("Time period for return aggregation")`

Update handler to pass all options to calculateCorrelationMatrix.
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; get_correlation_matrix schema shows all new parameters</verify>
  <done>get_correlation_matrix exposes all 5 CorrelationOptions parameters</done>
</task>

<task type="auto">
  <name>Task 3: Expand get_tail_risk schema</name>
  <files>packages/mcp-server/src/tools/analysis.ts</files>
  <action>
Expand get_tail_risk tool schema to expose all TailRiskAnalysisOptions:

**Current (limited):**
- blockId

**Expand to include:**
- `tailThreshold: z.number().min(0.01).max(0.5).default(0.1).describe("Percentile threshold for tail events (0.1 = worst 10%)")`
- `minTradingDays: z.number().min(10).default(30).describe("Minimum shared trading days required")`
- `normalization: z.enum(['raw', 'margin', 'notional']).default('raw').describe("How to normalize returns")`
- `dateBasis: z.enum(['opened', 'closed']).default('opened').describe("Which trade date to use")`
- `tickerFilter: z.string().optional().describe("Filter trades by ticker symbol")`
- `strategyFilter: z.array(z.string()).optional().describe("Filter to specific strategies only")`

Update handler to pass all options to performTailRiskAnalysis.
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; get_tail_risk schema shows all new parameters</verify>
  <done>get_tail_risk exposes all 6 TailRiskAnalysisOptions parameters</done>
</task>

<task type="auto">
  <name>Task 4: Expand run_walk_forward schema</name>
  <files>packages/mcp-server/src/tools/analysis.ts</files>
  <action>
Expand run_walk_forward tool schema to expose more WalkForwardConfig options:

**Current (limited):**
- blockId, strategy, isWindowCount, oosWindowCount, optimizationTarget

**Expand to include (most impactful options):**
- `inSampleDays: z.number().min(7).optional().describe("Explicit in-sample period days (overrides isWindowCount calculation)")`
- `outOfSampleDays: z.number().min(1).optional().describe("Explicit out-of-sample period days (overrides oosWindowCount calculation)")`
- `stepSizeDays: z.number().min(1).optional().describe("Days to slide forward each period")`
- `minInSampleTrades: z.number().min(5).default(10).describe("Minimum trades required in IS period")`
- `minOutSampleTrades: z.number().min(1).default(3).describe("Minimum trades required in OOS period")`
- `profitFactor` and `cagr` added to optimizationTarget enum
- `anchored: z.boolean().default(false).describe("If true, all IS windows start from beginning (expanding window)")`

**Note:** Keep isWindowCount/oosWindowCount as convenience parameters that calculate days dynamically.
If explicit days are provided, they override the window count calculations.

Update handler logic to handle both modes (window count vs explicit days).
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; run_walk_forward schema shows all new parameters</verify>
  <done>run_walk_forward exposes 10+ parameters with both convenience and explicit modes</done>
</task>

<task type="auto">
  <name>Task 5: Expand get_position_sizing schema</name>
  <files>packages/mcp-server/src/tools/analysis.ts</files>
  <action>
Expand get_position_sizing tool schema:

**Current (limited):**
- blockId, capitalBase

**Expand to include:**
- `kellyFraction: z.enum(['full', 'half', 'quarter']).default('half').describe("Kelly fraction to use (half Kelly recommended for safety)")`
- `maxAllocationPct: z.number().min(1).max(100).default(25).describe("Maximum allocation per strategy as percentage")`
- `includeNegativeKelly: z.boolean().default(true).describe("Include strategies with negative Kelly (loss reduction)")`

Update handler to:
- Apply Kelly fraction multiplier (1.0, 0.5, 0.25) to allocations
- Respect max allocation cap
- Optionally exclude negative Kelly strategies from recommendations
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; get_position_sizing schema shows all new parameters</verify>
  <done>get_position_sizing exposes 5 parameters with configurable Kelly fractions</done>
</task>

<task type="auto">
  <name>Task 6: Expand Tier 1 block tools schemas</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Audit and expand Tier 1 tool schemas where applicable:

**list_backtests:**
- Add `sortBy: z.enum(['name', 'tradeCount', 'netPl', 'dateRange']).default('name').describe("Sort results by field")`
- Add `sortOrder: z.enum(['asc', 'desc']).default('asc').describe("Sort direction")`

**get_trades:**
- Add `strategy: z.string().optional().describe("Filter by strategy name")`
- Add `sortBy: z.enum(['date', 'pl', 'strategy']).default('date').describe("Sort trades by field")`
- Add `sortOrder: z.enum(['asc', 'desc']).default('desc').describe("Sort direction")`
- Add `minPl: z.number().optional().describe("Filter trades with P&L >= this value")`
- Add `maxPl: z.number().optional().describe("Filter trades with P&L <= this value")`

**get_statistics:**
- Add `strategy: z.string().optional().describe("Calculate stats for specific strategy only")`

**get_strategy_comparison:**
- Already good, no changes needed

**compare_blocks:**
- Add `metrics: z.array(z.string()).optional().describe("Specific metrics to compare (default: all)")`

**get_block_info:**
- Already good, no changes needed

Update handlers to implement new filtering/sorting logic.
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; pnpm run lint passes</verify>
  <done>All Tier 1 tools have expanded filtering, sorting, and customization options</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter tradeblocks-mcp build` succeeds
- [ ] `pnpm run lint` passes
- [ ] All tools have significantly expanded schemas
- [ ] Parameter descriptions are clear and helpful for Claude
- [ ] Default values are sensible for common use cases
- [ ] Handlers pass all new parameters to underlying functions
</verification>

<success_criteria>

- All 11 MCP tools audited and expanded
- Monte Carlo: 12+ parameters (up from 4)
- Correlation: 5 parameters (up from 2)
- Tail Risk: 6 parameters (up from 1)
- Walk-Forward: 10+ parameters (up from 5)
- Position Sizing: 5 parameters (up from 2)
- Tier 1 tools: filtering/sorting added where applicable
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/12-core-integration-layer/12-02-FIX-SUMMARY.md`

Then update `.planning/phases/12-core-integration-layer/12-02-ISSUES.md` to move UAT-001 to "Resolved Issues" section.
</output>
