---
phase: 12-core-integration-layer
plan: 01
type: execute
domain: mcp-server
---

<objective>
Build block data loading utilities and implement Tier 1 core MCP tools for block listing, statistics, and comparison.

Purpose: Establish the data loading foundation and expose core query capabilities via MCP tools.
Output: Working MCP server with block loading utils and 6 core tools (list_backtests, get_block_info, get_statistics, get_strategy_comparison, compare_blocks, get_trades).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-core-integration-layer/12-RESEARCH.md
@.planning/phases/11-research-architecture/11-02-SUMMARY.md

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Key files from Phase 11
@packages/mcp-server/src/index.ts
@packages/mcp-server/package.json
@packages/mcp-server/tsup.config.ts

# Calculation module to reuse
@lib/calculations/portfolio-stats.ts
@lib/processing/trade-processor.ts
@lib/processing/daily-log-processor.ts

**Tech stack from Phase 11:**
- @modelcontextprotocol/sdk ^1.11.0
- zod ^4.0.0
- tsup for bundling with @lib/* imports

**Established patterns:**
- McpServer.registerTool() for tool registration
- stderr for logging, stdout reserved for JSON-RPC
- Command line arg for backtest directory
- Folder-based blocks: tradelog.csv (required), dailylog.csv (optional), reportinglog.csv (optional)

**Key decisions:**
- MCP "reprocess" = re-parse CSVs + recalculate (different from UI "recalculate")
- .block.json stores metadata + cached stats
- Return structured markdown for Claude parsing
- 8-12 tools max to avoid model confusion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create block data loading utilities</name>
  <files>packages/mcp-server/src/utils/block-loader.ts, packages/mcp-server/src/utils/output-formatter.ts</files>
  <action>
Create utility modules for the MCP server:

**block-loader.ts:**
- `loadBlock(baseDir, blockId)` - Load trades and optional daily logs from block folder
- `listBlocks(baseDir)` - Scan directory for valid block folders (contain tradelog.csv)
- `loadMetadata(blockPath)` - Read .block.json if exists, return undefined otherwise
- `saveMetadata(blockPath, metadata)` - Write .block.json with stats cache
- Use TradeProcessor from @lib/processing for CSV parsing
- Use DailyLogProcessor from @lib/processing for daily logs
- Handle missing files gracefully (dailylog.csv is optional)
- Return typed results: `{ trades: Trade[], dailyLogs?: DailyLogEntry[], metadata?: BlockMetadata }`

**output-formatter.ts:**
- `formatStatsTable(stats: PortfolioStats)` - Format stats as markdown table
- `formatTradesTable(trades: Trade[], limit: number)` - Paginated trade list
- `formatBlockSummary(block: BlockInfo)` - Summary for list_backtests
- Include monetary formatting ($1,234.56), percentage formatting (12.34%)
- All output as structured markdown for Claude parsing

Use @lib/* path alias for imports (already configured in tsup).
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds, TypeScript compiles without errors</verify>
  <done>block-loader.ts exports loadBlock, listBlocks, loadMetadata, saveMetadata; output-formatter.ts exports formatStatsTable, formatTradesTable, formatBlockSummary</done>
</task>

<task type="auto">
  <name>Task 2: Implement Tier 1 core tools</name>
  <files>packages/mcp-server/src/index.ts, packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Refactor index.ts to import tools from separate files and implement 6 Tier 1 tools:

**packages/mcp-server/src/tools/blocks.ts:**
Create tool registration functions that accept the server and baseDir:

1. **list_backtests** (upgrade existing) - List all block folders with summary stats
   - Schema: `{}` (no params)
   - Return: markdown list with block name, trade count, date range, net P/L

2. **get_block_info** - Detailed info for specific block
   - Schema: `{ blockId: z.string().describe("Block folder name") }`
   - Return: trade count, date range, strategies found, daily log status

3. **get_statistics** - Full portfolio stats with optional filters
   - Schema: `{ blockId: string, strategy?: string, startDate?: string, endDate?: string }`
   - Use PortfolioStatsCalculator from @lib/calculations
   - When strategy filter provided, set isStrategyFiltered=true (forces trade-based calculations)
   - Return: formatted stats table with all metrics

4. **get_strategy_comparison** - Compare all strategies within block
   - Schema: `{ blockId: string }`
   - Calculate stats per strategy using calculateStrategyStats
   - Return: comparison table sorted by net P/L

5. **compare_blocks** - Compare stats across multiple blocks
   - Schema: `{ blockIds: z.array(z.string()).max(5) }` (limit to 5)
   - Return: side-by-side stats comparison table

6. **get_trades** - Get trades with filtering and pagination
   - Schema: `{ blockId: string, strategy?: string, startDate?: string, endDate?: string, page?: number, pageSize?: number }`
   - Default pageSize: 50, max: 100
   - Return: paginated trade list with total count

**index.ts updates:**
- Import and call registerBlockTools(server, resolvedDir)
- Keep startup logic, move tool registrations to tools/blocks.ts
- Ensure console.error only for logging (never console.log in stdio server)
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds; manual test: node dist/index.js ~/test-backtests (create test folder with sample tradelog.csv)</verify>
  <done>All 6 tools registered and callable; each returns structured markdown; error cases return isError: true with descriptive message</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter tradeblocks-mcp build` succeeds without errors
- [ ] `pnpm run lint` passes (including new files)
- [ ] Manual test: Create test folder with sample tradelog.csv, verify list_backtests shows it
- [ ] No console.log statements in server code (only console.error)
- [ ] All tools use structured markdown output
</verification>

<success_criteria>

- Block loading utilities created and working
- 6 Tier 1 tools registered and callable
- All tools return structured markdown responses
- Error handling returns isError: true with descriptive messages
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-core-integration-layer/12-01-SUMMARY.md` using the summary template.
</output>
