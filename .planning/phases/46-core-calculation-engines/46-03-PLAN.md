---
phase: 46-core-calculation-engines
plan: 03
type: execute
wave: 2
depends_on: ["46-01", "46-02"]
files_modified:
  - packages/mcp-server/src/tools/edge-decay.ts
  - packages/mcp-server/src/index.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "An MCP tool accepts a blockId and returns period-segmented statistics with trends and rolling metric trajectories"
    - "The tool output includes period breakdowns (yearly/quarterly/monthly), trend regression data, worst consecutive losing months, rolling series, seasonal averages, and recent-vs-historical comparison with structural flags"
    - "The tool works via CLI --call mode for testing"
    - "The tool accepts optional parameters for rolling window size, recent window size, and recent window days"
  artifacts:
    - path: "packages/mcp-server/src/tools/edge-decay.ts"
      provides: "MCP tool registration for edge decay analysis (period segmentation + rolling metrics)"
      exports: ["registerEdgeDecayTools"]
    - path: "packages/mcp-server/src/index.ts"
      provides: "Updated server registration including edge decay tools"
      contains: "registerEdgeDecayTools"
  key_links:
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/lib/calculations/period-segmentation.ts"
      via: "segmentByPeriod import from @tradeblocks/lib"
      pattern: "segmentByPeriod"
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/lib/calculations/rolling-metrics.ts"
      via: "computeRollingMetrics import from @tradeblocks/lib"
      pattern: "computeRollingMetrics"
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/mcp-server/src/utils/block-loader.ts"
      via: "loadBlock for loading trade data"
      pattern: "loadBlock"
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/mcp-server/src/tools/middleware/sync-middleware.ts"
      via: "withSyncedBlock for automatic sync"
      pattern: "withSyncedBlock"
    - from: "packages/mcp-server/src/index.ts"
      to: "packages/mcp-server/src/tools/edge-decay.ts"
      via: "tool registration"
      pattern: "registerEdgeDecayTools"
---

<objective>
Wire period segmentation and rolling metrics engines into MCP tool(s) and verify via CLI.

Purpose: Makes the Phase 46 calculation engines accessible to Claude and other MCP clients through the `analyze_period_metrics` and `analyze_rolling_metrics` MCP tools (or a single combined tool). Also bumps the MCP server version since this adds new tool functionality.

Output: New MCP tool file (`edge-decay.ts`), updated server index, version bump, and CLI verification.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-core-calculation-engines/46-CONTEXT.md
@.planning/phases/46-core-calculation-engines/46-RESEARCH.md
@.planning/phases/46-core-calculation-engines/46-01-SUMMARY.md
@.planning/phases/46-core-calculation-engines/46-02-SUMMARY.md
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/tools/analysis.ts
@packages/mcp-server/src/tools/blocks/core.ts
@packages/mcp-server/src/tools/middleware/sync-middleware.ts
@packages/mcp-server/src/utils/output-formatter.ts
@packages/mcp-server/src/utils/block-loader.ts
@packages/mcp-server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP edge decay tools and register them</name>
  <files>
    packages/mcp-server/src/tools/edge-decay.ts
    packages/mcp-server/src/index.ts
    packages/mcp-server/package.json
  </files>
  <action>
**1. Create `packages/mcp-server/src/tools/edge-decay.ts`**

Follow the exact patterns from `packages/mcp-server/src/tools/analysis.ts` and `packages/mcp-server/src/tools/blocks/core.ts`.

```typescript
import { z } from "zod";
import type { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { loadBlock } from "../utils/block-loader.js";
import { createToolOutput } from "../utils/output-formatter.js";
import { withSyncedBlock } from "./middleware/sync-middleware.js";
import { segmentByPeriod, computeRollingMetrics } from "@tradeblocks/lib";
import type { Trade } from "@tradeblocks/lib";
```

Register TWO tools in a single `registerEdgeDecayTools(server, baseDir)` function:

**Tool 1: `analyze_period_metrics`**

Description: "Segment a block's trades by year, quarter, and month with per-period statistics, trend detection via linear regression, and worst consecutive losing month identification. Foundation for edge decay analysis."

Input schema (Zod):
```typescript
z.object({
  blockId: z.string().describe("Block folder name"),
  strategy: z.string().optional().describe("Filter by strategy name (case-insensitive)"),
})
```

Handler:
- Load block via `loadBlock(blockId, baseDir)` -- gets `{ trades, dailyLogEntries, metadata }`.
- Filter by strategy if provided (use `trades.filter(t => t.strategy.toLowerCase() === strategy.toLowerCase())`).
- Call `segmentByPeriod(filteredTrades)`.
- Build summary text:
  ```
  Period metrics for {blockId}: {totalTrades} trades across {yearCount} years
  Yearly trend (win rate slope): {slope}, Quarterly periods: {quarterCount}
  Worst losing streak: {months} months ({startMonth} to {endMonth})
  ```
- Return via `createToolOutput(summary, result)` where result is the full PeriodSegmentationResult.

Wrap with `withSyncedBlock` for automatic DuckDB sync:
```typescript
server.registerTool(
  "analyze_period_metrics",
  { description: "...", inputSchema: schema },
  withSyncedBlock(baseDir, async (input, ctx) => {
    // handler
  })
)
```

**Tool 2: `analyze_rolling_metrics`**

Description: "Compute rolling window statistics, quarterly seasonal averages, and recent-vs-historical comparison with structural flags for a block's trades. Foundation for edge decay analysis."

Input schema (Zod):
```typescript
z.object({
  blockId: z.string().describe("Block folder name"),
  strategy: z.string().optional().describe("Filter by strategy name (case-insensitive)"),
  windowSize: z.number().min(5).optional().describe("Rolling window size in trades (default: auto-calculated based on trade count)"),
  recentWindowSize: z.number().min(10).optional().describe("Recent window size in trades for comparison (default: auto-calculated)"),
  recentWindowDays: z.number().min(7).optional().describe("Override: recent window as calendar days instead of trade count"),
})
```

Handler:
- Load block via `loadBlock(blockId, baseDir)`.
- Filter by strategy if provided.
- Call `computeRollingMetrics(filteredTrades, { windowSize, recentWindowSize, recentWindowDays })`.
- Build summary text:
  ```
  Rolling metrics for {blockId}: {totalTrades} trades, window={windowSize}
  Rolling series: {seriesLength} data points
  Structural flags: {flagCount} ({flagNames or "none"})
  Recent vs historical: win rate {recentWR} vs {histWR}, PF {recentPF} vs {histPF}
  ```
- Return via `createToolOutput(summary, result)`.
- Wrap with `withSyncedBlock`.

**2. Update `packages/mcp-server/src/index.ts`**

Add import:
```typescript
import { registerEdgeDecayTools } from "./tools/edge-decay.js";
```

Add registration call after the existing tool registrations (e.g., after `registerSchemaTools`):
```typescript
registerEdgeDecayTools(server, baseDir);
```

**3. Bump version in `packages/mcp-server/package.json`**

Bump minor version since this adds new tool functionality. If current version is e.g. `0.6.1`, bump to `0.7.0`. Read the current version first and increment the minor segment.

IMPORTANT:
- Use the `.js` extension in imports (for ESM compatibility in the MCP server).
- Follow the existing `withSyncedBlock` pattern exactly (it handles block loading, sync, and error responses).
- The `loadBlock` function returns `{ trades: Trade[], dailyLogEntries: DailyLogEntry[], metadata: BlockMetadata, reportingTrades?: ReportingTrade[] }`. Use only `trades` for these tools.
- Summary text should be concise (1-3 lines). The structured JSON is the primary data source.
- No interpretive labels in any output.
  </action>
  <verify>
1. Build: `npm run build --workspace=packages/mcp-server` succeeds
2. CLI test with period metrics:
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_period_metrics '{"blockId":"main-port-2026"}'
   ```
   Should return JSON with yearly/quarterly/monthly arrays, trends, and worstConsecutiveLosingMonths.
3. CLI test with rolling metrics:
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_rolling_metrics '{"blockId":"main-port-2026"}'
   ```
   Should return JSON with rolling series, seasonalAverages, and recentVsHistorical.
4. Full test suite: `npm test` passes
  </verify>
  <done>
- `analyze_period_metrics` tool registered and working via CLI --call mode
- `analyze_rolling_metrics` tool registered and working via CLI --call mode
- Both tools use withSyncedBlock middleware for automatic DuckDB sync
- MCP server version bumped (minor version increment)
- Server index imports and registers the new tools
- No interpretive labels in tool output
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end CLI verification with real data</name>
  <files></files>
  <action>
Run both new tools against real block data to verify correctness end-to-end. This is a verification-only task that produces no new files.

**Step 1: Verify analyze_period_metrics**

```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_period_metrics '{"blockId":"main-port-2026"}'
```

Check the output for:
- `yearly` array has entries with `periodKey`, `winRate`, `profitFactor`, `kellyPercent`, `sharpeRatio`, `avgMonthlyReturnPct`, `netPl`, `tradeCount`
- `quarterly` array has entries with similar structure
- `monthly` array has entries with similar structure
- `trends.yearly` has regression results (slope, rSquared, pValue, sampleSize) for each metric
- `worstConsecutiveLosingMonths.allTime` has startMonth, endMonth, months, totalLoss (or null if no losing months)
- `dataQuality` fields are populated
- NO interpretive labels present

If the blockId doesn't exist or there's an error, try another block. Use `tradeblocks-mcp --call list_blocks '{}'` first to find available blocks.

**Step 2: Verify analyze_rolling_metrics**

```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_rolling_metrics '{"blockId":"main-port-2026"}'
```

Check the output for:
- `windowSize` is auto-calculated and reasonable
- `series` array has rolling data points with date, winRate, profitFactor, etc.
- `seasonalAverages` has Q1-Q4 data for each metric
- `recentVsHistorical.metrics` has comparison entries with delta
- `recentVsHistorical.structuralFlags` is an array (may be empty if no flags triggered)
- `dataQuality` fields populated

**Step 3: Verify with strategy filter**

```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_period_metrics '{"blockId":"main-port-2026","strategy":"SomeStrategy"}'
```

Verify it filters correctly (fewer trades than unfiltered).

**Step 4: Verify with custom parameters**

```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_rolling_metrics '{"blockId":"main-port-2026","windowSize":30,"recentWindowSize":100}'
```

Verify custom window sizes are respected.

If any test fails, diagnose and fix the issue in the relevant files before proceeding.
  </action>
  <verify>
All 4 CLI calls return valid JSON output without errors. Output structure matches the expected interfaces.
  </verify>
  <done>
- Both MCP tools return valid structured output for real block data
- Strategy filtering works correctly
- Custom parameter overrides work
- No runtime errors or crashes
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=packages/mcp-server` succeeds
2. `npm test` -- full test suite passes
3. `analyze_period_metrics` CLI test returns valid period segmentation data
4. `analyze_rolling_metrics` CLI test returns valid rolling metrics data
5. Strategy filtering works for both tools
6. Custom parameters (windowSize, recentWindowSize) are respected
7. MCP server version bumped in package.json
</verification>

<success_criteria>
- Two new MCP tools (`analyze_period_metrics`, `analyze_rolling_metrics`) registered and functional
- Tools accessible via CLI --call mode with real data producing valid output
- Output includes all Phase 46 requirements: period breakdowns, trends, worst losing stretch, rolling series, seasonal averages, recent comparison, structural flags
- MCP server version bumped
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/46-core-calculation-engines/46-03-SUMMARY.md`
</output>
