---
phase: 21-strategy-similarity
plan: 01
type: execute
---

<objective>
Implement strategy_similarity MCP tool to flag potentially redundant strategies based on correlation, tail dependence, and return overlap.

Purpose: Answer "Which strategies are too similar and might be adding risk without diversification benefit?" - critical for portfolio simplification and risk reduction.
Output: Working MCP tool with similarity scoring, redundancy flags, and actionable recommendations, plus integration tests with CLI verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-marginal-contribution/20-01-SUMMARY.md
@.planning/phases/19-drawdown-attribution/19-01-SUMMARY.md
@packages/mcp-server/src/tools/blocks.ts
@packages/mcp-server/src/tools/analysis.ts

**Tech stack available:**
- `calculateCorrelationMatrix()` and `calculateCorrelationAnalytics()` from `@lib/calculations/correlation`
- `performTailRiskAnalysis()` from `@lib/calculations/tail-risk-analysis`
- filterByStrategy utility in blocks.ts
- JSON-first output pattern with summary line + structured data

**Established patterns:**
- JSON-first output with summary line + structured data
- Trade-based calculations only (no daily logs) per Phase 17 constraint
- Integration tests in tests/integration/, fixtures in tests/fixtures/
- CLI test mode verification per Phase 17.1 constraint

**Constraining decisions:**
- Phase 17: Trade-based calculations only for comparison tools
- Phase 17.1: CLI test verification required for all v2.1 MCP tools
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement strategy_similarity MCP tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add Tool 10: strategy_similarity (after marginal_contribution, before get_trades - renumber get_trades to Tool 11).

**Input schema:**
- blockId (required): Block folder name
- correlationThreshold (optional, default 0.7): Minimum correlation to flag as similar
- tailDependenceThreshold (optional, default 0.5): Minimum tail dependence to flag as high joint risk
- method (optional, default "kendall"): Correlation method (kendall, spearman, pearson)
- minSharedDays (optional, default 30): Minimum trading days for valid comparison
- topN (optional, default 5): Number of most similar pairs to return

**Algorithm:**
1. Load block and get all trades
2. Get unique strategies list (need at least 2 for similarity analysis)
3. Calculate correlation matrix using `calculateCorrelationMatrix()` with method parameter
4. Calculate tail risk using `performTailRiskAnalysis()` with minTradingDays parameter
5. For each unique strategy pair (i < j):
   a. Get correlation from correlation matrix
   b. Get tail dependence from jointTailRiskMatrix
   c. Calculate overlap score: count of days both strategies traded / total unique days
   d. Calculate composite similarity score (weighted average):
      - 50% correlation (absolute value)
      - 30% tail dependence
      - 20% overlap score
   e. Determine flags:
      - isHighCorrelation: |correlation| >= correlationThreshold
      - isHighTailDependence: tailDependence >= tailDependenceThreshold
      - isRedundant: isHighCorrelation AND isHighTailDependence
6. Sort pairs by composite similarity score (highest first)
7. Return topN results

**Key implementation details:**
- Import calculateCorrelationMatrix, calculateCorrelationAnalytics from correlation
- Import performTailRiskAnalysis from tail-risk-analysis
- Handle insufficient data: pairs without enough shared days get null similarity
- Overlap calculation: group trades by date (dateOpened), count shared trading days
- Use { normalization: "raw", dateBasis: "opened" } for both correlation and tail risk to ensure consistency

**Output format (JSON-first pattern):**
Summary: "Strategy Similarity: {blockId} | {N} strategies | {M} redundant pairs | Most similar: {A}-{B} ({score})"

Structured data:
```json
{
  "blockId": "...",
  "options": {
    "correlationThreshold": 0.7,
    "tailDependenceThreshold": 0.5,
    "method": "kendall",
    "minSharedDays": 30,
    "topN": 5
  },
  "strategySummary": {
    "totalStrategies": N,
    "totalPairs": N*(N-1)/2,
    "redundantPairs": M,
    "highCorrelationPairs": X,
    "highTailDependencePairs": Y
  },
  "similarPairs": [
    {
      "strategyA": "...",
      "strategyB": "...",
      "correlation": 0.85,
      "tailDependence": 0.62,
      "overlapScore": 0.78,
      "compositeSimilarity": 0.75,
      "sharedTradingDays": 45,
      "flags": {
        "isHighCorrelation": true,
        "isHighTailDependence": true,
        "isRedundant": true
      },
      "recommendation": "Consider consolidating - these strategies move together and suffer losses together"
    }
  ],
  "recommendations": [
    "Pair A-B flagged as redundant: high correlation (0.85) + high tail dependence (0.62)",
    "Consider removing one of A or B to reduce concentrated risk"
  ]
}
```

**Recommendations logic:**
- isRedundant: "Consider consolidating - these strategies move together and suffer losses together"
- isHighCorrelation only: "Moderate redundancy - correlated returns reduce diversification benefit"
- isHighTailDependence only: "Tail risk overlap - may amplify losses during market stress"
- Neither flag: null (no recommendation needed)
  </action>
  <verify>npm run build -w packages/mcp-server succeeds without errors</verify>
  <done>Tool registered with proper input schema and output format, builds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests</name>
  <files>packages/mcp-server/tests/integration/strategy-similarity.test.ts, packages/mcp-server/tests/fixtures/similarity-test-block/tradelog.csv</files>
  <action>
Create test fixture designed to demonstrate strategy similarity:

**Fixture design (tradelog.csv):**
Design 4 strategies with known characteristics (40 trades total, 10 per strategy):
1. "TrendFollowA" - Similar to TrendFollowB (same dates, similar P/L direction) → should be flagged redundant
2. "TrendFollowB" - Pair with TrendFollowA for high correlation test
3. "MeanRevert" - Inversely correlated to TrendFollow strategies → low similarity
4. "Independent" - Trades on different days, uncorrelated returns → low overlap, low correlation

Use dates spread across 2024 with:
- TrendFollowA and TrendFollowB: Same 30 trading days, similar P/L (±10%)
- MeanRevert: Same 30 days as TrendFollow, opposite P/L direction
- Independent: Different 30 days, unrelated P/L

**Test cases:**
1. Basic functionality - all pairs calculated, summary statistics correct
2. TrendFollowA-TrendFollowB should have high correlation (> 0.7)
3. TrendFollowA-TrendFollowB should be flagged as redundant
4. TrendFollowA-MeanRevert should have negative correlation
5. Independent-others should have low overlap score
6. correlationThreshold parameter - changing threshold affects flags
7. tailDependenceThreshold parameter - changing threshold affects flags
8. topN parameter - limits results correctly
9. Single strategy portfolio - returns error (need at least 2)
10. Two strategy portfolio - returns single pair result
11. Recommendations generated correctly based on flags
12. method parameter (kendall vs pearson) produces different correlations

**Document CLI test verification in test file header:**
```typescript
/**
 * CLI Test Mode Verification:
 * TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call strategy_similarity '{"blockId":"main-port-2026"}'
 *
 * Expected: Summary line + JSON with similarity pairs and recommendations
 */
```
  </action>
  <verify>npm test -w packages/mcp-server -- --testPathPattern=strategy-similarity passes all tests</verify>
  <done>All integration tests pass, fixture demonstrates expected similarity detection behavior</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build -w packages/mcp-server` succeeds without errors
- [ ] `npm test -w packages/mcp-server` passes all tests (existing + new)
- [ ] `npm test -w packages/mcp-server -- --testPathPattern=strategy-similarity` passes
- [ ] Tool follows JSON-first output pattern with summary line
- [ ] Trade-based calculations only (no daily logs) per Phase 17 constraint
- [ ] Leverages existing correlation and tail-risk calculations (no duplication)
</verification>

<success_criteria>

- strategy_similarity tool implemented and registered
- Algorithm combines correlation, tail dependence, and overlap metrics
- Redundancy flags correctly identify similar strategy pairs
- Actionable recommendations generated based on flags
- Integration tests cover core functionality and edge cases
- CLI test mode documented for real data verification
- No TypeScript errors, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-strategy-similarity/21-01-SUMMARY.md` using the summary template with frontmatter.

Include:
- Tech patterns: composite-similarity-scoring, redundancy-detection, strategy-pair-analysis
- Key files created/modified
- Key decisions (weights for composite score, threshold defaults, recommendation logic)
- CLI test mode verification example
</output>
