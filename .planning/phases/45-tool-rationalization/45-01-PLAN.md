---
phase: 45-tool-rationalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/blocks/core.ts
  - packages/mcp-server/src/tools/reports/fields.ts
  - packages/mcp-server/src/tools/reports/queries.ts
  - packages/mcp-server/src/tools/market-data.ts
  - packages/mcp-server/src/utils/schema-metadata.ts
  - packages/mcp-server/CHANGELOG.md
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "run_sql can perform all queries that removed tools could perform"
    - "describe_database provides SQL examples for common patterns previously handled by removed tools"
    - "MCP server starts and works without the removed tools"
    - "Remaining tools (computational) still function correctly"
  artifacts:
    - path: "packages/mcp-server/src/tools/blocks/core.ts"
      provides: "Core block tools without get_trades"
      min_lines: 300
    - path: "packages/mcp-server/src/tools/reports/fields.ts"
      provides: "Field tools without list_available_fields"
      min_lines: 100
    - path: "packages/mcp-server/src/tools/reports/queries.ts"
      provides: "Empty file or removed (no tools remain)"
      min_lines: 0
    - path: "packages/mcp-server/src/tools/market-data.ts"
      provides: "Market data tools without get_market_context, enrich_trades, find_similar_days"
      min_lines: 400
    - path: "packages/mcp-server/CHANGELOG.md"
      provides: "Changelog documenting breaking changes"
      contains: "BREAKING"
    - path: ".planning/phases/45-tool-rationalization/45-ANALYSIS.md"
      provides: "Tool rationalization analysis document"
      min_lines: 100
  key_links:
    - from: "packages/mcp-server/src/tools/reports/index.ts"
      to: "registerQueryTools"
      via: "Import removed or registration removed if file deleted"
      pattern: "(registerQueryTools|queries\\.js)"
    - from: "packages/mcp-server/src/utils/schema-metadata.ts"
      to: "EXAMPLE_QUERIES"
      via: "New examples for trade filtering, market queries, joins, aggregations"
      pattern: "EXAMPLE_QUERIES"
---

<objective>
Remove MCP tools that run_sql can fully replace and update schema examples.

Purpose: Complete the SQL analytics layer by removing redundant query tools. run_sql + describe_database now provide flexible SQL access, making rigid query tools obsolete.

Output:
- Analysis document listing removed vs kept tools with rationale
- 7 tools removed from codebase
- Updated schema examples covering removed tool functionality
- CHANGELOG documenting breaking changes
- Version bump to 0.6.0 (minor - removing tools is breaking change)
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-tool-rationalization/45-CONTEXT.md
@.planning/phases/45-tool-rationalization/45-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis document and remove tools</name>
  <files>
    .planning/phases/45-tool-rationalization/45-ANALYSIS.md
    packages/mcp-server/src/tools/blocks/core.ts
    packages/mcp-server/src/tools/reports/fields.ts
    packages/mcp-server/src/tools/reports/queries.ts
    packages/mcp-server/src/tools/reports/index.ts
    packages/mcp-server/src/tools/market-data.ts
  </files>
  <action>
    1. Create 45-ANALYSIS.md documenting:
       - Tools removed (7): get_trades, list_available_fields, run_filtered_query, aggregate_by_field, get_market_context, enrich_trades, find_similar_days
       - Tools kept and why (computational tools using TradeBlocks libraries)
       - SQL replacement patterns for each removed tool

    2. Remove tools from source files:

       a) In blocks/core.ts: Remove the `get_trades` tool registration (lines ~544-745).
          Keep: list_blocks, get_block_info, get_reporting_log_stats, get_statistics

       b) In reports/fields.ts: Remove `list_available_fields` tool registration (lines ~27-136).
          Keep: get_field_statistics (computational - calculates percentiles, histograms)
          Update exports if needed.

       c) In reports/queries.ts: Remove BOTH tools (run_filtered_query, aggregate_by_field).
          This file becomes empty of tools - either delete it entirely or leave shell.

       d) In reports/index.ts: Remove import and registration of registerQueryTools since
          queries.ts no longer has tools. Keep other registrations.

       e) In market-data.ts: Remove get_market_context, enrich_trades, find_similar_days.
          Keep: analyze_regime_performance, suggest_filters, calculate_orb (computational)
          These tools use library logic beyond simple SQL queries.

    3. After removal, verify imports are clean (no unused imports).
  </action>
  <verify>
    cd packages/mcp-server && npm run build
    # Should compile without errors
  </verify>
  <done>
    - 45-ANALYSIS.md exists with rationale for each tool
    - get_trades removed from core.ts
    - list_available_fields removed from fields.ts
    - queries.ts deleted or emptied (run_filtered_query + aggregate_by_field removed)
    - reports/index.ts no longer imports/registers query tools
    - get_market_context, enrich_trades, find_similar_days removed from market-data.ts
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Update schema examples and documentation</name>
  <files>
    packages/mcp-server/src/utils/schema-metadata.ts
    packages/mcp-server/CHANGELOG.md
    packages/mcp-server/package.json
    packages/mcp-server/src/index.ts
  </files>
  <action>
    1. Update EXAMPLE_QUERIES in schema-metadata.ts to cover patterns from removed tools:

       Add to `basic` section:
       - Trade filtering with pagination (replaces get_trades):
         ```sql
         SELECT date_opened, time_opened, strategy, legs, pl, num_contracts
         FROM trades.trade_data
         WHERE block_id = 'my-block'
           AND strategy ILIKE '%iron%'
           AND pl > 0
         ORDER BY date_opened DESC
         LIMIT 50 OFFSET 0
         ```

       - Market data query (replaces get_market_context):
         ```sql
         SELECT date, VIX_Close, Vol_Regime, Term_Structure_State, Gap_Pct
         FROM market.spx_daily
         WHERE date BETWEEN '2024-01-01' AND '2024-06-30'
           AND VIX_Close > 20
         ORDER BY date
         ```

       Add to `joins` section:
       - Trade enrichment pattern (replaces enrich_trades):
         ```sql
         SELECT t.date_opened, t.strategy, t.pl,
                m.VIX_Close, m.Vol_Regime, m.Gap_Pct
         FROM trades.trade_data t
         LEFT JOIN market.spx_daily m ON t.date_opened = m.date
         WHERE t.block_id = 'my-block'
         ```

       Add to `hypothesis` section:
       - Aggregation by field with buckets (replaces aggregate_by_field):
         ```sql
         SELECT
           CASE
             WHEN m.VIX_Close < 15 THEN '10-15'
             WHEN m.VIX_Close < 20 THEN '15-20'
             WHEN m.VIX_Close < 25 THEN '20-25'
             ELSE '25+'
           END as vix_bucket,
           COUNT(*) as trades,
           SUM(CASE WHEN t.pl > 0 THEN 1 ELSE 0 END)::FLOAT / COUNT(*) as win_rate,
           SUM(t.pl) as total_pl
         FROM trades.trade_data t
         JOIN market.spx_daily m ON t.date_opened = m.date
         WHERE t.block_id = 'my-block'
         GROUP BY vix_bucket
         ORDER BY vix_bucket
         ```

       - Find similar days (replaces find_similar_days):
         ```sql
         WITH ref AS (
           SELECT VIX_Close, Vol_Regime, Term_Structure_State
           FROM market.spx_daily WHERE date = '2024-01-15'
         )
         SELECT m.date, m.VIX_Close, m.Vol_Regime, m.Term_Structure_State
         FROM market.spx_daily m, ref
         WHERE m.date != '2024-01-15'
           AND m.Vol_Regime = ref.Vol_Regime
           AND ABS(m.VIX_Close - ref.VIX_Close) < 3
         ORDER BY ABS(m.VIX_Close - ref.VIX_Close)
         LIMIT 20
         ```

    2. Create packages/mcp-server/CHANGELOG.md:
       ```markdown
       # Changelog

       ## [0.6.0] - YYYY-MM-DD

       ### BREAKING CHANGES

       Removed 7 MCP tools that are now fully replaceable by `run_sql` + `describe_database`:

       - `get_trades` - Use `SELECT ... FROM trades.trade_data WHERE ...`
       - `list_available_fields` - Use `describe_database` for schema info
       - `run_filtered_query` - Use `SELECT ... WHERE ...` with conditions
       - `aggregate_by_field` - Use `GROUP BY` with CASE expressions
       - `get_market_context` - Use `SELECT ... FROM market.spx_daily WHERE ...`
       - `enrich_trades` - Use `JOIN trades.trade_data t JOIN market.spx_daily m`
       - `find_similar_days` - Use CTE with similarity conditions

       See `describe_database` examples for SQL patterns replacing each tool.

       ### Added

       - New SQL examples in `describe_database` covering all removed tool patterns
       ```

    3. Update version in package.json from "0.5.1" to "0.6.0"

    4. Update version in src/index.ts McpServer constructor (line ~273) from "0.5.0" to "0.6.0"
  </action>
  <verify>
    cd packages/mcp-server && npm run build
    grep -q "0.6.0" package.json
    grep -q "0.6.0" src/index.ts
    test -f CHANGELOG.md
  </verify>
  <done>
    - schema-metadata.ts has new SQL examples covering removed tool patterns
    - CHANGELOG.md exists with breaking changes documented
    - package.json version is 0.6.0
    - index.ts McpServer version is 0.6.0
    - Build succeeds
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   cd packages/mcp-server && npm run build
   ```

2. Tool count verification (should be reduced by 7):
   ```bash
   # Count remaining tool registrations
   grep -r "server.registerTool" packages/mcp-server/src/tools/ | wc -l
   ```

3. Removed tools should NOT appear:
   ```bash
   grep -r "get_trades\|list_available_fields\|run_filtered_query\|aggregate_by_field\|get_market_context\|enrich_trades\|find_similar_days" packages/mcp-server/src/tools/ --include="*.ts" | grep -v "// Removed" | grep registerTool || echo "OK: No removed tools found"
   ```

4. Computational tools should still exist:
   ```bash
   grep -q "get_statistics" packages/mcp-server/src/tools/blocks/core.ts && echo "OK: get_statistics present"
   grep -q "get_field_statistics" packages/mcp-server/src/tools/reports/fields.ts && echo "OK: get_field_statistics present"
   grep -q "analyze_regime_performance" packages/mcp-server/src/tools/market-data.ts && echo "OK: analyze_regime_performance present"
   grep -q "suggest_filters" packages/mcp-server/src/tools/market-data.ts && echo "OK: suggest_filters present"
   grep -q "calculate_orb" packages/mcp-server/src/tools/market-data.ts && echo "OK: calculate_orb present"
   ```
</verification>

<success_criteria>
- [ ] 45-ANALYSIS.md documents all tool decisions
- [ ] 7 tools removed from codebase
- [ ] queries.ts deleted or emptied; reports/index.ts updated
- [ ] schema-metadata.ts has SQL examples for removed patterns
- [ ] CHANGELOG.md documents breaking changes
- [ ] Version bumped to 0.6.0 in package.json and index.ts
- [ ] npm run build succeeds
- [ ] Computational tools (get_statistics, get_field_statistics, analyze_regime_performance, suggest_filters, calculate_orb, run_monte_carlo, etc.) still present
</success_criteria>

<output>
After completion, create `.planning/phases/45-tool-rationalization/45-01-SUMMARY.md`
</output>
