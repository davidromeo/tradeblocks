---
phase: 52-duckdb-schema-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/db/schemas.ts
  - packages/mcp-server/src/sync/market-sync.ts
  - packages/mcp-server/src/utils/schema-metadata.ts
  - packages/mcp-server/src/tools/schema.ts
  - packages/mcp-server/src/tools/sql.ts
  - packages/mcp-server/src/tools/market-data.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "describe_database shows spx_daily with all 13 highlow columns and 7 new VIX columns with accurate descriptions"
    - "spx_highlow table no longer exists in the schema (dropped on connection init)"
    - "Market sync ingests the combined daily CSV with highlow + VIX fields into spx_daily"
    - "spx_highlow.csv file mapping is gone from sync configuration"
    - "Existing spx_daily data can be purged and re-imported cleanly after schema change"
    - "No references to spx_highlow remain in tool descriptions, available tables, or purge enums"
  artifacts:
    - path: "packages/mcp-server/src/db/schemas.ts"
      provides: "55-column spx_daily schema, migration check, spx_highlow drop"
      contains: "High_Time DOUBLE"
    - path: "packages/mcp-server/src/sync/market-sync.ts"
      provides: "3-file sync config (no spx_highlow.csv)"
    - path: "packages/mcp-server/src/utils/schema-metadata.ts"
      provides: "Column descriptions for 20 new spx_daily columns, no spx_highlow section"
      contains: "VIX_Gap_Pct"
    - path: "packages/mcp-server/src/tools/schema.ts"
      provides: "purge_market_table without spx_highlow option"
    - path: "packages/mcp-server/src/tools/sql.ts"
      provides: "AVAILABLE_TABLES without market.spx_highlow"
    - path: "packages/mcp-server/src/tools/market-data.ts"
      provides: "Updated file header comment (no spx_highlow.csv reference)"
  key_links:
    - from: "packages/mcp-server/src/db/schemas.ts"
      to: "ensureMarketDataTables called from connection.ts"
      via: "getConnection() -> ensureMarketDataTables()"
      pattern: "ensureMarketDataTables"
    - from: "packages/mcp-server/src/db/schemas.ts"
      to: "market._sync_metadata"
      via: "migration clears sync metadata to force re-import"
      pattern: "DELETE FROM market._sync_metadata"
    - from: "packages/mcp-server/src/sync/market-sync.ts"
      to: "packages/mcp-server/src/db/schemas.ts"
      via: "mergeMarketDataRows auto-discovers table columns from DuckDB schema"
      pattern: "duckdb_columns"
---

<objective>
Update DuckDB schema to absorb 20 new columns (13 highlow + 7 VIX) into `spx_daily`, retire the `spx_highlow` table, update sync config to remove `spx_highlow.csv` mapping, and clean up all downstream references across the MCP server.

Purpose: After Phase 51 consolidated the PineScript to output a single combined CSV, the database layer must match -- one table with all daily data, no separate highlow table, no orphaned references.

Output: Updated schema, sync config, metadata, and tool descriptions. MCP server version bumped to 0.10.0.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-duckdb-schema-sync/52-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration + sync config update</name>
  <files>
    packages/mcp-server/src/db/schemas.ts
    packages/mcp-server/src/sync/market-sync.ts
  </files>
  <action>
**schemas.ts -- Update `ensureMarketDataTables()`:**

1. Add a migration check BEFORE the `CREATE TABLE IF NOT EXISTS market.spx_daily` statement. The migration detects if the table exists but is missing the new columns (using `High_Time` as sentinel):

```typescript
// Check if spx_daily needs migration (sentinel: High_Time column)
try {
  const tableCheck = await conn.runAndReadAll(`
    SELECT 1 FROM duckdb_tables()
    WHERE schema_name = 'market' AND table_name = 'spx_daily'
  `);
  if (tableCheck.getRows().length > 0) {
    const colCheck = await conn.runAndReadAll(`
      SELECT 1 FROM duckdb_columns()
      WHERE schema_name = 'market' AND table_name = 'spx_daily' AND column_name = 'High_Time'
    `);
    if (colCheck.getRows().length === 0) {
      // Old schema exists without new columns -- drop and recreate
      await conn.run(`DROP TABLE market.spx_daily`);
      await conn.run(`DELETE FROM market._sync_metadata WHERE file_name = 'spx_daily.csv'`);
    }
  }
} catch {
  // Non-fatal: CREATE TABLE IF NOT EXISTS will handle fresh state
}
```

2. Update the `CREATE TABLE IF NOT EXISTS market.spx_daily` to include 55 columns (existing 35 + 13 highlow + 7 VIX). Update the comment from "(35 fields)" to "(55 fields)". Add the 20 new columns AFTER `Prev_Return_Pct`:

**13 highlow columns:**
- `High_Time DOUBLE` -- Time of day high as decimal hours (e.g., 10.5 = 10:30 AM)
- `Low_Time DOUBLE` -- Time of day low as decimal hours
- `High_Before_Low INTEGER` -- 1 if high occurred before low, 0 if not
- `High_In_First_Hour INTEGER` -- 1 if high was 9:30-10:30 AM
- `Low_In_First_Hour INTEGER` -- 1 if low was 9:30-10:30 AM
- `High_In_Last_Hour INTEGER` -- 1 if high was 3:00-4:00 PM
- `Low_In_Last_Hour INTEGER` -- 1 if low was 3:00-4:00 PM
- `Reversal_Type INTEGER` -- 1=morning high/afternoon low, -1=opposite, 0=same session
- `High_Low_Spread DOUBLE` -- Hours between high and low
- `Early_Extreme INTEGER` -- 1 if either extreme in first 30 min
- `Late_Extreme INTEGER` -- 1 if either extreme in last 30 min
- `Intraday_High DOUBLE` -- Intraday high price
- `Intraday_Low DOUBLE` -- Intraday low price

**7 VIX columns:**
- `VIX_Gap_Pct DOUBLE` -- VIX overnight gap percentage
- `VIX9D_Open DOUBLE` -- 9-day VIX open value
- `VIX9D_Change_Pct DOUBLE` -- 9-day VIX open-to-close change percentage
- `VIX_High DOUBLE` -- VIX intraday high
- `VIX_Low DOUBLE` -- VIX intraday low
- `VIX3M_Open DOUBLE` -- 3-month VIX open value
- `VIX3M_Change_Pct DOUBLE` -- 3-month VIX open-to-close change percentage

3. Replace the `CREATE TABLE IF NOT EXISTS market.spx_highlow` block (lines 199-221) with:
```typescript
// Drop retired spx_highlow table (data now in spx_daily)
await conn.run(`DROP TABLE IF EXISTS market.spx_highlow`);
await conn.run(`DELETE FROM market._sync_metadata WHERE file_name = 'spx_highlow.csv'`);
```

**market-sync.ts:**

1. Remove the `"spx_highlow.csv"` entry from `MARKET_DATA_FILES` (line 30). The config should have 3 entries: spx_daily.csv, spx_15min.csv, vix_intraday.csv.

2. Update the file header comment (lines 7-11) to remove `spx_highlow.csv -> market.spx_highlow` and update to show 3 files.
  </action>
  <verify>
Run `npm run typecheck` from `packages/mcp-server/` to confirm no TypeScript errors. Grep for "spx_highlow" in schemas.ts and market-sync.ts -- should only appear in DROP/DELETE statements in schemas.ts and nowhere in market-sync.ts.
  </verify>
  <done>
schemas.ts defines 55-column spx_daily table with migration check, drops spx_highlow table and clears its sync metadata. market-sync.ts maps 3 CSV files (no spx_highlow.csv). TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reference cleanup + metadata + version bump</name>
  <files>
    packages/mcp-server/src/utils/schema-metadata.ts
    packages/mcp-server/src/tools/schema.ts
    packages/mcp-server/src/tools/sql.ts
    packages/mcp-server/src/tools/market-data.ts
    packages/mcp-server/package.json
  </files>
  <action>
**schema-metadata.ts:**

1. Add 13 highlow column descriptions to `spx_daily.columns` (after `Prev_Return_Pct`). Copy the descriptions from the existing `spx_highlow` section but keep hypothesis values matching the research table:
   - High_Time: `"Time of day high as decimal hours (e.g., 10.5 = 10:30 AM)"`, hypothesis: true
   - Low_Time: `"Time of day low as decimal hours (e.g., 14.25 = 2:15 PM)"`, hypothesis: true
   - High_Before_Low: `"Did high occur before low? (1=yes, 0=no)"`, hypothesis: true
   - High_In_First_Hour: `"Did high occur in first hour? (1=yes, 0=no)"`, hypothesis: true
   - Low_In_First_Hour: `"Did low occur in first hour? (1=yes, 0=no)"`, hypothesis: true
   - High_In_Last_Hour: `"Did high occur in last hour? (1=yes, 0=no)"`, hypothesis: true
   - Low_In_Last_Hour: `"Did low occur in last hour? (1=yes, 0=no)"`, hypothesis: true
   - Reversal_Type: `"Reversal pattern type (1=morning reversal up, -1=morning reversal down, 0=trend day)"`, hypothesis: true
   - High_Low_Spread: `"Time spread between high and low in hours"`, hypothesis: true
   - Early_Extreme: `"Was either extreme in first 30 min? (1=yes, 0=no)"`, hypothesis: true
   - Late_Extreme: `"Was either extreme in last 30 min? (1=yes, 0=no)"`, hypothesis: true
   - Intraday_High: `"Intraday high price (may differ from daily high on gap days)"`, hypothesis: false
   - Intraday_Low: `"Intraday low price (may differ from daily low on gap days)"`, hypothesis: false

2. Add 7 new VIX column descriptions to `spx_daily.columns`:
   - VIX_Gap_Pct: `"VIX overnight gap percentage ((VIX_Open - prior VIX_Close) / prior VIX_Close * 100)"`, hypothesis: true
   - VIX9D_Open: `"9-day VIX open value"`, hypothesis: false
   - VIX9D_Change_Pct: `"9-day VIX open-to-close change percentage"`, hypothesis: true
   - VIX_High: `"VIX intraday high"`, hypothesis: false
   - VIX_Low: `"VIX intraday low"`, hypothesis: false
   - VIX3M_Open: `"3-month VIX open value"`, hypothesis: false
   - VIX3M_Change_Pct: `"3-month VIX open-to-close change percentage"`, hypothesis: true

3. Update `spx_daily.description` to mention highlow timing data: `"Daily SPX data with technical indicators, VIX context, highlow timing, and regime classifications. JOIN with trades on date_opened = date."`

4. Update `spx_daily.keyColumns` to add `"High_Time"` and `"Reversal_Type"`.

5. Remove the entire `spx_highlow` table section from `SCHEMA_DESCRIPTIONS.market.tables` (lines 523-601).

6. Update the "Trades on reversal days" example query in `EXAMPLE_QUERIES.joins` (lines 849-858). Change from JOINing `market.spx_highlow h` to JOINing `market.spx_daily m`, and update the column references from `h.` to `m.`:
```typescript
{
  description: "Trades on reversal days (high/low timing)",
  sql: `SELECT
  t.date_opened, t.strategy, t.pl,
  m.Reversal_Type, m.High_Before_Low, m.High_In_First_Hour
FROM trades.trade_data t
JOIN market.spx_daily m ON t.date_opened = m.date
WHERE m.Reversal_Type != 0
  AND t.block_id = 'my-block'`,
},
```

**schema.ts:**

1. Remove `spx_highlow: "spx_highlow.csv"` from `MARKET_TABLE_FILES` constant (line 70).

2. Remove `"spx_highlow"` from the `purge_market_table` Zod enum (line 217). The enum should be: `z.enum(["spx_daily", "spx_15min", "vix_intraday"])`.

3. Update the `purge_market_table` description string (line 214) to list valid tables as: `"Valid tables: spx_daily, spx_15min, vix_intraday"`.

**sql.ts:**

1. Remove `"market.spx_highlow"` from the `AVAILABLE_TABLES` array (line 36).

2. Remove `"market.spx_highlow"` from the file header comment's "Available tables" list (line 18).

3. Remove `"market.spx_highlow, "` from the `run_sql` description string (line 239). The description should list: `"market.spx_daily, market.spx_15min, market.vix_intraday"`.

**market-data.ts:**

1. Update the file header comment only (lines 7-11). Remove the `spx_highlow.csv` line. Change the spx_daily.csv description from "(35 fields)" to "(55 fields)". Leave ALL code (HighLowTimingData, loadHighLowData, highlowDataCache) untouched -- Phase 53 will remove the CSV loading code entirely.

**package.json:**

1. Bump version from `"0.9.3"` to `"0.10.0"` (minor version bump per CLAUDE.md guidance -- user-visible schema change).
  </action>
  <verify>
Run `npm run typecheck` from the repo root to confirm no TypeScript errors across the entire project. Then verify cleanup is complete:
- `grep -r "spx_highlow" packages/mcp-server/src/` should only show: (a) DROP/DELETE in schemas.ts, (b) the loadHighLowData/HighLowTimingData code in market-data.ts that Phase 53 will remove
- `grep "0.10.0" packages/mcp-server/package.json` confirms version bump
  </verify>
  <done>
All spx_highlow references removed from schema-metadata.ts, schema.ts, sql.ts tool descriptions and enums. 20 new column descriptions added to spx_daily metadata. Example query updated to use spx_daily instead of spx_highlow. market-data.ts header comment updated. MCP server version bumped to 0.10.0. Only intentional spx_highlow references remain (schemas.ts DROP statement, market-data.ts CSV loading code deferred to Phase 53).
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full set of requirements:

1. **SCHEMA-01**: `grep "High_Time DOUBLE" packages/mcp-server/src/db/schemas.ts` returns a match in the spx_daily CREATE TABLE
2. **SCHEMA-02**: `grep "VIX_Gap_Pct DOUBLE" packages/mcp-server/src/db/schemas.ts` returns a match in the spx_daily CREATE TABLE
3. **SCHEMA-03**: `grep "DROP TABLE IF EXISTS market.spx_highlow" packages/mcp-server/src/db/schemas.ts` confirms retirement
4. **SCHEMA-04**: `grep "VIX_Gap_Pct" packages/mcp-server/src/utils/schema-metadata.ts` confirms description exists
5. **SYNC-01**: The `mergeMarketDataRows` function auto-discovers columns from DuckDB schema, so no sync code changes needed beyond removing the spx_highlow.csv mapping
6. **SYNC-02**: `grep "spx_highlow.csv" packages/mcp-server/src/sync/market-sync.ts` returns no matches
7. **SYNC-03**: Migration check in schemas.ts drops old spx_daily table and clears sync metadata, enabling clean re-import
8. **Version**: `grep '"version": "0.10.0"' packages/mcp-server/package.json` confirms bump
9. **Typecheck**: `npm run typecheck` passes with no errors
</verification>

<success_criteria>
- 55-column spx_daily schema defined in schemas.ts with migration check for existing databases
- spx_highlow table dropped on every connection init with sync metadata cleanup
- Sync config maps 3 files (no spx_highlow.csv)
- describe_database shows 20 new columns with descriptions, no spx_highlow table
- run_sql, purge_market_table, and all tool descriptions reference only 3 market tables
- market-data.ts header updated (code changes deferred to Phase 53)
- MCP server version 0.10.0
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/52-duckdb-schema-sync/52-01-SUMMARY.md`
</output>
