---
phase: 20-marginal-contribution
plan: 01
type: execute
---

<objective>
Implement marginal_contribution MCP tool to calculate how each strategy affects portfolio risk-adjusted returns.

Purpose: Answer "How much does adding/removing strategy X improve or hurt my Sharpe/Sortino ratio?" - critical for portfolio construction decisions.
Output: Working MCP tool with per-strategy marginal Sharpe/Sortino contributions, integration tests, CLI verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-drawdown-attribution/19-01-SUMMARY.md
@.planning/phases/18-stress-test/18-01-SUMMARY.md
@packages/mcp-server/src/tools/blocks.ts

**Tech stack available:** PortfolioStatsCalculator with Sharpe/Sortino calculations, filterByStrategy utility
**Established patterns:**
- JSON-first output with summary line + structured data
- Trade-based calculations only (no daily logs) per Phase 17 constraint
- Integration tests in tests/integration/, fixtures in tests/fixtures/
- CLI test mode verification per Phase 17.1 constraint

**Constraining decisions:**
- Phase 17: Trade-based calculations only for comparison tools
- Phase 17.1: CLI test verification required for all v2.1 MCP tools
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement marginal_contribution MCP tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add Tool 10: marginal_contribution after drawdown_attribution.

**Input schema:**
- blockId (required): Block folder name
- targetStrategy (optional): Calculate for specific strategy only. If omitted, calculates for all strategies.
- topN (optional, default 5): Number of top contributors to return when targetStrategy is omitted

**Algorithm:**
1. Load block and get all trades
2. Get unique strategies list
3. Calculate baseline portfolio metrics (Sharpe, Sortino) using ALL trades
4. For each strategy (or just targetStrategy if specified):
   a. Filter OUT that strategy's trades (portfolio WITHOUT this strategy)
   b. Calculate "without" portfolio metrics
   c. Marginal contribution = baseline metric - without metric
   d. Positive = strategy IMPROVES the ratio, Negative = strategy HURTS the ratio
5. Sort by largest positive contribution (most beneficial first)
6. Return topN results

**Key implementation details:**
- Use `PortfolioStatsCalculator.calculatePortfolioStats()` for ratio calculations
- Pass `undefined` for dailyLogs and `true` for isStrategyFiltered (trade-based only per Phase 17)
- Handle edge cases:
  - Single strategy portfolio: marginalSharpe = null, marginalSortino = null (can't calculate "without")
  - Ratios undefined for baseline: skip that metric in output
  - Strategy filter returns 0 trades when removed: that strategy IS the portfolio

**Output format (JSON-first pattern):**
Summary: "Marginal Contribution: {blockId} | Top: {strategy} (Sharpe +{delta}) | Worst: {strategy} (Sharpe {delta})"

Structured data:
```json
{
  "blockId": "...",
  "filters": { "targetStrategy": null, "topN": 5 },
  "baseline": {
    "totalStrategies": N,
    "totalTrades": N,
    "sharpeRatio": X.XX,
    "sortinoRatio": X.XX
  },
  "contributions": [
    {
      "strategy": "StrategyA",
      "trades": N,
      "marginalSharpe": +0.15,  // positive = improves portfolio
      "marginalSortino": +0.22,
      "interpretation": "improves" // or "hurts" or "negligible" (|delta| < 0.01)
    }
  ],
  "summary": {
    "mostBeneficial": { "strategy": "...", "sharpe": +X.XX },
    "leastBeneficial": { "strategy": "...", "sharpe": -X.XX }
  }
}
```
  </action>
  <verify>npm run build -w packages/mcp-server succeeds without errors</verify>
  <done>Tool registered with proper input schema and output format, builds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests</name>
  <files>packages/mcp-server/tests/integration/marginal-contribution.test.ts, packages/mcp-server/tests/fixtures/marginal-test-block/tradelog.csv</files>
  <action>
Create test fixture designed to demonstrate marginal contribution:

**Fixture design (tradelog.csv):**
Design 3 strategies with known characteristics:
1. "HighSharpe" - Consistent small wins (many trades, high win rate, low volatility) - should IMPROVE Sharpe
2. "Volatile" - Big wins and big losses (low win rate, high volatility) - should HURT Sharpe
3. "Neutral" - Average performance similar to portfolio - negligible marginal contribution

Use ~30 trades total (10 per strategy) with dates spread across 2024.

**Test cases:**
1. Basic functionality - all strategies calculated, baseline metrics returned
2. targetStrategy parameter - only returns that strategy's contribution
3. Verify "HighSharpe" has positive marginal Sharpe (removing it hurts portfolio)
4. Verify "Volatile" has negative marginal Sharpe (removing it helps portfolio)
5. Single strategy portfolio - returns null marginal values (can't calculate "without")
6. Non-existent strategy - error handling
7. Empty block - error handling
8. topN parameter - limits results correctly
9. Interpretation field correctness (improves/hurts/negligible based on thresholds)

**Document CLI test verification in test file header:**
```typescript
/**
 * CLI Test Mode Verification:
 * TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call marginal_contribution '{"blockId":"main-port-2026"}'
 *
 * Expected: Summary line + JSON with baseline metrics and per-strategy contributions
 */
```
  </action>
  <verify>npm test -w packages/mcp-server -- --testPathPattern=marginal-contribution passes all tests</verify>
  <done>All integration tests pass, fixture demonstrates expected marginal contribution behavior</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build -w packages/mcp-server` succeeds without errors
- [ ] `npm test -w packages/mcp-server` passes all tests (existing + new)
- [ ] `npm test -w packages/mcp-server -- --testPathPattern=marginal-contribution` passes
- [ ] Tool follows JSON-first output pattern with summary line
- [ ] Trade-based calculations only (no daily logs) per Phase 17 constraint
</verification>

<success_criteria>

- marginal_contribution tool implemented and registered
- Algorithm correctly calculates with/without metrics
- Integration tests cover core functionality and edge cases
- CLI test mode documented for real data verification
- No TypeScript errors, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-marginal-contribution/20-01-SUMMARY.md` using the summary template with frontmatter.

Include:
- Tech patterns: marginal-contribution-algorithm, with-without-comparison
- Key files created/modified
- Key decisions (thresholds for interpretation, handling edge cases)
- CLI test mode verification example
</output>
