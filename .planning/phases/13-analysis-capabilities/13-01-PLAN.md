---
phase: 13-analysis-capabilities
plan: 01
type: execute
subsystem: mcp-server
---

<objective>
Add Report Builder MCP tools enabling Claude to run custom filtered queries, discover available fields, and aggregate trade data by any dimension.

Purpose: Complete the MCP server's analysis capabilities by exposing the Report Builder's powerful filtering and aggregation system, allowing Claude to autonomously explore trading data patterns.
Output: 4 new MCP tools (list_available_fields, run_filtered_query, get_field_statistics, aggregate_by_field) bringing total to 18 tools.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (Phase 12 established MCP patterns)
@.planning/phases/12-core-integration-layer/12-03-SUMMARY.md

# Key source files for Report Builder integration
@lib/models/report-config.ts
@lib/calculations/flexible-filter.ts
@lib/calculations/table-aggregation.ts
@lib/models/enriched-trade.ts

# Existing MCP server structure
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/utils/output-formatter.ts
@packages/mcp-server/src/utils/block-loader.ts
@packages/mcp-server/src/tools/blocks.ts

**Tech stack available:** MCP SDK with McpServer API, zod@4 for schemas, tsup bundler
**Established patterns:**
- `createToolOutput(summary, data)` for JSON-first output
- `registerXXXTools(server, baseDir)` for modular tool registration
- `filterByStrategy()`, `filterByDateRange()` helpers in block-loader
- Inline calculations when lib dependencies have browser-only imports

**Constraining decisions:**
- Phase 12-02: JSON-first output pattern (brief text + structured JSON)
- Phase 12-01: ESM imports require .js extension in TypeScript
- Phase 11-02: Folder-based block structure with tradelog.csv, dailylog.csv, reportinglog.csv
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Report Builder MCP tools</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Create new file with 4 MCP tools for Report Builder integration:

**1. list_available_fields**
- Parameters: blockId (required)
- Returns: All available fields grouped by category (market, returns, risk, trade, timing)
- Include field metadata: name, label, unit, description
- Also return custom fields discovered in the block's trades
- Use REPORT_FIELDS from @lib/models/report-config.ts as base, enrich with custom field discovery

**2. run_filtered_query**
- Parameters: blockId (required), conditions[] (array of {field, operator, value, value2?}), logic ('and'|'or'), strategy?, dateRange?
- Apply filters using pattern from flexible-filter.ts (implement inline - browser File API dependencies)
- Return: matchCount, totalCount, matchPercent, plus aggregated statistics for filtered trades
- Statistics: totalPl, avgPl, winRate, avgRom, tradeCount
- JSON output includes both summary stats and the filter conditions applied

**3. get_field_statistics**
- Parameters: blockId (required), field (required), strategy?, dateRange?
- Return: min, max, avg, median, stdDev, count, percentiles (10th, 25th, 50th, 75th, 90th)
- Also return value distribution as histogram buckets (10 auto-sized buckets)
- Useful for Claude to understand data ranges before creating filters

**4. aggregate_by_field**
- Parameters: blockId (required), groupByField (required), bucketEdges[] (required), metrics[] (optional, default ['count', 'winRate', 'pl:avg']), strategy?, dateRange?
- Bucket trades by groupByField using provided edges (like table-aggregation.ts)
- Return: Array of {label, values: {metric: value}} for each bucket
- Enables threshold analysis: "How do results differ when VIX > 25 vs < 15?"

**Implementation notes:**
- Follow established tool registration pattern: export function registerReportTools(server, baseDir)
- Use zod schemas with .describe() for all parameters
- Implement filter logic inline (can't import applyFilters due to browser dependencies)
- Use createToolOutput() for JSON-first responses
- Import REPORT_FIELDS, FilterOperator types from @lib/models/report-config (these are type-only, safe to import)
- Load trades via loadBlock() from block-loader.ts
- Handle missing blocks with isError: true response
  </action>
  <verify>TypeScript compiles: `pnpm --filter tradeblocks-mcp build` succeeds</verify>
  <done>4 tools implemented with zod schemas, inline filter logic, JSON-first output</done>
</task>

<task type="auto">
  <name>Task 2: Register tools and verify integration</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
1. Import registerReportTools from "./tools/reports.js" (note .js extension for ESM)
2. Call registerReportTools(server, baseDir) after existing tool registrations
3. Verify the MCP server builds and lints cleanly

Update order should be:
- registerBlockTools (existing - 6 tools)
- registerAnalysisTools (existing - 5 tools)
- registerPerformanceTools (existing - 3 tools)
- registerReportTools (new - 4 tools)

Total: 18 MCP tools
  </action>
  <verify>
- `pnpm --filter tradeblocks-mcp build` succeeds
- `pnpm run lint` passes
- Tool count in index.ts comments updated to reflect 18 total tools
  </verify>
  <done>Report tools registered, build passes, lint clean, 18 total MCP tools</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter tradeblocks-mcp build` succeeds without errors
- [ ] `pnpm run lint` passes
- [ ] All 4 report tools registered (list_available_fields, run_filtered_query, get_field_statistics, aggregate_by_field)
- [ ] Tools use JSON-first output pattern (createToolOutput)
- [ ] Filter operators match FilterOperator type: eq, neq, gt, gte, lt, lte, between
- [ ] Error handling for invalid blockId returns isError: true
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors or lint warnings
- 4 new Report Builder MCP tools operational
- Total MCP tool count: 18 (6 core + 5 analysis + 3 performance + 4 report)
</success_criteria>

<output>
After completion, create `.planning/phases/13-analysis-capabilities/13-01-SUMMARY.md` using summary template.

Include in summary:
- Tool capabilities for each of the 4 new tools
- Any implementation decisions (e.g., inline vs imported code)
- Deviations from plan if any
- Phase 14 readiness assessment
</output>
