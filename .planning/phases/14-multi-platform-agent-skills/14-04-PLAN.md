---
phase: 14-multi-platform-agent-skills
plan: "04"
type: execute
domain: agent-skills
---

<objective>
Prepare agent skills for npm packaging and programmatic installation.

Purpose: Enable skills to be bundled with the MCP server npm package and installed via CLI command.
Output: Portable skill structure, package.json updates, and skill installer module for Phase 15.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-multi-platform-agent-skills/14-RESEARCH.md
@.planning/phases/14-multi-platform-agent-skills/14-01-SUMMARY.md
@.planning/phases/14-multi-platform-agent-skills/14-02-SUMMARY.md
@.planning/phases/14-multi-platform-agent-skills/14-03-SUMMARY.md
@packages/mcp-server/package.json

**Prior work:**
- 14-01 through 14-03: Created 6 skills with documentation

**Packaging goal:**
When user runs `npx tradeblocks-mcp` (or similar), they should be able to:
1. Start the MCP server
2. Install skills for their preferred platform (claude/codex/gemini)

**npm packaging requirements:**
- Skills must be included in package via `files` array
- No absolute paths or symlinks in published package
- Skill installer needs to know where skills are in the installed package
- Cross-platform path handling (macOS, Linux, Windows)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ensure skill portability</name>
  <files>packages/agent-skills/</files>
  <action>
Audit all skill files for npm portability:

1. Check all SKILL.md files for absolute paths:
   - grep -r "~/" or "/Users/" or "/home/" in packages/agent-skills/
   - Replace any absolute paths with relative or placeholder text
   - MCP tool names should be referenced by name, not path

2. Check reference files for portability:
   - No local file references that won't exist in npm package
   - Documentation links should be relative within skill or to external URLs

3. Ensure consistent structure:
   - Each skill: SKILL.md at root, references/ subdirectory
   - No platform-specific files (.DS_Store, etc.)
   - Add .gitignore to packages/agent-skills/ if needed

4. Create packages/agent-skills/index.json manifest:
   ```json
   {
     "version": "1.0.0",
     "skills": [
       "tradeblocks-health-check",
       "tradeblocks-wfa",
       "tradeblocks-risk",
       "tradeblocks-compare",
       "tradeblocks-portfolio",
       "tradeblocks-optimize"
     ],
     "platforms": {
       "claude": "~/.claude/skills",
       "codex": "~/.codex/skills",
       "gemini": "~/.gemini/skills"
     }
   }
   ```
  </action>
  <verify>grep -r "/Users\|/home\|~/" packages/agent-skills/*.md returns no results (except install docs which explain paths)</verify>
  <done>All skills are portable with no hardcoded paths; index.json manifest created</done>
</task>

<task type="auto">
  <name>Task 2: Update MCP server package.json for skill bundling</name>
  <files>packages/mcp-server/package.json</files>
  <action>
Update package.json to include agent-skills in npm package:

1. Add agent-skills to files array:
   ```json
   "files": [
     "dist",
     "agent-skills"
   ]
   ```

2. Add bin entry for skill installer (will be implemented in Phase 15):
   ```json
   "bin": {
     "tradeblocks-mcp": "./dist/cli.js"
   }
   ```
   (Note: cli.js doesn't exist yet - Phase 15 will create it)

3. Consider: Should skills be a separate package?
   - For now, bundle with MCP server for simplicity
   - Can split later if skills grow large

4. Ensure agent-skills/ will be copied during build:
   - Skills are static files (markdown), no build needed
   - Just need to be included in package
  </action>
  <verify>cat packages/mcp-server/package.json | grep -A5 '"files"' shows agent-skills included</verify>
  <done>package.json updated with files array including agent-skills; bin entry added for future CLI</done>
</task>

<task type="auto">
  <name>Task 3: Create skill installer module</name>
  <files>packages/mcp-server/src/skill-installer.ts</files>
  <action>
Create a module that Phase 15 CLI can use to install skills:

```typescript
// packages/mcp-server/src/skill-installer.ts

import { promises as fs } from 'fs'
import path from 'path'
import os from 'os'

export type Platform = 'claude' | 'codex' | 'gemini'

const PLATFORM_PATHS: Record<Platform, string> = {
  claude: '.claude/skills',
  codex: '.codex/skills',
  gemini: '.gemini/skills'
}

export function getSkillsSourcePath(): string {
  // When running from npm package, skills are in ../agent-skills relative to dist/
  // When running from source, skills are in ../agent-skills relative to src/
  const distPath = path.join(__dirname, '..', 'agent-skills')
  const srcPath = path.join(__dirname, '..', '..', 'agent-skills')

  // Check which exists
  return fs.access(distPath).then(() => distPath).catch(() => srcPath)
}

export function getTargetPath(platform: Platform): string {
  return path.join(os.homedir(), PLATFORM_PATHS[platform])
}

export async function listAvailableSkills(): Promise<string[]> {
  const sourcePath = await getSkillsSourcePath()
  const indexPath = path.join(sourcePath, 'index.json')
  const index = JSON.parse(await fs.readFile(indexPath, 'utf-8'))
  return index.skills
}

export async function installSkills(platform: Platform): Promise<{
  installed: string[]
  skipped: string[]
  errors: string[]
}> {
  const sourcePath = await getSkillsSourcePath()
  const targetPath = getTargetPath(platform)
  const skills = await listAvailableSkills()

  const result = { installed: [], skipped: [], errors: [] }

  // Ensure target directory exists
  await fs.mkdir(targetPath, { recursive: true })

  for (const skill of skills) {
    const skillSource = path.join(sourcePath, skill)
    const skillTarget = path.join(targetPath, skill)

    try {
      // Check if already exists
      const exists = await fs.access(skillTarget).then(() => true).catch(() => false)
      if (exists) {
        result.skipped.push(skill)
        continue
      }

      // Copy skill directory (not symlink - more portable)
      await copyDirectory(skillSource, skillTarget)
      result.installed.push(skill)
    } catch (err) {
      result.errors.push(`${skill}: ${err.message}`)
    }
  }

  return result
}

async function copyDirectory(src: string, dest: string): Promise<void> {
  await fs.mkdir(dest, { recursive: true })
  const entries = await fs.readdir(src, { withFileTypes: true })

  for (const entry of entries) {
    const srcPath = path.join(src, entry.name)
    const destPath = path.join(dest, entry.name)

    if (entry.isDirectory()) {
      await copyDirectory(srcPath, destPath)
    } else {
      await fs.copyFile(srcPath, destPath)
    }
  }
}

export async function uninstallSkills(platform: Platform): Promise<string[]> {
  const targetPath = getTargetPath(platform)
  const skills = await listAvailableSkills()
  const removed: string[] = []

  for (const skill of skills) {
    const skillPath = path.join(targetPath, skill)
    try {
      await fs.rm(skillPath, { recursive: true })
      removed.push(skill)
    } catch {
      // Ignore - skill may not be installed
    }
  }

  return removed
}
```

Export from package index for Phase 15 CLI to use.
  </action>
  <verify>pnpm --filter tradeblocks-mcp build succeeds</verify>
  <done>skill-installer.ts created with install/uninstall/list functions; builds without errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No hardcoded absolute paths in skill files (except documentation)
- [ ] packages/agent-skills/index.json manifest exists
- [ ] packages/mcp-server/package.json includes agent-skills in files array
- [ ] packages/mcp-server/src/skill-installer.ts exists and builds
- [ ] MCP server still builds: pnpm --filter tradeblocks-mcp build
</verification>

<success_criteria>
- Skills are portable (no absolute paths in SKILL.md files)
- Skills will be included in npm package
- skill-installer.ts provides API for Phase 15 CLI
- MCP server builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-platform-agent-skills/14-04-SUMMARY.md`:

# Phase 14-04: npm Packaging Preparation Summary

**[Brief description of what was created]**

## Accomplishments
- [Portability audit, package.json updates, installer module]

## Files Created/Modified
- packages/agent-skills/index.json
- packages/mcp-server/package.json (files array)
- packages/mcp-server/src/skill-installer.ts

## Decisions Made
- [Copy vs symlink, bundle vs separate package]

## Issues Encountered
[Problems and resolutions]

## Phase 14 Complete
All skills created, documented, and prepared for npm packaging. Phase 15 will create the CLI that uses skill-installer.ts.
</output>
