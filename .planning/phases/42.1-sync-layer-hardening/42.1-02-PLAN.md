---
phase: 42.1-sync-layer-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/blocks/index.ts
  - packages/mcp-server/src/tools/blocks/core.ts
  - packages/mcp-server/src/tools/blocks/comparison.ts
  - packages/mcp-server/src/tools/blocks/analysis.ts
  - packages/mcp-server/src/tools/blocks/similarity.ts
  - packages/mcp-server/src/tools/blocks/health.ts
  - packages/mcp-server/src/tools/reports/index.ts
  - packages/mcp-server/src/tools/reports/fields.ts
  - packages/mcp-server/src/tools/reports/queries.ts
  - packages/mcp-server/src/tools/reports/predictive.ts
  - packages/mcp-server/src/tools/reports/slippage.ts
  - packages/mcp-server/src/tools/shared/filters.ts
  - packages/mcp-server/src/tools/blocks.ts
  - packages/mcp-server/src/tools/reports.ts
  - packages/mcp-server/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "blocks.ts is split into modules, each under 800 lines"
    - "reports.ts is split into modules, each under 800 lines"
    - "All existing MCP tools continue to work identically"
    - "npm run build succeeds with no TypeScript errors"
  artifacts:
    - path: "packages/mcp-server/src/tools/blocks/index.ts"
      provides: "Barrel export for blocks module"
      exports: ["registerBlockTools"]
    - path: "packages/mcp-server/src/tools/blocks/core.ts"
      provides: "Core block tools: list_blocks, get_block_info, get_statistics, get_reporting_log_stats"
      max_lines: 800
    - path: "packages/mcp-server/src/tools/blocks/comparison.ts"
      provides: "Comparison tools: get_strategy_comparison, compare_blocks, block_diff"
      max_lines: 800
    - path: "packages/mcp-server/src/tools/blocks/analysis.ts"
      provides: "Analysis tools: stress_test, drawdown_attribution, marginal_contribution"
      max_lines: 800
    - path: "packages/mcp-server/src/tools/blocks/similarity.ts"
      provides: "Similarity tools: strategy_similarity, what_if_scaling"
      max_lines: 800
    - path: "packages/mcp-server/src/tools/blocks/health.ts"
      provides: "Health tool: portfolio_health_check"
      max_lines: 800
    - path: "packages/mcp-server/src/tools/reports/index.ts"
      provides: "Barrel export for reports module"
      exports: ["registerReportTools"]
    - path: "packages/mcp-server/src/tools/shared/filters.ts"
      provides: "Shared filter utilities"
      exports: ["filterByStrategy", "filterByDateRange"]
  key_links:
    - from: "packages/mcp-server/src/tools/index.ts"
      to: "packages/mcp-server/src/tools/blocks/index.ts"
      via: "import { registerBlockTools }"
      pattern: "from.*blocks"
    - from: "packages/mcp-server/src/tools/index.ts"
      to: "packages/mcp-server/src/tools/reports/index.ts"
      via: "import { registerReportTools }"
      pattern: "from.*reports"
---

<objective>
Split `blocks.ts` (3,374 lines, 14 tools) and `reports.ts` (3,338 lines, 9 tools) into logical modules under 800 lines each.

Purpose: Success criteria 3 and 4 require these oversized files to be split for maintainability. This refactor preserves all functionality while enabling the middleware pattern in Plan 03.

Output: `blocks/` and `reports/` directories with focused module files, plus `shared/filters.ts` for deduplicated utilities.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42.1-sync-layer-hardening/42.1-RESEARCH.md

# Files to split
@packages/mcp-server/src/tools/blocks.ts
@packages/mcp-server/src/tools/reports.ts

# Tool registration entry point
@packages/mcp-server/src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared utilities and split blocks.ts</name>
  <files>
    packages/mcp-server/src/tools/shared/filters.ts
    packages/mcp-server/src/tools/blocks/index.ts
    packages/mcp-server/src/tools/blocks/core.ts
    packages/mcp-server/src/tools/blocks/comparison.ts
    packages/mcp-server/src/tools/blocks/analysis.ts
    packages/mcp-server/src/tools/blocks/similarity.ts
    packages/mcp-server/src/tools/blocks/health.ts
    packages/mcp-server/src/tools/blocks.ts
  </files>
  <action>
**Step 1: Create shared filters module**
Create `packages/mcp-server/src/tools/shared/filters.ts`:
- Move `filterByStrategy()` and `filterByDateRange()` from blocks.ts
- Export both functions
- These are duplicated in blocks.ts and reports.ts, so consolidate to one location

**Step 2: Create blocks/ directory structure**
Create `packages/mcp-server/src/tools/blocks/` directory with these files:

**blocks/core.ts** (~650 lines):
- Import shared deps (zod, McpServer, PortfolioStatsCalculator, sync functions, etc.)
- Import `filterByStrategy`, `filterByDateRange` from `../shared/filters.js`
- Keep `calculatePeakExposure()` helper (used by multiple tools in this file)
- Export `registerCoreBlockTools(server, baseDir)` containing:
  - `list_blocks` tool
  - `get_block_info` tool (was get_statistics conceptually)
  - `get_statistics` tool
  - `get_reporting_log_stats` tool

**blocks/comparison.ts** (~550 lines):
- Export `registerComparisonBlockTools(server, baseDir)` containing:
  - `get_strategy_comparison` tool
  - `compare_blocks` tool
  - `block_diff` tool

**blocks/analysis.ts** (~750 lines):
- Export `registerAnalysisBlockTools(server, baseDir)` containing:
  - `stress_test` tool
  - `drawdown_attribution` tool
  - `marginal_contribution` tool

**blocks/similarity.ts** (~700 lines):
- Export `registerSimilarityBlockTools(server, baseDir)` containing:
  - `strategy_similarity` tool
  - `what_if_scaling` tool

**blocks/health.ts** (~700 lines):
- Export `registerHealthBlockTools(server, baseDir)` containing:
  - `portfolio_health_check` tool

**blocks/index.ts** (barrel export):
```typescript
import type { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { registerCoreBlockTools } from "./core.js";
import { registerComparisonBlockTools } from "./comparison.js";
import { registerAnalysisBlockTools } from "./analysis.js";
import { registerSimilarityBlockTools } from "./similarity.js";
import { registerHealthBlockTools } from "./health.js";

export function registerBlockTools(server: McpServer, baseDir: string): void {
  registerCoreBlockTools(server, baseDir);
  registerComparisonBlockTools(server, baseDir);
  registerAnalysisBlockTools(server, baseDir);
  registerSimilarityBlockTools(server, baseDir);
  registerHealthBlockTools(server, baseDir);
}
```

**Step 3: Update original blocks.ts**
Replace contents of `packages/mcp-server/src/tools/blocks.ts` with:
```typescript
// Re-export from new module structure for backwards compatibility
export { registerBlockTools } from "./blocks/index.js";
```

**Important:** Preserve ALL existing tool logic exactly. This is a structural refactor, not a behavior change. Each tool's implementation should be copy-pasted, only updating imports.
  </action>
  <verify>
Run:
```bash
cd packages/mcp-server
npm run build
npm run typecheck
```
No TypeScript errors. Build succeeds.
  </verify>
  <done>
- `shared/filters.ts` created with `filterByStrategy`, `filterByDateRange`
- `blocks/` directory created with 6 files (index + 5 modules)
- Each module file is under 800 lines
- Original `blocks.ts` re-exports from new structure
- Build passes with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Split reports.ts and update tool index</name>
  <files>
    packages/mcp-server/src/tools/reports/index.ts
    packages/mcp-server/src/tools/reports/fields.ts
    packages/mcp-server/src/tools/reports/queries.ts
    packages/mcp-server/src/tools/reports/predictive.ts
    packages/mcp-server/src/tools/reports/slippage.ts
    packages/mcp-server/src/tools/reports.ts
    packages/mcp-server/src/tools/index.ts
  </files>
  <action>
**Step 1: Create reports/ directory structure**
Create `packages/mcp-server/src/tools/reports/` directory:

**reports/fields.ts** (~400 lines):
- Import `filterByStrategy`, `filterByDateRange` from `../shared/filters.js`
- Export `registerFieldTools(server, baseDir)` containing:
  - `list_available_fields` tool
  - `get_field_statistics` tool

**reports/queries.ts** (~500 lines):
- Export `registerQueryTools(server, baseDir)` containing:
  - `run_filtered_query` tool
  - `aggregate_by_field` tool

**reports/predictive.ts** (~600 lines):
- Export `registerPredictiveTools(server, baseDir)` containing:
  - `find_predictive_fields` tool
  - `filter_curve` tool

**reports/slippage.ts** (~800 lines):
- Export `registerSlippageTools(server, baseDir)` containing:
  - `analyze_discrepancies` tool
  - `suggest_strategy_matches` tool
  - `slippage_trends` tool

**reports/index.ts** (barrel export):
```typescript
import type { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { registerFieldTools } from "./fields.js";
import { registerQueryTools } from "./queries.js";
import { registerPredictiveTools } from "./predictive.js";
import { registerSlippageTools } from "./slippage.js";

export function registerReportTools(server: McpServer, baseDir: string): void {
  registerFieldTools(server, baseDir);
  registerQueryTools(server, baseDir);
  registerPredictiveTools(server, baseDir);
  registerSlippageTools(server, baseDir);
}
```

**Step 2: Update original reports.ts**
Replace contents with re-export:
```typescript
// Re-export from new module structure for backwards compatibility
export { registerReportTools } from "./reports/index.js";
```

**Step 3: Verify tools/index.ts**
The main `tools/index.ts` should already import from `./blocks.js` and `./reports.js`. Since we're using re-exports, no changes needed unless it directly imports internal functions. Verify and update if needed.

**Important:** Remove the duplicated `filterByStrategy` and `filterByDateRange` from the split files - they should import from `../shared/filters.js` instead.
  </action>
  <verify>
Run:
```bash
cd packages/mcp-server
npm run build
npm run typecheck
npm test
```
Build passes. All existing tests pass (proves tools still work).
  </verify>
  <done>
- `reports/` directory created with 5 files (index + 4 modules)
- Each module file is under 800 lines
- Original `reports.ts` re-exports from new structure
- `tools/index.ts` works without modification
- All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify line counts and run full test suite</name>
  <files>
    packages/mcp-server/src/tools/blocks/core.ts
    packages/mcp-server/src/tools/blocks/comparison.ts
    packages/mcp-server/src/tools/blocks/analysis.ts
    packages/mcp-server/src/tools/blocks/similarity.ts
    packages/mcp-server/src/tools/blocks/health.ts
    packages/mcp-server/src/tools/reports/fields.ts
    packages/mcp-server/src/tools/reports/queries.ts
    packages/mcp-server/src/tools/reports/predictive.ts
    packages/mcp-server/src/tools/reports/slippage.ts
  </files>
  <action>
**Step 1: Verify all split files are under 800 lines**
Run `wc -l` on each new file. If any exceed 800 lines, further split by moving additional tools or helpers.

**Step 2: Run full test suite**
Run `npm test` in the mcp-server package to verify all tools work correctly after the split.

**Step 3: Run typecheck**
Run `npm run typecheck` to ensure no type errors were introduced.

**Step 4: Test MCP server startup**
If a manual test is feasible, verify the server starts without errors. Otherwise, the existing integration tests provide sufficient coverage.

**If any file exceeds 800 lines:**
- Identify the largest tool or helper in that file
- Create a new sub-module (e.g., `blocks/stress-test.ts`) containing just that tool
- Update the parent file to import and re-register
  </action>
  <verify>
Run:
```bash
cd packages/mcp-server
wc -l src/tools/blocks/*.ts src/tools/reports/*.ts src/tools/shared/*.ts
npm run build
npm test
```
All files under 800 lines. Build passes. All tests pass.
  </verify>
  <done>
- All blocks/* files verified under 800 lines
- All reports/* files verified under 800 lines
- Full test suite passes
- TypeScript compilation succeeds
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/davidromeo/Code/tradeblocks/packages/mcp-server

# Verify line counts (all should be < 800)
wc -l src/tools/blocks/*.ts src/tools/reports/*.ts src/tools/shared/*.ts

# Full build and test
npm run build
npm run typecheck
npm test
```

All split files under 800 lines. Build succeeds. All tests pass.
</verification>

<success_criteria>
1. `blocks/` directory exists with index.ts, core.ts, comparison.ts, analysis.ts, similarity.ts, health.ts
2. `reports/` directory exists with index.ts, fields.ts, queries.ts, predictive.ts, slippage.ts
3. `shared/filters.ts` exists with filterByStrategy, filterByDateRange
4. Every file in blocks/* and reports/* is under 800 lines
5. `npm run build` succeeds
6. `npm test` passes all existing tests (no regressions)
7. Original blocks.ts and reports.ts are thin re-export wrappers
</success_criteria>

<output>
After completion, create `.planning/phases/42.1-sync-layer-hardening/42.1-02-SUMMARY.md`
</output>
