---
phase: 42.1-sync-layer-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/tests/integration/sync-layer.test.ts
  - packages/mcp-server/tests/fixtures/sync-test-block/tradelog.csv
autonomous: true

must_haves:
  truths:
    - "Tests verify sync detects new blocks and imports them to DuckDB"
    - "Tests verify sync detects changed blocks (hash mismatch) and re-syncs"
    - "Tests verify sync detects deleted blocks and removes data from DuckDB"
    - "Tests verify transaction rollback on failure leaves no partial state"
  artifacts:
    - path: "packages/mcp-server/tests/integration/sync-layer.test.ts"
      provides: "Integration tests for sync layer change detection and rollback"
      min_lines: 200
    - path: "packages/mcp-server/tests/fixtures/sync-test-block/tradelog.csv"
      provides: "Test fixture for sync integration tests"
  key_links:
    - from: "packages/mcp-server/tests/integration/sync-layer.test.ts"
      to: "packages/mcp-server/src/sync/index.ts"
      via: "imports syncAllBlocks, syncBlock"
      pattern: "import.*from.*sync"
---

<objective>
Create integration tests for the sync layer that verify change detection (new, changed, deleted blocks) and transaction rollback behavior.

Purpose: Success criteria 1 and 2 require tests proving sync correctly detects changes and rolls back on failure. These tests protect against regressions as we refactor in subsequent plans.

Output: `sync-layer.test.ts` with comprehensive tests for the sync layer.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42.1-sync-layer-hardening/42.1-RESEARCH.md

# Sync layer implementation
@packages/mcp-server/src/sync/index.ts
@packages/mcp-server/src/sync/block-sync.ts
@packages/mcp-server/src/sync/metadata.ts
@packages/mcp-server/src/sync/hasher.ts

# Existing test patterns
@packages/mcp-server/tests/integration/block-diff.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test fixture and sync layer integration tests</name>
  <files>
    packages/mcp-server/tests/fixtures/sync-test-block/tradelog.csv
    packages/mcp-server/tests/integration/sync-layer.test.ts
  </files>
  <action>
1. Create a minimal test fixture at `packages/mcp-server/tests/fixtures/sync-test-block/tradelog.csv` with 2-3 valid trade rows following the existing fixture format.

2. Create `packages/mcp-server/tests/integration/sync-layer.test.ts` with tests for:

**Test Group 1: Change Detection**
- `detects new blocks correctly`: Create temp dir, copy fixture, call `syncAllBlocks()`, verify `blocksSynced === 1`, query DuckDB to confirm trades exist
- `detects changed blocks correctly`: Sync once, modify the CSV (append a trade), sync again, verify block was re-synced (not unchanged)
- `detects deleted blocks correctly`: Sync once, delete the block folder, sync again, verify `blocksDeleted === 1`, query DuckDB to confirm trades removed
- `marks unchanged blocks as unchanged`: Sync twice without modifications, verify second sync has `blocksUnchanged === 1`

**Test Group 2: Transaction Rollback**
- `rolls back on failure - no partial state`: Create a block with valid CSV, manually corrupt the sync metadata to simulate mid-sync state, call sync and force an error (e.g., malformed CSV), verify no orphaned data in DuckDB (either fully synced or fully absent)

**Test Setup/Teardown:**
- Use `beforeEach` to create temp directory via `fs.mkdtemp(path.join(os.tmpdir(), 'sync-test-'))`
- Use `afterEach` to clean up temp directory via `fs.rm(testDir, { recursive: true, force: true })`
- Use `afterAll` to close DuckDB connection via `closeConnection()` import

**Pattern to follow:**
```typescript
import * as path from 'path';
import * as fs from 'fs/promises';
import { tmpdir } from 'os';
import { syncAllBlocks, syncBlock } from '../../dist/sync/index.js';
import { getConnection, closeConnection } from '../../dist/db/connection.js';
```

Import from `../../dist/` since tests run against built output (see existing test patterns).
  </action>
  <verify>
Run: `cd packages/mcp-server && npm run build && npm test -- tests/integration/sync-layer.test.ts`
All tests pass.
  </verify>
  <done>
- 4+ tests covering new/changed/deleted/unchanged block detection
- 1+ test covering transaction rollback behavior
- All tests pass independently and when run together
- Tests use isolated temp directories (no shared state)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rollback edge case tests</name>
  <files>
    packages/mcp-server/tests/integration/sync-layer.test.ts
  </files>
  <action>
Add additional rollback and edge case tests to the existing test file:

**Test Group 3: Edge Cases**
- `handles empty block folder gracefully`: Create folder with no tradelog.csv, sync, verify error is recorded but doesn't crash
- `handles malformed CSV gracefully`: Create block with invalid CSV content (missing required columns), sync, verify error captured and no partial data
- `syncBlock returns deleted for removed folder`: Sync a block, delete its folder, call `syncBlock(blockId, baseDir)`, verify `status === 'deleted'`

**Test Group 4: Market Data Sync (if time permits)**
- `syncs market data files`: Create temp `_marketdata/` folder with small test CSV, call `syncMarketData()`, verify rows inserted

Ensure all tests continue to use isolated fixtures and clean up properly.
  </action>
  <verify>
Run: `cd packages/mcp-server && npm test -- tests/integration/sync-layer.test.ts`
All tests (7+) pass.
  </verify>
  <done>
- Edge case tests added for empty folders, malformed CSV, per-block sync
- All tests pass
- No test pollution between runs
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/davidromeo/Code/tradeblocks/packages/mcp-server
npm run build
npm test -- tests/integration/sync-layer.test.ts --verbose
```

All sync layer tests pass. Running tests multiple times produces consistent results (no flakiness from shared state).
</verification>

<success_criteria>
1. `sync-layer.test.ts` exists with 7+ integration tests
2. Tests cover: new block detection, changed block detection, deleted block detection, unchanged block detection
3. Tests cover: transaction rollback on failure
4. Tests cover: edge cases (empty folder, malformed CSV, per-block sync)
5. All tests pass when run via `npm test`
6. Tests are isolated (each test has its own temp directory)
</success_criteria>

<output>
After completion, create `.planning/phases/42.1-sync-layer-hardening/42.1-01-SUMMARY.md`
</output>
