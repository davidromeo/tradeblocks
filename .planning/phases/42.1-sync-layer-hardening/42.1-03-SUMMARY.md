---
phase: 42.1-sync-layer-hardening
plan: 03
subsystem: mcp
tags: [middleware, higher-order-functions, typescript, duckdb, sync]

# Dependency graph
requires:
  - phase: 42.1-02
    provides: Split tool files (blocks/* and reports/* modules)
  - phase: 42
    provides: Sync layer with syncBlock, syncAllBlocks, syncMarketData

provides:
  - withSyncedBlock middleware for single-block tools
  - withSyncedBlocks middleware for multi-block comparison tools
  - withFullSync middleware for list_blocks
  - Consistent deleted block error handling via middleware

affects: [future-mcp-tools, sync-performance]

# Tech tracking
tech-stack:
  added: []
  patterns: [higher-order-function-middleware, sync-before-query]

key-files:
  created:
    - packages/mcp-server/src/tools/middleware/sync-middleware.ts
  modified:
    - packages/mcp-server/src/tools/blocks/core.ts
    - packages/mcp-server/src/tools/blocks/comparison.ts
    - packages/mcp-server/src/tools/blocks/analysis.ts
    - packages/mcp-server/src/tools/blocks/similarity.ts
    - packages/mcp-server/src/tools/blocks/health.ts
    - packages/mcp-server/src/tools/reports/fields.ts
    - packages/mcp-server/src/tools/reports/queries.ts
    - packages/mcp-server/src/tools/reports/predictive.ts
    - packages/mcp-server/src/tools/reports/discrepancies.ts
    - packages/mcp-server/src/tools/reports/slippage-trends.ts
    - packages/mcp-server/src/tools/reports/strategy-matches.ts

key-decisions:
  - "Single middleware module exports three functions for different tool patterns"
  - "Index signature added to ToolError for MCP SDK compatibility"
  - "as const assertions used for literal types in error responses"

patterns-established:
  - "withSyncedBlock: wrap single-block tools for automatic sync-before-query"
  - "withSyncedBlocks: wrap multi-block tools, sync all blocks before handler"
  - "withFullSync: wrap list_blocks for full sync of all blocks and market data"

# Metrics
duration: 35min
completed: 2026-02-02
---

# Phase 42.1 Plan 03: Sync Middleware Summary

**Higher-order middleware functions that wrap MCP tool handlers with automatic sync-before-query behavior, eliminating ~15 lines of boilerplate per tool**

## Performance

- **Duration:** 35 min
- **Started:** 2026-02-02T10:00:00Z
- **Completed:** 2026-02-02T10:35:00Z
- **Tasks:** 3
- **Files modified:** 12

## Accomplishments

- Created sync middleware module with three patterns: withSyncedBlock, withSyncedBlocks, withFullSync
- Applied middleware to all 14 blocks/* tools
- Applied middleware to all 9 reports/* tools
- Eliminated all inline sync calls from tool handlers (verified via grep)
- Consistent deleted block error handling now handled by middleware

## Task Commits

Each task was committed atomically:

1. **Task 1: Create sync middleware module** - `c9a839a` (feat)
2. **Task 2: Apply middleware to blocks/* tools** - `9dff111` (refactor)
3. **Task 3: Apply middleware to reports/* tools and verify** - `25a5474` (feat)

## Files Created/Modified

- `packages/mcp-server/src/tools/middleware/sync-middleware.ts` - Core middleware with withSyncedBlock, withSyncedBlocks, withFullSync
- `packages/mcp-server/src/tools/blocks/core.ts` - list_blocks, get_block_info, get_statistics wrapped
- `packages/mcp-server/src/tools/blocks/comparison.ts` - compare_blocks, block_diff wrapped
- `packages/mcp-server/src/tools/blocks/analysis.ts` - stress_test, drawdown_attribution, marginal_contribution wrapped
- `packages/mcp-server/src/tools/blocks/similarity.ts` - strategy_similarity, what_if_scaling wrapped
- `packages/mcp-server/src/tools/blocks/health.ts` - portfolio_health_check wrapped
- `packages/mcp-server/src/tools/reports/fields.ts` - list_available_fields, get_field_statistics wrapped
- `packages/mcp-server/src/tools/reports/queries.ts` - run_filtered_query, aggregate_by_field wrapped
- `packages/mcp-server/src/tools/reports/predictive.ts` - find_predictive_fields, filter_curve wrapped
- `packages/mcp-server/src/tools/reports/discrepancies.ts` - analyze_discrepancies wrapped
- `packages/mcp-server/src/tools/reports/slippage-trends.ts` - analyze_slippage_trends wrapped
- `packages/mcp-server/src/tools/reports/strategy-matches.ts` - suggest_strategy_matches wrapped

## Decisions Made

1. **Index signature for MCP SDK compatibility** - The MCP SDK requires tool return types to have `[x: string]: unknown` index signature. Added to ToolError interface in middleware.

2. **as const assertions for literal types** - Error responses need `type: "text" as const` and `isError: true as const` to satisfy TypeScript's literal type requirements for MCP SDK compatibility.

3. **Middleware pattern over immediate invocation** - Some tools (health.ts, similarity.ts) initially used immediate invocation pattern `withSyncedBlock(...)({...})` which doesn't work correctly. Restructured to proper middleware wrapping.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed MCP SDK type compatibility**
- **Found during:** Task 3 (Apply middleware to reports/* tools)
- **Issue:** MCP SDK expects index signature on tool return types, causing type errors
- **Fix:** Added `[key: string]: unknown;` to ToolError interface
- **Files modified:** packages/mcp-server/src/tools/middleware/sync-middleware.ts
- **Verification:** npm run build succeeds
- **Committed in:** 25a5474

**2. [Rule 1 - Bug] Fixed immediate invocation pattern in health.ts and similarity.ts**
- **Found during:** Task 3 verification
- **Issue:** Tools used `async (input) => { return withSyncedBlock(...)({...}) }` which doesn't correctly apply middleware
- **Fix:** Restructured to `withSyncedBlock(baseDir, async (input) => { ... })` directly
- **Files modified:** packages/mcp-server/src/tools/blocks/health.ts, packages/mcp-server/src/tools/blocks/similarity.ts
- **Verification:** npm run build succeeds, tests pass
- **Committed in:** 25a5474

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both auto-fixes essential for correctness. No scope creep.

## Issues Encountered

- Missing closing parentheses in some reports/* files after adding middleware wrapper - fixed by adding extra `)` for the middleware closure
- Some error responses had string types instead of literal types - fixed with `as const` assertions

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All tools now use middleware pattern for sync-before-query
- No inline sync calls remain in tool handlers
- Ready for Plan 04: Documentation updates

---
*Phase: 42.1-sync-layer-hardening*
*Completed: 2026-02-02*
