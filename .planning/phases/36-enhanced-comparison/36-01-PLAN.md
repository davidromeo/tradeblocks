---
phase: 36-enhanced-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/performance.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "Model can get trade-level comparison with entry/exit prices, contracts, and differences"
    - "Model can identify high-slippage outliers automatically with severity levels"
    - "Model can group comparison results by strategy or date (daily/weekly/monthly)"
    - "Existing callers work unchanged (backward compatible defaults)"
  artifacts:
    - path: "packages/mcp-server/src/tools/performance.ts"
      provides: "Enhanced compare_backtest_to_actual tool"
      contains: "detailLevel"
    - path: "packages/mcp-server/src/tools/performance.ts"
      provides: "Outlier detection logic"
      contains: "outlierStats"
    - path: "packages/mcp-server/src/tools/performance.ts"
      provides: "Grouping logic"
      contains: "groupBy"
  key_links:
    - from: "compare_backtest_to_actual"
      to: "math.js mean/std"
      via: "import and z-score calculation"
      pattern: "mean.*std"
    - from: "compare_backtest_to_actual"
      to: "getISOWeekNumber"
      via: "week grouping helper"
      pattern: "getISOWeekNumber"
---

<objective>
Enhance the `compare_backtest_to_actual` MCP tool with three new capabilities: (1) trade-level detail comparison showing field-by-field differences, (2) automatic outlier detection using z-score statistics, and (3) flexible grouping by strategy or date granularity.

Purpose: Enable models to perform detailed discrepancy analysis between backtest and actual trades, surface high-slippage outliers automatically, and organize results by strategy or time period for pattern recognition.

Output: Enhanced MCP tool with new parameters (`detailLevel`, `outliersOnly`, `outliersThreshold`, `groupBy`) that maintains backward compatibility while enabling deep trade-level analysis.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context
@.planning/phases/36-enhanced-comparison/36-CONTEXT.md
@.planning/phases/36-enhanced-comparison/36-RESEARCH.md

# Existing code to modify
@packages/mcp-server/src/tools/performance.ts (lines 1781-2141 - compare_backtest_to_actual tool)

# Pattern references
@packages/lib/calculations/streak-analysis.ts (z-score pattern)
@packages/mcp-server/src/tools/reports.ts (groupBy pattern, getISOWeekNumber)
@packages/lib/models/trade.ts (Trade interface)
@packages/lib/models/reporting-trade.ts (ReportingTrade interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new parameters and trade-level comparison logic</name>
  <files>packages/mcp-server/src/tools/performance.ts</files>
  <action>
Extend the `compare_backtest_to_actual` tool input schema with new optional parameters (all with defaults for backward compatibility):

```typescript
detailLevel: z
  .enum(["summary", "trades"])
  .default("summary")
  .describe("'summary' (default): aggregate by date+strategy. 'trades': individual trade comparison with field-by-field differences"),
outliersOnly: z
  .boolean()
  .default(false)
  .describe("Only return high-slippage outliers (trades exceeding z-score threshold)"),
outliersThreshold: z
  .number()
  .default(2)
  .describe("Z-score threshold for outlier detection (default: 2 = ~95% confidence)"),
groupBy: z
  .enum(["none", "strategy", "date", "week", "month"])
  .default("none")
  .describe("Group results: 'none' (flat list), 'strategy', 'date' (daily), 'week', 'month'"),
```

Implement trade-level matching when `detailLevel='trades'`:
- Match individual trades by `date|strategy|timeOpened` (truncated to HH:mm for matching)
- For each matched pair, compute field-by-field differences:
  - numContracts (delta)
  - openingPrice (delta)
  - closingPrice (delta if both have it)
  - reasonForClose (flag if different)
- Include context from backtest trade: openingVix, closingVix, gap, movement
- Maintain existing day-level aggregation as default behavior (`detailLevel='summary'`)

Create DetailedComparison interface:
```typescript
interface DetailedComparison {
  date: string
  strategy: string
  timeOpened: string
  matched: boolean
  backtestPl: number
  actualPl: number
  scaledBacktestPl: number
  slippage: number
  slippagePercent: number | null
  backtestContracts: number
  actualContracts: number
  scalingFactor: number
  differences: Array<{
    field: string
    backtest: number | string | null
    actual: number | string | null
    delta?: number
  }>
  isOutlier: boolean
  outlierSeverity?: 'low' | 'medium' | 'high'
  zScore?: number
  context?: {
    openingVix?: number
    closingVix?: number
    gap?: number
    movement?: number
    backtestReasonForClose?: string
    actualReasonForClose?: string
  }
}
```

**IMPORTANT:** Guard against edge cases:
- Division by zero when backtestContracts=0 (set scalingFactor to 0)
- Time precision: truncate time to minute for matching (backtest "09:34:00" vs actual "09:34:06.5809432")
- Use existing `formatDateKey()` for date handling
  </action>
  <verify>
Run typecheck: `npm run typecheck` passes in packages/mcp-server.

Test with CLI:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd"}'
```
Verify default response unchanged (backward compatible).

Test trade-level:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","detailLevel":"trades"}'
```
Verify response includes `differences` array and `context` object for matched trades.
  </verify>
  <done>
- Input schema accepts new parameters with backward-compatible defaults
- `detailLevel='summary'` returns existing aggregate behavior
- `detailLevel='trades'` returns individual trade comparisons with field differences
- Trade matching works by date+strategy+time (minute precision)
- Context fields (VIX, gap, movement) included from backtest trades
  </done>
</task>

<task type="auto">
  <name>Task 2: Add outlier detection and grouping logic</name>
  <files>packages/mcp-server/src/tools/performance.ts</files>
  <action>
Import math.js functions at top of file (if not already):
```typescript
import { mean, std } from 'mathjs'
```

Implement outlier detection after comparisons are built:
1. Extract slippage values from matched comparisons only
2. Guard: if fewer than 3 matched comparisons, skip outlier detection (set outlierStats to null)
3. Guard: if stdDev < 1e-10, skip outlier detection (all values essentially same)
4. Calculate z-score for each comparison: `(slippage - meanSlippage) / stdDev`
5. Flag outliers where `abs(zScore) >= threshold`
6. Assign severity: `>= 3` -> 'high', `>= 2` -> 'medium', else 'low'
7. Set `isOutlier`, `outlierSeverity`, `zScore` on each comparison

Add outlierStats to summary:
```typescript
outlierStats: {
  meanSlippage: number
  stdDevSlippage: number
  threshold: number
  outlierCount: number
  outlierPercent: number
  outlierTotalSlippage: number
  outlierAvgSlippage: number
} | null  // null if insufficient data (<3 matched)
```

If `outliersOnly=true`, filter comparisons to only those with `isOutlier=true`.

Implement grouping when `groupBy !== 'none'`:
1. Create helper `getGroupKey(date: Date, groupBy: 'strategy' | 'date' | 'week' | 'month')`:
   - 'strategy': use comparison.strategy
   - 'date': use formatDateKey(date)
   - 'week': use `${year}-W${getISOWeekNumber(date).toString().padStart(2, '0')}`
   - 'month': use `${year}-${(month+1).toString().padStart(2, '0')}`

2. Group comparisons into Map<string, DetailedComparison[]>

3. Calculate aggregate stats per group:
```typescript
interface GroupedResult {
  groupKey: string
  count: number
  matchedCount: number
  totalSlippage: number
  avgSlippage: number
  outlierCount: number
  comparisons: DetailedComparison[]  // Individual trades in group
}
```

4. Return `groups` array instead of `comparisons` when grouped

Update response structure:
```typescript
const structuredData = {
  // ... existing fields
  filters: {
    // ... existing
    detailLevel,
    groupBy,
    outliersOnly,
    outliersThreshold
  },
  summary: {
    // ... existing
    outlierStats  // NEW
  },
  // Conditional output based on groupBy
  ...(groupBy === 'none'
    ? { comparisons }
    : { groups })
}
```

Sort comparisons/groups by slippage (worst first) to surface problem areas.
  </action>
  <verify>
Run typecheck: `npm run typecheck` passes.

Test outlier detection:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","detailLevel":"trades"}'
```
Verify `summary.outlierStats` present with meanSlippage, stdDevSlippage, outlierCount.
Verify comparisons have `isOutlier`, `zScore` fields.

Test outliers-only filter:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","detailLevel":"trades","outliersOnly":true}'
```
Verify only outlier trades returned (or empty if none).

Test grouping by strategy:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","groupBy":"strategy"}'
```
Verify `groups` array with per-strategy aggregates.

Test grouping by week:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","groupBy":"week"}'
```
Verify week keys like "2026-W05".
  </verify>
  <done>
- Outlier detection using z-score with configurable threshold
- Severity levels (low/medium/high) based on z-score magnitude
- `outlierStats` in summary with count, percent, average outlier slippage
- `outliersOnly` filter returns only high-slippage trades
- `groupBy` parameter groups by strategy, date, week, or month
- Grouped results include aggregate stats per group
- Results sorted by slippage (worst first)
  </done>
</task>

<task type="auto">
  <name>Task 3: Version bump and integration verification</name>
  <files>packages/mcp-server/package.json</files>
  <action>
1. Bump MCP server version: 0.4.3 -> 0.4.4 (minor feature addition)

2. Run comprehensive verification:
   - `npm run typecheck` in packages/mcp-server
   - `npm test` to verify no regressions

3. Test backward compatibility with existing call pattern:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","scaling":"toReported","matchedOnly":true}'
```
Verify response structure unchanged for callers not using new parameters.

4. Test combined new features:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","detailLevel":"trades","groupBy":"strategy","outliersOnly":true}'
```
Verify grouped by strategy, only outliers, with trade-level detail.

5. Commit with descriptive message covering all three requirements.
  </action>
  <verify>
`npm run typecheck` passes.
`npm test` passes (or only pre-existing failures).
Version in package.json is 0.4.4.
All four test commands return valid JSON responses without errors.
  </verify>
  <done>
- MCP server version bumped to 0.4.4
- All typechecks pass
- All tests pass
- Backward compatibility verified (existing calls work unchanged)
- All three requirements (CMP-01, CMP-02, CMP-03) satisfied
  </done>
</task>

</tasks>

<verification>
All three requirements verified:

**CMP-01 (Trade-level details):**
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","detailLevel":"trades"}'
```
- Response includes `differences` array with field-by-field comparison
- Response includes `context` with VIX, gap, movement from backtest
- Each trade has entry/exit prices, contracts, and reasons

**CMP-02 (Outlier detection):**
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","outliersOnly":true}'
```
- `summary.outlierStats` present with statistical summary
- Trades flagged with `isOutlier`, `outlierSeverity`, `zScore`
- Can filter to outliers only

**CMP-03 (Grouping):**
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call compare_backtest_to_actual '{"blockId":"main-port-2026-ytd","groupBy":"strategy"}'
```
- `groups` array returned instead of flat `comparisons`
- Each group has aggregated stats (count, avgSlippage, outlierCount)
- Supports strategy, date, week, month granularities
</verification>

<success_criteria>
1. `detailLevel='trades'` returns individual trade comparisons with field differences
2. `outlierStats` calculated using z-score, with configurable threshold
3. `groupBy` parameter enables strategy/date/week/month aggregation
4. All new parameters have defaults preserving backward compatibility
5. MCP server version bumped to 0.4.4
6. All tests and typechecks pass
</success_criteria>

<output>
After completion, create `.planning/phases/36-enhanced-comparison/36-01-SUMMARY.md`
</output>
