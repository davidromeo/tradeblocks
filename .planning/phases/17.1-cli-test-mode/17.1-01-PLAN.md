---
phase: 17.1-cli-test-mode
plan: 01
type: execute
domain: mcp-server
---

<objective>
Add a `--call` CLI flag to the MCP server for direct tool invocation without running the full server.

Purpose: Enable subagents and developers to test MCP tools directly from the command line using real data.
Output: `npx tradeblocks-mcp --call <tool> '<json-args>'` works and returns JSON output.
</objective>

<context>
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/tools/blocks.ts
@packages/mcp-server/package.json

**Usage pattern:**
```bash
# Test block_diff with real data
TRADEBLOCKS_DATA_DIR=~/backtests npx tradeblocks-mcp --call block_diff '{"blockIdA":"main-port-2026","blockIdB":"main-port-dual-5_7"}'

# List available blocks
npx tradeblocks-mcp --call list_blocks '{}'
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --call CLI mode to MCP server</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Modify the main entry point to support a `--call` flag that bypasses the MCP server and directly invokes a tool handler.

**Implementation:**
1. At the top of `main()`, check for `--call` flag in `process.argv`
2. If present, parse: `--call <toolName> <jsonArgs>`
3. Look up the tool handler from the registered tools
4. Call the handler with parsed args and baseDir
5. Print JSON result to stdout
6. Exit with code 0 on success, 1 on error

**Code structure:**
```typescript
async function main() {
  // Check for --call mode
  const callIndex = process.argv.indexOf('--call');
  if (callIndex !== -1) {
    await handleDirectCall(process.argv.slice(callIndex + 1));
    return;
  }

  // ... existing MCP server code ...
}

async function handleDirectCall(args: string[]) {
  const [toolName, jsonArgs] = args;
  if (!toolName) {
    console.error('Usage: tradeblocks-mcp --call <tool-name> \'<json-args>\'');
    process.exit(1);
  }

  const parsedArgs = jsonArgs ? JSON.parse(jsonArgs) : {};
  const baseDir = process.env.TRADEBLOCKS_DATA_DIR || process.cwd();

  // Get tool handler - need to expose handlers from tool registration
  const result = await invokeToolByName(toolName, parsedArgs, baseDir);

  console.log(JSON.stringify(result, null, 2));
}
```

**Tool handler lookup:**
Create a registry object that maps tool names to their handlers. Export this from tools/blocks.ts or create a central registry.
  </action>
  <verify>`npm run build -w packages/mcp-server` passes</verify>
  <done>--call flag parsed and routes to direct invocation path</done>
</task>

<task type="auto">
  <name>Task 2: Test CLI mode with block_diff</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Test the --call mode with real backtest data:

```bash
cd packages/mcp-server
TRADEBLOCKS_DATA_DIR=~/backtests node server/index.js --call list_blocks '{}'
TRADEBLOCKS_DATA_DIR=~/backtests node server/index.js --call block_diff '{"blockIdA":"main-port-2026","blockIdB":"main-port-dual-5_7"}'
```

Verify:
1. list_blocks returns JSON array of block IDs
2. block_diff returns full comparison JSON with strategyOverlap, perStrategyComparison, portfolioTotals
3. Error cases return proper error JSON and exit code 1
  </action>
  <verify>Both commands produce valid JSON output</verify>
  <done>CLI test mode works with real data</done>
</task>

</tasks>

<verification>
- [ ] `npm run build -w packages/mcp-server` passes
- [ ] `--call list_blocks` returns block IDs from ~/backtests
- [ ] `--call block_diff` returns comparison JSON
- [ ] Invalid tool name returns error JSON
- [ ] Invalid JSON args returns parse error
</verification>

<success_criteria>
- --call flag works for direct tool invocation
- JSON output suitable for parsing/verification
- Works with TRADEBLOCKS_DATA_DIR env var
- Subagents can use this for testing future tools
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-cli-test-mode/17.1-01-SUMMARY.md`
</output>
