---
phase: 17.1-cli-test-mode
plan: 01
subsystem: mcp-server
tags: [cli, testing, mcp]

requires:
  - phase: 17
    provides: block_diff tool to test with
provides:
  - --call CLI mode for direct tool invocation
  - Test harness for subagents
affects: [phase-18, phase-19, phase-20, phase-21, phase-22, phase-23]

tech-stack:
  added: []
  patterns: [mock-server-capture, cli-tool-invocation]

key-files:
  created:
    - packages/mcp-server/src/cli-handler.ts
  modified:
    - packages/mcp-server/src/index.ts

key-decisions:
  - "Mock MCP server approach captures registrations without modifying tool files"
  - "Extract JSON from resource content for clean CLI output"

patterns-established:
  - "CLI test mode: TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call <tool> '<args>'"

issues-created: []

duration: 12min
completed: 2026-01-17
---

# Phase 17.1 Plan 01: CLI Test Mode Summary

**Added --call CLI flag to MCP server for direct tool invocation, enabling subagents to test tools with real data**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-17T23:30:00Z
- **Completed:** 2026-01-17T23:42:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Added `--call` CLI mode that bypasses MCP server for direct tool testing
- Created mock server that captures tool registrations without modifying tool files
- Extracts JSON data from tool output resources for clean CLI output
- Supports `TRADEBLOCKS_DATA_DIR` env var for specifying data directory
- Tested with `list_backtests` and `block_diff` using real backtest data

## Task Commits

1. **Task 1+2: Add --call CLI mode** - `fd7774b` (feat)

## Files Created/Modified

- `packages/mcp-server/src/cli-handler.ts` - New CLI handler with mock server capture
- `packages/mcp-server/src/index.ts` - Added --call routing and updated help text

## Usage

```bash
# List available tools
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call --list

# List blocks
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call list_backtests '{}'

# Compare blocks
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call block_diff '{"blockIdA":"main-port-2026","blockIdB":"main-port-dual-5_7"}'
```

## Decisions Made

- Used mock MCP server approach to capture tool registrations - avoids modifying existing tool files
- Extract JSON from resource content items (not text summary) for structured CLI output

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- CLI test mode ready for use in Phases 18-23
- All future MCP tools can be tested via `--call` flag
- Subagents can verify tool output by parsing JSON from stdout

---
*Phase: 17.1-cli-test-mode*
*Completed: 2026-01-17*
