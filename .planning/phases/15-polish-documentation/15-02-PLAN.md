---
phase: 15-polish-documentation
plan: "02"
type: execute
---

<objective>
Add GitHub Actions release workflow for MCPB distribution, integration tests, and usage documentation.

Purpose: Enable automated releases with .mcpb bundles on GitHub, ensure MCP tools work correctly, and provide real-world usage examples.
Output: Automated release pipeline, passing integration tests, comprehensive usage docs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/15-polish-documentation/15-01-SUMMARY.md

# Existing CI workflow
@.github/workflows/ci.yml

# Key files
@packages/mcp-server/package.json
@packages/mcp-server/manifest.json
@packages/mcp-server/scripts/pack-mcpb.js

**Tech stack available:** GitHub Actions, archiver (for mcpb packing), Jest
**Established patterns:** MCPB v0.3 manifest format, pack-mcpb.js script

**Distribution approaches:**
1. Source install: `git clone` + `npm install` + `npm run build:mcp`
2. npx/npm: `npx tradeblocks-mcp` (once published to npm registry)
3. MCPB: Download .mcpb from GitHub Releases, double-click to install in Claude Desktop
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create a new workflow that triggers on version tags and:

1. **Trigger:** On push of tags matching `v*` (e.g., v0.1.0, v1.0.0)

2. **Build job:**
   - Checkout code
   - Setup Node.js 20
   - Install dependencies (npm ci)
   - Run lint and tests
   - Build MCP server (npm run build -w packages/mcp-server)
   - Pack MCPB bundle (npm run mcpb:pack -w packages/mcp-server)

3. **Release job** (needs build):
   - Create GitHub Release with tag name
   - Upload .mcpb file as release asset
   - Generate release notes from commits since last tag

**Workflow file:**
```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build MCP Server
        run: npm run build -w packages/mcp-server

      - name: Pack MCPB Bundle
        run: npm run mcpb:pack -w packages/mcp-server

      - name: Upload MCPB artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcpb-bundle
          path: packages/mcp-server/*.mcpb

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download MCPB artifact
        uses: actions/download-artifact@v4
        with:
          name: mcpb-bundle
          path: ./dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/*.mcpb
          generate_release_notes: true
          body: |
            ## Installation

            ### Claude Desktop (One-Click)
            Download `tradeblocks-*.mcpb` below and double-click to install.

            ### npm
            ```bash
            npx tradeblocks-mcp ~/path/to/backtests
            ```

            ### From Source
            ```bash
            git clone https://github.com/davidromeo/tradeblocks
            cd tradeblocks && npm install && npm run build:mcp
            ```
```

Also update the existing ci.yml to add MCP server build step:
- Add job or step to build packages/mcp-server on PRs
- Ensures MCP server compiles before merge
  </action>
  <verify>
Manually verify workflow file syntax with: `cat .github/workflows/release.yml | head -50`
Check that existing ci.yml still valid after updates.
  </verify>
  <done>
- release.yml triggers on version tags
- Builds and tests before releasing
- Creates GitHub Release with .mcpb attachment
- Release notes include installation instructions
- ci.yml updated to build MCP server on PRs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for MCP tools</name>
  <files>packages/mcp-server/tests/tools.test.ts, packages/mcp-server/jest.config.js, packages/mcp-server/package.json</files>
  <action>
Set up Jest for the MCP server package and create integration tests.

**1. Install test dependencies:**
Add to devDependencies: jest, @types/jest, ts-jest

**2. Create jest.config.js:**
```javascript
export default {
  preset: 'ts-jest/presets/default-esm',
  testEnvironment: 'node',
  extensionsToTreatAsEsm: ['.ts'],
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1',
    '^@lib/(.*)$': '<rootDir>/../../lib/$1'
  },
  transform: {
    '^.+\\.tsx?$': ['ts-jest', { useESM: true }]
  },
  testMatch: ['**/tests/**/*.test.ts'],
  collectCoverageFrom: ['src/**/*.ts', '!src/**/*.d.ts']
};
```

**3. Update package.json scripts:**
```json
"test": "NODE_OPTIONS='--experimental-vm-modules' jest"
```

**4. Create tests/fixtures/ with mock data:**
- tests/fixtures/mock-block/tradelog.csv (small valid trade log, ~5 trades)
- tests/fixtures/mock-block/dailylog.csv (matching daily log entries)

**5. Create tests/tools.test.ts:**

Test the core tool functions directly (not via MCP protocol):

```typescript
import { loadBlock, listBlocks } from '../src/utils/block-loader.js';
import path from 'path';

const FIXTURES_DIR = path.join(__dirname, 'fixtures');

describe('block-loader', () => {
  describe('listBlocks', () => {
    it('should list blocks in directory', async () => {
      const blocks = await listBlocks(FIXTURES_DIR);
      expect(blocks).toHaveLength(1);
      expect(blocks[0].blockId).toBe('mock-block');
    });

    it('should return empty array for empty directory', async () => {
      // Use temp dir or non-existent safe path
    });
  });

  describe('loadBlock', () => {
    it('should load trades from block', async () => {
      const block = await loadBlock(FIXTURES_DIR, 'mock-block');
      expect(block.trades.length).toBeGreaterThan(0);
      expect(block.trades[0]).toHaveProperty('pl');
      expect(block.trades[0]).toHaveProperty('dateOpened');
    });

    it('should load daily logs when present', async () => {
      const block = await loadBlock(FIXTURES_DIR, 'mock-block');
      expect(block.dailyLogs).toBeDefined();
      expect(block.dailyLogs!.length).toBeGreaterThan(0);
    });
  });
});
```

**6. Create tests/csv-detection.test.ts** (for ISS-006 fix):

```typescript
import { detectCsvType } from '../src/utils/block-loader.js';

describe('CSV type detection', () => {
  it('should detect trade log by columns', async () => {
    const type = await detectCsvType(path.join(FIXTURES_DIR, 'mock-block/tradelog.csv'));
    expect(type).toBe('tradelog');
  });

  it('should detect daily log by columns', async () => {
    const type = await detectCsvType(path.join(FIXTURES_DIR, 'mock-block/dailylog.csv'));
    expect(type).toBe('dailylog');
  });

  it('should return null for unrecognized CSV', async () => {
    // Create fixture with random columns
  });
});
```

Keep tests focused on block-loader utilities - these are the foundation that all tools depend on.
  </action>
  <verify>
Run `npm test -w packages/mcp-server` - all tests should pass.
  </verify>
  <done>
- Jest configured for MCP server package
- Test fixtures created with valid mock data
- block-loader tests pass (listBlocks, loadBlock)
- CSV detection tests pass (for ISS-006 fix)
- npm test script works
  </done>
</task>

<task type="auto">
  <name>Task 3: Create usage examples documentation</name>
  <files>packages/mcp-server/docs/USAGE.md, packages/mcp-server/README.md</files>
  <action>
Create comprehensive usage documentation with real-world examples.

**1. Create packages/mcp-server/docs/USAGE.md:**

```markdown
# TradeBlocks MCP Server Usage Guide

## Quick Start

### 1. Set Up Your Data

Create a folder for your trading data:
```bash
mkdir -p ~/Trading/backtests
```

Each strategy is a "block" - a folder containing:
- `tradelog.csv` (required) - Your trade records
- `dailylog.csv` (optional) - Daily portfolio values

### 2. Start the Server

```bash
# With npx (recommended)
npx tradeblocks-mcp ~/Trading/backtests

# Or if installed globally
tradeblocks-mcp ~/Trading/backtests
```

### 3. Connect Claude Desktop

The server connects via stdio. Claude Desktop will auto-configure when you install the .mcpb bundle.

---

## Common Workflows

### Health Check a Strategy

"Run a health check on my iron-condor strategy"

Claude will:
1. `list_backtests` - Find available blocks
2. `get_statistics` - Get performance metrics
3. `run_walk_forward` - Check for overfitting
4. `get_tail_risk` - Assess worst-case scenarios

### Compare Two Strategies

"Compare my spy-puts strategy against qqq-calls"

Claude will:
1. Load both blocks
2. `get_statistics` on each
3. `calculate_correlation` between them
4. Present side-by-side comparison

### Analyze for Portfolio Addition

"Should I add this new strategy to my portfolio?"

Claude will:
1. Run health check on new strategy
2. Calculate correlation with existing strategies
3. Assess diversification benefit
4. Provide ADD/CONSIDER/SKIP recommendation

### Optimize Parameters

"What's the best day of week to enter trades?"

Claude will:
1. `list_available_fields` - Find filterable fields
2. `aggregate_by_field` - Group by day of week
3. `get_field_statistics` - Compare performance
4. Present findings with overfitting warnings

---

## Tool Reference

### Core Tools
| Tool | Purpose |
|------|---------|
| `list_backtests` | List all available blocks |
| `get_statistics` | Performance metrics for a block |
| `get_trades` | Raw trade data with optional filters |
| `reprocess_block` | Re-parse CSVs and recalculate stats |

### Analysis Tools
| Tool | Purpose |
|------|---------|
| `run_walk_forward` | Detect overfitting via WFA |
| `run_monte_carlo` | Risk simulation with confidence intervals |
| `calculate_correlation` | Strategy correlation matrix |
| `get_tail_risk` | VaR, CVaR, max drawdown analysis |
| `calculate_position_sizing` | Kelly criterion position sizing |

### Performance Tools
| Tool | Purpose |
|------|---------|
| `get_performance_charts` | Chart data (equity, drawdown, etc.) |
| `get_period_returns` | Returns by time period |
| `compare_backtest_vs_actual` | Backtest vs live comparison |

### Report Builder Tools
| Tool | Purpose |
|------|---------|
| `list_available_fields` | Filterable trade fields |
| `run_filtered_query` | Query trades with filters |
| `get_field_statistics` | Statistics for a field |
| `aggregate_by_field` | Group and aggregate trades |

### Import Tools
| Tool | Purpose |
|------|---------|
| `import_csv` | Import CSV and create new block |

---

## CSV Format

### Trade Log (tradelog.csv)

Required columns:
- Date Opened, Time Opened
- Date Closed, Time Closed
- P/L (gross profit/loss)
- Strategy name
- Symbol

Optional columns:
- No. of Contracts
- Premium
- Max Profit, Max Loss (for MFE/MAE)
- Opening/Closing commissions

### Daily Log (dailylog.csv)

Required columns:
- Date
- Portfolio Value (or "Value", "Equity")

---

## Troubleshooting

### "Block not found"

1. Check folder exists in your backtests directory
2. Ensure it contains a valid CSV (tradelog.csv or detected by content)
3. Run `list_backtests` to see what's available

### "No trades after filtering"

The date range or strategy filter may be too restrictive. Try without filters first.

### CSV not detected

If your CSV has non-standard names, ensure it has the expected columns:
- Trade log needs: P/L, Date Opened, Date Closed, Symbol
- Daily log needs: Date, Portfolio Value
```

**2. Update packages/mcp-server/README.md:**

Add a "Usage" section that links to docs/USAGE.md and includes the quick start example.

Add "Installation" section with all three methods:
- MCPB (one-click)
- npx/npm
- From source

Add "Skills" section explaining the agent skills and how to install them.
  </action>
  <verify>
Check files exist and are well-formatted:
- `cat packages/mcp-server/docs/USAGE.md | head -50`
- `cat packages/mcp-server/README.md | head -50`
  </verify>
  <done>
- USAGE.md created with workflows, tool reference, CSV format docs
- README.md updated with installation methods and usage link
- Documentation covers all 19 MCP tools
- Troubleshooting section included
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `.github/workflows/release.yml` exists and has valid syntax
- [ ] `npm test -w packages/mcp-server` passes
- [ ] `packages/mcp-server/docs/USAGE.md` exists with comprehensive examples
- [ ] `packages/mcp-server/README.md` updated with installation methods
- [ ] Existing `npm run build` still works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Release workflow ready to trigger on `git tag v0.1.0 && git push --tags`
- Integration tests provide baseline coverage for block-loader
- Documentation covers all major use cases
- Phase 15 complete - v2.0 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/15-polish-documentation/15-02-SUMMARY.md` with:
- Accomplishments (release workflow, tests, docs)
- Files created/modified
- Key decisions
- Phase 15 complete status
- v2.0 milestone completion readiness
</output>
