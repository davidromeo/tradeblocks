---
phase: 15-polish-documentation
plan: "01"
type: execute
---

<objective>
Add CLI install-skills command and fix flexible CSV discovery for better UX.

Purpose: Enable programmatic skill installation and resolve ISS-006 which blocks users whose CSVs have non-standard names.
Output: Working `tradeblocks-mcp install-skills` command and flexible block discovery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (Phase 14 prepared the skill-installer module)
@.planning/phases/14-multi-platform-agent-skills/14-04-SUMMARY.md

# Key files
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/skill-installer.ts
@packages/mcp-server/src/utils/block-loader.ts

**Tech stack available:** @modelcontextprotocol/sdk, tsup, zod@4
**Established patterns:** McpServer.registerTool(), skill-installer API (install/uninstall/check)

**Constraining decisions:**
- Phase 14-04: Skill installer module created with install/uninstall/check functions
- Phase 14-04: Multi-entry tsup config (index.ts + skill-installer.ts)
- Phase 11-02: Folder-based block structure (folder = block with tradelog.csv)

**Issue being addressed:**
- ISS-006: MCP block loader requires exact CSV filenames (high impact UX issue)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add install-skills CLI command</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Add command-line argument parsing to detect `install-skills` subcommand before MCP server startup.

When `process.argv[2] === 'install-skills'`:
1. Parse flags: `--platform` (claude|codex|gemini, default: claude), `--force` (reinstall existing)
2. Import and call `installSkills()` from skill-installer module
3. Print results: installed count, skipped count, any errors
4. Exit with appropriate code (0 success, 1 error)

When `process.argv[2] === 'uninstall-skills'`:
1. Parse `--platform` flag
2. Call `uninstallSkills()`
3. Print removed skills
4. Exit

When `process.argv[2] === 'check-skills'`:
1. Parse `--platform` flag
2. Call `checkInstallation()`
3. Print installed/missing status
4. Exit

Otherwise, proceed with normal MCP server startup (existing behavior).

Update the usage message to include these commands:
```
Usage: tradeblocks-mcp <command|backtests-folder>

Commands:
  install-skills    Install TradeBlocks skills to AI platform
  uninstall-skills  Remove TradeBlocks skills from AI platform
  check-skills      Check skill installation status

Options for skill commands:
  --platform <name>  Target platform: claude, codex, gemini (default: claude)
  --force            Reinstall even if skills exist (install only)

MCP Server:
  tradeblocks-mcp <backtests-folder>
  BLOCKS_DIRECTORY=/path tradeblocks-mcp
```

Do NOT use a CLI parsing library - keep it simple with manual argv parsing. The skill-installer module already handles all the heavy lifting.
  </action>
  <verify>
Run `npx tsx packages/mcp-server/src/index.ts install-skills --help` shows usage.
Run `npx tsx packages/mcp-server/src/index.ts check-skills` shows installation status.
  </verify>
  <done>
- `install-skills` command installs all 6 skills to ~/.claude/skills/ (or other platform)
- `uninstall-skills` removes them
- `check-skills` shows current status
- Normal MCP server startup still works with folder argument
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix ISS-006 - Flexible CSV discovery</name>
  <files>packages/mcp-server/src/utils/block-loader.ts</files>
  <action>
Modify `listBlocks()` and block loading to discover CSVs by content pattern, not just exact filename.

**Discovery logic for a folder:**

1. First check for exact names (tradelog.csv, dailylog.csv, reportinglog.csv) - existing behavior
2. If no exact match, scan folder for .csv files and detect type by content:

**Trade log detection** (look for these columns in header):
- Required: "P/L" or "P&L" or "Profit/Loss"
- Plus at least 2 of: "Date Opened", "Date Closed", "Symbol", "Strategy", "Contracts", "Premium"

**Daily log detection** (look for these columns):
- Required: "Date", "Portfolio Value" or "Value" or "Equity"
- Should have numeric values in value column

**Reporting log detection** (look for these columns):
- Required: "Actual P/L" or columns from REPORTING_TRADE_COLUMN_ALIASES
- Or: "Trade ID" + "Reported" in column names

**Implementation approach:**

Add helper function `detectCsvType(filePath: string): Promise<'tradelog' | 'dailylog' | 'reportinglog' | null>`:
1. Read first line (header)
2. Parse CSV header into column names
3. Match against detection patterns above
4. Return type or null if unrecognized

Modify `listBlocks()`:
1. For each folder, first try exact names
2. If no tradelog.csv found, scan for *.csv files
3. Use detectCsvType() to identify each CSV
4. Store discovered mappings in .block.json under `csvMappings: { tradelog: "actual-filename.csv", ... }`
5. Use these mappings when loading block data

Add clear console.error logging when a folder has CSVs but none match expected patterns:
```
Warning: Folder 'my-strategy' has CSV files but none match expected trade log format.
  Found: trade-log-2024.csv, notes.csv
  Expected columns: P/L, Date Opened, Date Closed, Symbol, Strategy
```

This preserves backward compatibility (exact names still work) while adding flexible discovery.
  </action>
  <verify>
1. Create test folder with `my-trades-2024.csv` containing valid trade columns
2. Run list_backtests - should discover and list the block
3. Existing folders with tradelog.csv should still work unchanged
  </verify>
  <done>
- Blocks with non-standard CSV names are discovered
- CSV type detected by column content, not filename
- Mappings cached in .block.json for performance
- Warning logged for folders with unrecognized CSVs
- ISS-006 resolved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in packages/mcp-server succeeds
- [ ] `tradeblocks-mcp install-skills` works (installs to ~/.claude/skills/)
- [ ] `tradeblocks-mcp check-skills` shows installation status
- [ ] Block with non-standard CSV filename is discovered by list_backtests
- [ ] Existing blocks with exact filenames still work
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- ISS-006 marked resolved in ISSUES.md
- CLI commands documented in help output
</success_criteria>

<output>
After completion, create `.planning/phases/15-polish-documentation/15-01-SUMMARY.md` with:
- Accomplishments (CLI commands added, ISS-006 fixed)
- Files modified
- Key decisions (detection patterns, backward compatibility approach)
- Any issues encountered
</output>
