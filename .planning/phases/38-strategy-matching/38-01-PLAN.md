---
phase: 38-strategy-matching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/reports.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "Model can get suggested strategy matches based on P/L correlation"
    - "Model receives confidence scores (0-100) for each match suggestion"
    - "Model can detect when backtest and actual are systematically different (unmatchable divergence)"
    - "Strategies that exist only in backtest OR only in actual are listed as unmatched"
    - "Exact name matches auto-confirm at 100% confidence"
  artifacts:
    - path: "packages/mcp-server/src/tools/reports.ts"
      provides: "suggest_strategy_matches MCP tool"
      contains: "suggest_strategy_matches"
  key_links:
    - from: "packages/mcp-server/src/tools/reports.ts"
      to: "@tradeblocks/lib"
      via: "import Trade, ReportingTrade"
      pattern: "import.*Trade.*from.*@tradeblocks/lib"
    - from: "packages/mcp-server/src/tools/reports.ts"
      to: "loadReportingLog"
      via: "block loader utility"
      pattern: "loadReportingLog"
---

<objective>
Implement `suggest_strategy_matches` MCP tool that correlates backtest and actual strategies by P/L patterns to suggest matches when names don't align, with confidence scores and unmatchable divergence detection.

Purpose: When strategy names in backtest don't match names in actual (reporting log), this tool helps users identify which strategies correspond to which by analyzing P/L correlation and trade timing overlap.

Output: New MCP tool registered in reports.ts, MCP server version bumped.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-strategy-matching/38-CONTEXT.md
@packages/lib/calculations/correlation.ts
@packages/mcp-server/src/tools/reports.ts
@packages/mcp-server/src/tools/performance.ts
@packages/mcp-server/src/utils/block-loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement suggest_strategy_matches MCP tool</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Add `suggest_strategy_matches` tool to reports.ts following the established MCP tool pattern.

**Input Parameters:**
- `blockId` (required): Block folder name
- `dateRange` (optional): Filter trades to date range
- `correlationMethod` (default: "pearson"): Correlation method (pearson, spearman, kendall)
- `minOverlapDays` (default: 5): Minimum overlapping trading days required for correlation
- `minCorrelation` (optional): Minimum correlation to include in suggestions (default: show all)
- `includeUnmatched` (default: true): Include strategies with no potential matches

**Core Algorithm:**

1. **Load Data:**
   - Load backtest trades from block
   - Load reporting log (actual trades)
   - Apply dateRange filter if provided

2. **Identify Exact Name Matches:**
   - Find strategies that exist in BOTH backtest AND actual with identical names (case-insensitive)
   - These auto-confirm at 100% confidence, skip correlation calculation

3. **Build Daily P/L Series:**
   - For each backtest strategy: aggregate daily P/L (normalized per-contract if numContracts > 0)
   - For each actual strategy: aggregate daily P/L (normalized per-contract if numContracts > 0)
   - Use dateOpened as the date key (format: YYYY-MM-DD)

4. **Calculate Cross-Correlation Matrix:**
   - For each (backtest_strategy, actual_strategy) pair where names differ:
     - Find overlapping trading days (dates where both have P/L)
     - If overlap < minOverlapDays, mark as insufficient data
     - Calculate Pearson/Spearman/Kendall correlation on overlapping daily P/L values
     - Track sample size (number of overlapping days)

5. **Calculate Trade Timing Overlap:**
   - For each (backtest_strategy, actual_strategy) pair:
     - Count days where backtest_strategy traded
     - Count days where actual_strategy traded
     - Count days where BOTH traded
     - Calculate overlap ratio: (both traded) / min(bt days, actual days)

6. **Compute Confidence Scores (0-100):**
   - Base formula: `confidence = correlationWeight * abs(correlation) + overlapWeight * timingOverlap`
   - Weights: correlationWeight = 70, overlapWeight = 30 (P/L correlation is primary, timing is secondary)
   - Scale correlation from [-1,1] to contribution: positive correlation -> higher score, negative -> lower
   - Adjust for sample size: apply penalty if overlap < 20 days (multiply by overlap/20)
   - Exact name matches: 100% confidence (skip correlation)

7. **Detect Unmatchable Strategies:**
   - Flag as unmatchable if EITHER:
     - Negative correlation (strategies move opposite) - correlation < -0.2
     - Systematic P/L difference in one direction - bias (mean slippage / std) > 2
   - Include reason for unmatchable flag

8. **Identify Unmatched Strategies:**
   - Strategies that exist ONLY in backtest (no actual counterpart)
   - Strategies that exist ONLY in actual (no backtest counterpart)
   - List separately from unmatchable (these are simply missing, not systematically different)

**Output Structure:**
```json
{
  "summary": {
    "backtestStrategies": 5,
    "actualStrategies": 4,
    "exactMatches": 2,
    "suggestedMatches": 2,
    "unmatchableCount": 0,
    "unmatchedBacktestOnly": 1,
    "unmatchedActualOnly": 0
  },
  "exactMatches": [
    { "strategy": "IronCondor", "confidence": 100 }
  ],
  "suggestedMatches": [
    {
      "backtestStrategy": "IC_SPY",
      "actualStrategy": "SPY Iron Condor",
      "confidence": 85,
      "correlation": 0.92,
      "correlationMethod": "pearson",
      "overlapDays": 45,
      "timingOverlap": 0.78,
      "reasoning": "High P/L correlation (0.92) with 45 overlapping days"
    }
  ],
  "unmatchable": [
    {
      "backtestStrategy": "Straddle",
      "potentialActual": "Strangle",
      "correlation": -0.45,
      "reason": "Negative correlation - strategies move opposite"
    }
  ],
  "unmatched": {
    "backtestOnly": ["ExperimentalStrategy"],
    "actualOnly": []
  },
  "correlationMatrix": {
    "rows": ["BT_Strat1", "BT_Strat2"],
    "cols": ["Actual_Strat1", "Actual_Strat2"],
    "values": [[0.92, 0.15], [0.08, 0.87]],
    "sampleSizes": [[45, 12], [10, 52]]
  }
}
```

**Important Notes:**
- Use per-contract normalization: `dailyPl = sumPl / sumContracts` for each day
- Handle case where numContracts is 0 or missing (use raw P/L)
- Case-insensitive strategy name comparison for exact matches
- Sort suggested matches by confidence descending
- Include correlationMatrix for Claude's programmatic interpretation
  </action>
  <verify>
Run `npm run lint && npm run build` in packages/mcp-server/ to verify no TypeScript errors.
  </verify>
  <done>
`suggest_strategy_matches` tool is registered and compiles without errors. Tool accepts blockId and optional parameters, returns match suggestions with confidence scores.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bump MCP server version</name>
  <files>packages/mcp-server/package.json</files>
  <action>
Increment the version in packages/mcp-server/package.json from current version to next patch version.

Read current version first, then bump the patch number (e.g., 0.4.5 -> 0.4.6).
  </action>
  <verify>
Verify package.json has updated version number.
  </verify>
  <done>
MCP server version is bumped to reflect the new tool.
  </done>
</task>

<task type="auto">
  <name>Task 3: CLI verification with real data</name>
  <files>N/A (verification only)</files>
  <action>
Test the new tool using CLI test mode with a real block that has both tradelog.csv and reportinglog.csv:

```bash
cd /Users/davidromeo/Code/tradeblocks/packages/mcp-server
npm run build
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call suggest_strategy_matches '{"blockId":"main-port-2026-ytd"}'
```

Verify:
1. Tool returns structured JSON output
2. exactMatches array contains strategies with identical names in both logs
3. suggestedMatches array contains correlation-based suggestions with confidence scores
4. unmatched.backtestOnly and unmatched.actualOnly list orphaned strategies
5. correlationMatrix is included for programmatic interpretation

If errors occur, fix and re-test.
  </action>
  <verify>
CLI test returns valid JSON with all expected fields (summary, exactMatches, suggestedMatches, unmatchable, unmatched, correlationMatrix).
  </verify>
  <done>
Tool is verified working with real data, returning match suggestions with confidence scores and proper categorization of matched/unmatched/unmatchable strategies.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes in packages/mcp-server/
2. `npm run build` passes in packages/mcp-server/
3. CLI test with real block returns structured output
4. Confidence scores are in 0-100 range
5. Exact name matches show 100% confidence
6. Unmatched strategies are properly categorized (backtestOnly vs actualOnly)
</verification>

<success_criteria>
- suggest_strategy_matches MCP tool registered and callable
- Tool suggests matches based on P/L correlation with confidence scores (0-100)
- Exact name matches auto-confirm at 100% confidence
- Unmatchable strategies (negative correlation or systematic bias) are flagged with reasons
- Strategies existing only in backtest or only in actual are listed as unmatched
- MCP server version bumped
- CLI verification passes with real data
</success_criteria>

<output>
After completion, create `.planning/phases/38-strategy-matching/38-01-SUMMARY.md`
</output>
