---
phase: 11-research-architecture
plan: 02
type: execute
---

<objective>
Create a minimal working MCP server that proves the architecture - accepts commands via stdio, imports from lib/, and responds to tool calls.

Purpose: Validate the end-to-end architecture before building full tool suite in Phase 12.
Output: Working MCP server with list_backtests tool, testable via npx.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-research-architecture/11-RESEARCH.md
@.planning/phases/11-research-architecture/11-01-SUMMARY.md

**From research:**
- Use stdio transport (StdioServerTransport)
- Get backtest folder from command line args
- Log to stderr only (stdout reserved for JSON-RPC)
- Security: validate paths stay within allowed directory

**Code patterns from 11-RESEARCH.md:**
- See "Complete MCP Server Entry Point" example
- See "Pattern 2: Tool Registration" for tool structure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP server entry point with list_backtests tool</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Create packages/mcp-server/src/index.ts with:

1. Import MCP SDK:
   ```typescript
   import { Server } from "@modelcontextprotocol/sdk/server/index.js";
   import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
   import {
     CallToolRequestSchema,
     ListToolsRequestSchema,
   } from "@modelcontextprotocol/sdk/types.js";
   ```

2. Import Node.js modules:
   ```typescript
   import * as fs from "fs/promises";
   import * as path from "path";
   ```

3. Parse command line for backtest directory:
   ```typescript
   const backtestDir = process.argv[2];
   if (!backtestDir) {
     console.error("Usage: tradeblocks-mcp <backtests-folder>");
     console.error("Example: tradeblocks-mcp ~/backtests");
     process.exit(1);
   }
   const resolvedDir = path.resolve(backtestDir);
   ```

4. Create server and register list_backtests tool:
   - Tool lists all CSV files in the directory
   - Validate directory exists on startup
   - Return helpful error if directory missing

5. Handle CallToolRequest for list_backtests:
   - Read directory contents
   - Filter for .csv files
   - Return formatted list

6. Connect to stdio transport and start server

**What to avoid:**
- console.log() - use console.error() for all logging
- Sync file operations - use fs.promises
- Hardcoded paths - always use command line arg

**Minimal example (expand for production):**
```typescript
#!/usr/bin/env node
import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from "@modelcontextprotocol/sdk/types.js";
import * as fs from "fs/promises";
import * as path from "path";

const backtestDir = process.argv[2];
if (!backtestDir) {
  console.error("Usage: tradeblocks-mcp <backtests-folder>");
  process.exit(1);
}

const resolvedDir = path.resolve(backtestDir);

const server = new Server(
  { name: "tradeblocks-mcp", version: "0.1.0" },
  { capabilities: { tools: {} } }
);

server.setRequestHandler(ListToolsRequestSchema, async () => ({
  tools: [
    {
      name: "list_backtests",
      description: "List all CSV files available for analysis in the backtests folder",
      inputSchema: {
        type: "object" as const,
        properties: {},
        required: []
      }
    }
  ]
}));

server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name } = request.params;

  if (name === "list_backtests") {
    try {
      const files = await fs.readdir(resolvedDir);
      const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));

      if (csvFiles.length === 0) {
        return {
          content: [{
            type: "text",
            text: `No CSV files found in ${resolvedDir}\n\nDrop your backtest CSV files in this folder and try again.`
          }]
        };
      }

      return {
        content: [{
          type: "text",
          text: `Found ${csvFiles.length} backtest file(s):\n${csvFiles.map(f => `  - ${f}`).join('\n')}`
        }]
      };
    } catch (error) {
      return {
        content: [{
          type: "text",
          text: `Error reading directory: ${(error as Error).message}`
        }],
        isError: true
      };
    }
  }

  return {
    content: [{ type: "text", text: `Unknown tool: ${name}` }],
    isError: true
  };
});

async function main() {
  // Verify directory exists
  try {
    await fs.access(resolvedDir);
  } catch {
    console.error(`Error: Directory does not exist: ${resolvedDir}`);
    process.exit(1);
  }

  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error(`TradeBlocks MCP ready. Watching: ${resolvedDir}`);
}

main().catch((error) => {
  console.error("Fatal error:", error);
  process.exit(1);
});
```
  </action>
  <verify>
- File exists at packages/mcp-server/src/index.ts
- No console.log() calls (only console.error())
- TypeScript compiles: pnpm --filter tradeblocks-mcp build
  </verify>
  <done>MCP server entry point created with list_backtests tool</done>
</task>

<task type="auto">
  <name>Task 2: Build and test MCP server locally</name>
  <files>packages/mcp-server/dist/index.js</files>
  <action>
1. Install dependencies:
   ```bash
   cd packages/mcp-server && pnpm install
   ```

2. Build the server:
   ```bash
   pnpm --filter tradeblocks-mcp build
   ```

3. Verify build output:
   - dist/index.js exists
   - Has shebang (#!/usr/bin/env node) as first line
   - File is executable

4. Create test directory and CSV:
   ```bash
   mkdir -p /tmp/test-backtests
   echo "Date,P&L" > /tmp/test-backtests/test-strategy.csv
   ```

5. Test server manually using mcp CLI tool (if available) or echo test:
   ```bash
   # Test that server starts without error
   timeout 2 node packages/mcp-server/dist/index.js /tmp/test-backtests 2>&1 || true
   ```

   The server should print "TradeBlocks MCP ready" to stderr and wait for input.

6. Test with JSON-RPC request (advanced - optional):
   ```bash
   echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | node packages/mcp-server/dist/index.js /tmp/test-backtests
   ```
   Should return JSON with list_backtests tool.

**What to avoid:**
- Running without directory argument (should error)
- Using a non-existent directory (should error)
  </action>
  <verify>
- pnpm --filter tradeblocks-mcp build completes without errors
- dist/index.js exists and starts with shebang
- Server starts and prints ready message to stderr
  </verify>
  <done>MCP server builds and runs successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Minimal MCP server with list_backtests tool that:
- Takes a backtest folder path as argument
- Lists CSV files in that folder
- Uses stdio transport for Claude Desktop/Cowork compatibility
  </what-built>
  <how-to-verify>
1. Build the server:
   ```bash
   pnpm --filter tradeblocks-mcp build
   ```

2. Create a test folder with a CSV:
   ```bash
   mkdir -p ~/test-backtests
   cp tests/data/trade-log.csv ~/test-backtests/ 2>/dev/null || echo "Date,P&L" > ~/test-backtests/sample.csv
   ```

3. Test the server starts:
   ```bash
   node packages/mcp-server/dist/index.js ~/test-backtests
   ```
   You should see "TradeBlocks MCP ready. Watching: /Users/.../test-backtests" on stderr.
   Press Ctrl+C to stop.

4. (Optional) If you have Claude Desktop, configure it:
   - Edit ~/Library/Application Support/Claude/claude_desktop_config.json
   - Add:
     ```json
     {
       "mcpServers": {
         "tradeblocks": {
           "command": "node",
           "args": ["/path/to/tradeblocks/packages/mcp-server/dist/index.js", "/path/to/backtests"]
         }
       }
     }
     ```
   - Restart Claude Desktop
   - Ask Claude "What backtests are available?"

5. Confirm the architecture is working:
   - Server starts without errors
   - Ready message appears
   - No TypeScript errors during build
  </how-to-verify>
  <resume-signal>Type "approved" if server works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm --filter tradeblocks-mcp build succeeds
- [ ] dist/index.js has shebang
- [ ] Server starts and prints ready message
- [ ] Human verified architecture works
</verification>

<success_criteria>
- MCP server builds successfully
- Server starts with directory argument
- list_backtests tool is registered
- Human confirmed architecture is sound
- Phase 11 complete, ready for Phase 12 (Core Integration Layer)
</success_criteria>

<output>
After completion, create `.planning/phases/11-research-architecture/11-02-SUMMARY.md`:

# Phase 11 Plan 02: MCP Server Scaffold Summary

**[One-liner: what shipped]**

## Accomplishments

- Created MCP server entry point with list_backtests tool
- Configured stdio transport for Claude compatibility
- Validated build pipeline (TypeScript → tsup → dist)
- Verified server starts and responds to tool listing

## Files Created/Modified

- `packages/mcp-server/src/index.ts` - MCP server entry point
- `packages/mcp-server/dist/` - Build output

## Decisions Made

[Any runtime decisions made during execution]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 11 complete. Ready for Phase 12: Core Integration Layer
- Monorepo structure established
- MCP server scaffold working
- Next: Add analyze_backtest tool with lib/ imports
</output>
