---
phase: 11-research-architecture
plan: 01
type: execute
---

<objective>
Set up TradeBlocks as a monorepo with pnpm workspaces, creating the foundation for the MCP server package.

Purpose: Enable the MCP server to import shared calculation logic directly from lib/ while being independently publishable to npm.
Output: Working monorepo structure with packages/mcp-server/ scaffold and TypeScript/build configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-research-architecture/11-RESEARCH.md

**Architecture decision (from research):**
- Monorepo with pnpm workspaces
- MCP server at packages/mcp-server/
- Direct imports from lib/ (single source of truth)
- tsup bundles for npm distribution

**Key constraint:** TradeBlocks is currently NOT a monorepo. This plan converts it to one.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure pnpm workspace structure</name>
  <files>pnpm-workspace.yaml, package.json</files>
  <action>
1. Create pnpm-workspace.yaml at repo root with:
   ```yaml
   packages:
     - 'packages/*'
   ```

2. Update root package.json:
   - Keep existing scripts, dependencies, devDependencies
   - Add workspace-level scripts for MCP:
     ```json
     "scripts": {
       "build:mcp": "pnpm --filter tradeblocks-mcp build",
       "test:mcp": "pnpm --filter tradeblocks-mcp test"
     }
     ```
   - Do NOT add "private": true (breaks Next.js deployment)
   - Do NOT add "workspaces" field (that's npm syntax, we use pnpm-workspace.yaml)

3. Create packages/ directory (empty for now)

**What to avoid:**
- Adding "type": "module" to root package.json (keep current setup)
- Changing existing tsconfig.json (each package gets its own)
- Moving any existing files
  </action>
  <verify>
- pnpm-workspace.yaml exists and is valid YAML
- package.json has build:mcp and test:mcp scripts
- packages/ directory exists
- pnpm install still works (no breaking changes)
  </verify>
  <done>Workspace structure configured, existing app unaffected</done>
</task>

<task type="auto">
  <name>Task 2: Create MCP server package scaffold</name>
  <files>packages/mcp-server/package.json, packages/mcp-server/tsconfig.json, packages/mcp-server/tsup.config.ts, packages/mcp-server/.gitignore</files>
  <action>
1. Create packages/mcp-server/package.json:
   ```json
   {
     "name": "tradeblocks-mcp",
     "version": "0.1.0",
     "description": "MCP server for options trade analysis - works with Claude Desktop/Cowork",
     "type": "module",
     "main": "dist/index.js",
     "bin": {
       "tradeblocks-mcp": "dist/index.js"
     },
     "scripts": {
       "build": "tsup",
       "dev": "tsup --watch",
       "test": "echo 'Tests pending'",
       "prepublishOnly": "npm run build"
     },
     "dependencies": {
       "@modelcontextprotocol/sdk": "^1.11.0",
       "zod": "^3.24.0"
     },
     "devDependencies": {
       "tsup": "^8.4.0",
       "typescript": "^5.8.0",
       "@types/node": "^22.0.0"
     },
     "engines": {
       "node": ">=18"
     },
     "files": ["dist"],
     "keywords": ["mcp", "claude", "options", "trading", "backtest"],
     "license": "MIT",
     "repository": {
       "type": "git",
       "url": "https://github.com/davidromeo/tradeblocks",
       "directory": "packages/mcp-server"
     }
   }
   ```

2. Create packages/mcp-server/tsconfig.json:
   ```json
   {
     "compilerOptions": {
       "target": "ES2022",
       "module": "Node16",
       "moduleResolution": "Node16",
       "outDir": "./dist",
       "rootDir": "./src",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "declaration": true,
       "resolveJsonModule": true,
       "paths": {
         "@lib/*": ["../../lib/*"]
       }
     },
     "include": ["src/**/*"],
     "exclude": ["node_modules", "dist"]
   }
   ```

3. Create packages/mcp-server/tsup.config.ts:
   ```typescript
   import { defineConfig } from 'tsup';

   export default defineConfig({
     entry: ['src/index.ts'],
     format: ['esm'],
     target: 'node18',
     clean: true,
     dts: true,
     sourcemap: true,
     banner: {
       js: '#!/usr/bin/env node'
     },
     // Bundle lib/ imports into dist
     noExternal: [/^@lib\//]
   });
   ```

4. Create packages/mcp-server/.gitignore:
   ```
   dist/
   node_modules/
   ```

5. Create packages/mcp-server/src/ directory (empty, next plan populates)

**What to avoid:**
- Using CommonJS ("type": "commonjs") - MCP SDK requires ESM
- Bundling SDK dependencies (they should be external)
- Complex tsconfig extends chain
  </action>
  <verify>
- All files created with correct content
- pnpm install in packages/mcp-server/ succeeds
- TypeScript can be invoked: pnpm --filter tradeblocks-mcp exec tsc --version
  </verify>
  <done>MCP server package scaffold complete with build tooling configured</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm install at root succeeds
- [ ] packages/mcp-server/ has package.json, tsconfig.json, tsup.config.ts
- [ ] pnpm --filter tradeblocks-mcp exec tsc --version returns TypeScript version
- [ ] Existing app still works: npm run build succeeds
</verification>

<success_criteria>
- Monorepo structure established
- MCP server package scaffold exists
- Build tooling configured
- No regression to existing TradeBlocks app
</success_criteria>

<output>
After completion, create `.planning/phases/11-research-architecture/11-01-SUMMARY.md`
</output>
