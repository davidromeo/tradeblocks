---
phase: 63-tool-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/utils/schema-metadata.ts
  - packages/mcp-server/src/utils/field-timing.ts
  - packages/mcp-server/src/utils/data-availability.ts
  - packages/mcp-server/src/test-exports.ts
  - packages/mcp-server/tests/unit/field-timing.test.ts
  - packages/mcp-server/src/db/market-schemas.ts
autonomous: true
requirements: [MIG-06, MIG-07, MIG-09, MIG-10]

must_haves:
  truths:
    - "SCHEMA_DESCRIPTIONS.market.tables has 'daily', 'context', and 'intraday' keys (not spx_daily, spx_15min, vix_intraday)"
    - "Every column in daily and context tables (except date, ticker) has a timing annotation (open, close, or static)"
    - "OPEN_KNOWN_FIELDS merges open-known fields from both daily (including Prior_Range_vs_ATR) and context tables"
    - "CLOSE_KNOWN_FIELDS merges close-derived fields from both daily and context tables"
    - "buildLookaheadFreeQuery JOINs market.daily and market.context before applying LAG, partitioned by ticker"
    - "checkDataAvailability returns actionable warnings when daily, context, or intraday data is missing"
    - "field-timing.test.ts passes with updated field counts matching the new schema"
  artifacts:
    - path: "packages/mcp-server/src/utils/schema-metadata.ts"
      provides: "New table descriptions for daily, context, intraday with timing annotations"
      contains: "tables.daily"
    - path: "packages/mcp-server/src/utils/field-timing.ts"
      provides: "Dual-table derived field sets and JOIN-aware LAG CTE builder"
      contains: "market.daily"
    - path: "packages/mcp-server/src/utils/data-availability.ts"
      provides: "checkDataAvailability helper for all market tools"
      exports: ["checkDataAvailability"]
    - path: "packages/mcp-server/tests/unit/field-timing.test.ts"
      provides: "Updated field count assertions for new schema"
  key_links:
    - from: "packages/mcp-server/src/utils/field-timing.ts"
      to: "packages/mcp-server/src/utils/schema-metadata.ts"
      via: "SCHEMA_DESCRIPTIONS import"
      pattern: "SCHEMA_DESCRIPTIONS\\.market\\.tables\\.(daily|context)"
    - from: "packages/mcp-server/src/utils/field-timing.ts"
      to: "market.daily JOIN market.context"
      via: "SQL template in buildLookaheadFreeQuery"
      pattern: "LEFT JOIN market\\.context"
---

<objective>
Rewrite the shared query foundation (schema-metadata, field-timing, data-availability) for the new normalized schema so all downstream tools can build correct JOIN-aware queries.

Purpose: The old schema had one wide table (spx_daily) with 55 columns. The new schema splits into daily (per-ticker indicators) and context (global VIX/regime). Field-timing sets and the LAG CTE builder must be updated to source from both tables and JOIN them correctly before LAG application.

Output: Updated schema-metadata.ts, field-timing.ts, new data-availability.ts helper, updated test-exports.ts, passing field-timing.test.ts
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/63-tool-migration/63-CONTEXT.md
@.planning/phases/63-tool-migration/63-RESEARCH.md
@packages/mcp-server/src/utils/schema-metadata.ts
@packages/mcp-server/src/utils/field-timing.ts
@packages/mcp-server/src/db/market-schemas.ts
@packages/mcp-server/tests/unit/field-timing.test.ts
@packages/mcp-server/src/test-exports.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite schema-metadata.ts with new table structure</name>
  <files>
    packages/mcp-server/src/utils/schema-metadata.ts
    packages/mcp-server/src/db/market-schemas.ts
  </files>
  <action>
**First: Add `Prior_Range_vs_ATR` column to `market.daily` in `market-schemas.ts`:**

The `Prior_Range_vs_ATR` field was designed in the market-data-separation plan but never added to the schema (documented as a schema gap in `market-enricher.ts` line 691). Per locked user decision, `enrich_trades` must expose this field. Add it to the CREATE TABLE:

In `packages/mcp-server/src/db/market-schemas.ts`, add `Prior_Range_vs_ATR DOUBLE,` after `Prev_Return_Pct DOUBLE,` in the `market.daily` CREATE TABLE statement (in the Tier 1 enrichment section). This is the prior trading day's (high - low) / ATR ratio, known at market open.

**Then: Rewrite schema-metadata.ts** — Replace the market tables section of SCHEMA_DESCRIPTIONS to use the new normalized schema. The trades schema is unchanged.

**Replace `market.tables`** with three new tables:

1. **`daily`** — Per-ticker OHLCV + Tier 1 enrichment + calendar fields. All columns from `market-schemas.ts` `market.daily` CREATE TABLE (including the newly added `Prior_Range_vs_ATR`). Source of truth for column list: `packages/mcp-server/src/db/market-schemas.ts`.
   - Key columns: `["ticker", "date", "RSI_14", "ATR_Pct", "BB_Position", "BB_Width", "Realized_Vol_20D"]`
   - Column descriptions ported from old `spx_daily` where they match (e.g., `open`, `high`, `close`, `Prior_Close`, `Gap_Pct`, etc.)
   - NEW columns that need descriptions: `BB_Width` ("Bollinger Band width (upper - lower) / middle, measures volatility compression"), `Realized_Vol_5D` ("5-day realized volatility (annualized standard deviation of log returns)"), `Realized_Vol_20D` ("20-day realized volatility (annualized standard deviation of log returns)"), `Prior_Range_vs_ATR` ("Prior trading day's (high - low) / ATR ratio, measures prior day's range relative to average true range")
   - Timing annotations: see research section "New timing annotation counts" — daily has 5 open-known (open, Prior_Close, Gap_Pct, Prev_Return_Pct, Prior_Range_vs_ATR), 18 close-derived (high, low, close, ATR_Pct, RSI_14, Price_vs_EMA21_Pct, Price_vs_SMA50_Pct, BB_Position, BB_Width, Realized_Vol_5D, Realized_Vol_20D, Return_5D, Return_20D, Intraday_Range_Pct, Intraday_Return_Pct, Close_Position_In_Range, Gap_Filled, Consecutive_Days), 3 static (Day_of_Week, Month, Is_Opex)
   - NOTE: `Prior_Range_vs_ATR` is `timing: 'open'` because it uses the prior day's range and ATR, both known at market open
   - Also include Tier 3 timing columns that ARE in market-schemas.ts: High_Time (close), Low_Time (close), High_Before_Low (close), Reversal_Type (close) — these are present in the schema even though Tier 3 enrichment is deferred (the columns exist and might be populated later)
   - DO NOT include columns NOT in market-schemas.ts, specifically: Total_Return_Pct, High_In_First_Hour, Low_In_First_Hour, High_In_Last_Hour, Low_In_Last_Hour, High_Low_Spread, Early_Extreme, Late_Extreme, Intraday_High, Intraday_Low — these were in old spx_daily but are NOT in the new market.daily schema
   - `ticker` and `date` columns: no timing annotation (same as before for key columns)

2. **`context`** — Global VIX/regime data. All columns from `market-schemas.ts` `market.context` CREATE TABLE (lines 82-107).
   - Key columns: `["date", "Vol_Regime", "VIX_Close", "Term_Structure_State", "VIX_Percentile"]`
   - Column descriptions ported from old `spx_daily` VIX columns
   - Timing annotations: 4 open-known (VIX_Open, VIX_Gap_Pct, VIX9D_Open, VIX3M_Open), 14 close-derived (VIX_Close, VIX_High, VIX_Low, VIX_Change_Pct, VIX9D_Close, VIX9D_Change_Pct, VIX3M_Close, VIX3M_Change_Pct, VIX9D_VIX_Ratio, VIX_VIX3M_Ratio, Vol_Regime, Term_Structure_State, VIX_Percentile, VIX_Spike_Pct)
   - `date` column: no timing annotation

3. **`intraday`** — Unpivoted bar data. Columns from `market-schemas.ts` `market.intraday` CREATE TABLE (lines 111-124).
   - Key columns: `["ticker", "date", "time"]`
   - Columns: ticker, date, time ("Bar time in HH:MM Eastern Time format"), open, high, low, close
   - NO timing annotations (intraday data is not classified into the open/close timing model)
   - Description: "Raw intraday bars per ticker. One row per bar (any resolution). Use for ORB calculations and intraday context enrichment."

**Also update `EXAMPLE_QUERIES`** — replace all `market.spx_daily` references with `market.daily` and `market.context` JOINs. Replace `market.spx_15min` references with `market.intraday`. Replace `market.vix_intraday` references with `market.intraday WHERE ticker = 'VIX'`. Update JOIN patterns to use the dual-table LAG CTE pattern from 63-RESEARCH.md. Keep the same categories (basic, joins, hypothesis) but with corrected SQL.

**Update the module docstring** to reference the new tables.

Important: Do NOT include the old `spx_daily`, `spx_15min`, or `vix_intraday` tables. Clean break per user decision.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/mcp-server/tsconfig.json` to check TypeScript compilation. Confirm no references to `spx_daily`, `spx_15min`, or `vix_intraday` remain in the file with grep.
  </verify>
  <done>
market-schemas.ts has `Prior_Range_vs_ATR DOUBLE` column in market.daily CREATE TABLE. schema-metadata.ts has `daily`, `context`, and `intraday` table descriptions with correct timing annotations matching market-schemas.ts columns (including Prior_Range_vs_ATR as timing: 'open'). Example queries reference new table names with JOIN patterns. Zero references to old table names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite field-timing.ts with dual-table derivation and JOIN-aware CTE + create data-availability.ts</name>
  <files>
    packages/mcp-server/src/utils/field-timing.ts
    packages/mcp-server/src/utils/data-availability.ts
    packages/mcp-server/src/test-exports.ts
  </files>
  <action>
**field-timing.ts rewrite:**

Replace the single-table derivation with dual-table derivation:

```typescript
const dailyColumns = SCHEMA_DESCRIPTIONS.market.tables.daily.columns;
const contextColumns = SCHEMA_DESCRIPTIONS.market.tables.context.columns;
```

Derive combined sets that merge from both tables:
- `OPEN_KNOWN_FIELDS`: union of timing='open' from daily + context
- `CLOSE_KNOWN_FIELDS`: union of timing='close' from daily + context
- `STATIC_FIELDS`: union of timing='static' from daily + context

Also export table-specific sets (needed by the CTE builder to know which fields come from which table):
- `DAILY_OPEN_FIELDS`, `DAILY_CLOSE_FIELDS`, `DAILY_STATIC_FIELDS`
- `CONTEXT_OPEN_FIELDS`, `CONTEXT_CLOSE_FIELDS`

**buildLookaheadFreeQuery rewrite:**

Both overloads (string[] and MarketLookupKey[]) must produce a CTE that:
1. JOINs `market.daily d LEFT JOIN market.context c ON d.date = c.date`
2. Passes through open-known fields from daily (as `d.{field}`) and context (as `c.{field}`)
3. Passes through static fields from daily (as `d.{field}`)
4. Applies LAG() to close-derived fields from BOTH tables, PARTITIONED BY d.ticker, ORDER BY d.date
5. For the string[] overload (legacy), filter `WHERE d.ticker = DEFAULT_MARKET_TICKER` (single ticker)
6. For the MarketLookupKey[] overload, filter by `WHERE d.ticker IN (SELECT DISTINCT ticker FROM requested)` and final JOIN to requested pairs

The LAG column aliases use `prev_{field}` pattern regardless of source table. Fields from context table in the LAG CTE should reference `c.{field}` in the joined CTE and `LAG("{field}")` in the lagged CTE.

Important: The `joined` CTE must scan the FULL ticker history (all trading days), NOT just requested dates. Only the final SELECT filters to requested dates. This ensures LAG sees the correct prior trading day.

**buildOutcomeQuery rewrite:**

Update both overloads to query from `market.daily d LEFT JOIN market.context c ON d.date = c.date`, selecting close-derived fields from BOTH tables. No LAG needed (same-day values).

**data-availability.ts (new file):**

Create `packages/mcp-server/src/utils/data-availability.ts`:

```typescript
export interface DataAvailabilityReport {
  hasDailyData: boolean;
  hasContextData: boolean;
  hasIntradayData: boolean;
  dailyDateRange: { min: string; max: string } | null;
  contextDateRange: { min: string; max: string } | null;
  intradayDateRange: { min: string; max: string } | null;
  warnings: string[];
}

export async function checkDataAvailability(
  conn: DuckDBConnection,
  ticker: string,
  options?: { checkIntraday?: boolean }
): Promise<DataAvailabilityReport>
```

Implementation:
- Query `SELECT COUNT(*) as cnt, MIN(date) as min_date, MAX(date) as max_date FROM market.daily WHERE ticker = $1`
- Query `SELECT COUNT(*) as cnt, MIN(date) as min_date, MAX(date) as max_date FROM market.context`
- If `options.checkIntraday`, query `SELECT COUNT(*) as cnt, MIN(date) as min_date, MAX(date) as max_date FROM market.intraday WHERE ticker = $1`
- Build `warnings` array with actionable messages:
  - Missing daily: `"No market.daily data for ticker ${ticker}. Import daily OHLCV with import_market_csv (target_table: \"daily\", ticker: \"${ticker}\")."`
  - Missing context: `"No market.context data (VIX/regime). Import VIX data with import_market_csv (target_table: \"context\") then run enrich_market_data for tier 2 enrichment."`
  - Missing intraday: `"No market.intraday data for ticker ${ticker}. Import intraday bars with import_market_csv (target_table: \"intraday\", ticker: \"${ticker}\")."`

**test-exports.ts update:**

Add exports for:
- `checkDataAvailability` and `DataAvailabilityReport` from `./utils/data-availability.js`
- `DAILY_OPEN_FIELDS`, `DAILY_CLOSE_FIELDS`, `DAILY_STATIC_FIELDS`, `CONTEXT_OPEN_FIELDS`, `CONTEXT_CLOSE_FIELDS` from `./utils/field-timing.js` (if exported for tests)

Important: Remove the old `spxColumns` reference pattern. The field-timing.ts must NOT reference `spx_daily` anywhere.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/mcp-server/tsconfig.json` to verify compilation. Grep for `spx_daily` in modified files to confirm zero references.
  </verify>
  <done>
field-timing.ts derives field sets from both daily and context tables. buildLookaheadFreeQuery produces a JOIN CTE with LAG applied to the joined result. data-availability.ts provides checkDataAvailability with actionable warnings. test-exports.ts exports new utilities. Zero references to old table names.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update field-timing.test.ts for new schema counts and build + test</name>
  <files>packages/mcp-server/tests/unit/field-timing.test.ts</files>
  <action>
Update field-timing.test.ts to reflect the new dual-table schema:

1. **Update the import source reference:** Change `const spxColumns = SCHEMA_DESCRIPTIONS.market.tables.spx_daily.columns;` to reference both tables:
   ```typescript
   const dailyColumns = SCHEMA_DESCRIPTIONS.market.tables.daily.columns;
   const contextColumns = SCHEMA_DESCRIPTIONS.market.tables.context.columns;
   ```

2. **Update "every classified column has timing" test:** Iterate over BOTH `dailyColumns` and `contextColumns`, checking that every non-key column (excluding `date`, `ticker`, `time`) has a timing annotation.

3. **Update count assertions:**
   - Total classified columns: count all columns with timing from both tables. Expected: Daily has 5 open (open, Prior_Close, Gap_Pct, Prev_Return_Pct, Prior_Range_vs_ATR) + 22 close (18 Tier 1 + 4 Tier 3) + 3 static = 30 classified. Context has 4 open + 14 close = 18 classified. Total = 30 + 18 = 48 classified. BUT verify by actually counting from the schema-metadata.ts written in Task 1 — the exact count must match.
   - `OPEN_KNOWN_FIELDS.size`: should be 5 (daily: open, Prior_Close, Gap_Pct, Prev_Return_Pct, Prior_Range_vs_ATR) + 4 (context) = 9
   - `CLOSE_KNOWN_FIELDS.size`: should be 22 (daily: high, low, close, ATR_Pct, RSI_14, Price_vs_EMA21_Pct, Price_vs_SMA50_Pct, BB_Position, BB_Width, Realized_Vol_5D, Realized_Vol_20D, Return_5D, Return_20D, Intraday_Range_Pct, Intraday_Return_Pct, Close_Position_In_Range, Gap_Filled, Consecutive_Days, High_Time, Low_Time, High_Before_Low, Reversal_Type) + 14 (context) = 36
   - `STATIC_FIELDS.size`: should be 3
   - Total: 9 + 36 + 3 = 48

   IMPORTANT: The exact numbers above are estimates from the research. After Task 1 writes schema-metadata.ts, COUNT the actual columns with timing annotations to get the precise numbers. If they differ, use the actual counts.

4. **Update specific classification tests:**
   - Keep Return_5D, Return_20D as close-derived (still in daily)
   - Keep Prev_Return_Pct as open-known (still in daily)
   - Keep Consecutive_Days as close-derived (still in daily)
   - Add: `BB_Width is close-derived`, `Realized_Vol_5D is close-derived`, `Vol_Regime is close-derived` (now from context)
   - Add: `VIX_Open is open-known` (now from context), `VIX_Gap_Pct is open-known` (now from context)
   - Add: `Prior_Range_vs_ATR is open-known` (new field in daily, prior day's range/ATR known at open)

5. **Update buildLookaheadFreeQuery tests:**
   - Change `FROM market.spx_daily` expectations to `FROM market.daily` and `LEFT JOIN market.context`
   - Legacy string[] overload should produce SQL with `market.daily d LEFT JOIN market.context c ON d.date = c.date`
   - MarketLookupKey[] overload should produce SQL with `PARTITION BY` and ticker filtering
   - LAG columns should still have `prev_` prefix
   - Open-known fields should NOT be in LAG()
   - Context fields (e.g., Vol_Regime) should appear in LAG as close-derived

6. **Update buildOutcomeQuery tests:**
   - Change `FROM market.spx_daily` expectations to `FROM market.daily` and `LEFT JOIN market.context`
   - Should include close-derived fields from BOTH daily and context

7. **Build and test:**
   ```bash
   cd packages/mcp-server && npm run build && npm test -- tests/unit/field-timing.test.ts
   ```

Important: The test file imports from `../../dist/test-exports.js` which is the compiled output. A build is REQUIRED before tests will reflect changes. Always build before running tests.
  </action>
  <verify>
`cd packages/mcp-server && npm run build && npm test -- tests/unit/field-timing.test.ts` — all tests pass.
  </verify>
  <done>
field-timing.test.ts passes with correct field counts for the new dual-table schema. All classification tests verify fields from both daily and context. buildLookaheadFreeQuery tests confirm JOIN pattern. Zero references to spx_daily in test file.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/mcp-server/tsconfig.json` — no type errors
2. `cd packages/mcp-server && npm run build && npm test -- tests/unit/field-timing.test.ts` — all tests pass
3. `grep -r "spx_daily\|spx_15min\|vix_intraday" packages/mcp-server/src/utils/schema-metadata.ts packages/mcp-server/src/utils/field-timing.ts packages/mcp-server/src/utils/data-availability.ts packages/mcp-server/tests/unit/field-timing.test.ts` — zero matches
4. `grep "Prior_Range_vs_ATR" packages/mcp-server/src/db/market-schemas.ts packages/mcp-server/src/utils/schema-metadata.ts` — present in both files
</verification>

<success_criteria>
- schema-metadata.ts has daily, context, intraday table descriptions with correct timing annotations
- field-timing.ts derives field sets from both daily and context tables
- buildLookaheadFreeQuery JOINs market.daily + market.context inside CTE before LAG
- checkDataAvailability helper exists with actionable warning messages
- field-timing.test.ts passes with updated counts
- Zero references to old table names in any modified file
</success_criteria>

<output>
After completion, create `.planning/phases/63-tool-migration/63-01-SUMMARY.md`
</output>
