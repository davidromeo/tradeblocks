---
phase: 03-input-validation-fixes
plan: 01
type: execute
---

<objective>
Fix WFA numeric input validation to allow smaller values AND enable free text editing (delete and retype).

Purpose: Enable users to test with shorter windows, fewer trades, and finer granularity. Also fix the UX issue where HTML5 validation blocks deleting and retyping values.
Output: Updated period-selector.tsx with relaxed constraints AND improved input editing behavior.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-input-validation-fixes/03-CONTEXT.md
@.planning/phases/02-parameter-selection-ui/02-01-SUMMARY.md

# Key file to modify:
@components/walk-forward/period-selector.tsx

**Tech stack available:** Next.js 15, React, shadcn/ui, Radix UI
**Established patterns:** HoverCard tooltips, Collapsible sections

**Constraining decisions:**
- Phase 2: Parameters disabled by default (opt-in model)
- Keep scope minimal - just fix constraints, nothing extra

**Prior context from 03-CONTEXT.md:**
- Relax minimum constraints on all WFA numeric inputs
- Keep sensible defaults that guide users to good choices
- Don't over-engineer

**Key UX issue (from user):**
HTML5 number inputs with `min` attributes block users from deleting the value and typing a new number. The input validates on every keystroke, rejecting intermediate states. Need to use string state for display with validation on blur.

**Pattern from CLAUDE.md:**
```typescript
const [value, setValue] = useState<number>(10)           // Actual validated value
const [inputValue, setInputValue] = useState<string>("10") // String for input display

const handleBlur = () => {
  const val = parseInt(inputValue, 10)
  if (!isNaN(val) && val >= min && val <= max) {
    setValue(val)
    setInputValue(String(val))
  } else {
    setInputValue(String(value)) // Revert to last valid value
  }
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix window configuration inputs (IS/OOS/Step days)</name>
  <files>components/walk-forward/period-selector.tsx</files>
  <action>
Create a reusable pattern for the 3 main window inputs that allows free text editing:

1. **Add local string state for each input** at the component level:
```typescript
// Window configuration input states (for free text editing)
const [inSampleInput, setInSampleInput] = useState(String(config.inSampleDays))
const [outOfSampleInput, setOutOfSampleInput] = useState(String(config.outOfSampleDays))
const [stepSizeInput, setStepSizeInput] = useState(String(config.stepSizeDays))
```

2. **Sync state when config changes externally** (e.g., presets):
```typescript
useEffect(() => {
  setInSampleInput(String(config.inSampleDays))
  setOutOfSampleInput(String(config.outOfSampleDays))
  setStepSizeInput(String(config.stepSizeDays))
}, [config.inSampleDays, config.outOfSampleDays, config.stepSizeDays])
```

3. **Update each input** to use string state with blur validation:

**In-Sample Days** (~line 365-370):
- Remove `min={10}` attribute (or keep for browser tooltip hint only)
- Change `value={config.inSampleDays}` to `value={inSampleInput}`
- Change `onChange` to `onChange={(e) => setInSampleInput(e.target.value)}`
- Add `onBlur` handler that validates (min=1), clamps, and updates config
- Add `onKeyDown` to validate on Enter

**Out-of-Sample Days** (~line 398-403):
- Same pattern, min=1

**Step Size Days** (~line 432-437):
- Same pattern, min=1

4. **New minimums:**
- In-Sample Days: min=1 (was 10)
- Out-of-Sample Days: min=1 (was 5)
- Step Size Days: min=1 (already was 1)

5. **Validation logic for blur handler:**
```typescript
const handleInSampleBlur = () => {
  const val = parseInt(inSampleInput, 10)
  if (!isNaN(val) && val >= 1) {
    updateConfig({ inSampleDays: val })
    setInSampleInput(String(val))
  } else {
    // Revert to last valid value
    setInSampleInput(String(config.inSampleDays))
  }
}
```
  </action>
  <verify>
    - `npm run typecheck` passes
    - No ESLint errors
  </verify>
  <done>
    - In-Sample Days: accepts typing any value, validates on blur, allows 1+
    - Out-of-Sample Days: accepts typing any value, validates on blur, allows 1+
    - Step Size Days: accepts typing any value, validates on blur, allows 1+
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining numeric inputs (Min Trades, Sliders, Weight Step)</name>
  <files>components/walk-forward/period-selector.tsx</files>
  <action>
Apply the same pattern to other inputs that need fixing, and relax slider minimums:

**Min IS Trades** (~line 608-615):
- Current min=5, change to min=1
- Apply string state pattern with blur validation
- Use local state `minISTradesInput`

**Min OOS Trades** (~line 641-648):
- Already min=1, but apply string state pattern for consistency
- Use local state `minOOSTradesInput`

**Sliders - just update min values** (no string state needed for sliders):

**Max Correlation Slider** (~line 936):
- Change `min={0.3}` to `min={0.1}`
- Slider handles drag natively, no UX issue

**Max Tail Dependence Slider** (~line 1019):
- Change `min={0.2}` to `min={0.1}`

**Weight Sweep Step inputs** (~line 1284):
- Change `min={0.05}` to `min={0.01}`
- These are in a map, apply string state pattern if causing issues OR just update min attribute

For Weight Sweep inputs in the map: Since these are rendered per-strategy in a loop, consider adding local state management within the map or accepting that the min attribute change alone may be sufficient for these less-frequently-edited inputs.

**Prioritize:** The main window inputs (Task 1) are most critical. Task 2 inputs are secondary.
  </action>
  <verify>
    - `npm run typecheck` passes
    - No ESLint errors
  </verify>
  <done>
    - Min IS Trades: accepts values from 1, free text editing works
    - Min OOS Trades: free text editing works
    - Max Correlation slider: allows 0.1 minimum
    - Max Tail Dependence slider: allows 0.1 minimum
    - Weight Sweep Step: accepts values from 0.01
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed numeric input validation with relaxed constraints and free text editing</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Visit: http://localhost:3000/walk-forward

    **Test free text editing (most important):**
    3. In-Sample Days field:
       - Select all text (Cmd+A) and delete
       - Type "5" - should accept without validation error
       - Tab away - value should update to 5
    4. Out-of-Sample Days field:
       - Delete entire value, type "2" - should work smoothly
    5. Step Size Days field:
       - Clear and type "3" - should work

    **Test new minimums:**
    6. In-Sample Days: Enter "1" - should be accepted (was blocked at 10)
    7. Out-of-Sample Days: Enter "1" - should be accepted (was blocked at 5)

    **Test sliders:**
    8. Select diversification target, enable Correlation Constraint
       - Drag slider to leftmost position - should show 0.1 (was 0.3)
    9. Enable Tail Risk Constraint
       - Max Tail Dependence slider leftmost - should show 0.1 (was 0.2)

    **Test edge cases:**
    10. Enter invalid value (like "abc") in In-Sample Days, tab away
        - Should revert to previous valid value
    11. Enter 0 in In-Sample Days, tab away
        - Should either clamp to 1 or revert

    **Verify defaults unchanged:**
    12. Refresh page - defaults should be same as before (In-Sample ~45, etc.)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes
- [ ] All main inputs support free text editing (delete and retype)
- [ ] New minimums work: IS=1, OOS=1, Min IS Trades=1
- [ ] Slider minimums relaxed: Correlation=0.1, Tail=0.1
- [ ] Weight Step minimum relaxed: 0.01
- [ ] Invalid input reverts to last valid value on blur
- [ ] Default values unchanged
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Users can freely delete and retype values in all WFA inputs
- Users can enter smaller values (min=1 for days/trades)
- Sensible defaults preserved
  </success_criteria>

<output>
After completion, create `.planning/phases/03-input-validation-fixes/03-01-SUMMARY.md` following the summary template.
</output>
