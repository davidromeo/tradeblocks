---
phase: 43-query-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/sql.ts
  - packages/mcp-server/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Claude can execute SELECT queries via run_sql tool"
    - "Queries return results as array of objects with column metadata"
    - "Dangerous SQL patterns (INSERT, DROP, COPY, etc.) are blocked with helpful error"
    - "Query timeout after 30 seconds returns clear error message"
    - "Unknown table/column errors suggest available alternatives"
    - "Results are limited to max 1000 rows with truncation metadata"
  artifacts:
    - path: "packages/mcp-server/src/tools/sql.ts"
      provides: "run_sql tool with validation, timeout, and error handling"
      exports: ["registerSQLTools"]
      min_lines: 150
    - path: "packages/mcp-server/src/index.ts"
      provides: "SQL tool registration"
      contains: "registerSQLTools"
  key_links:
    - from: "packages/mcp-server/src/tools/sql.ts"
      to: "packages/mcp-server/src/db/connection.ts"
      via: "getConnection() for DuckDB access"
      pattern: "getConnection\\(baseDir\\)"
    - from: "packages/mcp-server/src/tools/sql.ts"
      to: "packages/mcp-server/src/sync/index.ts"
      via: "withFullSync middleware for pre-query sync"
      pattern: "withFullSync"
---

<objective>
Implement the run_sql MCP tool that allows Claude to execute arbitrary SELECT queries against the DuckDB analytics database.

Purpose: Enables Claude to perform ad-hoc analysis, hypothesis testing, and data exploration across trades and market data using SQL, unlocking flexible analytics beyond the rigid query tools.

Output: Working run_sql MCP tool with security sandbox, timeout protection, and helpful error messages.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Phase-specific context:
@.planning/phases/43-query-interface/43-CONTEXT.md
@.planning/phases/43-query-interface/43-RESEARCH.md

Reference implementations:
@packages/mcp-server/src/tools/reports/queries.ts (tool registration pattern)
@packages/mcp-server/src/tools/middleware/sync-middleware.ts (withFullSync pattern)
@packages/mcp-server/src/db/connection.ts (getConnection pattern)
@packages/mcp-server/src/utils/output-formatter.ts (createToolOutput pattern)
@packages/mcp-server/src/db/schemas.ts (available tables reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement run_sql tool</name>
  <files>packages/mcp-server/src/tools/sql.ts</files>
  <action>
Create the run_sql MCP tool in a new sql.ts file with these components:

**1. SQL Validation (DANGEROUS_PATTERNS blocklist)**
Block these patterns with RegEx before execution:
- Write operations: INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, TRUNCATE
- External access: COPY, EXPORT, ATTACH, DETACH
- File functions: read_csv(, read_parquet(, read_json(, read_text(, write_csv(
- Config changes: SET

Return helpful error: `"{operation} operations are not allowed. This tool only supports SELECT queries for read-only data analysis."`

**2. Query Execution with Timeout**
Implement `executeWithTimeout(conn, sql, limit, timeoutMs)`:
- Use Promise.race with 30-second timeout
- If query has no LIMIT clause, append `LIMIT {limit}` (default 100, max 1000)
- Timeout error message: "Query exceeded 30s timeout. Consider adding LIMIT or filtering by block_id."
- Return: `{ rows: Record<string, unknown>[], columns: { name: string, type: string }[] }`

**3. Error Enhancement**
Implement `enhanceError(error)` to suggest alternatives:
- Table not found: List available tables (trades.trade_data, market.spx_daily, market.spx_15min, market.spx_highlow, market.vix_intraday)
- Column not found: Suggest using `DESCRIBE trades.trade_data;` to see available columns
- Syntax errors: Pass through verbatim (DuckDB includes line/column info)
- Timeout: Return message as-is (already includes suggestion)

**4. Tool Registration**
Implement `registerSQLTools(server, baseDir)`:
- Tool name: "run_sql"
- Description: "Execute a SQL SELECT query against the DuckDB analytics database. Query trades (trades.trade_data) and market data (market.spx_daily, market.spx_15min, market.spx_highlow, market.vix_intraday). Returns up to 1000 rows."
- Input schema (Zod):
  - query: z.string() - SQL SELECT query to execute
  - limit: z.number().min(1).max(1000).default(100) - Maximum rows (default 100)
- Use `withFullSync(baseDir, handler)` to sync all blocks/market data before query
- On success: Use `createToolOutput(summary, structuredData)` with:
  - summary: "Query returned N row(s)"
  - structuredData: `{ rows, columns, totalRows, returnedRows, truncated }`
- On validation error: Return `{ content: [{ type: "text", text: error }], isError: true }`
- On execution error: Return enhanced error using `enhanceError()`

**Implementation notes:**
- Import DuckDBConnection type from @duckdb/node-api
- Use getConnection(baseDir) from ../db/connection.js
- Use withFullSync from ./middleware/sync-middleware.js
- Use createToolOutput from ../utils/output-formatter.js
- Export registerSQLTools for use in index.ts
  </action>
  <verify>
TypeScript compiles: `npm run build -w packages/mcp-server`
  </verify>
  <done>
- sql.ts exists with registerSQLTools export
- DANGEROUS_PATTERNS blocks INSERT/UPDATE/DELETE/DROP/CREATE/ALTER/COPY/EXPORT/ATTACH/SET/file functions
- executeWithTimeout implements Promise.race with 30s timeout
- enhanceError suggests alternatives for table/column not found
- Tool registered with correct schema and description
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire into MCP server and verify</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
**1. Add import:**
```typescript
import { registerSQLTools } from "./tools/sql.js";
```

**2. Add registration call** (after other tool registrations):
```typescript
registerSQLTools(server, baseDir);
```

**3. Verify with CLI test mode:**
Test successful query:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "SELECT COUNT(*) as count FROM trades.trade_data"}'
```

Test dangerous pattern blocking:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "DROP TABLE trades.trade_data"}'
```
Expected: Error message about DROP not being allowed

Test unknown table suggestion:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "SELECT * FROM nonexistent_table"}'
```
Expected: Error with list of available tables

Test limit parameter:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "SELECT * FROM trades.trade_data", "limit": 5}'
```
Expected: Returns max 5 rows
  </action>
  <verify>
- `npm run build -w packages/mcp-server` succeeds
- CLI test for COUNT query returns result
- CLI test for DROP shows blocked error
- CLI test for unknown table lists alternatives
  </verify>
  <done>
- run_sql tool is callable via MCP server
- Dangerous patterns are blocked at runtime
- Unknown tables show available alternatives
- Limit parameter caps row count
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification:**
   ```bash
   npm run build -w packages/mcp-server
   npm run typecheck
   ```

2. **Functional tests via CLI:**
   ```bash
   # Basic query works
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "SELECT block_id, COUNT(*) as trade_count FROM trades.trade_data GROUP BY block_id"}'

   # JOIN query works (SQL-02)
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "SELECT t.block_id, t.date_opened, m.VIX_Open FROM trades.trade_data t JOIN market.spx_daily m ON t.date_opened = m.date LIMIT 5"}'

   # Cross-block query works (SQL-03)
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "SELECT block_id, SUM(pl) as total_pl FROM trades.trade_data GROUP BY block_id"}'

   # Dangerous SQL blocked (SQL-06)
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_sql '{"query": "COPY trades.trade_data TO 'output.csv'"}'
   # Expected: Error about COPY not allowed
   ```

3. **Requirements checklist:**
   - [x] SQL-01: run_sql accepts SQL query string
   - [x] SQL-02: Queries can JOIN trades with market data
   - [x] SQL-03: Cross-block queries work
   - [x] SQL-04: Results limited with configurable limit
   - [x] SQL-05: Helpful error messages
   - [x] SQL-06: Dangerous patterns blocked
</verification>

<success_criteria>
1. run_sql MCP tool is registered and callable
2. SELECT queries execute successfully and return results
3. Dangerous operations (INSERT, DROP, COPY, etc.) are blocked with helpful error
4. Unknown tables/columns trigger suggestion of available alternatives
5. Results include truncation metadata (totalRows, returnedRows, truncated)
6. Timeout after 30 seconds with clear error message
7. TypeScript builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-query-interface/43-01-SUMMARY.md`
</output>
