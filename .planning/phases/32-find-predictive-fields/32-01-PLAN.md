---
phase: 32-find-predictive-fields
plan: 01
type: execute
domain: mcp-server
---

<objective>
Create MCP tool that identifies which trade entry conditions predict profitability.

Purpose: Enable data-driven filter optimization by showing users which fields (VIX level, time of day, etc.) correlate most strongly with trade P/L.
Output: New `find_predictive_fields` MCP tool that scans all numeric fields and returns ranked correlation data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@packages/mcp-server/src/tools/reports.ts
@packages/lib/models/report-config.ts
@packages/lib/calculations/statistical-utils.ts

# Existing patterns to follow
The tool should follow the pattern established by get_field_statistics and aggregate_by_field:
- Use loadBlock() for data loading
- Use enrichTrades() inline implementation for field enrichment
- Use getTradeFieldValue() for field extraction
- Use createToolOutput() for JSON-first response format
- Support optional strategy and date range pre-filters

# Dependencies available
- pearsonCorrelation from @tradeblocks/lib - already exported and handles edge cases
- REPORT_FIELDS from @tradeblocks/lib - defines all standard numeric fields
- CLI test mode exists: `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call <tool> '<json>'`

# Key decisions
- Use Pearson correlation (linear relationship detection)
- Rank by absolute correlation value (both positive and negative correlations are predictive)
- Require minimum sample size (default: 30) for reliable correlation
- Include interpretation guidance (|r| > 0.7 strong, > 0.4 moderate, > 0.2 weak)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create find_predictive_fields MCP tool</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Add new MCP tool `find_predictive_fields` to reports.ts. Implementation details:

1. **Input schema** (Zod):
   - blockId: string (required) - Block folder name
   - strategy: string (optional) - Pre-filter by strategy name
   - startDate: string (optional) - Pre-filter start date (YYYY-MM-DD)
   - endDate: string (optional) - Pre-filter end date (YYYY-MM-DD)
   - targetField: string (default: "pl") - Field to correlate against (usually P/L)
   - minSamples: number (default: 30, min: 10) - Minimum trades with valid values for reliable correlation
   - includeCustomFields: boolean (default: true) - Include custom fields from CSV

2. **Logic**:
   - Load block, apply strategy/date filters
   - Enrich trades using existing enrichTrades()
   - Build list of fields to analyze:
     - Static fields from REPORT_FIELDS
     - Custom fields from trades (if includeCustomFields)
     - Skip targetField itself
   - For each field:
     - Extract (fieldValue, targetValue) pairs where both are non-null
     - Skip if sampleSize < minSamples
     - Calculate Pearson correlation using imported pearsonCorrelation from statistical-utils
   - Sort by absolute correlation (descending)
   - Add interpretation: |r| >= 0.7 = "strong", >= 0.4 = "moderate", >= 0.2 = "weak", else "negligible"

3. **Output structure**:
   - Summary line: "Found X predictive fields out of Y analyzed"
   - Structured data:
     - blockId, targetField, filters applied
     - totalFieldsAnalyzed, fieldsWithSufficientData
     - rankedFields: array of { field, label, correlation, absCorrelation, sampleSize, interpretation, direction: "positive" | "negative" }
     - fieldsSkipped: array of { field, label, reason: "insufficient_samples" | "no_variance", sampleSize }

4. **Import pearsonCorrelation**: Add import at top of file:
   ```typescript
   import { pearsonCorrelation } from "@tradeblocks/lib";
   ```

CRITICAL: Follow the exact pattern of other tools in reports.ts. Use inline enrichTrades() - do NOT try to import it from lib (browser deps). Use getTradeFieldValue() helper already in the file.
  </action>
  <verify>npm run typecheck passes in packages/mcp-server/</verify>
  <done>
- Tool registered with proper Zod schema
- Correlation calculation works for all standard REPORT_FIELDS
- Custom fields included when available
- Fields ranked by |correlation|
- Interpretation labels assigned correctly
- Skipped fields tracked with reasons
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI test verification with real data</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Test the new tool using CLI test mode with actual backtest data.

1. **Build MCP server**:
   ```bash
   cd packages/mcp-server && npm run build
   ```

2. **Run find_predictive_fields**:
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call find_predictive_fields '{"blockId":"<real-block-id>"}'
   ```
   Replace `<real-block-id>` with an actual block folder name from `~/backtests/`.

3. **Verify output**:
   - Check that fields are ranked by absolute correlation
   - Verify sample sizes are reasonable (>= minSamples for included fields)
   - Confirm interpretation labels match correlation values
   - Ensure both positive and negative correlations appear
   - Check that skipped fields show proper reasons

4. **Test with filters** (if multiple strategies exist):
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call find_predictive_fields '{"blockId":"<block-id>","strategy":"<strategy-name>"}'
   ```

5. **Test edge cases**:
   - Test with minSamples=10 (lower threshold)
   - Test with targetField="rom" (alternate target)

If any test reveals issues, fix them in reports.ts before proceeding.
  </action>
  <verify>CLI test returns valid JSON with ranked correlations</verify>
  <done>
- Tool returns properly formatted JSON output
- Correlations are calculated correctly (spot check: openingVix, durationHours should have some correlation)
- Edge cases handled (empty blocks, insufficient data)
- Performance acceptable (< 5s for typical portfolio)
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes in packages/mcp-server/
- [ ] CLI test with real data returns valid output
- [ ] At least one field shows moderate or strong correlation
- [ ] Skipped fields array populated with reasons
- [ ] Output follows JSON-first pattern (createToolOutput)
</verification>

<success_criteria>
- find_predictive_fields tool registered and working
- Correlations calculated using Pearson method
- Fields ranked by predictive strength
- Interpretation guidance included
- CLI test verification passed
- Code follows existing patterns in reports.ts
</success_criteria>

<output>
After completion, create `.planning/phases/32-find-predictive-fields/32-01-SUMMARY.md`:

# Phase 32 Plan 01: find-predictive-fields Tool Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `packages/mcp-server/src/tools/reports.ts` - Added find_predictive_fields tool

## Decisions Made
- [Any implementation choices]

## Issues Encountered
- [Problems and resolutions, or "None"]

## CLI Test Results
- [Sample output from verification]

## Next Step
Phase 32 complete, ready for Phase 33 (filter-curve tool)
</output>
