---
phase: 53-import-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/market-data.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "analyze_regime_performance returns correct regime breakdown results using DuckDB queries (no CSV file reads)"
    - "suggest_filters returns correct filter suggestions using DuckDB queries (no CSV file reads)"
    - "calculate_orb returns correct ORB levels using DuckDB queries (no CSV file reads)"
    - "All three tools are wrapped with withFullSync middleware ensuring market data is synced before querying"
    - "In-memory CSV loading functions (loadDailyData, loadIntradayData, loadHighLowData, loadVixIntradayData, getMarketData) are removed"
    - "CSV file caching infrastructure (dailyDataCache, intradayDataCache, highlowDataCache, vixIntradayDataCache, cacheTimestamp, CACHE_TTL_MS) is removed"
    - "fs and path imports are removed from market-data.ts"
  artifacts:
    - path: "packages/mcp-server/src/tools/market-data.ts"
      provides: "3 migrated tools using DuckDB, no CSV loading code"
      contains: "getConnection"
    - path: "packages/mcp-server/package.json"
      provides: "Version bump to 0.10.1"
      contains: "0.10.1"
  key_links:
    - from: "packages/mcp-server/src/tools/market-data.ts"
      to: "packages/mcp-server/src/db/connection.ts"
      via: "import { getConnection }"
      pattern: 'import.*getConnection.*from.*connection'
    - from: "packages/mcp-server/src/tools/market-data.ts"
      to: "packages/mcp-server/src/tools/middleware/sync-middleware.ts"
      via: "import { withFullSync }"
      pattern: 'import.*withFullSync.*from.*sync-middleware'
    - from: "registerMarketDataTools"
      to: "withFullSync"
      via: "All three tool handlers wrapped with withFullSync(baseDir, ...)"
      pattern: 'withFullSync\(baseDir'
---

<objective>
Migrate all three market data tools (analyze_regime_performance, suggest_filters, calculate_orb) from in-memory CSV loading to DuckDB queries, then remove all CSV loading infrastructure.

Purpose: Eliminate the redundant in-memory CSV loading path, making DuckDB the single source of truth for market data. This simplifies the codebase and removes the 5-minute TTL cache, 4 CSV loading functions, and ~380 lines of dead code.

Output: A cleaned-up market-data.ts where all tools query DuckDB via getConnection() and are wrapped with withFullSync middleware.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-import-consolidation/53-RESEARCH.md
@.planning/phases/52-duckdb-schema-sync/52-01-SUMMARY.md

Key source files to read before implementation:
@packages/mcp-server/src/tools/market-data.ts (PRIMARY - the file being refactored)
@packages/mcp-server/src/tools/middleware/sync-middleware.ts (withFullSync pattern)
@packages/mcp-server/src/tools/sql.ts (lines 145-184 - DuckDB query + row conversion pattern)
@packages/mcp-server/src/db/connection.ts (getConnection singleton)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DuckDB helper and migrate analyze_regime_performance + suggest_filters</name>
  <files>packages/mcp-server/src/tools/market-data.ts</files>
  <action>
Read market-data.ts fully, then make these changes:

1. **Add imports** (replace `fs` and `path` imports):
   ```typescript
   import { getConnection } from "../db/connection.js";
   import { withFullSync } from "./middleware/sync-middleware.js";
   ```
   Remove: `import * as fs from "fs/promises"` and `import * as path from "path"`.

2. **Add a `resultToRecords` helper function** in the Utility Functions section (after `formatTradeDate`, before `getVolRegimeLabel`). This converts DuckDB query results to Record objects with BigInt handling:
   ```typescript
   function resultToRecords(result: { columnCount: number; columnName(i: number): string; getRows(): Iterable<unknown[]> }): Record<string, unknown>[] {
     const columnCount = result.columnCount;
     const colNames: string[] = [];
     for (let i = 0; i < columnCount; i++) {
       colNames.push(result.columnName(i));
     }
     const records: Record<string, unknown>[] = [];
     for (const row of result.getRows()) {
       const record: Record<string, unknown> = {};
       for (let i = 0; i < columnCount; i++) {
         const val = row[i];
         record[colNames[i]] = typeof val === "bigint" ? Number(val) : val;
       }
       records.push(record);
     }
     return records;
   }
   ```

3. **Add a `getNum` accessor helper** right after `resultToRecords`:
   ```typescript
   function getNum(record: Record<string, unknown>, field: string): number {
     const val = record[field];
     if (val === null || val === undefined) return NaN;
     if (typeof val === "bigint") return Number(val);
     return val as number;
   }
   ```

4. **Migrate `analyze_regime_performance`:**
   - Wrap the handler with `withFullSync(baseDir, async ({ blockId, segmentBy, strategy }) => { ... })`.
   - Replace `const { daily } = await getMarketData(baseDir);` with a DuckDB batch query:
     - After filtering trades, collect unique trade dates: `const tradeDates = [...new Set(trades.map(t => formatTradeDate(t.dateOpened)))];`
     - If tradeDates is empty, return the "No trades found" error.
     - Build a batch query: `SELECT * FROM market.spx_daily WHERE date IN (${tradeDates.map((_, i) => "$" + (i + 1)).join(", ")})` with `tradeDates` as params.
     - Execute via `const conn = await getConnection(baseDir);` and `conn.runAndReadAll(sql, tradeDates)`.
     - Convert to a `Map<string, Record<string, unknown>>` using `resultToRecords`, keying by `record["date"] as string`.
   - Update the segment extraction to use `getNum()`:
     - `marketData.Vol_Regime` becomes `getNum(marketData, "Vol_Regime")`
     - `marketData.Term_Structure_State` becomes `getNum(marketData, "Term_Structure_State")`
     - `marketData.Day_of_Week` becomes `getNum(marketData, "Day_of_Week")`
     - `marketData.Gap_Pct` becomes `getNum(marketData, "Gap_Pct")`
     - `marketData.Trend_Score` becomes `getNum(marketData, "Trend_Score")`
   - The `daily.get(tradeDate)` call returns `Record<string, unknown> | undefined` now instead of `DailyMarketData | undefined`. The rest of the logic (segment stats calculation) does not access market data fields, so it stays unchanged.

5. **Migrate `suggest_filters`:**
   - Wrap the handler with `withFullSync(baseDir, async ({ blockId, strategy, minImprovementPct = 3 }) => { ... })`.
   - Replace `const { daily } = await getMarketData(baseDir);` with the same DuckDB batch query pattern as analyze_regime_performance.
   - Update the `EnrichedTrade` interface: change `market: DailyMarketData | null` to `market: Record<string, unknown> | null`.
   - Update the enrichedTrades mapping: `daily.get(tradeDate) || null` stays the same (now returns `Record<string, unknown> | null`).
   - Update the `testFilters` array: change the `test` function type from `(m: DailyMarketData) => boolean` to `(m: Record<string, unknown>) => boolean`.
   - Update each filter test function to use `getNum()`:
     - `(m) => Math.abs(m.Gap_Pct) > 0.5` becomes `(m) => Math.abs(getNum(m, "Gap_Pct")) > 0.5`
     - `(m) => m.VIX_Close > 25` becomes `(m) => getNum(m, "VIX_Close") > 25`
     - `(m) => m.VIX_Spike_Pct > 5` becomes `(m) => getNum(m, "VIX_Spike_Pct") > 5`
     - `(m) => m.Term_Structure_State === -1` becomes `(m) => getNum(m, "Term_Structure_State") === -1`
     - `(m) => m.Vol_Regime >= 5` becomes `(m) => getNum(m, "Vol_Regime") >= 5`
     - `(m) => m.Vol_Regime === 1` becomes `(m) => getNum(m, "Vol_Regime") === 1`
     - `(m) => m.Day_of_Week === 6` becomes `(m) => getNum(m, "Day_of_Week") === 6`
     - `(m) => m.Day_of_Week === 2` becomes `(m) => getNum(m, "Day_of_Week") === 2`
     - `(m) => m.Is_Opex === 1` becomes `(m) => getNum(m, "Is_Opex") === 1`
     - `(m) => m.Trend_Score <= 1` becomes `(m) => getNum(m, "Trend_Score") <= 1`
     - `(m) => m.Trend_Score >= 4` becomes `(m) => getNum(m, "Trend_Score") >= 4`
     - `(m) => m.Consecutive_Days >= 4` becomes `(m) => getNum(m, "Consecutive_Days") >= 4`
     - `(m) => m.Consecutive_Days <= -4` becomes `(m) => getNum(m, "Consecutive_Days") <= -4`
     - `(m) => m.RSI_14 > 70` becomes `(m) => getNum(m, "RSI_14") > 70`
     - `(m) => m.RSI_14 < 30` becomes `(m) => getNum(m, "RSI_14") < 30`
     - `(m) => m.VIX_Close > 30` and `(m) => m.VIX_Close < 14` similarly.
   - The `t.market!` non-null assertions in the filter test loop become `t.market as Record<string, unknown>` (since matchedTrades already filtered nulls).

IMPORTANT: Keep all existing tool logic (segment stats calculation, filter testing, sorting, output formatting) exactly the same. Only the data SOURCE changes (DuckDB instead of CSV), not the business logic.

IMPORTANT: The `withFullSync` handler receives `(input, ctx)` but we destructure `input` directly. The second `ctx` parameter is unused but the signature must accept it. Use: `withFullSync(baseDir, async ({ blockId, segmentBy, strategy }) => { ... })` -- the middleware passes the input object as first arg.

IMPORTANT: NaN behavior -- `getNum` returns `NaN` for null/undefined values from DuckDB. `NaN > 25` is `false`, `NaN === -1` is `false`, `Math.abs(NaN) > 0.5` is `false`. These all match the existing behavior where `NaN` from `parseNum()` would produce the same boolean results. No special handling needed.
  </action>
  <verify>
Run `cd /Users/davidromeo/Code/tradeblocks && npx tsc --noEmit -p packages/mcp-server/tsconfig.json` to verify TypeScript compiles without errors. The file should have no `getMarketData` calls in `analyze_regime_performance` or `suggest_filters` handlers, and both should use `getConnection` + `withFullSync`.
  </verify>
  <done>
analyze_regime_performance and suggest_filters both query DuckDB via getConnection() + batch SELECT, are wrapped with withFullSync middleware, and use getNum() for field access. No CSV loading in these two tools. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate calculate_orb + remove all CSV loading infrastructure + version bump</name>
  <files>packages/mcp-server/src/tools/market-data.ts, packages/mcp-server/package.json</files>
  <action>
1. **Migrate `calculate_orb`:**
   - Wrap the handler with `withFullSync(baseDir, async ({ startTime, endTime, startDate, endDate, limit = 100 }) => { ... })`.
   - Replace `const { intraday } = await getMarketData(baseDir);` with a DuckDB query:
     ```typescript
     const conn = await getConnection(baseDir);
     const end = endDate || startDate;
     const result = await conn.runAndReadAll(
       `SELECT * FROM market.spx_15min WHERE date BETWEEN $1 AND $2 ORDER BY date`,
       [startDate, end]
     );
     const intradayRecords = resultToRecords(result);
     ```
   - Replace the `if (intraday.size === 0)` check with `if (intradayRecords.length === 0)`.
   - Replace the iteration `for (const [date, intradayData] of intraday)` with `for (const intradayData of intradayRecords)`. Extract date: `const date = intradayData["date"] as string;`.
   - Remove the date range filtering inside the loop (`const d = new Date(date); if (d < startD || d > endD) continue;`) since the SQL WHERE clause already handles it. Also remove the `startD` and `endD` variables.
   - Move the `const end = endDate || startDate;` to before the query (it's currently after the query in the original code -- make sure it's available for both the query and the output).
   - Update the `checkpointFields` type from `Record<string, keyof Intraday15MinData>` to `Record<string, string>` since we're no longer indexing into a typed interface.
   - Update checkpoint price access: `intradayData[field] as number` becomes `getNum(intradayData, field)`.
   - Update `intradayData.close` to `getNum(intradayData, "close")`.
   - The `!isNaN(price) && price > 0` check stays the same since `getNum` returns `NaN` for null values.

2. **Remove ALL CSV loading infrastructure** from market-data.ts:
   - Delete the entire "Data Loading & Caching" section (lines 218-601 approximately):
     - Cache variables: `dailyDataCache`, `intradayDataCache`, `highlowDataCache`, `vixIntradayDataCache`, `cacheTimestamp`, `CACHE_TTL_MS`
     - Functions: `parseTimestamp()`, `parseNum()`, `loadDailyData()`, `loadIntradayData()`, `loadHighLowData()`, `loadVixIntradayData()`, `getMarketData()`
   - The `fs` and `path` imports should already be removed from Task 1. Verify they are gone.

3. **Clean up type interfaces:**
   - Remove `HighLowTimingData` interface (spx_highlow retired in Phase 52)
   - Remove `VixIntradayData` interface (only used by CSV loading, not by any tool)
   - Remove `IntradayMarketData` type alias (deprecated, only used by CSV loading)
   - Remove `MarketDataRecord` interface (only used by CSV loading)
   - Keep `DailyMarketData` interface as documentation (useful reference for what columns exist in spx_daily). Add a comment: `/** Daily market data columns in market.spx_daily DuckDB table. Kept as documentation reference. */`
   - Keep `Intraday15MinData` interface as documentation. Add comment: `/** 15-minute intraday columns in market.spx_15min DuckDB table. Kept as documentation reference. */`

4. **Update the file header comment:**
   ```typescript
   /**
    * Market Data Tools
    *
    * MCP tools for analyzing market context (VIX, term structure, regimes)
    * and correlating with trade performance.
    *
    * Data source: DuckDB analytics database (synced from TradingView exports)
    * - market.spx_daily: Daily context (55 fields incl. highlow timing + VIX enrichment)
    * - market.spx_15min: 15-minute intraday checkpoints
    */
   ```

5. **Version bump:** Update `packages/mcp-server/package.json` version from `"0.10.0"` to `"0.10.1"`.

IMPORTANT: Do NOT remove `formatTradeDate`, `getVolRegimeLabel`, `getTermStructureLabel`, `getDayLabel` utility functions -- they are still used by the migrated tools.

IMPORTANT: Do NOT remove `loadBlock` import -- it is still used by `analyze_regime_performance` and `suggest_filters` for loading trade data from CSV (trade data loading stays unchanged per research).
  </action>
  <verify>
Run `cd /Users/davidromeo/Code/tradeblocks && npx tsc --noEmit -p packages/mcp-server/tsconfig.json` to verify TypeScript compiles. Then verify:
1. `grep -c "getMarketData" packages/mcp-server/src/tools/market-data.ts` returns 0 (no CSV loading calls remain)
2. `grep -c "loadDailyData\|loadIntradayData\|loadHighLowData\|loadVixIntradayData" packages/mcp-server/src/tools/market-data.ts` returns 0
3. `grep -c "dailyDataCache\|intradayDataCache\|highlowDataCache\|vixIntradayDataCache\|CACHE_TTL_MS" packages/mcp-server/src/tools/market-data.ts` returns 0
4. `grep -c "import.*fs.*from\|import.*path.*from" packages/mcp-server/src/tools/market-data.ts` returns 0
5. `grep -c "withFullSync" packages/mcp-server/src/tools/market-data.ts` returns 3 (one per tool)
6. `grep -c "getConnection" packages/mcp-server/src/tools/market-data.ts` returns at least 3
7. `grep "version" packages/mcp-server/package.json | head -1` shows 0.10.1
  </verify>
  <done>
calculate_orb migrated to DuckDB. All CSV loading infrastructure removed (7 functions, 6 cache variables, 2 imports). Dead type interfaces removed (HighLowTimingData, VixIntradayData, MarketDataRecord, IntradayMarketData). DailyMarketData and Intraday15MinData kept as documentation. MCP server version bumped to 0.10.1. TypeScript compiles cleanly. Zero references to CSV file reading remain.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation:** `npx tsc --noEmit -p packages/mcp-server/tsconfig.json` passes
2. **No CSV loading remains:** Zero occurrences of `getMarketData`, `loadDailyData`, `loadIntradayData`, `loadHighLowData`, `loadVixIntradayData`, `parseTimestamp`, `parseNum` in market-data.ts
3. **No cache infrastructure remains:** Zero occurrences of `dailyDataCache`, `intradayDataCache`, `highlowDataCache`, `vixIntradayDataCache`, `cacheTimestamp`, `CACHE_TTL_MS`
4. **No file I/O imports:** Zero occurrences of `import * as fs` or `import * as path` in market-data.ts
5. **DuckDB integration present:** `getConnection` and `withFullSync` imports exist, each tool handler is wrapped with `withFullSync`
6. **Version bumped:** package.json shows 0.10.1
7. **Existing tests pass:** `cd packages/mcp-server && npm test` (if any tests exist for these tools)
</verification>

<success_criteria>
- All three market data tools (analyze_regime_performance, suggest_filters, calculate_orb) query DuckDB exclusively via getConnection() + runAndReadAll()
- All three tools are wrapped with withFullSync middleware
- All CSV loading functions, cache variables, and file I/O imports are removed from market-data.ts
- Dead type interfaces (HighLowTimingData, VixIntradayData, MarketDataRecord, IntradayMarketData) are removed
- DailyMarketData and Intraday15MinData interfaces kept as documentation
- MCP server version bumped to 0.10.1
- TypeScript compiles without errors
- Requirements IMPORT-01 through IMPORT-05 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/53-import-consolidation/53-01-SUMMARY.md`
</output>
