---
phase: 57-restore-enrich-trades
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/market-data.ts
  - packages/mcp-server/src/utils/field-timing.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "Calling enrich_trades with a blockId returns trades with market context split into entryContext.sameDay and entryContext.priorDay sections"
    - "enrich_trades supports strategy, startDate, endDate filters and limit/offset pagination"
    - "When includeOutcomeFields is true, trades include a separate outcomeFields section with a lookahead bias warning"
    - "Response includes per-field temporal provenance via the sameDay/priorDay/outcomeFields structural grouping"
    - "Response includes lagNote explaining which fields are lagged and why"
    - "Pagination metadata shows totalTrades, returned, offset, hasMore"
  artifacts:
    - path: "packages/mcp-server/src/tools/market-data.ts"
      provides: "enrich_trades tool registration"
      contains: "enrich_trades"
    - path: "packages/mcp-server/src/utils/field-timing.ts"
      provides: "buildOutcomeQuery function for same-day close-derived fields"
      contains: "buildOutcomeQuery"
  key_links:
    - from: "packages/mcp-server/src/tools/market-data.ts"
      to: "packages/mcp-server/src/utils/field-timing.ts"
      via: "import buildLookaheadFreeQuery, buildOutcomeQuery, OPEN_KNOWN_FIELDS, CLOSE_KNOWN_FIELDS, STATIC_FIELDS"
      pattern: "buildOutcomeQuery"
    - from: "packages/mcp-server/src/tools/market-data.ts"
      to: "packages/mcp-server/src/utils/block-loader.ts"
      via: "loadBlock(baseDir, blockId)"
      pattern: "loadBlock"
---

<objective>
Implement the `enrich_trades` MCP tool that returns trades enriched with lag-aware market context from `spx_daily`.

Purpose: Users and LLM consumers who naively JOIN on date get same-day close-derived values (lookahead bias). This tool enforces correct temporal joins by default -- open-known fields use same-day values, close-derived fields use prior trading day values via LAG CTE, and outcome fields (same-day close) are opt-in with a clear warning.

Output: Working `enrich_trades` tool in market-data.ts, `buildOutcomeQuery` in field-timing.ts, MCP server version bump.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-fix-existing-tools/56-01-SUMMARY.md
@packages/mcp-server/src/tools/market-data.ts
@packages/mcp-server/src/utils/field-timing.ts
@packages/mcp-server/src/utils/block-loader.ts
@packages/mcp-server/src/utils/output-formatter.ts
@packages/mcp-server/src/tools/shared/filters.ts
@packages/mcp-server/src/tools/middleware/sync-middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add buildOutcomeQuery to field-timing.ts and implement enrich_trades tool</name>
  <files>
    packages/mcp-server/src/utils/field-timing.ts
    packages/mcp-server/src/tools/market-data.ts
    packages/mcp-server/package.json
  </files>
  <action>
**1. Add `buildOutcomeQuery()` to `packages/mcp-server/src/utils/field-timing.ts`:**

Export a new function below the existing `buildLookaheadFreeQuery()`:

```typescript
export function buildOutcomeQuery(tradeDates: string[]): { sql: string; params: string[] } {
  const closeColumns = [...CLOSE_KNOWN_FIELDS].map(f => `"${f}"`).join(', ');
  const placeholders = tradeDates.map((_, i) => `$${i + 1}`).join(', ');
  const sql = `SELECT date, ${closeColumns} FROM market.spx_daily WHERE date IN (${placeholders})`;
  return { sql, params: tradeDates };
}
```

This returns same-day close-derived values (no LAG) for outcome fields. Only called when `includeOutcomeFields=true`.

**2. Add `enrich_trades` tool registration inside `registerMarketDataTools()` in `packages/mcp-server/src/tools/market-data.ts`:**

Add the import of `buildOutcomeQuery`, `OPEN_KNOWN_FIELDS`, `CLOSE_KNOWN_FIELDS`, `STATIC_FIELDS` from field-timing.ts (buildLookaheadFreeQuery is already imported).

Add import of `filterByStrategy`, `filterByDateRange` from `./shared/filters.js`.

Register the tool using `withFullSync` (same as other market-data tools -- needs market data synced). Place it between suggest_filters and calculate_orb.

**Tool schema (Zod):**
```typescript
z.object({
  blockId: z.string().describe("Block ID to enrich"),
  strategy: z.string().optional().describe("Filter to specific strategy (exact match)"),
  startDate: z.string().optional().describe("Start date filter (YYYY-MM-DD)"),
  endDate: z.string().optional().describe("End date filter (YYYY-MM-DD)"),
  includeOutcomeFields: z.boolean().default(false).describe("Include same-day close values (lookahead). Defaults to false for safety."),
  limit: z.number().min(1).max(500).default(50).describe("Max trades to return (default: 50, max: 500)"),
  offset: z.number().min(0).default(0).describe("Pagination offset (default: 0)"),
})
```

**Tool description:** "Enrich trades with market context using correct temporal joins. Open-known fields (Gap_Pct, VIX_Open) use same-day values. Close-derived fields (VIX_Close, RSI_14, Vol_Regime) use prior trading day values to prevent lookahead bias. Use includeOutcomeFields=true for post-hoc analysis (with clear warning)."

**Handler implementation pattern (follow analyze_regime_performance exactly):**

1. Load block: `const block = await loadBlock(baseDir, blockId);`
2. Filter trades: apply `filterByStrategy()` then `filterByDateRange()`.
3. If no trades, return error.
4. Compute pagination: `totalTrades = filtered.length`, `paginated = filtered.slice(offset, offset + limit)`.
5. Collect unique dates from **paginated** trades only (avoid querying dates we won't return).
6. Query DuckDB with `buildLookaheadFreeQuery(tradeDates)` -> `resultToRecords()` -> build `Map<string, Record<string, unknown>>`.
7. If `includeOutcomeFields`, also run `buildOutcomeQuery(tradeDates)` -> `resultToRecords()` -> build a second `Map<string, Record<string, unknown>>`.
8. Build enriched trades array by iterating paginated trades. For each trade:
   - Match to market data by date using `formatTradeDate()`.
   - If no match, track in `unmatchedDates`, set `entryContext: null`.
   - Build `entryContext.sameDay`: iterate `OPEN_KNOWN_FIELDS` and `STATIC_FIELDS`, extract values from market data record. Replace NaN with null (check `v === v ? v : null`).
   - Build `entryContext.priorDay`: iterate `CLOSE_KNOWN_FIELDS`, read `prev_{field}` from market data record. Replace NaN with null.
   - Build `outcomeFields` (only if `includeOutcomeFields`): iterate `CLOSE_KNOWN_FIELDS`, read same-name fields from outcome query result. Replace NaN with null.
   - Output per-trade object shape:
     ```
     {
       dateOpened: string (YYYY-MM-DD),
       timeOpened: string,
       strategy: string,
       legs: string,
       pl: number,
       numContracts: number,
       premium: number,
       reasonForClose: string | null,
       commissions: number,
       entryContext: { sameDay: {...}, priorDay: {...} } | null,
       outcomeFields?: {...}  // only when includeOutcomeFields=true
     }
     ```
   - For numeric values from DuckDB: `typeof val === 'bigint' ? Number(val) : val`, then NaN to null: `(typeof v === 'number' && isNaN(v)) ? null : v`.

9. Build lagNote string. When NOT including outcome fields:
   ```
   "Entry context uses lookahead-free temporal joins. Same-day fields (Gap_Pct, VIX_Open, Day_of_Week, etc.) are values known at market open. Prior-day fields (VIX_Close, RSI_14, Vol_Regime, etc.) use the previous trading day's close-derived values to prevent lookahead bias."
   ```
   When INCLUDING outcome fields, append:
   ```
   " Outcome fields contain same-day close-derived values and represent information NOT available at trade entry time."
   ```

10. Also include `lookaheadWarning` field (only when outcome fields enabled):
    ```
    "WARNING: outcomeFields contain same-day close-derived values that were NOT available at trade entry time. Do not use these for entry signal analysis."
    ```

11. Return via `createToolOutput(summary, data)`:
    - summary: `"Enriched trades: {blockId} | {matched}/{paginated.length} matched | offset {offset}, limit {limit}"`
    - data: `{ blockId, strategy: strategy || null, lagNote, lookaheadWarning (if applicable), tradesTotal: totalTrades, returned: paginated.length, offset, hasMore: offset + limit < totalTrades, tradesMatched: matched count, unmatchedDates: [...], trades: enrichedTradesArray }`

12. Wrap in try/catch returning error format on failure (same as other tools).

**3. Bump MCP server version in `packages/mcp-server/package.json`:**
Bump from `"1.0.1"` to `"1.1.0"` (minor version for new feature).

**Key implementation notes:**
- Use `withFullSync` (not `withSyncedBlock`) -- matches other market-data tools, ensures market.spx_daily is synced.
- Static fields (Day_of_Week, Month, Is_Opex) go in `entryContext.sameDay` since they're known before market open.
- Filter BEFORE paginate: `totalTrades` reflects filtered count, `hasMore` refers to filtered set.
- Only query DuckDB for paginated trade dates (efficiency).
- NaN handling: `getNum()` returns NaN for null DuckDB values. JSON.stringify converts NaN to null, but explicitly replace for safety.
- Trade commissions: `trade.openingCommissionsFees + trade.closingCommissionsFees`.
  </action>
  <verify>
1. `cd /Users/davidromeo/Code/tradeblocks && npx tsc --noEmit -p packages/mcp-server/tsconfig.json` passes (no type errors)
2. `npm test --prefix packages/mcp-server` passes (existing tests not broken)
3. Grep confirms: `grep -c "enrich_trades" packages/mcp-server/src/tools/market-data.ts` returns >= 1
4. Grep confirms: `grep -c "buildOutcomeQuery" packages/mcp-server/src/utils/field-timing.ts` returns >= 1
5. Version in package.json is "1.1.0"
  </verify>
  <done>
- enrich_trades tool is registered in registerMarketDataTools() with correct Zod schema
- buildOutcomeQuery() exported from field-timing.ts
- Tool returns trades with entryContext.sameDay (open-known + static fields), entryContext.priorDay (lagged close-derived fields)
- includeOutcomeFields=true adds outcomeFields section with lookaheadWarning
- Pagination (limit/offset) works with filter-before-paginate ordering
- lagNote explains temporal semantics in output
- MCP server version bumped to 1.1.0
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tool comment header and remove obsolete enrich_trades removal note</name>
  <files>
    packages/mcp-server/src/tools/market-data.ts
  </files>
  <action>
Update the comment block at the top of `registerMarketDataTools()` (around lines 222-233) to reflect that enrich_trades has been restored. Currently it says:

```
 * Note: The following tools were REMOVED in v0.6.0 - use run_sql instead:
 * - get_market_context: ...
 * - enrich_trades: ...
 * - find_similar_days: ...
```

Change to:

```
 * Note: The following tools were REMOVED in v0.6.0 - use run_sql instead:
 * - get_market_context: SELECT ... FROM market.spx_daily WHERE ...
 * - find_similar_days: Use CTE with similarity conditions
 *
 * Restored in v1.1.0 with lookahead-free temporal joins:
 * - enrich_trades: Returns trades enriched with lag-aware market context
 *
 * Kept tools (require TradeBlocks library computation):
```

Also update the top-of-file module docstring to mention enrich_trades:
```
 * MCP tools for analyzing market context (VIX, term structure, regimes)
 * and correlating with trade performance. Includes enrich_trades for
 * lag-aware trade enrichment with market data.
```
  </action>
  <verify>
1. `grep "Restored in v1.1.0" packages/mcp-server/src/tools/market-data.ts` returns a match
2. `grep -c "enrich_trades" packages/mcp-server/src/tools/market-data.ts` returns >= 3 (registration, comment, description)
  </verify>
  <done>
- Comment header accurately reflects tool inventory (enrich_trades restored, get_market_context and find_similar_days still removed)
- Module docstring mentions enrich_trades
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit -p packages/mcp-server/tsconfig.json` passes
2. Existing tests: `npm test --prefix packages/mcp-server` passes
3. Tool registration: grep confirms enrich_trades is registered
4. Outcome query: grep confirms buildOutcomeQuery exists in field-timing.ts
5. Version bump: package.json shows 1.1.0
6. No hardcoded field names: enrich_trades uses OPEN_KNOWN_FIELDS, CLOSE_KNOWN_FIELDS, STATIC_FIELDS sets (not inline lists)
</verification>

<success_criteria>
- enrich_trades tool callable via MCP with blockId parameter
- Output contains entryContext.sameDay (11 fields: 8 open + 3 static) and entryContext.priorDay (44 close-derived fields) per trade
- includeOutcomeFields=true adds outcomeFields section (44 same-day close values) with lookaheadWarning
- Pagination works: default 50 trades, max 500, offset supported, hasMore flag
- Strategy and date range filters applied before pagination
- lagNote in response explains temporal semantics
- TypeScript compiles, existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/57-restore-enrich-trades/57-01-SUMMARY.md`
</output>
