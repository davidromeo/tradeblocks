---
phase: 28-mcp-tests
plan: 01
type: execute
---

<objective>
Fix pre-existing test failures to achieve clean test run before marking v2.2 milestone complete.

Purpose: 6 failing tests (unrelated to v2.2) have been blocking clean test runs. Fixing them completes the milestone with a clean slate.
Output: All 989 tests passing, v2.2 milestone ready to ship.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

**Bug Analysis:**

The 6 failing tests are documented in CONCERNS.md as known bugs:

**Bug 1: Leg group maxLoss calculation (1 test)**
- File: lib/utils/combine-leg-groups.ts
- Test: tests/lib/utils/combine-leg-groups.test.ts:61
- Issue: Single debit trade with `maxLoss: undefined` should default to premium paid
- Current behavior: Returns `undefined` for single trades, preserving original value
- Expected: Single Long Call with `premium: -300` should have `maxLoss: -300`

**Bug 2: Calendar data scaling (5 tests)**
- File: lib/services/calendar-data.ts
- Tests: tests/unit/calendar-data.test.ts (lines 915, 1022, 1056, 1099, 1130)
- Issue: Tests don't pass `strategyMatches` parameter, so toReported scaling can't find strategy mappings
- Current behavior: Function requires explicit strategy matches
- Expected: Tests should pass strategy matches when backtest/actual strategies have same name

**Key Files:**
@lib/utils/combine-leg-groups.ts
@lib/services/calendar-data.ts
@tests/lib/utils/combine-leg-groups.test.ts
@tests/unit/calendar-data.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix maxLoss fallback for debit trades</name>
  <files>lib/utils/combine-leg-groups.ts</files>
  <action>
In `combineLegGroup()` around line 194-213, update the maxLoss handling for single trades.

Current behavior for `trades.length === 1`:
```typescript
if (trades.length === 1) {
  maxProfit = firstTrade.maxProfit
  maxLoss = firstTrade.maxLoss  // Just preserves undefined
}
```

Fix: When maxLoss is undefined for a single debit trade, fall back to premium paid:
```typescript
if (trades.length === 1) {
  maxProfit = firstTrade.maxProfit
  maxLoss = firstTrade.maxLoss
  // For debit trades without explicit maxLoss, use premium paid as max loss
  if (maxLoss === undefined && firstTrade.premium < 0) {
    maxLoss = firstTrade.premium
  }
}
```

This ensures Long Calls, Long Puts, and other debit trades have sensible maxLoss values even when CSV doesn't include them.
  </action>
  <verify>npm test -- tests/lib/utils/combine-leg-groups.test.ts - all 4 tests pass</verify>
  <done>combine-leg-groups.test.ts has 0 failures, debit trade maxLoss fallback working</done>
</task>

<task type="auto">
  <name>Task 2: Fix calendar scaling tests with proper strategyMatches</name>
  <files>tests/unit/calendar-data.test.ts</files>
  <action>
Update the failing tests to pass `strategyMatches` parameter when testing toReported mode.

The function signature is:
```typescript
getScaledDayBacktestPl(dayData: CalendarDayData, scalingMode: ScalingMode, strategyMatches: StrategyMatch[] = [])
```

For tests where backtest and actual use the same strategy name, pass a strategy match:

1. **Test at line 915** ("should scale DOWN to actual in toReported mode"):
   - Current: `getScaledDayBacktestPl(dayData, 'toReported')`
   - Fix: `getScaledDayBacktestPl(dayData, 'toReported', [{ backtestStrategy: 'Test Strategy', actualStrategy: 'Test Strategy' }])`

2. **Test at line 1022** ("should scale backtest DOWN when actual has fewer contracts"):
   - Same fix - add strategy match for 'Test Strategy'

3. **Test at line 1056** ("should use first trade contract count, not sum"):
   - Same fix - add strategy match for 'Test Strategy'

4. **Test at line 1099** ("should scale each strategy separately"):
   - Add TWO strategy matches: 'Strategy A' and 'Strategy B'
   - `[{ backtestStrategy: 'Strategy A', actualStrategy: 'Strategy A' }, { backtestStrategy: 'Strategy B', actualStrategy: 'Strategy B' }]`

5. **Test at line 1130** ("should handle unmatched strategies"):
   - Add match only for 'Matched' strategy
   - `[{ backtestStrategy: 'Matched', actualStrategy: 'Matched' }]`
   - This correctly tests that 'Unmatched' falls back to raw value

This approach fixes the tests by using the API correctly while preserving the test intent. The API design requiring explicit strategy matches is correct because in production, backtest and actual strategies often have different names.
  </action>
  <verify>npm test -- tests/unit/calendar-data.test.ts - all tests pass</verify>
  <done>calendar-data.test.ts has 0 failures in the scaling section</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify clean slate</name>
  <files>-</files>
  <action>
Run the complete test suite to verify all 989 tests pass:

```bash
npm test
```

Verify:
- Test Suites: 64 passed, 64 total (was 2 failed, 62 passed)
- Tests: 989 passed, 989 total (was 6 failed, 983 passed)
- No TypeScript errors

Also run typecheck:
```bash
npm run typecheck
```
  </action>
  <verify>npm test exits with 0, all tests pass</verify>
  <done>989/989 tests passing, no failures, clean test run achieved</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` shows 989 passed, 0 failed
- [ ] `npm run typecheck` passes
- [ ] No new console warnings in test output
</verification>

<success_criteria>

- All 989 tests pass
- combine-leg-groups maxLoss fallback works for debit trades
- Calendar scaling tests use API correctly with strategyMatches
- v2.2 milestone ready to ship
</success_criteria>

<output>
After completion, create `.planning/phases/28-mcp-tests/28-01-SUMMARY.md`
</output>
