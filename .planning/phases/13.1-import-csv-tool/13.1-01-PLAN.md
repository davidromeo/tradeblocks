---
phase: 13.1-import-csv-tool
plan: "01"
type: execute
domain: mcp-server
---

<objective>
Add `import_csv` MCP tool to accept arbitrary CSV paths and create persistent blocks.

Purpose: Enable Claude to analyze any CSV file without requiring pre-configured block directories. Removes friction for ad-hoc analysis in Cowork and Claude Code.
Output: New MCP tool `import_csv` that copies CSVs into the blocks directory and returns a usable block ID.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-analysis-capabilities/13-01-SUMMARY.md

**Key files:**
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/utils/block-loader.ts
@packages/mcp-server/src/tools/blocks.ts

**Tech stack available:**
- McpServer API with zod@4 for tool schemas
- Folder-based block structure (tradelog.csv required, dailylog.csv optional)
- .block.json for metadata caching
- ESM imports with .js extension

**Established patterns:**
- Tool registration via `register*Tools(server, resolvedDir)` functions
- JSON-first output: brief text summary + structured JSON
- Inline CSV parsing (browser deps prevent importing lib/processing)

**Constraining decisions:**
- Phase 11-02: Folder-based block structure with .block.json metadata
- Phase 12-01: CSV parsing inline in block-loader (TradeProcessor uses browser File API)
- Phase 12-02: JSON-first output pattern for all tools
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import_csv MCP tool</name>
  <files>packages/mcp-server/src/tools/imports.ts, packages/mcp-server/src/utils/block-loader.ts</files>
  <action>
Create new `imports.ts` tool file with `import_csv` tool:

**Tool schema:**
- `csvPath` (required): Absolute path to the CSV file
- `blockName` (optional): Custom name for the block (defaults to filename without extension)
- `csvType` (optional): "tradelog" | "dailylog" | "reportinglog" (defaults to "tradelog")

**Implementation:**
1. Add `importCsv()` function to block-loader.ts:
   - Validate source file exists and is readable
   - Derive blockId from blockName or filename (kebab-case, no spaces)
   - Create block directory: `{baseDir}/{blockId}/`
   - Copy CSV to appropriate filename (tradelog.csv, dailylog.csv, or reportinglog.csv)
   - Parse CSV to extract metadata (trade count, date range, strategies)
   - Generate and save .block.json with metadata
   - Return { blockId, name, tradeCount, dateRange, strategies }

2. Create imports.ts with `registerImportTools(server, resolvedDir)`:
   - Register `import_csv` tool with zod schema
   - Call `importCsv()` from block-loader
   - Return JSON-first output: brief summary + JSON resource

**Edge cases to handle:**
- Block already exists: Return error with suggestion to use different name
- Invalid CSV structure: Validate has required columns before copying
- Path outside allowed directories: No restriction (user controls MCP server)

**Avoid:**
- Importing from lib/processing (browser dependencies)
- Modifying existing blocks (import creates new only)
  </action>
  <verify>npm run build:mcp succeeds without errors</verify>
  <done>import_csv tool implemented with validation, copy, and metadata generation</done>
</task>

<task type="auto">
  <name>Task 2: Register tool and verify integration</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
1. Import `registerImportTools` in index.ts
2. Call `registerImportTools(server, resolvedDir)` after existing registrations
3. Update comment to reflect 19 total MCP tools

**Verify by inspection:**
- Tool appears in MCP tool list
- Build succeeds
- Lint passes
  </action>
  <verify>npm run build:mcp && npm run lint both pass</verify>
  <done>import_csv tool registered, total MCP tools updated to 19</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build:mcp` succeeds without errors
- [ ] `npm run lint` passes
- [ ] imports.ts exists with import_csv tool
- [ ] block-loader.ts has importCsv() function
- [ ] index.ts imports and registers import tools
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- import_csv tool properly validates CSV and creates block
- JSON-first output pattern followed
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-import-csv-tool/13.1-01-SUMMARY.md`
</output>
