---
phase: 48-walk-forward-degradation
plan: 02
type: execute
wave: 2
depends_on: ["48-01"]
files_modified:
  - packages/mcp-server/src/tools/edge-decay.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "analyze_walk_forward_degradation MCP tool is registered and callable via CLI"
    - "Tool accepts blockId, optional strategy, and all WFD config parameters via Zod schema"
    - "Tool returns text summary + structured JSON with periods, trends, and comparison"
    - "Tool handles errors gracefully (no trades, insufficient history)"
  artifacts:
    - path: "packages/mcp-server/src/tools/edge-decay.ts"
      provides: "analyze_walk_forward_degradation tool registration"
      contains: "analyze_walk_forward_degradation"
    - path: "packages/mcp-server/package.json"
      provides: "Version bump to 0.7.2"
      contains: "0.7.2"
  key_links:
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/lib/calculations/walk-forward-degradation.ts"
      via: "import analyzeWalkForwardDegradation from @tradeblocks/lib"
      pattern: "analyzeWalkForwardDegradation"
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/mcp-server/src/utils/output-formatter.ts"
      via: "createToolOutput for JSON-first response"
      pattern: "createToolOutput"
---

<objective>
Register `analyze_walk_forward_degradation` as the fourth edge decay MCP tool, exposing the WFD engine via CLI with Zod-validated schema and JSON-first output.

Purpose: Makes walk-forward degradation analysis available to Claude and other MCP clients. Follows the identical pattern of the three existing edge decay tools (analyze_period_metrics, analyze_rolling_metrics, analyze_regime_comparison).

Output: Updated edge-decay.ts with new tool, MCP server version bump to 0.7.2.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-walk-forward-degradation/48-01-SUMMARY.md

Key reference files (read before implementing):
@packages/mcp-server/src/tools/edge-decay.ts (add Tool 4 following exact pattern of Tools 1-3)
@packages/mcp-server/package.json (bump version)
@packages/lib/calculations/walk-forward-degradation.ts (engine to import)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register analyze_walk_forward_degradation MCP tool</name>
  <files>packages/mcp-server/src/tools/edge-decay.ts, packages/mcp-server/package.json</files>
  <action>
**In `edge-decay.ts`:**

1. Add `analyzeWalkForwardDegradation` to the import from `@tradeblocks/lib`:
```typescript
import {
  segmentByPeriod,
  computeRollingMetrics,
  runRegimeComparison,
  analyzeWalkForwardDegradation,
} from "@tradeblocks/lib";
```

2. Add Tool 4 after the `analyze_regime_comparison` registration block. Follow the EXACT pattern of Tools 1-3. Update the module header JSDoc to mention WFD.

**Tool registration:**
```
server.registerTool("analyze_walk_forward_degradation", { ... })
```

**Description:** "Run progressive walk-forward analysis to track whether out-of-sample performance is degrading relative to in-sample. Slides IS/OOS windows across trade history, computes efficiency ratios (OOS metric / IS metric) for Sharpe, win rate, and profit factor, detects trends via linear regression, and compares recent vs historical OOS efficiency."

**Zod input schema:**
- `blockId`: z.string() -- "Block folder name"
- `strategy`: z.string().optional() -- "Filter by strategy name (case-insensitive)"
- `inSampleDays`: z.number().min(30).optional() -- "In-sample window in calendar days (default: 365)"
- `outOfSampleDays`: z.number().min(7).optional() -- "Out-of-sample window in calendar days (default: 90)"
- `stepSizeDays`: z.number().min(7).optional() -- "Step size in calendar days (default: 90)"
- `minTradesPerPeriod`: z.number().min(1).optional() -- "Minimum trades for a period to be considered sufficient (default: 10)"
- `recentPeriodCount`: z.number().min(1).optional() -- "Number of recent WF periods for comparison (default: 3)"

**Handler (inside withSyncedBlock):**
1. Load block via `loadBlock(baseDir, blockId)`
2. Apply `filterByStrategy(trades, strategy)` -- same as other tools
3. If no trades, return error (same pattern as Tools 1-3)
4. Call `analyzeWalkForwardDegradation(trades, { inSampleDays, outOfSampleDays, stepSizeDays, minTradesPerPeriod, recentPeriodCount, strategy: undefined })` -- strategy already filtered
5. Build text summary:
   - Line 1: `WF degradation for {blockId}{strategy suffix}: {totalTrades} trades, {totalPeriods} periods ({sufficientPeriods} sufficient)`
   - Line 2: `Config: IS={inSampleDays}d, OOS={outOfSampleDays}d, step={stepSizeDays}d`
   - Line 3: `Recent vs historical efficiency (Sharpe): {recentAvg} vs {historicalAvg} (delta: {delta})` -- format to 2 decimal places, "N/A" if null
   - Line 4: `Trends sufficient: {yes/no}, Efficiency trend slope (Sharpe): {slope or N/A}`
6. Build structured JSON including ALL result data:
   - `blockId`, `strategy` (null if not filtered)
   - `periods` (full array from result)
   - `efficiencyTrends` (from result)
   - `recentVsHistorical` (from result)
   - `config` (resolved config from result)
   - `dataQuality` (from result)
7. Return `createToolOutput(summary, structuredData)`
8. Wrap in try/catch, return error on failure (same pattern as Tools 1-3)

**In `package.json`:**
Bump version from `"0.7.1"` to `"0.7.2"`.

**Build verification:**
Run `npm run build` in packages/mcp-server/ (or whatever the build command is) to verify TypeScript compiles and the tool is registered correctly.
  </action>
  <verify>
1. Build MCP server: `cd /Users/davidromeo/Code/tradeblocks/packages/mcp-server && npm run build`
2. Verify no TypeScript errors in build output
3. Run full test suite: `cd /Users/davidromeo/Code/tradeblocks && npm test` -- all pass
4. CLI verification (if possible, may be blocked by DuckDB lock): `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_walk_forward_degradation '{"blockId":"main-port-2026"}'`
  </verify>
  <done>
analyze_walk_forward_degradation MCP tool is registered in edge-decay.ts with Zod-validated schema, JSON-first output via createToolOutput, and error handling. MCP server builds successfully. Version bumped to 0.7.2. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. MCP server builds without TypeScript errors
2. `analyze_walk_forward_degradation` is registered alongside existing 3 edge decay tools
3. Tool accepts all WFD config parameters via Zod schema
4. Tool returns text summary + structured JSON data
5. Error handling follows same pattern as other tools
6. MCP server version is 0.7.2
7. Full test suite passes with no regressions
</verification>

<success_criteria>
- analyze_walk_forward_degradation registered in edge-decay.ts
- Zod schema validates blockId (required) + strategy + 5 optional config params
- Text summary includes trade count, period count, recent vs historical efficiency, trend info
- Structured JSON includes full periods array, trends, comparison, config, dataQuality
- MCP server builds and version is 0.7.2
- All four edge decay tools registered: analyze_period_metrics, analyze_rolling_metrics, analyze_regime_comparison, analyze_walk_forward_degradation
</success_criteria>

<output>
After completion, create `.planning/phases/48-walk-forward-degradation/48-02-SUMMARY.md`
</output>
