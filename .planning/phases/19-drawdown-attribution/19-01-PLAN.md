---
phase: 19-drawdown-attribution
plan: 01
type: execute
---

<objective>
Implement the `drawdown_attribution` MCP tool to identify which strategies contributed most to losses during the portfolio's maximum drawdown period.

Purpose: Enable users to understand which strategies are responsible for the worst portfolio drawdowns, helping them make informed decisions about strategy allocation.
Output: Working MCP tool with integration tests, verified via CLI test mode.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (context for patterns)
@.planning/phases/17-block-diff/17-01-SUMMARY.md
@.planning/phases/18-stress-test/18-01-SUMMARY.md

# Key source files
@packages/mcp-server/src/tools/blocks.ts
@lib/calculations/portfolio-stats.ts

**Tech stack available:** MCP SDK, Zod validation, PortfolioStatsCalculator
**Established patterns:** JSON-first output, trade-based calculations only (no daily logs for filtered analysis), filterByDateRange utility, CLI test mode verification

**Constraining decisions:**
- Phase 17: Trade-based calculations only for comparison tools (daily logs represent full portfolio)
- Phase 17.1: CLI test verification required for all v2.1 MCP tools

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement drawdown_attribution MCP tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add `drawdown_attribution` tool to blocks.ts after the stress_test tool. The tool should:

1. **Input schema:**
   - `blockId`: string (required) - Block folder name
   - `strategy`: string (optional) - Filter to specific strategy before calculating drawdown
   - `topN`: number (optional, default 5) - Number of top contributors to return

2. **Implementation logic:**
   a. Load block and get trades (filter by strategy if provided)
   b. Build equity curve from trades using trade-based approach (no daily logs per constraining decision):
      - Sort trades by close date/time
      - Calculate initial capital from first trade's fundsAtClose - pl
      - Track cumulative equity at each trade close
   c. Find max drawdown period:
      - Track peak equity and peak date
      - At each point, calculate drawdown from peak
      - Track max drawdown, its start date (peak), and end date (trough)
   d. Filter trades to the drawdown period (trades closed between peak and trough dates)
   e. Group trades by strategy and calculate:
      - Total P/L per strategy during drawdown
      - Trade count per strategy
      - Contribution percentage (strategy P/L / total portfolio loss during period)
   f. Sort strategies by P/L (most negative first) and return topN
   g. Include overall drawdown stats: maxDrawdown%, peakDate, troughDate, totalLoss, duration (days)

3. **Output format (JSON-first pattern):**
   - Summary line: "Drawdown Attribution: {blockId} | Max DD: {pct}% | {startDate} to {endDate} | Top contributor: {strategy} ({pct}%)"
   - Structured data with drawdown period info and per-strategy attribution

4. **Edge cases:**
   - Return null stats if no trades or no drawdown (always at peak)
   - Handle single-trade blocks gracefully
   - If all strategies had positive P/L during the "drawdown" period (unusual), still return them sorted by contribution

Use the existing `filterByDateRange` utility for date filtering. Follow the stress_test tool pattern for structure and error handling.
  </action>
  <verify>TypeScript compiles: `npm run typecheck` in packages/mcp-server</verify>
  <done>Tool registered, compiles without errors, follows JSON-first output pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests and verify via CLI</name>
  <files>packages/mcp-server/tests/integration/drawdown-attribution.test.ts, packages/mcp-server/tests/fixtures/drawdown-test-block/tradelog.csv</files>
  <action>
1. **Create test fixture** at `packages/mcp-server/tests/fixtures/drawdown-test-block/tradelog.csv`:
   - Design trades that create a clear drawdown period
   - Include 3-4 strategies with different P/L during the drawdown
   - Example sequence:
     - Day 1-5: Gains (equity rises to peak)
     - Day 6-10: Losses from multiple strategies (drawdown period)
     - Day 11-15: Recovery (equity rises again)
   - Strategy A: Big loser during drawdown (-$500)
   - Strategy B: Moderate loser (-$200)
   - Strategy C: Small winner during drawdown (+$50)
   - This creates clear attribution: A contributed most to drawdown

2. **Create test file** at `packages/mcp-server/tests/integration/drawdown-attribution.test.ts`:
   - Test basic attribution: verify top contributor is correctly identified
   - Test topN parameter: verify limiting results works
   - Test strategy filter: when filtering to single strategy, attribution shows only that strategy
   - Test edge case: block with no drawdown (always rising)
   - Test edge case: single trade block

3. **Verify via CLI test mode** (manual verification step documented in test file):
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call drawdown_attribution '{"blockId":"main-port-2026"}'
   ```
   Document expected output structure in test file comments.
  </action>
  <verify>`npm test -- tests/integration/drawdown-attribution.test.ts` passes all tests</verify>
  <done>Integration tests pass, CLI test mode documented, tool verified with real data</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes in packages/mcp-server
- [ ] `npm test` passes all tests including new drawdown-attribution tests
- [ ] CLI test mode works: `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call drawdown_attribution '{"blockId":"<test-block>"}'`
- [ ] Output follows JSON-first pattern with summary line and structured data
- [ ] Drawdown period correctly identified (peak to trough dates)
- [ ] Strategy attribution percentages sum to ~100% (within rounding)
</verification>

<success_criteria>

- Both tasks completed
- All verification checks pass
- Tool correctly identifies max drawdown period
- Strategy contributions correctly calculated and sorted
- CLI test verification documented
</success_criteria>

<output>
After completion, create `.planning/phases/19-drawdown-attribution/19-01-SUMMARY.md` using template:
~/.claude/get-shit-done/templates/summary.md
</output>
