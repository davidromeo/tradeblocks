---
phase: 18-stress-test
plan: 01
type: execute
---

<objective>
Implement the `stress_test` MCP tool to show portfolio performance during named historical market scenarios.

Purpose: Enable AI agents to quickly assess how a portfolio would have performed during historical stress events (COVID crash, 2022 bear market, VIX spikes) without manually specifying date ranges.
Output: Working stress_test MCP tool with comprehensive integration tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/17-block-diff/17-01-SUMMARY.md
@.planning/phases/17.1-cli-test-mode/17.1-01-SUMMARY.md

# Key files to reference:
@packages/mcp-server/src/tools/blocks.ts - MCP tool patterns (block_diff, get_statistics)
@packages/mcp-server/tests/integration/block-diff.test.ts - Test patterns

**Tech stack available:**
- MCP SDK with Zod schemas
- PortfolioStatsCalculator from @lib/calculations/portfolio-stats
- createToolOutput for JSON-first output pattern

**Established patterns:**
- filterByDateRange for date filtering
- JSON-first output with summary + structuredData
- Integration tests with test fixtures
- CLI test mode for verification

**Constraining decisions:**
- Phase 17: Trade-based calculations only for comparison tools (don't use daily logs)
- Phase 17.1: CLI test mode available via `--call` flag
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement stress_test MCP tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add stress_test tool to blocks.ts following the established MCP tool pattern.

**Input schema:**
- `blockId` (string, required): Block to analyze
- `scenarios` (array of strings, optional): Specific scenarios to test. If omitted, run all built-in scenarios.
- `customScenarios` (array of {name, startDate, endDate}, optional): User-defined scenarios with custom date ranges

**Built-in scenarios to define (all post-2013 since backtests start there):**

**Crashes & Corrections:**
1. "china_deval_2015" - 2015-08-11 to 2015-08-25 (China yuan devaluation, global selloff)
2. "brexit" - 2016-06-23 to 2016-06-27 (UK Brexit vote shock)
3. "volmageddon" - 2018-02-02 to 2018-02-09 (VIX spike, XIV blowup, largest VIX jump since 1987)
4. "q4_2018" - 2018-10-01 to 2018-12-24 (Fed rate hike selloff)
5. "covid_crash" - 2020-02-19 to 2020-03-23 (pandemic crash, peak to trough)
6. "bear_2022" - 2022-01-03 to 2022-10-12 (Fed tightening bear market)
7. "svb_crisis" - 2023-03-08 to 2023-03-15 (Silicon Valley Bank collapse, regional bank contagion)
8. "vix_aug_2024" - 2024-08-01 to 2024-08-15 (Yen carry trade unwind, VIX spike)
9. "liberation_day" - 2025-04-02 to 2025-04-08 (Trump tariffs, largest drop since COVID)

**Recoveries:**
10. "covid_recovery" - 2020-03-23 to 2020-08-18 (V-shaped recovery)
11. "liberation_recovery" - 2025-04-09 to 2025-05-02 (Post 90-day tariff pause rally, S&P +9.5% single day)

**Implementation:**
1. Define SCENARIOS constant with name, startDate, endDate, description
2. Validate requested scenarios exist (or use all if none specified)
3. Merge built-in and custom scenarios
4. For each scenario:
   - Filter trades to scenario date range using existing filterByDateRange
   - Calculate stats using PortfolioStatsCalculator (trade-based only, no daily logs)
   - Track trades found and metrics
5. Handle scenarios with no trades (return null stats, not error)
6. Return summary + JSON-first output

**Output structure:**
```json
{
  "blockId": "...",
  "scenarios": [
    {
      "name": "covid_crash",
      "description": "COVID-19 market crash peak to trough",
      "dateRange": { "start": "2020-02-19", "end": "2020-03-23" },
      "tradeCount": 15,
      "stats": { "netPl": -1234, "winRate": 0.4, "maxDrawdown": 0.15, ... } | null
    },
    ...
  ],
  "summary": {
    "totalScenarios": 6,
    "scenariosWithTrades": 4,
    "worstScenario": "covid_crash",
    "bestScenario": "covid_recovery"
  }
}
```

**Avoid:** Using daily logs for stats - use trade-based calculations only (consistent with block_diff pattern).
  </action>
  <verify>npm run build -w packages/mcp-server succeeds, npm run typecheck -w packages/mcp-server passes</verify>
  <done>stress_test tool registered and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests</name>
  <files>packages/mcp-server/tests/integration/stress-test.test.ts, packages/mcp-server/tests/fixtures/stress-test-block/tradelog.csv</files>
  <action>
Create integration test suite following block-diff.test.ts pattern.

**Test fixture:**
Create stress-test-block with trades spanning multiple scenario periods:
- Trades in COVID crash period (Feb-Mar 2020)
- Trades in 2022 bear market period
- Trades in VIX Aug 2024 period
- Some trades outside all scenario periods

Use realistic trade structure from existing fixtures but with dates matching scenarios.

**Test cases (8-10 tests):**
1. Returns all built-in scenarios by default
2. Returns specific scenarios when requested
3. Handles custom scenarios with user-defined dates
4. Returns null stats for scenarios with no trades
5. Correctly calculates stats for each scenario
6. Identifies worst and best scenarios in summary
7. Filters correctly to scenario date ranges
8. Handles non-existent block gracefully
9. Mixes built-in and custom scenarios correctly
10. Handles block with no trades in any scenario

**Pattern to follow:**
- Use `listToolsCapture` and `executeToolCapture` from block-diff tests
- Parse JSON from resource content
- Assert on structuredData fields
  </action>
  <verify>npm test -w packages/mcp-server -- --testPathPatterns=stress-test passes all tests</verify>
  <done>Integration test suite created with 8+ passing tests covering all major functionality</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build -w packages/mcp-server` succeeds
- [ ] `npm run typecheck -w packages/mcp-server` passes
- [ ] `npm test -w packages/mcp-server` passes (all existing + new tests)
- [ ] `npm test -w packages/mcp-server -- --testPathPatterns=stress-test` passes (8+ tests)
- [ ] CLI test works: `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call stress_test '{"blockId":"main-port-2026"}'`
</verification>

<success_criteria>

- stress_test tool implemented with 11 built-in scenarios (9 crashes + 2 recoveries)
- Custom scenario support working
- 8+ integration tests passing
- JSON-first output consistent with other MCP tools
- No TypeScript errors
- CLI test mode works with real data
</success_criteria>

<output>
After completion, create `.planning/phases/18-stress-test/18-01-SUMMARY.md`:

# Phase 18 Plan 01: Stress Test Tool Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `packages/mcp-server/src/tools/blocks.ts` - Added stress_test tool
- `packages/mcp-server/tests/integration/stress-test.test.ts` - Integration tests
- `packages/mcp-server/tests/fixtures/stress-test-block/tradelog.csv` - Test fixture

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 19: Drawdown Attribution Tool
</output>
