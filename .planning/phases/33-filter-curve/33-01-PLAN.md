---
phase: 33-filter-curve
plan: 01
type: execute
domain: mcp-server
---

<objective>
Create MCP tool that sweeps filter thresholds for a field and returns outcome curves.

Purpose: After find_predictive_fields identifies correlated fields, users need to know WHERE to set the threshold. This tool sweeps across possible values and shows performance at each, enabling data-driven filter optimization.
Output: New `filter_curve` MCP tool that generates threshold outcome curves and identifies sweet spots.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (dependency)
@.planning/phases/32-find-predictive-fields/32-01-SUMMARY.md

# Key source files
@packages/mcp-server/src/tools/reports.ts
@packages/lib/models/report-config.ts

# Patterns from Phase 32
The find_predictive_fields tool established:
- Runtime defaults pattern: `rawParam ?? defaultValue`
- Guard pattern for getTradeFieldValue
- Use enrichTrades() inline, getTradeFieldValue() for field extraction
- createToolOutput() for JSON-first responses
- Support strategy/date pre-filters

# Available helpers in reports.ts
- enrichTrades(): Adds derived fields (rom, plPct, durationHours, etc.)
- getTradeFieldValue(): Extracts field value from enriched trade
- filterByStrategy(), filterByDateRange(): Pre-filters
- percentile(): Calculate percentile from sorted array
- stdDev(): Standard deviation

# CLI test mode
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call <tool> '<json>'
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filter_curve MCP tool</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Add new MCP tool `filter_curve` to reports.ts. Implementation details:

1. **Input schema** (Zod):
   - blockId: string (required) - Block folder name
   - field: string (required) - Field to sweep thresholds on (e.g., "openingVix", "durationHours")
   - mode: enum "lt" | "gt" | "both" (default: "both") - Direction of filter
     - "lt": Only show trades where field < threshold
     - "gt": Only show trades where field > threshold
     - "both": Show both directions at each threshold
   - thresholds: number[] (optional) - Custom threshold values to test. If omitted, auto-generate from percentiles.
   - percentileSteps: number[] (optional, default: [5, 10, 25, 50, 75, 90, 95]) - Percentiles to use for auto-generated thresholds
   - strategy: string (optional) - Pre-filter by strategy
   - startDate: string (optional) - Pre-filter start date (YYYY-MM-DD)
   - endDate: string (optional) - Pre-filter end date (YYYY-MM-DD)

2. **Logic**:
   - Load block, apply pre-filters, enrich trades
   - Extract field values, calculate baseline metrics (all trades)
   - Generate thresholds:
     - If custom thresholds provided, use those
     - Otherwise, calculate thresholds from percentileSteps of field distribution
   - For each threshold, for each mode direction:
     - Filter trades by condition (field < threshold or field > threshold)
     - Calculate metrics: count, winRate, avgPl, totalPl, percentOfTrades
     - Calculate improvement vs baseline: winRateDelta, avgPlDelta
   - Identify sweet spots: thresholds where both winRate AND avgPl improve over baseline

3. **Output structure**:
   - Summary: "Filter curve for {field}: {N} thresholds analyzed | {M} sweet spots found"
   - structuredData:
     - blockId, field, mode, filters applied
     - baseline: { count, winRate, avgPl, totalPl } (unfiltered metrics)
     - thresholds: array sorted by threshold value
     - For "both" mode, each threshold entry has:
       - threshold: number
       - lt: { count, percentOfTrades, winRate, avgPl, totalPl, winRateDelta, avgPlDelta }
       - gt: { count, percentOfTrades, winRate, avgPl, totalPl, winRateDelta, avgPlDelta }
     - For "lt" or "gt" mode, flatten to single direction per threshold
     - sweetSpots: array of { threshold, direction, winRateDelta, avgPlDelta, recommendation }
       - recommendation: "Consider filtering {field} {direction} {threshold}"

4. **Sweet spot detection**:
   - A sweet spot is a threshold where:
     - winRateDelta > 0 (win rate improves)
     - avgPlDelta > 0 (average P/L improves)
     - percentOfTrades >= 20% (retains meaningful sample)
   - Rank sweet spots by (winRateDelta * avgPlDelta) as combined improvement score

CRITICAL: Apply runtime defaults pattern (rawParam ?? defaultValue) for all optional params with defaults.
  </action>
  <verify>npm run typecheck passes in packages/mcp-server/</verify>
  <done>
- Tool registered with proper Zod schema
- Threshold sweeping works for both auto-generated and custom thresholds
- Bidirectional mode ("both") returns lt/gt results at each threshold
- Baseline metrics calculated correctly
- Sweet spots identified with meaningful criteria
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI test verification with real data</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Test the new tool using CLI test mode with actual backtest data.

1. **Build MCP server**:
   ```bash
   cd packages/mcp-server && npm run build
   ```

2. **Basic test with auto-generated thresholds**:
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call filter_curve '{"blockId":"<real-block-id>","field":"openingVix"}'
   ```
   Verify:
   - Baseline metrics present
   - Thresholds correspond to percentiles of openingVix distribution
   - Both lt and gt results at each threshold
   - Sweet spots array populated (may be empty if no improvement found)

3. **Test single direction mode**:
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call filter_curve '{"blockId":"<block-id>","field":"openingVix","mode":"lt"}'
   ```
   Verify output only includes lt results.

4. **Test custom thresholds**:
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call filter_curve '{"blockId":"<block-id>","field":"openingVix","thresholds":[15,20,25,30]}'
   ```
   Verify exactly those 4 thresholds in output.

5. **Test different field** (from Phase 32's find_predictive_fields output):
   ```bash
   TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call filter_curve '{"blockId":"<block-id>","field":"durationHours"}'
   ```

If any test reveals issues, fix them in reports.ts before proceeding.
  </action>
  <verify>CLI test returns valid JSON with threshold curves</verify>
  <done>
- Tool returns properly formatted JSON output
- Auto-generated thresholds span the field's distribution
- Baseline metrics match expected portfolio stats
- Sweet spots detection produces sensible recommendations
- Performance acceptable (< 5s for typical portfolio)
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes in packages/mcp-server/
- [ ] CLI test with "openingVix" field returns valid threshold curve
- [ ] Both lt/gt directions work correctly
- [ ] Custom thresholds override auto-generation
- [ ] Sweet spots identified with proper criteria
- [ ] Output follows JSON-first pattern (createToolOutput)
</verification>

<success_criteria>
- filter_curve tool registered and working
- Threshold sweeping generates meaningful data points
- Bidirectional analysis shows tradeoffs at each threshold
- Sweet spots help users identify optimal filter values
- CLI test verification passed
- Code follows patterns established in Phase 32
</success_criteria>

<output>
After completion, create `.planning/phases/33-filter-curve/33-01-SUMMARY.md`:

# Phase 33 Plan 01: filter-curve Tool Summary

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `packages/mcp-server/src/tools/reports.ts` - Added filter_curve tool

## Decisions Made
- [Any implementation choices]

## Issues Encountered
- [Problems and resolutions, or "None"]

## CLI Test Results
- [Sample output from verification]

## Next Step
Phase 33 complete, ready for Phase 34 (report-tools-fixes)
</output>
