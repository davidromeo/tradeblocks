---
phase: 22-what-if-scaling
plan: 01
type: execute
---

<objective>
Implement what_if_scaling MCP tool for exploring strategy weight combinations within a portfolio.

Purpose: Answer "what if I scaled strategy X to 0.5x?" questions - optimizing strategy mix, not overall leverage. Enables AI-as-optimizer pattern where 3-4 quick weight explorations converge on optimal blend.
Output: MCP tool (Tool 11) with before/after portfolio comparison and per-strategy breakdown.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase patterns (from frontmatter):
@.planning/phases/21-strategy-similarity/21-01-SUMMARY.md
@.planning/phases/20-marginal-contribution/20-01-SUMMARY.md

# Key files:
@packages/mcp-server/src/tools/blocks.ts

**Tech stack available:** MCP server, PortfolioStatsCalculator, filterByStrategy, filterByDateRange
**Established patterns:** JSON-first output (summary line + structuredData), trade-based calculations only, CLI test mode verification
**Constraining decisions:**
- Phase 17: Trade-based calculations only for comparison tools (no daily logs)
- Phase 17.1: CLI test mode verification required for all v2.1 MCP tools
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement what_if_scaling MCP tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add Tool 11: what_if_scaling after strategy_similarity (renumber get_trades to Tool 12).

Input schema:
- blockId: string (required) - Block folder name
- strategyWeights: Record<string, number> (optional) - Weight per strategy, e.g., {"5/7 17Δ": 0.5}
  - Unspecified strategies default to 1.0
  - Weight 0 = exclude strategy entirely
  - Weight range: 0 to 2.0 (cap for realism)
- startDate/endDate: string (optional) - Date range filters

Algorithm:
1. Load block and filter trades by date range if specified
2. Get all unique strategies from trades
3. Apply weights to each trade:
   - Look up strategy's weight (default 1.0 if not specified)
   - Scale P/L: `scaledPl = trade.pl * weight`
   - Scale commissions proportionally: `scaledComm = (openingComm + closingComm) * weight`
   - Weight 0 = exclude trade entirely from scaled portfolio
4. Calculate baseline metrics using original trades (calculator.calculatePortfolioStats with trade-based mode)
5. Calculate scaled metrics using scaled trades (excluding weight=0 trades)
6. Calculate per-strategy breakdown showing original vs scaled contribution

Output structure (JSON-first pattern):
- Summary line with key deltas:
  "What-If Scaling: {blockId} | Sharpe {baseline} → {scaled} ({delta}%) | MDD {baseline}% → {scaled}% ({delta}%)"

- structuredData:
  - blockId, strategyWeights (as applied, including defaults), dateRange
  - comparison: {
      sharpeRatio: { original, scaled, delta, deltaPct },
      sortinoRatio: { original, scaled, delta, deltaPct },
      maxDrawdown: { original, scaled, delta, deltaPct },
      netPl: { original, scaled, delta, deltaPct },
      totalTrades: { original, scaled }  // scaled excludes weight=0
    }
  - perStrategy: Array of {
      strategy: string,
      weight: number,  // 1.0 for unscaled, actual weight for scaled
      original: { trades, netPl, plContributionPct },
      scaled: { trades, netPl, plContributionPct },
      delta: { netPl, netPlPct }  // 0% delta for unscaled strategies
    }
    // Show ALL strategies, not just scaled ones - confirms what stayed at 1.0x

Example output for what_if_scaling(blockId, {"5/7 17Δ": 0.5}):
```
What-If Scaling: main-port | Sharpe 6.21 → 6.35 (+2.3%) | MDD 5.86% → 5.52% (-5.8%)

comparison:
  sharpeRatio: { original: 6.21, scaled: 6.35, delta: 0.14, deltaPct: 2.3 }
  maxDrawdown: { original: 5.86, scaled: 5.52, delta: -0.34, deltaPct: -5.8 }
  netPl: { original: 66000000, scaled: 58000000, delta: -8000000, deltaPct: -12.1 }

perStrategy:
  - { strategy: "5/7 17Δ", weight: 0.5, original: {...}, scaled: {...}, delta: {netPlPct: -50} }
  - { strategy: "Friday DC 5/7 25D", weight: 1.0, original: {...}, scaled: {...}, delta: {netPlPct: 0} }
  - { strategy: "Other Strategy", weight: 1.0, ... }
```

Edge cases:
- Empty block: Return error message
- No strategyWeights provided: Return baseline = scaled (all weights 1.0, no change)
- Strategy in weights not found in block: Warn but continue (ignore unknown strategy)
- All strategies weight 0: Return error (empty scaled portfolio)

AVOID: Using daily logs (per Phase 17 constraint).
DO: Scale commissions proportionally with weight (0.5x size ≈ 0.5x commissions).
  </action>
  <verify>npm run typecheck passes, tool registered in blocks.ts</verify>
  <done>what_if_scaling tool implemented with strategy weights, before/after comparison, per-strategy breakdown</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for what_if_scaling</name>
  <files>packages/mcp-server/tests/integration/what-if-scaling.test.ts</files>
  <action>
Create integration tests using existing fixture (reuse marginal-test-block which has 3 strategies: HighSharpe, Volatile, Neutral).

Test cases:
1. No weights (baseline = scaled): All strategies at 1.0x, verify metrics identical
2. Single strategy 0.5x: Scale one strategy, verify:
   - That strategy's P/L contribution halved
   - Other strategies unchanged (delta 0%)
   - Portfolio metrics recalculated
3. Single strategy 2.0x: Scale up, verify proportional increase
4. Weight 0 (exclude): Set strategy weight to 0, verify:
   - Strategy excluded from scaled portfolio
   - Trade count reduced in scaled
   - Equivalent to marginal_contribution "without" calculation
5. Multiple strategy weights: {"HighSharpe": 0.5, "Volatile": 1.5}
6. Unknown strategy in weights: Warn and ignore, process valid weights
7. All strategies weight 0: Return error (empty portfolio)
8. Date range + weights: Both filters applied correctly
9. Commission scaling: Verify commissions scale with weight

Verification approach:
- For 0.5x scaling with known P/L, verify scaled P/L = original * 0.5
- Verify commissions also scaled by 0.5
- Verify per-strategy breakdown shows all strategies
- Verify unscaled strategies show 0% delta

Add CLI test mode documentation:
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call what_if_scaling '{"blockId":"main-port-2026","strategyWeights":{"5/7 17Δ":0.5}}'
```
  </action>
  <verify>npm test -- packages/mcp-server/tests/integration/what-if-scaling.test.ts passes</verify>
  <done>Integration tests pass, CLI test mode documented, all edge cases covered</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes
- [ ] `npm test -- packages/mcp-server/tests/integration/what-if-scaling.test.ts` passes
- [ ] Tool appears in blocks.ts as Tool 11
- [ ] JSON output includes comparison table and per-strategy breakdown
- [ ] Commissions scale proportionally with weights
</verification>

<success_criteria>

- what_if_scaling tool implemented with strategyWeights parameter
- Before/after comparison with delta percentages
- Per-strategy breakdown showing ALL strategies (not just scaled)
- Weight 0 excludes strategy entirely
- Commissions scale with weights
- Integration tests cover weight combinations and edge cases
- CLI test mode documented
</success_criteria>

<output>
After completion, create `.planning/phases/22-what-if-scaling/22-01-SUMMARY.md` following summary-frontmatter.md template with:
- Frontmatter: phase, plan, subsystem, tags, requires, provides, affects, tech-stack, key-files, key-decisions, patterns-established, issues-created, duration, completed
- Performance section
- Accomplishments
- Task commits
- Files created/modified
- Decisions made (strategyWeights design, commission scaling, etc.)
- CLI test mode documentation
- Future enhancement note: keepTotalExposure flag for capital reallocation
- Next phase readiness
</output>
