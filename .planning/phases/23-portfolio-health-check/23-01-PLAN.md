---
phase: 23-portfolio-health-check
plan: 01
type: execute
---

<objective>
Implement portfolio_health_check MCP tool that runs correlation + tail risk + Monte Carlo in one call and returns a unified, layered health assessment.

Purpose: Eliminate the friction of running multiple analysis tools and digging through raw matrices. One call surfaces everything important with actionable flags.
Output: Working MCP tool with integration tests, CLI verification ready.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-portfolio-health-check/23-CONTEXT.md

# Prior v2.1 tool patterns
@.planning/phases/21-strategy-similarity/21-01-SUMMARY.md
@.planning/phases/22-what-if-scaling/22-01-SUMMARY.md

# Relevant source files
@packages/mcp-server/src/tools/blocks.ts
@packages/mcp-server/src/tools/analysis.ts

**Tech stack available:** MCP SDK, Zod validation, existing calculation utilities
**Established patterns:**
- createToolOutput for JSON-first responses
- filterByStrategy, filterByDateRange utilities
- SIMILARITY_DEFAULTS typed constant pattern
- CLI test verification via --call mode

**Constraining decisions:**
- Phase 17: Trade-based calculations only (no daily logs)
- Phase 21: Composite similarity scoring pattern (weighted components)
- Phase 17.1: CLI test mode verification required

**Vision from context:**
- 4 layers: verdict -> grades -> flags -> key numbers
- Grades: A/B/C (with +/- modifiers)
- Flags: specific strategy names + numbers
- Configurable thresholds via optional parameters
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement portfolio_health_check tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add portfolio_health_check as Tool 12 in blocks.ts. Structure:

**Defaults constant (HEALTH_CHECK_DEFAULTS):**
- correlationThreshold: 0.5 (flag pairs above this)
- tailDependenceThreshold: 0.5 (flag pairs above this)
- profitProbabilityThreshold: 0.95 (MC, below this is warning)
- wfeThreshold: -0.15 (WFA degradation, below this is warning)
- mddMultiplierThreshold: 3.0 (MC MDD vs historical, above this is warning)

**Input schema:**
- blockId (required)
- correlationThreshold, tailDependenceThreshold, profitProbabilityThreshold, wfeThreshold, mddMultiplierThreshold (all optional with defaults)

**Implementation logic:**
1. Load block and trades
2. Require >= 2 strategies and >= 20 trades
3. Calculate portfolio stats via calculator (Sharpe, MDD, trade count, etc.)
4. Calculate correlation matrix (kendall, raw, opened)
5. Calculate tail risk (0.1 threshold)
6. Run Monte Carlo (1000 sims, trades method)
7. Run WFA if possible (try 5 IS windows, 1 OOS)

**Build 4-layer response:**

Layer 1 - Verdict:
- Count flags (warnings from each dimension)
- 0 flags = "HEALTHY", 1-2 = "MODERATE_CONCERNS", 3+ = "ISSUES_DETECTED"
- oneLineSummary explains the verdict

Layer 2 - Grades (A/B/C/F, no +/- modifiers for simplicity):
- diversification: based on avg correlation (A: <0.2, B: <0.4, C: <0.6, F: >=0.6)
- tailRisk: based on avg joint tail risk (A: <0.3, B: <0.5, C: <0.7, F: >=0.7)
- robustness: based on WFE (A: >0, B: >-0.1, C: >-0.2, F: <=-0.2), null if WFA skipped (doesn't count toward flags)
- consistency: based on MC profit probability (A: >=0.98, B: >=0.90, C: >=0.70, F: <0.70)

Layer 3 - Flags (array of objects):
- type: "warning" or "pass"
- dimension: "diversification" | "tailRisk" | "robustness" | "consistency"
- message: actionable text with strategy names and numbers

Generate flags:
- High correlation pairs (> threshold): list each pair
- High tail dependence pairs (> threshold): list each pair
- MC profit probability below threshold
- MC median MDD vs historical MDD multiplier above threshold
- WFE below threshold

Layer 4 - Key numbers:
- strategies, trades, sharpe, sortino, maxDrawdownPct, netPl
- avgCorrelation, avgTailDependence
- mcProbabilityOfProfit, mcMedianMdd, mcMddMultiplier (MC median MDD / historical MDD)
- wfe (null if skipped)

Use createToolOutput with summary line: "Health Check: {blockId} | {verdict} | {flagCount} flags | Sharpe: {sharpe}"
  </action>
  <verify>npm run typecheck in packages/mcp-server/ passes</verify>
  <done>Tool registered, compiles without errors, follows established patterns</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests</name>
  <files>packages/mcp-server/tests/integration/portfolio-health-check.test.ts</files>
  <action>
Create integration test file following strategy-similarity.test.ts pattern.

**Test fixture:** Use existing fixtures (similarity-test-block or multi-strat-test-block) - they have multiple strategies which is what we need.

**Simulate tool function:** Create simulatePortfolioHealthCheck() that mirrors the tool logic using loadBlock and calculation utilities from test-exports.js.

**Test cases (6-8 tests):**
1. Returns HEALTHY verdict for well-diversified portfolio (mock low correlation data)
2. Flags high correlation pairs correctly (use fixture strategies that correlate)
3. Flags high tail dependence pairs correctly
4. Returns null grades when WFA cannot run (insufficient data)
5. Respects custom thresholds (pass higher threshold, verify no flag)
6. Returns ISSUES_DETECTED when multiple dimensions have warnings
7. Key numbers are populated and reasonable
8. Handles edge case: exactly 2 strategies (minimum)

**Test structure:**
- Import from test-exports.js (bundled @lib dependencies)
- Define TypeScript interfaces for result structure
- Each test validates specific behavior with clear assertions

Follow CLI test comment pattern:
```
CLI Test Mode Verification:
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call portfolio_health_check '{"blockId":"main-port-2026"}'
```
  </action>
  <verify>npm test -- tests/integration/portfolio-health-check.test.ts passes</verify>
  <done>All test cases pass, coverage for 4 layers + edge cases</done>
</task>

<task type="auto">
  <name>Task 3: CLI verification and final validation</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Run CLI test with real data to verify tool works end-to-end:

```bash
cd packages/mcp-server && npm run build
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call portfolio_health_check '{"blockId":"main-port-2026"}'
```

Verify output:
1. Summary line appears with verdict and flag count
2. JSON includes all 4 layers (verdict, grades, flags, keyNumbers)
3. Flags have specific strategy names (not generic text)
4. Grades use A/B/C/F format
5. Key numbers are populated

If any issues found, fix in blocks.ts and re-test.

Also run full test suite to ensure no regressions:
```bash
npm test
```
  </action>
  <verify>CLI outputs valid 4-layer health assessment, all tests pass</verify>
  <done>Tool works with real data, produces actionable output matching vision</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck` passes in packages/mcp-server/
- [ ] `npm test` passes all tests including new integration tests
- [ ] CLI verification shows 4-layer output structure
- [ ] Flags include specific strategy names and numbers
- [ ] Grades use A/B/C/F format
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- portfolio_health_check tool registered as Tool 12
- 4-layer response structure: verdict -> grades -> flags -> keyNumbers
- Configurable thresholds with sensible defaults
- Integration tests covering main scenarios
- CLI verification successful with real data
</success_criteria>

<output>
After completion, create `.planning/phases/23-portfolio-health-check/23-01-SUMMARY.md`
</output>
