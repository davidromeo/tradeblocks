---
phase: 64-cleanup-and-api-surface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/market-data.ts
  - packages/mcp-server/src/tools/sql.ts
  - packages/mcp-server/src/tools/schema.ts
  - packages/mcp-server/src/tools/reports/queries.ts
  - packages/mcp-server/src/sync/index.ts
  - packages/mcp-server/src/test-exports.ts
  - packages/mcp-server/src/index.ts
  - packages/mcp-server/src/sync/market-sync.ts
  - packages/mcp-server/src/utils/intraday-timing.ts
  - packages/mcp-server/tests/integration/market-sync-multi-ticker.test.ts
  - packages/mcp-server/tests/unit/intraday-timing.test.ts
autonomous: true
requirements: [CLN-02, CLN-03, CLN-04, CLN-07]

must_haves:
  truths:
    - "run_sql accepts queries against market.daily, market.context, market.intraday, market._sync_metadata"
    - "run_sql rejects queries referencing old table names (market.spx_daily, market.spx_15min, market.vix_intraday) by failing the allowlist"
    - "describe_database shows intraday example queries and an Import Workflow section"
    - "market-sync.ts and intraday-timing.ts are deleted with zero remaining import references"
    - "enrich_trades returns raw intraday bars (array of {time, open, high, low, close}) instead of pivoted checkpoint columns"
    - "McpServer version in index.ts matches package.json version (1.5.0)"
  artifacts:
    - path: "packages/mcp-server/src/tools/sql.ts"
      provides: "Updated AVAILABLE_TABLES array and tool description with new table names"
      contains: "market.daily"
    - path: "packages/mcp-server/src/tools/schema.ts"
      provides: "Intraday example queries and Import Workflow guidance"
      contains: "import_market_csv"
    - path: "packages/mcp-server/src/sync/index.ts"
      provides: "Sync module with market-sync exports removed"
  key_links:
    - from: "packages/mcp-server/src/tools/market-data.ts"
      to: "market.intraday"
      via: "Simple raw bar query replacing checkpoint pivot"
      pattern: "intradayBars"
---

<objective>
Remove dead sync code, simplify enrich_trades intraday output to raw bars, update run_sql and describe_database for the new normalized schema, and sync McpServer version.

Purpose: Clean the API surface so users and Claude see only the new normalized table names, and remove ~600 lines of dead code (market-sync.ts, intraday-timing.ts) that no longer serves any purpose after the Phase 60-63 migration.

Output: Updated MCP server with clean API surface, no dead code, and correct version metadata.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-cleanup-and-api-surface/64-RESEARCH.md

Key references:
@packages/mcp-server/src/tools/market-data.ts (lines 34-40 for intraday-timing imports, lines 946-1127 for enrich_trades intraday section)
@packages/mcp-server/src/tools/sql.ts (lines 14-36 for AVAILABLE_TABLES and header comment, lines 236-237 for tool description)
@packages/mcp-server/src/tools/schema.ts (describe_database tool — needs intraday examples + Import Workflow section)
@packages/mcp-server/src/sync/index.ts (lines 18, 55, 158-162 for syncMarketData/MarketSyncResult exports)
@packages/mcp-server/src/test-exports.ts (lines 34-38 for market-sync exports, lines 71-82 for intraday-timing exports)
@packages/mcp-server/src/index.ts (line 278 for version "1.2.0" that needs updating to "1.5.0")
@packages/mcp-server/src/tools/reports/queries.ts (line 25 stale market.spx_daily reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify enrich_trades intraday output to raw bars and remove intraday-timing dependency</name>
  <files>
    packages/mcp-server/src/tools/market-data.ts
    packages/mcp-server/src/utils/intraday-timing.ts
    packages/mcp-server/tests/unit/intraday-timing.test.ts
    packages/mcp-server/src/test-exports.ts
  </files>
  <action>
**In `market-data.ts`:**

1. Remove all imports from `intraday-timing.js` (lines 34-40): `buildIntradayContext`, `SPX_15MIN_OUTCOME_FIELDS`, `VIX_OUTCOME_FIELDS`, `SPX_CHECKPOINTS`, `VIX_CHECKPOINTS` (and `VIX_OHLC_OUTCOME_FIELDS` if present).

2. Replace the entire intraday query section (lines ~946-1019) with a simple raw-bar query. Instead of pivoting bars into checkpoint columns via CASE WHEN, query raw bars:
```typescript
if (includeIntradayContext) {
  const { valuesClause: pairsClause, params: pairParams } = buildRequestedPairsClause(tradeKeys);
  const intradayResult = await conn.runAndReadAll(
    `WITH requested(ticker, date) AS (VALUES ${pairsClause})
     SELECT i.ticker, i.date, i.time, i.open, i.high, i.low, i.close
     FROM market.intraday i
     JOIN requested r ON i.ticker = r.ticker AND i.date = r.date
     ORDER BY i.ticker, i.date, i.time`,
    pairParams
  );
  const intradayRecords = resultToRecords(intradayResult);
  // Group by ticker+date into arrays of bars
  const intradayBarsByKey = new Map<string, Array<{time: string, open: number, high: number, low: number, close: number}>>();
  for (const rec of intradayRecords) {
    const key = marketTickerDateKey(String(rec.ticker), String(rec.date));
    if (!intradayBarsByKey.has(key)) intradayBarsByKey.set(key, []);
    intradayBarsByKey.get(key)!.push({
      time: String(rec.time),
      open: Number(rec.open),
      high: Number(rec.high),
      low: Number(rec.low),
      close: Number(rec.close),
    });
  }
}
```

3. Replace the intraday context assignment in the enriched trade building loop (lines ~1090-1127). Instead of calling `buildIntradayContext()` and building intradayOutcomeFields from checkpoint fields, set:
```typescript
if (includeIntradayContext && intradayBarsByKey) {
  const bars = intradayBarsByKey.get(marketKey) || null;
  baseTrade.intradayBars = bars;
}
```
Remove the `spxIntradayMap`/`vixIntradayMap` variables and all their usage. The old checkpoint-pivot approach, `buildIntradayContext` call, and `intradayOutcomeFields` loop are all replaced by the single `intradayBars` property.

4. Remove the `VIX_OHLC_OUTCOME_FIELDS` import reference if it exists.

5. Remove the `Intraday15MinData` interface reference or any related dead types, and remove the `GLOBAL_MARKET_TICKER` usage for VIX intraday if it was only used for the old checkpoint pattern. Keep `GLOBAL_MARKET_TICKER` if it's used elsewhere (check `marketTickerDateKey` calls for VIX context lookups which may still need it for the daily entryContext).

**Delete files:**
- Delete `packages/mcp-server/src/utils/intraday-timing.ts` (entire file — checkpoint-format definitions are obsolete)
- Delete `packages/mcp-server/tests/unit/intraday-timing.test.ts` (tests for deleted code)

**In `test-exports.ts`:**
- Remove the intraday-timing export block (lines 71-82 which export `SPX_CHECKPOINTS`, `VIX_CHECKPOINTS`, `buildIntradayContext`, `IntradayContext`, `SPX_15MIN_OUTCOME_FIELDS`, `VIX_OUTCOME_FIELDS`, `VIX_OHLC_OUTCOME_FIELDS`, `GLOBAL_VIX_CHECKPOINTS`)
- Add the new Tier 3 export (consolidating all test-exports.ts edits in this plan to avoid conflicts with Plan 64-03):
  ```typescript
  export { computeIntradayTimingFields } from './utils/market-enricher.js';
  ```
  </action>
  <verify>
1. `cd packages/mcp-server && npx tsc --noEmit` — no TypeScript errors
2. `grep -r "intraday-timing" packages/mcp-server/src/` returns no results
3. `grep -r "buildIntradayContext\|SPX_CHECKPOINTS\|VIX_CHECKPOINTS\|SPX_15MIN_OUTCOME\|VIX_OUTCOME_FIELDS\|VIX_OHLC_OUTCOME" packages/mcp-server/src/` returns no results
4. Verify `packages/mcp-server/src/utils/intraday-timing.ts` does not exist
5. Verify `packages/mcp-server/tests/unit/intraday-timing.test.ts` does not exist
6. `grep -n "computeIntradayTimingFields" packages/mcp-server/src/test-exports.ts` — export exists
  </verify>
  <done>enrich_trades intraday output uses raw bar arrays (`intradayBars: [{time, open, high, low, close}, ...]`) instead of pivoted checkpoint columns; intraday-timing.ts and its test file are deleted; zero references to deleted module remain in source; computeIntradayTimingFields export added to test-exports.ts for Plan 64-03 consumption</done>
</task>

<task type="auto">
  <name>Task 2: Delete market-sync.ts, update run_sql/describe_database/index.ts, clean stale references</name>
  <files>
    packages/mcp-server/src/sync/market-sync.ts
    packages/mcp-server/src/sync/index.ts
    packages/mcp-server/src/test-exports.ts
    packages/mcp-server/tests/integration/market-sync-multi-ticker.test.ts
    packages/mcp-server/src/tools/sql.ts
    packages/mcp-server/src/tools/schema.ts
    packages/mcp-server/src/tools/reports/queries.ts
    packages/mcp-server/src/index.ts
  </files>
  <action>
**Delete order matters — delete test first to avoid import failures:**

1. **Delete** `packages/mcp-server/tests/integration/market-sync-multi-ticker.test.ts`

2. **In `packages/mcp-server/src/test-exports.ts`:** Remove the market-sync export lines (around lines 34-38):
   - Remove `syncMarketData` export
   - Remove `type MarketSyncResult` export
   - Keep all other exports intact

3. **In `packages/mcp-server/src/sync/index.ts`:** Remove:
   - The import: `import { syncMarketDataInternal } from "./market-sync.js";`
   - The `MarketSyncResult` interface export
   - The `syncMarketData` function export
   - Keep: `syncAllBlocks`, `syncBlock`, all block-sync-related exports, metadata exports, hasher exports

4. **Delete** `packages/mcp-server/src/sync/market-sync.ts`

5. **In `packages/mcp-server/src/tools/sql.ts`:**
   - Update file header comment (lines 14-19) to reference new table names:
     ```
     *   - trades.trade_data: Trade records from all blocks (includes inferred ticker)
     *   - trades.reporting_data: Reporting/actual trade records from strategy logs
     *   - market.daily: Daily OHLCV + enriched indicators keyed by (ticker, date)
     *   - market.context: Global market conditions (VIX, regime) keyed by (date)
     *   - market.intraday: Intraday bars at any resolution keyed by (ticker, date, time)
     *   - market._sync_metadata: Import/enrichment tracking metadata
     ```
   - Update `AVAILABLE_TABLES` array (lines 31-36) to:
     ```typescript
     const AVAILABLE_TABLES = [
       "trades.trade_data",
       "trades.reporting_data",
       "market.daily",
       "market.context",
       "market.intraday",
       "market._sync_metadata",
     ];
     ```
   - Update the tool description string (lines 236-237) to:
     ```
     "Query trades (trades.trade_data, trades.reporting_data) and market data " +
     "(market.daily, market.context, market.intraday, market._sync_metadata). " +
     ```

6. **In `packages/mcp-server/src/tools/schema.ts`:**
   - The LAG template and existing example queries already reference new table names (verified) — do NOT modify those.
   - Add intraday example queries to the `EXAMPLE_QUERIES` data or the describe_database output. Add entries like:
     - "ORB (Opening Range Breakout) calculation" showing `SELECT date, MAX(high) - MIN(low) AS orb_range FROM market.intraday WHERE ticker = 'SPX' AND time BETWEEN '09:30' AND '10:00' GROUP BY date`
     - "Time-range bar query" showing `SELECT * FROM market.intraday WHERE ticker = 'SPX' AND date = '2024-01-15' ORDER BY time`
   - Add an embedded "Import Workflow" section in the describe_database output explaining the pipeline: `import_market_csv` (ingest raw CSV) → `enrich_market_data` (compute ~40 derived indicators). Keep this brief (3-4 lines) — a short guide, not documentation.

7. **In `packages/mcp-server/src/tools/reports/queries.ts`:**
   - Update the stale `market.spx_daily` reference at line 25 to `market.daily`

8. **In `packages/mcp-server/src/index.ts`:**
   - Update the McpServer constructor version from `"1.2.0"` to `"1.5.0"` at line 278 to match package.json
   - CLN-07 verification: Verify that `registerMarketImportTools` and `registerMarketEnrichmentTools` are both called in `createServer()`. They should already be present at lines 286-287. **If either call is missing, add it** following the pattern of existing `register*Tools(server, resolvedDir)` calls. Both imports should exist at the top of the file; if missing, add them:
     ```typescript
     import { registerMarketImportTools } from "./tools/market-imports.js";
     import { registerMarketEnrichmentTools } from "./tools/market-enrichment.js";
     ```
     And in `createServer()`:
     ```typescript
     registerMarketImportTools(server, resolvedDir);
     registerMarketEnrichmentTools(server, resolvedDir);
     ```

9. **Sweep for any remaining `spx_daily`, `spx_15min`, or `vix_intraday` references** in `packages/mcp-server/src/` (excluding the deleted files). Update any stale comments. The only remaining references should be in `market-sync.ts` (being deleted) and `intraday-timing.ts` (being deleted in Task 1).
  </action>
  <verify>
1. `cd packages/mcp-server && npx tsc --noEmit` — no TypeScript errors
2. `npm test -- --passWithNoTests` (the deleted test files should not cause failures)
3. `grep -r "syncMarketData\|MarketSyncResult\|market-sync" packages/mcp-server/src/` returns no results
4. `grep -r "spx_daily\|spx_15min\|vix_intraday" packages/mcp-server/src/` returns no results (all old table references removed)
5. Verify `packages/mcp-server/src/sync/market-sync.ts` does not exist
6. Verify `packages/mcp-server/tests/integration/market-sync-multi-ticker.test.ts` does not exist
7. Verify `packages/mcp-server/src/index.ts` has version `"1.5.0"`
8. `grep -n "registerMarketImportTools\|registerMarketEnrichmentTools" packages/mcp-server/src/index.ts` — both tool registrations present
9. Build succeeds: `cd packages/mcp-server && npm run build`
  </verify>
  <done>market-sync.ts is deleted; run_sql uses new table names in allowlist and description; describe_database has intraday examples and Import Workflow section; McpServer version is 1.5.0; zero references to old table names remain in the codebase source</done>
</task>

</tasks>

<verification>
1. `cd packages/mcp-server && npm run build` — clean build with no errors
2. `grep -rn "spx_daily\|spx_15min\|vix_intraday\|intraday-timing\|market-sync\|buildIntradayContext\|SPX_CHECKPOINTS\|VIX_CHECKPOINTS" packages/mcp-server/src/` — zero results
3. `grep -rn "syncMarketData\|MarketSyncResult" packages/mcp-server/src/` — zero results
4. All remaining tests pass: `cd packages/mcp-server && npm test -- --passWithNoTests`
</verification>

<success_criteria>
- run_sql AVAILABLE_TABLES contains market.daily, market.context, market.intraday, market._sync_metadata (not old names)
- describe_database output includes intraday query examples and Import Workflow guidance
- market-sync.ts and intraday-timing.ts are deleted
- enrich_trades returns intradayBars as raw bar arrays (not pivoted checkpoint columns)
- McpServer version in index.ts is "1.5.0"
- Zero references to old table names (spx_daily, spx_15min, vix_intraday) in packages/mcp-server/src/
- Build succeeds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/64-cleanup-and-api-surface/64-01-SUMMARY.md`
</output>
