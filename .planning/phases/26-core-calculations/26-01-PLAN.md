---
phase: 26-core-calculations
plan: 01
type: tdd
---

<objective>
Update Sharpe and Sortino ratio calculations to use date-based Treasury rates from Phase 25 utility.

Purpose: Replace fixed 2% risk-free rate with actual historical rates, making risk-adjusted metrics accurate across different rate environments (0% in 2020 vs 5%+ in 2023).
Output: Portfolio stats calculations that use per-day Treasury rates for accurate Sharpe/Sortino ratios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-treasury-data/25-01-SUMMARY.md
@lib/calculations/portfolio-stats.ts
@lib/utils/risk-free-rate.ts
@lib/models/daily-log.ts
@tests/unit/portfolio-stats.test.ts
@tests/unit/risk-free-rate.test.ts

**Prior Phase 25 Output:**
- `getRiskFreeRate(date)` - O(1) lookup for trading days, O(log n) for weekends/holidays
- Returns annual percentage (e.g., 4.32 = 4.32%)
- Fallback: earliest rate for dates before range, latest rate for after

**Current Implementation (to change):**
- `calculateSharpeRatio()` uses `this.config.riskFreeRate / 100 / this.config.annualizationFactor` as a constant daily rate
- `calculateSortinoRatio()` uses the same constant daily rate
- Need to change to per-day rate lookup using `getRiskFreeRate(date)` for each trading day

**Key Insight:**
The existing code already tracks dates when building daily returns:
- Daily log path: `dailyLogEntries[i].date` is available for each return
- Trade path: `dailyPl.keys()` gives sorted date strings

We can refactor to build arrays of `{date, return}` pairs, then calculate excess returns using per-day rates.

**Test Data Strategy:**
Use specific date ranges where rates varied significantly:
- 2020-03-01 to 2020-04-01: COVID crash, rates near 0%
- 2023-06-01 to 2023-07-01: Rate hikes, rates ~5%
Tests should show different Sharpe/Sortino results vs fixed 2% assumption.
</context>

<feature>
  <name>Date-based risk-free rates for Sharpe/Sortino</name>
  <files>lib/calculations/portfolio-stats.ts, tests/unit/portfolio-stats-risk-free.test.ts</files>
  <behavior>
    Core behavior:
    - calculateSharpeRatio() uses actual Treasury rate for each day's excess return calculation
    - calculateSortinoRatio() uses actual Treasury rate for each day's excess return calculation
    - When daily logs available: use entry.date for rate lookup
    - When trade-based: use the date key for rate lookup

    Expected test cases:
    1. Sharpe with 2020 COVID data (near-0% rates) differs from fixed 2% assumption
    2. Sharpe with 2023 high-rate data (~5% rates) differs from fixed 2% assumption
    3. Sortino with 2020 COVID data differs from fixed 2% assumption
    4. Sortino with 2023 high-rate data differs from fixed 2% assumption
    5. Date-based calculation matches hand-computed expected value for known data
    6. Empty/insufficient data still returns undefined (regression test)
    7. When config.riskFreeRate is provided, it's ignored (new behavior - rates are always date-based)

    Internal changes:
    - calculateDailyReturns() should return {date: Date, return: number}[] instead of number[]
    - Calculate per-day excess return: return - (getRiskFreeRate(date) / 100 / 252)
    - Average the excess returns, divide by std dev, annualize
  </behavior>
  <implementation>
    1. Create new helper: calculateDailyReturnsWithDates() returning {date: Date, return: number}[]
    2. Refactor calculateSharpeRatio() to:
       - Call calculateDailyReturnsWithDates()
       - For each {date, return}, compute excessReturn = return - (getRiskFreeRate(date) / 100 / 252)
       - Use mean(excessReturns) / std(returns) * sqrt(252) for final ratio
    3. Refactor calculateSortinoRatio() to:
       - Call calculateDailyReturnsWithDates()
       - For each {date, return}, compute excessReturn = return - (getRiskFreeRate(date) / 100 / 252)
       - Filter negative excess returns for downside deviation
       - Use mean(excessReturns) / std(negativeExcessReturns) * sqrt(252)
    4. Remove/deprecate riskFreeRate from AnalysisConfig (or ignore it) - this is Phase 27 scope
  </implementation>
</feature>

<verification>
npm test -- tests/unit/portfolio-stats-risk-free.test.ts
npm test -- tests/unit/portfolio-stats.test.ts
npm run build
</verification>

<success_criteria>
- New test file with 7+ test cases for date-based risk-free rate calculations
- Tests demonstrate different Sharpe/Sortino values for high-rate vs low-rate periods
- Existing portfolio-stats.test.ts tests still pass (may need slight adjustments for changed behavior)
- No TypeScript errors
- All 3 commits present (RED, GREEN, REFACTOR if needed)
</success_criteria>

<output>
After completion, create `.planning/phases/26-core-calculations/26-01-SUMMARY.md`:

# Phase 26 Plan 01: Core Calculations Summary

**[Substantive one-liner about what shipped]**

## TDD Cycle

### RED
- Test cases written and failing

### GREEN
- Implementation details

### REFACTOR
- Cleanup if any

## Files Created/Modified

## Verification

## Commits

## Next Step
</output>
