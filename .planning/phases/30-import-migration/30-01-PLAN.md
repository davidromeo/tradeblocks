---
phase: 30-import-migration
plan: 01
type: execute
---

<objective>
Update MCP server imports from path aliases to workspace package imports.

Purpose: Enable MCP server to import from @tradeblocks/lib instead of fragile @lib/* path aliases that require esbuild resolution.
Output: MCP server using clean workspace package imports, with simplified build config.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./30-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-workspace-setup/29-01-SUMMARY.md

**Key files from Phase 29:**
@packages/lib/package.json
@packages/lib/index.ts

**Current MCP server config:**
@packages/mcp-server/tsconfig.json
@packages/mcp-server/tsup.config.ts

**Current state:**
- MCP server uses `@lib/*` path aliases in 6 source files
- tsconfig.json has paths: `"@lib/*": ["../../lib/*"]`
- tsup.config.ts has esbuild aliases pointing to `../../lib`
- After Phase 29, `@tradeblocks/lib` is available via workspace symlink

**Migration pattern:**
- `import { X } from '@lib/models'` → `import { X } from '@tradeblocks/lib'`
- All barrel exports are in packages/lib/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MCP server source imports</name>
  <files>packages/mcp-server/src/*.ts (6 files with @lib/ imports)</files>
  <action>
Update all `@lib/*` imports to use `@tradeblocks/lib`:

1. Find all files with @lib/ imports:
   ```bash
   grep -r "@lib/" packages/mcp-server/src --include="*.ts" -l
   ```

2. For each file, replace imports:
   - `import { X } from '@lib/models'` → `import { X } from '@tradeblocks/lib'`
   - `import { Y } from '@lib/calculations'` → `import { Y } from '@tradeblocks/lib'`
   - etc.

**Note:** All imports consolidate to `@tradeblocks/lib` since barrel exports are available. If a file imports from multiple @lib/* subpaths, combine into single import from @tradeblocks/lib.

3. Also update any `@/*` imports if they reference lib:
   - `import { Z } from '@/lib/utils'` → `import { Z } from '@tradeblocks/lib'`
  </action>
  <verify>
- `grep -r "@lib/" packages/mcp-server/src` returns no matches
- TypeScript compiles: `cd packages/mcp-server && npx tsc --noEmit`
  </verify>
  <done>All MCP server source files use @tradeblocks/lib imports, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Update MCP server tsconfig.json</name>
  <files>packages/mcp-server/tsconfig.json</files>
  <action>
Remove the now-unnecessary path aliases since workspace resolution handles @tradeblocks/lib:

1. Remove from paths:
   - `"@lib/*": ["../../lib/*"]` - no longer needed

2. Keep `"@/*": ["../../*"]` if still used for non-lib imports (check first)
   - If no files use @/* for non-lib imports, remove this path too

3. The workspace symlink at node_modules/@tradeblocks/lib handles resolution automatically.
  </action>
  <verify>
- `cat packages/mcp-server/tsconfig.json | grep @lib` returns no matches
- TypeScript still compiles: `cd packages/mcp-server && npx tsc --noEmit`
  </verify>
  <done>tsconfig.json paths cleaned up, TypeScript compiles via workspace resolution</done>
</task>

<task type="auto">
  <name>Task 3: Update MCP server tsup.config.ts</name>
  <files>packages/mcp-server/tsup.config.ts</files>
  <action>
Simplify esbuild configuration now that workspace resolution works:

1. Remove the @lib alias from esbuildOptions in all three build configs:
   ```typescript
   // Remove these lines from each esbuildOptions block:
   '@lib': path.resolve(__dirname, '../../lib'),
   ```

2. Keep the @/ alias only if still needed for non-lib imports.

3. Update noExternal patterns if they reference @lib:
   - Remove `/^@lib\//` from noExternal arrays
   - The bundler will resolve @tradeblocks/lib through node_modules

4. For the main server entry (bundles everything), ensure @tradeblocks/lib content gets bundled:
   - The `noExternal: [/.*/]` already bundles all deps, so @tradeblocks/lib will be bundled too
   - This is the desired behavior for standalone MCPB distribution

**Important:** The path import at top of file may no longer be needed if no aliases remain.
  </action>
  <verify>
- Build succeeds: `cd packages/mcp-server && npm run build`
- Built output includes lib code: `grep -l "treasury" packages/mcp-server/server/index.js` (should find treasury rate code bundled)
  </verify>
  <done>tsup.config.ts simplified, build succeeds with @tradeblocks/lib bundled</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -r "@lib/" packages/mcp-server/src` returns no matches
- [ ] `cd packages/mcp-server && npx tsc --noEmit` succeeds
- [ ] `cd packages/mcp-server && npm run build` succeeds
- [ ] Built server runs: `node packages/mcp-server/server/index.js --help` (should show usage or start)
</verification>

<success_criteria>

- All MCP server imports use @tradeblocks/lib
- Path aliases removed from tsconfig.json
- esbuild aliases removed from tsup.config.ts
- Build produces working server bundle
</success_criteria>

<output>
After completion, create `.planning/phases/30-import-migration/30-01-SUMMARY.md`:

# Phase 30 Plan 01: MCP Server Import Migration Summary

**[One-liner describing what shipped]**

## Accomplishments
- Updated [N] source files to use @tradeblocks/lib
- Removed path aliases from tsconfig.json
- Simplified tsup.config.ts esbuild config
- Verified build produces working bundle

## Files Created/Modified
- `packages/mcp-server/src/*.ts` - Import updates
- `packages/mcp-server/tsconfig.json` - Path cleanup
- `packages/mcp-server/tsup.config.ts` - Build config simplification

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 30-02-PLAN.md (Next.js app import migration)
</output>
