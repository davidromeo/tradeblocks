---
phase: 31-cleanup-verification
plan: 01
type: execute
---

<objective>
Remove legacy @/lib/* path aliases and migrate remaining imports to @tradeblocks/lib.

Purpose: Complete the workspace package migration by removing backward-compatibility shims and ensuring all imports use the new workspace package.
Output: Clean codebase with no @/lib/* imports, working builds, and passing tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-workspace-setup/29-01-SUMMARY.md
@.planning/phases/30-import-migration/30-01-SUMMARY.md
@.planning/phases/30-import-migration/30-02-SUMMARY.md

**Prior phase context:**
- Phase 29 created @tradeblocks/lib workspace package
- Phase 30-01 migrated MCP server imports
- Phase 30-02 migrated Next.js app/components imports
- Added @/lib/* path alias to root tsconfig.json for backward compatibility

**Remaining @/lib/* imports discovered:**
- 5 dynamic imports in app/components still using @/lib/*
- ~95 imports in tests/ directory
- jest.config.js maps @/ to root but needs @tradeblocks/lib support
- Root tsconfig.json still has @/lib/* path (remove after migration)

**Key file references:**
@app/(platform)/blocks/page.tsx (lines 75, 232)
@components/block-dialog.tsx (lines 281, 1327, 1627)
@jest.config.js
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate remaining dynamic imports in app/components</name>
  <files>app/(platform)/blocks/page.tsx, components/block-dialog.tsx</files>
  <action>
Update 5 remaining dynamic imports that still use @/lib/:

1. `app/(platform)/blocks/page.tsx` line 75 and 232:
   - Change: `await import('@/lib/stores/performance-store')`
   - To: `await import('@tradeblocks/lib/stores')`
   - Extract: `usePerformanceStore`

2. `components/block-dialog.tsx` line 281:
   - Change: `await import("@/lib/db")`
   - To: `await import("@tradeblocks/lib")`
   - Extract: `getBlock`

3. `components/block-dialog.tsx` line 1327:
   - Change: `await import("@/lib/db")`
   - To: `await import("@tradeblocks/lib")`
   - Extract: `getTradesByBlock, getDailyLogsByBlock`

4. `components/block-dialog.tsx` line 1627:
   - Change: `await import("@/lib/db")`
   - To: `await import("@tradeblocks/lib")`
   - Extract: `getTradesByBlockWithOptions, getDailyLogsByBlock`

Note: Keep dynamic imports (don't convert to static) - they exist for code splitting.
  </action>
  <verify>grep -r "await import.*@/lib" app components returns no matches</verify>
  <done>All 5 dynamic imports updated to @tradeblocks/lib</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test imports and update Jest config</name>
  <files>jest.config.js, tests/**/*.ts</files>
  <action>
1. Update jest.config.js moduleNameMapper to support @tradeblocks/lib:
   ```js
   moduleNameMapper: {
     '^@tradeblocks/lib/stores$': '<rootDir>/packages/lib/stores/index.ts',
     '^@tradeblocks/lib$': '<rootDir>/packages/lib/index.ts',
     '^@/(.*)$': '<rootDir>/$1',
   },
   ```
   Order matters: specific mappings before general @/ mapping.

2. Update all ~95 test file imports from @/lib/* to @tradeblocks/lib:
   - `@/lib/models/*` → `@tradeblocks/lib`
   - `@/lib/calculations/*` → `@tradeblocks/lib`
   - `@/lib/processing/*` → `@tradeblocks/lib`
   - `@/lib/utils/*` → `@tradeblocks/lib`
   - `@/lib/services/*` → `@tradeblocks/lib`
   - `@/lib/db` → `@tradeblocks/lib`
   - `@/lib/data/*` → `@tradeblocks/lib`
   - `@/lib/stores/*` → `@tradeblocks/lib/stores`

   Use same import consolidation pattern as Phase 30:
   ```typescript
   // Before:
   import { Trade } from '@/lib/models/trade';
   import { PortfolioStatsCalculator } from '@/lib/calculations/portfolio-stats';

   // After:
   import { Trade, PortfolioStatsCalculator } from '@tradeblocks/lib';
   ```

3. Test files to update (from grep scan):
   - tests/unit/*.test.ts (~40 files)
   - tests/integration/*.test.ts
   - tests/lib/**/*.test.ts
   - tests/data/*.ts (mock data files)

Keep store imports separate: `import { useXStore } from '@tradeblocks/lib/stores'`
  </action>
  <verify>grep -r "@/lib/" tests returns no matches AND npm test runs (may have pre-existing type errors)</verify>
  <done>All test imports migrated, jest.config.js updated, tests can run</done>
</task>

<task type="auto">
  <name>Task 3: Remove legacy path alias and final verification</name>
  <files>tsconfig.json</files>
  <action>
1. Remove the @/lib/* path alias from root tsconfig.json paths:
   ```json
   "paths": {
     "@/*": ["./*"]
   }
   ```
   Remove: `"@/lib/*": ["./packages/lib/*"]`

2. Run full verification:
   - `npm run build` - Next.js build must pass
   - `npm test` - Jest tests must run (pre-existing type errors OK)
   - `npx tsc --noEmit` - TypeScript check

3. Verify no remaining @/lib/ imports anywhere:
   - `grep -r "@/lib/" app components packages tests`

Note: Pre-existing type errors in walk-forward-store.test.ts and trading-calendar-store.test.ts are NOT related to this migration (blockId/StoredTrade type mismatches). These should be logged but not block completion.
  </action>
  <verify>npm run build passes AND grep -r "@/lib/" app components packages tests returns only comments (not imports)</verify>
  <done>Legacy path alias removed, builds pass, no @/lib imports remain</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `grep -r "from '@/lib" app components packages tests` returns no matches
- [ ] `grep -r 'from "@/lib' app components packages tests` returns no matches
- [ ] `grep -r "await import.*@/lib" app components` returns no matches
- [ ] `npm run build` succeeds
- [ ] `npm test` runs (passes or only pre-existing type errors)
- [ ] Root tsconfig.json has no @/lib/* path alias
</verification>

<success_criteria>

- All imports migrated from @/lib/* to @tradeblocks/lib
- Jest moduleNameMapper configured for workspace package
- Legacy @/lib/* path alias removed from tsconfig.json
- Next.js build passes
- Tests run without import errors
- Milestone v2.3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/31-cleanup-verification/31-01-SUMMARY.md`:

# Phase 31 Plan 01: Cleanup Verification Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Milestone v2.3 complete. Update STATE.md, ROADMAP.md, archive milestone.
</output>
