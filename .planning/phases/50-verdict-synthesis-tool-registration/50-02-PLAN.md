---
phase: 50-verdict-synthesis-tool-registration
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - packages/mcp-server/src/tools/edge-decay.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "analyze_edge_decay MCP tool accepts blockId (required), strategy (optional), recentWindow (optional) via Zod schema"
    - "Tool loads block once, applies strategy filter, loads reporting log with graceful skip, calls synthesizeEdgeDecay(), formats output via createToolOutput()"
    - "Tool is registered inside existing registerEdgeDecayTools() function -- works automatically with CLI --call mode"
    - "CLI test: TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_edge_decay '{\"blockId\":\"...\"}' returns structured JSON"
    - "MCP server version bumped (minor) in package.json"
  artifacts:
    - path: "packages/mcp-server/src/tools/edge-decay.ts"
      provides: "Tool 6: analyze_edge_decay MCP tool registration"
      contains: "analyze_edge_decay"
    - path: "packages/mcp-server/package.json"
      provides: "Version bump for new MCP tool"
      contains: "0.8.0"
  key_links:
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/lib/calculations/edge-decay-synthesis.ts"
      via: "import synthesizeEdgeDecay"
      pattern: "synthesizeEdgeDecay"
    - from: "packages/mcp-server/src/tools/edge-decay.ts"
      to: "packages/mcp-server/src/utils/output-formatter.ts"
      via: "import createToolOutput"
      pattern: "createToolOutput"
---

<objective>
Register the `analyze_edge_decay` MCP tool as Tool 6 inside the existing `registerEdgeDecayTools()` function. The tool is a thin wrapper: load data, call `synthesizeEdgeDecay()`, format output. Verify it works via CLI --call mode.

Purpose: This is the user-facing entry point for the unified edge decay analysis. It completes the v2.7 milestone by exposing all 5 signal categories through a single MCP tool invocation.
Output: Tool registered, CLI-tested, version bumped.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/mcp-server/src/tools/edge-decay.ts (existing 5 tools, registerEdgeDecayTools function, import patterns)
@packages/mcp-server/src/utils/output-formatter.ts (createToolOutput)
@packages/mcp-server/src/utils/block-loader.ts (loadBlock, loadReportingLog)
@packages/mcp-server/src/tools/middleware/sync-middleware.ts (withSyncedBlock)
@packages/lib/calculations/edge-decay-synthesis.ts (synthesizeEdgeDecay, EdgeDecaySynthesisResult -- from Plan 01)
@.planning/phases/50-verdict-synthesis-tool-registration/50-01-SUMMARY.md
@.planning/phases/50-verdict-synthesis-tool-registration/50-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register analyze_edge_decay MCP tool + version bump</name>
  <files>
    packages/mcp-server/src/tools/edge-decay.ts
    packages/mcp-server/package.json
  </files>
  <action>
  **Add Tool 6 inside `registerEdgeDecayTools()`** in `edge-decay.ts`, after the existing Tool 5 (analyze_live_alignment).

  1. Add import for `synthesizeEdgeDecay` and `calculateDefaultRecentWindow` from `@tradeblocks/lib` (add to existing import block).

  2. Register the tool:
  ```typescript
  // Tool 6: analyze_edge_decay (unified)
  server.registerTool(
    "analyze_edge_decay",
    {
      description:
        "Run comprehensive edge decay analysis combining all 5 signal categories: " +
        "period metrics, rolling metrics, Monte Carlo regime comparison, walk-forward degradation, " +
        "and live alignment. Returns structured factual data (no verdicts, no grades) for LLM interpretation. " +
        "Use standalone tools (analyze_period_metrics, analyze_rolling_metrics, analyze_regime_comparison, " +
        "analyze_walk_forward_degradation, analyze_live_alignment) for detailed drill-down or custom parameters.",
      inputSchema: z.object({
        blockId: z.string().describe("Block folder name"),
        strategy: z.string().optional().describe("Filter by strategy name (case-insensitive)"),
        recentWindow: z.number().min(10).optional().describe(
          "Number of recent trades for comparison (default: auto-calculated as max(20% of trades, 200))"
        ),
      }),
    },
    withSyncedBlock(baseDir, async ({ blockId, strategy, recentWindow }) => {
      try {
        const block = await loadBlock(baseDir, blockId);
        let trades = applyStrategyFilter(block.trades, strategy);

        if (trades.length === 0) {
          return {
            content: [{
              type: "text" as const,
              text: strategy
                ? `No trades found for strategy "${strategy}" in block "${blockId}".`
                : `No trades found in block "${blockId}".`,
            }],
            isError: true as const,
          };
        }

        // Load reporting log -- graceful skip if missing
        let actualTrades: ReportingTrade[] | undefined;
        try {
          const raw = await loadReportingLog(baseDir, blockId);
          actualTrades = applyStrategyFilter(raw, strategy);
        } catch {
          actualTrades = undefined;
        }

        // Call pure synthesis engine
        const result = synthesizeEdgeDecay(trades, actualTrades, { recentWindow });

        // Build text summary
        const s = result.summary;
        const fmtPct = (v: number) => (v * 100).toFixed(1) + "%";
        const fmtRatio = (v: number | null) => v !== null ? v.toFixed(2) : "N/A";

        const lines = [
          `Edge decay analysis for ${blockId}${strategy ? ` (${strategy})` : ""}: ${s.totalTrades} trades, recent window=${s.recentWindow}`,
          `Win rate: ${fmtPct(s.recentWinRate)} recent vs ${fmtPct(s.historicalWinRate)} historical`,
          `Profit factor: ${fmtRatio(s.recentProfitFactor)} recent vs ${fmtRatio(s.historicalProfitFactor)} historical`,
          `Sharpe: ${fmtRatio(s.recentSharpe)} recent vs ${fmtRatio(s.historicalSharpe)} historical`,
          `Signals: ${result.metadata.signalsRun} run, ${result.metadata.signalsSkipped} skipped`,
          `Observations: ${s.observationCount} notable (${s.structuralFlagCount} structural flags)`,
        ];

        if (s.mcProbabilityOfProfit) {
          lines.push(`MC P(Profit): ${(s.mcProbabilityOfProfit.full * 100).toFixed(1)}% full vs ${(s.mcProbabilityOfProfit.recent * 100).toFixed(1)}% recent`);
        }
        if (s.liveDirectionAgreement !== null) {
          lines.push(`Live alignment: ${fmtPct(s.liveDirectionAgreement)} direction agreement, ${fmtRatio(s.liveExecutionEfficiency)} efficiency`);
        }

        const summaryText = lines.join("\n");

        return createToolOutput(summaryText, result);
      } catch (error) {
        return {
          content: [{
            type: "text" as const,
            text: `Error analyzing edge decay: ${(error as Error).message}`,
          }],
          isError: true as const,
        };
      }
    })
  );
  ```

  3. **Bump MCP server version** in `packages/mcp-server/package.json` from `0.7.3` to `0.8.0` (minor bump -- new tool feature).
  </action>
  <verify>
  Build the MCP server: `cd /Users/davidromeo/Code/tradeblocks/packages/mcp-server && npm run build`

  Run typecheck: `cd /Users/davidromeo/Code/tradeblocks && npm run typecheck`

  Test via CLI (requires real data): `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_edge_decay '{"blockId":"main-port-2026"}'`

  Verify the output contains:
  - `summary` object with key numbers
  - `observations` array
  - `signals` object with all 5 signal categories
  - `metadata` object
  </verify>
  <done>
  - `analyze_edge_decay` tool is registered as Tool 6 in `registerEdgeDecayTools()`
  - Tool accepts `blockId` (required), `strategy` (optional), `recentWindow` (optional) via Zod schema
  - Tool loads data once, calls `synthesizeEdgeDecay()`, formats output via `createToolOutput()`
  - CLI `--call` mode works and returns structured JSON with summary, observations, signals, metadata
  - MCP server version bumped to 0.8.0
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/davidromeo/Code/tradeblocks && npm run typecheck
cd /Users/davidromeo/Code/tradeblocks/packages/mcp-server && npm run build
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_edge_decay '{"blockId":"main-port-2026"}'
```
TypeScript compiles. MCP server builds. CLI returns valid JSON with all expected top-level keys.
</verification>

<success_criteria>
- analyze_edge_decay tool is registered and callable via MCP and CLI
- Tool accepts the 3 parameters defined in API-01 (blockId required, strategy optional, recentWindow optional with auto-calculation per API-02)
- Output includes structured factual data with no verdicts or grades (per philosophy)
- MCP server version bumped to 0.8.0
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/50-verdict-synthesis-tool-registration/50-02-SUMMARY.md`
</output>
