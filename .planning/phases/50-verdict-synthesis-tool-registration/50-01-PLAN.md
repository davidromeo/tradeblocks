---
phase: 50-verdict-synthesis-tool-registration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/lib/calculations/edge-decay-synthesis.ts
  - packages/lib/calculations/index.ts
  - tests/unit/edge-decay-synthesis.test.ts
autonomous: true

must_haves:
  truths:
    - "synthesizeEdgeDecay() accepts Trade[], optional ReportingTrade[], and options, returns a structured result with summary, observations, signals, and metadata"
    - "All 5 engine results are included under signals: periodMetrics, rollingMetrics, regimeComparison, walkForward, liveAlignment"
    - "MC regime comparison gracefully skips when trades < 30 (returns available: false)"
    - "Live alignment gracefully skips when actualTrades is undefined (returns available: false)"
    - "Factual observations are extracted as structured data objects with signal, metric, current, comparison, delta, percentChange fields"
    - "Rolling metrics series is excluded from output -- only recentVsHistorical, seasonalAverages, and dataQuality are included"
    - "Monthly periods are truncated to the most recent 12"
    - "Top-level summary contains key numbers from each signal category"
  artifacts:
    - path: "packages/lib/calculations/edge-decay-synthesis.ts"
      provides: "Pure synthesis engine function"
      exports: ["synthesizeEdgeDecay", "EdgeDecaySynthesisResult", "FactualObservation", "EdgeDecaySynthesisOptions"]
    - path: "tests/unit/edge-decay-synthesis.test.ts"
      provides: "Unit tests for synthesis engine"
      min_lines: 100
    - path: "packages/lib/calculations/index.ts"
      provides: "Re-export of edge-decay-synthesis"
      contains: "edge-decay-synthesis"
  key_links:
    - from: "packages/lib/calculations/edge-decay-synthesis.ts"
      to: "packages/lib/calculations/period-segmentation.ts"
      via: "import segmentByPeriod"
      pattern: "segmentByPeriod"
    - from: "packages/lib/calculations/edge-decay-synthesis.ts"
      to: "packages/lib/calculations/rolling-metrics.ts"
      via: "import computeRollingMetrics, calculateDefaultRecentWindow"
      pattern: "computeRollingMetrics"
    - from: "packages/lib/calculations/edge-decay-synthesis.ts"
      to: "packages/lib/calculations/mc-regime-comparison.ts"
      via: "import runRegimeComparison"
      pattern: "runRegimeComparison"
    - from: "packages/lib/calculations/edge-decay-synthesis.ts"
      to: "packages/lib/calculations/walk-forward-degradation.ts"
      via: "import analyzeWalkForwardDegradation"
      pattern: "analyzeWalkForwardDegradation"
    - from: "packages/lib/calculations/edge-decay-synthesis.ts"
      to: "packages/lib/calculations/live-alignment.ts"
      via: "import analyzeLiveAlignment"
      pattern: "analyzeLiveAlignment"
---

<objective>
Create the pure synthesis engine function `synthesizeEdgeDecay()` in packages/lib that calls all 5 edge decay engines, extracts factual observations, and returns a structured result. TDD approach: write tests first, then implement.

Purpose: This is the core aggregation logic for the unified edge decay tool. By keeping it as a pure function in lib (not MCP), it's testable, reusable, and framework-agnostic.
Output: `edge-decay-synthesis.ts` with full types, synthesis function, and observation extraction. Tests proving correctness.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/lib/calculations/period-segmentation.ts (PeriodSegmentationResult, segmentByPeriod)
@packages/lib/calculations/rolling-metrics.ts (RollingMetricsResult, computeRollingMetrics, calculateDefaultRecentWindow, StructuralFlag, RecentVsHistoricalComparison)
@packages/lib/calculations/mc-regime-comparison.ts (MCRegimeComparisonResult, runRegimeComparison, MetricComparison -- throws if trades < 30)
@packages/lib/calculations/walk-forward-degradation.ts (WFDResult, analyzeWalkForwardDegradation)
@packages/lib/calculations/live-alignment.ts (LiveAlignmentOutput, LiveAlignmentResult, LiveAlignmentSkipped, analyzeLiveAlignment)
@packages/lib/calculations/trade-matching.ts (applyStrategyFilter)
@packages/lib/calculations/index.ts (barrel exports)
@tests/unit/mc-regime-comparison.test.ts (test patterns: makeTrade, generateTradeSet helpers)
@.planning/phases/50-verdict-synthesis-tool-registration/50-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for edge decay synthesis engine</name>
  <files>tests/unit/edge-decay-synthesis.test.ts</files>
  <action>
  Create a comprehensive test suite for the synthesis engine. Use the `makeTrade` + `generateTradeSet` helper pattern from `mc-regime-comparison.test.ts`.

  **Test cases to write (these will fail initially -- RED phase):**

  1. **Basic structure test**: Given 50+ trades, `synthesizeEdgeDecay(trades, undefined)` returns an object with `summary`, `observations`, `signals`, and `metadata` top-level keys.

  2. **All 5 signals present**: Result has `signals.periodMetrics`, `signals.rollingMetrics`, `signals.regimeComparison`, `signals.walkForward`, `signals.liveAlignment` -- all with `available` boolean.

  3. **MC graceful skip on small block**: Given < 30 trades, `signals.regimeComparison.available` is `false` and has a `reason` string. No throw.

  4. **Live alignment graceful skip**: Given `actualTrades = undefined`, `signals.liveAlignment.available` is `false` with reason `"no reporting log"`.

  5. **Rolling series excluded**: `signals.rollingMetrics.detail` does NOT contain a `series` property. It DOES contain `recentVsHistorical`, `seasonalAverages`, and `dataQuality`.

  6. **Monthly truncation**: Given trades spanning > 12 months, `signals.periodMetrics.detail.monthly` has at most 12 entries (the most recent 12).

  7. **Factual observations are structured data objects**: Each observation has exactly `{ signal, metric, current, comparison, delta, percentChange }` shape with all number types (percentChange nullable).

  8. **Observations from rolling structural flags**: Given trades that trigger a structural flag (e.g., recent win rate < 50%), the observation appears with `signal: 'rollingMetrics'`.

  9. **recentWindow option honored**: Given explicit `recentWindow: 50`, the metadata shows `recentWindow: 50` and rolling metrics use that window.

  10. **Default recentWindow auto-calculation**: Given 500 trades and no `recentWindow` option, metadata.recentWindow should be `max(500 * 0.2, 200)` = 200.

  11. **Summary contains key numbers**: `result.summary` includes `totalTrades`, `recentWindow`, `recentWinRate`, `historicalWinRate`, `recentProfitFactor`, `historicalProfitFactor`, and `observationCount`.

  12. **Metadata completeness**: `result.metadata` includes `totalTrades`, `recentWindow`, `signalsRun`, `signalsSkipped`, `dateRange`.

  Import `synthesizeEdgeDecay` from `@tradeblocks/lib` (it will fail until Task 2 creates the file -- this is expected in TDD RED phase).
  </action>
  <verify>`npm test -- tests/unit/edge-decay-synthesis.test.ts` should fail with import/module errors (RED phase expected).</verify>
  <done>Test file exists with 10+ test cases covering all major synthesis behaviors including graceful skips, observation extraction, output shape, and option handling.</done>
</task>

<task type="auto">
  <name>Task 2: Implement synthesis engine + export + make tests pass</name>
  <files>
    packages/lib/calculations/edge-decay-synthesis.ts
    packages/lib/calculations/index.ts
  </files>
  <action>
  **GREEN phase: implement to make all tests pass.**

  Create `packages/lib/calculations/edge-decay-synthesis.ts` with:

  **Types:**

  ```typescript
  export interface EdgeDecaySynthesisOptions {
    recentWindow?: number
  }

  export interface FactualObservation {
    signal: string   // Which signal category: 'periodMetrics' | 'rollingMetrics' | 'regimeComparison' | 'walkForward' | 'liveAlignment'
    metric: string   // e.g. "profitFactor", "winRate", "sharpeEfficiency"
    current: number
    comparison: number
    delta: number
    percentChange: number | null
  }

  // Per-signal wrapper -- detail is the engine output (with rolling series removed, monthly truncated)
  export interface SignalOutput<T> {
    available: boolean
    reason?: string
    summary: Record<string, number | string | null>  // Key metrics for this signal
    detail: T | null
  }

  export interface EdgeDecaySynthesisResult {
    summary: { ... }  // see below
    observations: FactualObservation[]
    signals: {
      periodMetrics: SignalOutput<PeriodDetail>
      rollingMetrics: SignalOutput<RollingDetail>
      regimeComparison: SignalOutput<RegimeDetail>
      walkForward: SignalOutput<WFDetail>
      liveAlignment: SignalOutput<AlignmentDetail>
    }
    metadata: { ... }
  }
  ```

  Detail types are derived from engine results but pruned:
  - **PeriodDetail**: yearly, quarterly, monthly (last 12 only), trends, worstConsecutiveLosingMonths, dataQuality
  - **RollingDetail**: recentVsHistorical, seasonalAverages, dataQuality, windowSize (NO series)
  - **RegimeDetail**: fullHistory, recentWindow, comparison, divergence, parameters
  - **WFDetail**: periods, efficiencyTrends, recentVsHistorical, config, dataQuality
  - **AlignmentDetail**: overlapDateRange, directionAgreement, executionEfficiency, alignmentTrend, dataQuality

  **Summary structure** (flat object, key numbers across all signals):
  ```typescript
  summary: {
    totalTrades: number
    recentWindow: number
    recentWinRate: number
    historicalWinRate: number
    recentProfitFactor: number
    historicalProfitFactor: number
    recentSharpe: number | null
    historicalSharpe: number | null
    mcProbabilityOfProfit: { full: number; recent: number } | null
    wfAvgEfficiency: { sharpe: number | null; winRate: number | null; profitFactor: number | null } | null
    liveDirectionAgreement: number | null
    liveExecutionEfficiency: number | null
    observationCount: number
    structuralFlagCount: number
  }
  ```

  **Main function `synthesizeEdgeDecay(trades, actualTrades?, options?)`:**
  1. Calculate `recentWindow` via `calculateDefaultRecentWindow(trades.length)` if not provided
  2. Call `segmentByPeriod(trades)` -- always runs
  3. Call `computeRollingMetrics(trades, { recentWindowSize: recentWindow })` -- always runs
  4. Call `runRegimeComparison(trades, { recentWindowSize: recentWindow })` wrapped in try/catch -- skip if throws (< 30 trades)
  5. Call `analyzeWalkForwardDegradation(trades)` -- always runs (may produce empty periods)
  6. Call `analyzeLiveAlignment(trades, actualTrades, { scaling: 'perContract' })` only if `actualTrades` is defined and non-empty -- otherwise set `{ available: false, reason: 'no reporting log' }`
  7. Extract factual observations from all available results (see extraction logic below)
  8. Build summary, signals, metadata, and return

  **Observation extraction logic `extractObservations()`:**
  - From rolling `recentVsHistorical.structuralFlags`: map each StructuralFlag directly to an observation
  - From rolling `recentVsHistorical.metrics`: any metric with `percentChange < -20` becomes an observation
  - From MC `comparison`: any MetricComparison with `|percentChange| > 20` becomes an observation
  - From WF `recentVsHistorical.delta`: any metric (sharpe, winRate, profitFactor) where `|delta| > 0.2` becomes an observation (current = recent avg efficiency, comparison = historical avg efficiency)
  - From period `trends.yearly`: if winRate or profitFactor trend has negative slope and R-squared >= 0.5, surface as observation (current = slope, comparison = 0, delta = slope)
  - From live alignment (if available): if `directionAgreement.overallRate < 0.7` OR `executionEfficiency.overallEfficiency < 0.8`, surface as observation

  **Add export to `packages/lib/calculations/index.ts`:**
  Add `export * from './edge-decay-synthesis'` after the existing `export * from './live-alignment'` line.

  **Per user decision:** No verdicts, no grades, no interpretive labels. Pure numbers and structured data only.
  </action>
  <verify>`npm test -- tests/unit/edge-decay-synthesis.test.ts` passes all tests (GREEN phase). Also run `npm run typecheck` to verify no TypeScript errors.</verify>
  <done>All tests pass. `synthesizeEdgeDecay` is exported from `@tradeblocks/lib`. The function calls all 5 engines, extracts observations, and returns a typed result with summary, observations, signals, and metadata.</done>
</task>

</tasks>

<verification>
```bash
npm test -- tests/unit/edge-decay-synthesis.test.ts
npm run typecheck
```
All tests pass. TypeScript compiles without errors. `synthesizeEdgeDecay` is importable from `@tradeblocks/lib`.
</verification>

<success_criteria>
- `synthesizeEdgeDecay()` is a pure function that calls all 5 engines and returns a comprehensive typed result
- MC and live alignment gracefully skip when prerequisites aren't met (no throws)
- Rolling series is excluded from output; monthly periods truncated to 12
- Factual observations are structured data objects, not strings
- All types are exported for downstream MCP tool consumption
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/50-verdict-synthesis-tool-registration/50-01-SUMMARY.md`
</output>
