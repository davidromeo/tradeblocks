---
phase: 42-sync-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/sync/index.ts
  - packages/mcp-server/src/sync/hasher.ts
  - packages/mcp-server/src/sync/metadata.ts
  - packages/mcp-server/src/db/schemas.ts
  - packages/mcp-server/src/db/index.ts
autonomous: true

must_haves:
  truths:
    - "Sync metadata tables exist in DuckDB after first connection"
    - "File content can be hashed with SHA-256"
    - "Sync metadata can be read and written to DuckDB"
  artifacts:
    - path: "packages/mcp-server/src/sync/index.ts"
      provides: "Public sync API exports"
      exports: ["syncAllBlocks", "syncBlock", "syncMarketData"]
    - path: "packages/mcp-server/src/sync/hasher.ts"
      provides: "SHA-256 file hashing"
      exports: ["hashFileContent"]
    - path: "packages/mcp-server/src/sync/metadata.ts"
      provides: "Sync metadata table operations"
      exports: ["getSyncMetadata", "upsertSyncMetadata", "deleteSyncMetadata", "getAllSyncedBlockIds"]
    - path: "packages/mcp-server/src/db/schemas.ts"
      provides: "DuckDB table schemas"
      exports: ["ensureSyncTables", "ensureTradeDataTable", "ensureMarketDataTables"]
  key_links:
    - from: "packages/mcp-server/src/db/connection.ts"
      to: "packages/mcp-server/src/db/schemas.ts"
      via: "schemas called after connection init"
      pattern: "ensureSyncTables"
    - from: "packages/mcp-server/src/sync/metadata.ts"
      to: "packages/mcp-server/src/db/connection.ts"
      via: "getConnection for DB access"
      pattern: "getConnection"
---

<objective>
Create the foundational sync infrastructure: metadata tables, file hasher, and sync metadata operations.

Purpose: Establish the foundation that all sync operations depend on - the metadata tracking tables in DuckDB and the SHA-256 file hashing capability.
Output: Sync module skeleton with hasher, metadata operations, and table schemas ready for block/market sync implementations.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-sync-layer/42-CONTEXT.md
@.planning/phases/42-sync-layer/42-RESEARCH.md
@.planning/phases/41-database-infrastructure/41-01-SUMMARY.md

# Existing code to reference
@packages/mcp-server/src/db/connection.ts
@packages/mcp-server/src/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync metadata tables and schemas module</name>
  <files>
    packages/mcp-server/src/db/schemas.ts
    packages/mcp-server/src/db/index.ts
  </files>
  <action>
Create `packages/mcp-server/src/db/schemas.ts` with:

1. `ensureSyncTables(conn: DuckDBConnection)` - Creates both sync metadata tables:
   ```sql
   CREATE TABLE IF NOT EXISTS trades._sync_metadata (
     block_id VARCHAR PRIMARY KEY,
     tradelog_hash VARCHAR NOT NULL,
     dailylog_hash VARCHAR,
     reportinglog_hash VARCHAR,
     synced_at TIMESTAMP NOT NULL,
     sync_version INTEGER DEFAULT 1
   );

   CREATE TABLE IF NOT EXISTS market._sync_metadata (
     file_name VARCHAR PRIMARY KEY,
     content_hash VARCHAR NOT NULL,
     max_date VARCHAR,
     synced_at TIMESTAMP NOT NULL
   );
   ```

2. `ensureTradeDataTable(conn: DuckDBConnection)` - Creates trade data table:
   ```sql
   CREATE TABLE IF NOT EXISTS trades.trade_data (
     block_id VARCHAR NOT NULL,
     date_opened DATE NOT NULL,
     time_opened VARCHAR,
     strategy VARCHAR,
     legs VARCHAR,
     premium DOUBLE,
     num_contracts INTEGER,
     pl DOUBLE NOT NULL,
     date_closed DATE,
     time_closed VARCHAR,
     reason_for_close VARCHAR,
     margin_req DOUBLE,
     opening_commissions DOUBLE,
     closing_commissions DOUBLE
   );
   ```
   NOTE: Do NOT add PRIMARY KEY constraint - trades can have duplicates per day.

3. Placeholder `ensureMarketDataTables(conn: DuckDBConnection)` that creates empty shells (to be filled in market sync plan):
   - Just create the function signature with a comment "// TODO: Implement in Plan 03"
   - Return immediately (no-op for now)

Update `packages/mcp-server/src/db/index.ts` to export the new functions.
  </action>
  <verify>
- File exists at `packages/mcp-server/src/db/schemas.ts`
- `npm run build` succeeds in packages/mcp-server
- Export `ensureSyncTables`, `ensureTradeDataTable`, `ensureMarketDataTables` from db/index.ts
  </verify>
  <done>Schema creation functions exist and compile; tables will be created on first use.</done>
</task>

<task type="auto">
  <name>Task 2: Create file hasher and sync metadata operations</name>
  <files>
    packages/mcp-server/src/sync/hasher.ts
    packages/mcp-server/src/sync/metadata.ts
    packages/mcp-server/src/sync/index.ts
  </files>
  <action>
Create `packages/mcp-server/src/sync/hasher.ts`:
```typescript
import * as crypto from 'crypto';
import * as fs from 'fs/promises';

export async function hashFileContent(filePath: string): Promise<string> {
  const buffer = await fs.readFile(filePath);
  return crypto.createHash('sha256').update(buffer).digest('hex');
}
```

Create `packages/mcp-server/src/sync/metadata.ts` with:

1. Types:
   ```typescript
   export interface BlockSyncMetadata {
     block_id: string;
     tradelog_hash: string;
     dailylog_hash: string | null;
     reportinglog_hash: string | null;
     synced_at: Date;
     sync_version: number;
   }

   export interface MarketSyncMetadata {
     file_name: string;
     content_hash: string;
     max_date: string | null;
     synced_at: Date;
   }
   ```

2. Functions (all take DuckDBConnection as first param):
   - `getSyncMetadata(conn, blockId): Promise<BlockSyncMetadata | null>` - Query trades._sync_metadata
   - `upsertSyncMetadata(conn, metadata: BlockSyncMetadata): Promise<void>` - INSERT OR REPLACE
   - `deleteSyncMetadata(conn, blockId): Promise<void>` - DELETE from trades._sync_metadata
   - `getAllSyncedBlockIds(conn): Promise<string[]>` - SELECT all block_ids
   - `getMarketSyncMetadata(conn, fileName): Promise<MarketSyncMetadata | null>`
   - `upsertMarketSyncMetadata(conn, metadata: MarketSyncMetadata): Promise<void>`

Use DuckDB's `INSERT OR REPLACE INTO` for upserts. Handle the DuckDB result reader pattern (iterate with `for await` or use `getRows()`).

Create `packages/mcp-server/src/sync/index.ts`:
- Export all from hasher.ts
- Export all from metadata.ts
- Export placeholder functions (to be implemented in later plans):
  ```typescript
  export async function syncAllBlocks(baseDir: string): Promise<SyncResult> {
    // TODO: Implement in Plan 02
    throw new Error('Not implemented');
  }

  export async function syncBlock(blockId: string, baseDir: string): Promise<BlockSyncResult> {
    // TODO: Implement in Plan 02
    throw new Error('Not implemented');
  }

  export async function syncMarketData(baseDir: string): Promise<MarketSyncResult> {
    // TODO: Implement in Plan 03
    throw new Error('Not implemented');
  }
  ```
- Define result types: `SyncResult`, `BlockSyncResult`, `MarketSyncResult` with status, counts, errors arrays.
  </action>
  <verify>
- Files exist at sync/hasher.ts, sync/metadata.ts, sync/index.ts
- `npm run build` succeeds in packages/mcp-server
- Can import `{ hashFileContent, getSyncMetadata, syncAllBlocks }` from sync module
  </verify>
  <done>Sync module foundation complete with hasher, metadata operations, and placeholder exports.</done>
</task>

<task type="auto">
  <name>Task 3: Wire schema initialization to connection manager</name>
  <files>
    packages/mcp-server/src/db/connection.ts
  </files>
  <action>
Modify `packages/mcp-server/src/db/connection.ts`:

1. Import the new schema functions:
   ```typescript
   import { ensureSyncTables, ensureTradeDataTable } from "./schemas.js";
   ```

2. After creating schemas (trades, market), call schema initialization:
   ```typescript
   // Create schemas for organizing tables
   await connection.run("CREATE SCHEMA IF NOT EXISTS trades");
   await connection.run("CREATE SCHEMA IF NOT EXISTS market");

   // Ensure sync metadata and data tables exist
   await ensureSyncTables(connection);
   await ensureTradeDataTable(connection);
   ```

This ensures tables are created on first connection, matching the lazy init pattern.
  </action>
  <verify>
- `npm run build` succeeds
- Manual test: Delete analytics.duckdb, start MCP server, verify tables created by checking DuckDB file exists and is larger than empty
  </verify>
  <done>Sync tables auto-created on first DuckDB connection.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds in packages/mcp-server
2. New files exist:
   - `packages/mcp-server/src/db/schemas.ts`
   - `packages/mcp-server/src/sync/hasher.ts`
   - `packages/mcp-server/src/sync/metadata.ts`
   - `packages/mcp-server/src/sync/index.ts`
3. Exports work: Can import sync module functions from packages/mcp-server
4. Connection manager wires schema initialization
</verification>

<success_criteria>
- Sync metadata tables schema defined and created on first connection
- SHA-256 file hashing function available
- Sync metadata CRUD operations available
- Module structure ready for block-sync and market-sync implementations
</success_criteria>

<output>
After completion, create `.planning/phases/42-sync-layer/42-01-SUMMARY.md`
</output>
