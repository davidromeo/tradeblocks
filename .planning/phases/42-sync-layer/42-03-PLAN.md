---
phase: 42-sync-layer
plan: 03
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - packages/mcp-server/src/sync/market-sync.ts
  - packages/mcp-server/src/sync/index.ts
  - packages/mcp-server/src/db/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Market data from _marketdata/ folder is synced to DuckDB"
    - "New dates are inserted, existing dates are preserved (merge strategy)"
    - "Multiple market data files are supported (spx_daily, spx_15min, etc.)"
    - "Sync detects when CSV has new data by comparing hashes"
  artifacts:
    - path: "packages/mcp-server/src/sync/market-sync.ts"
      provides: "Market data sync logic"
      exports: ["syncMarketDataInternal", "mergeMarketDataRows"]
    - path: "packages/mcp-server/src/db/schemas.ts"
      provides: "Market data table schemas"
      contains: "CREATE TABLE IF NOT EXISTS market.spx_daily"
  key_links:
    - from: "packages/mcp-server/src/sync/market-sync.ts"
      to: "packages/mcp-server/src/db/connection.ts"
      via: "getConnection for DB operations"
      pattern: "getConnection"
    - from: "packages/mcp-server/src/sync/market-sync.ts"
      to: "packages/mcp-server/src/sync/metadata.ts"
      via: "market sync metadata operations"
      pattern: "(get|upsert)MarketSyncMetadata"
---

<objective>
Implement market data synchronization from _marketdata/ folder with date-based merge strategy.

Purpose: Satisfy SYNC-07 (market data syncs from _marketdata/ folder). Market data uses merge/preserve strategy since PineScript exports are rolling windows.
Output: Working `syncMarketData()` function that keeps DuckDB market tables in sync with CSV exports.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-sync-layer/42-CONTEXT.md
@.planning/phases/42-sync-layer/42-RESEARCH.md
@.planning/phases/42-sync-layer/42-01-SUMMARY.md

# Existing code to reference
@packages/mcp-server/src/tools/market-data.ts
@packages/mcp-server/src/db/schemas.ts
@packages/mcp-server/src/sync/index.ts
@packages/mcp-server/src/sync/metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add market data table schemas</name>
  <files>
    packages/mcp-server/src/db/schemas.ts
  </files>
  <action>
Update `packages/mcp-server/src/db/schemas.ts` to implement `ensureMarketDataTables()`:

1. **spx_daily table** (from DailyMarketData interface in market-data.ts):
   ```sql
   CREATE TABLE IF NOT EXISTS market.spx_daily (
     date VARCHAR PRIMARY KEY,
     Prior_Close DOUBLE,
     Open DOUBLE,
     High DOUBLE,
     Low DOUBLE,
     Close DOUBLE,
     Gap_Pct DOUBLE,
     Intraday_Range_Pct DOUBLE,
     Intraday_Return_Pct DOUBLE,
     Total_Return_Pct DOUBLE,
     Close_Position_In_Range DOUBLE,
     Gap_Filled INTEGER,
     VIX_Open DOUBLE,
     VIX_Close DOUBLE,
     VIX_Change_Pct DOUBLE,
     VIX_Spike_Pct DOUBLE,
     VIX_Percentile DOUBLE,
     Vol_Regime INTEGER,
     VIX9D_Close DOUBLE,
     VIX3M_Close DOUBLE,
     VIX9D_VIX_Ratio DOUBLE,
     VIX_VIX3M_Ratio DOUBLE,
     Term_Structure_State INTEGER,
     ATR_Pct DOUBLE,
     RSI_14 DOUBLE,
     Price_vs_EMA21_Pct DOUBLE,
     Price_vs_SMA50_Pct DOUBLE,
     Trend_Score INTEGER,
     BB_Position DOUBLE,
     Return_5D DOUBLE,
     Return_20D DOUBLE,
     Consecutive_Days INTEGER,
     Day_of_Week INTEGER,
     Month INTEGER,
     Is_Opex INTEGER,
     Prev_Return_Pct DOUBLE
   );
   ```

2. **spx_15min table** (from Intraday15MinData interface):
   ```sql
   CREATE TABLE IF NOT EXISTS market.spx_15min (
     date VARCHAR PRIMARY KEY,
     open DOUBLE,
     high DOUBLE,
     low DOUBLE,
     close DOUBLE,
     P_0930 DOUBLE, P_0945 DOUBLE, P_1000 DOUBLE, P_1015 DOUBLE, P_1030 DOUBLE,
     P_1045 DOUBLE, P_1100 DOUBLE, P_1115 DOUBLE, P_1130 DOUBLE, P_1145 DOUBLE,
     P_1200 DOUBLE, P_1215 DOUBLE, P_1230 DOUBLE, P_1245 DOUBLE, P_1300 DOUBLE,
     P_1315 DOUBLE, P_1330 DOUBLE, P_1345 DOUBLE, P_1400 DOUBLE, P_1415 DOUBLE,
     P_1430 DOUBLE, P_1445 DOUBLE, P_1500 DOUBLE, P_1515 DOUBLE, P_1530 DOUBLE,
     P_1545 DOUBLE,
     Pct_0930_to_1000 DOUBLE,
     Pct_0930_to_1200 DOUBLE,
     Pct_0930_to_1500 DOUBLE,
     Pct_0930_to_Close DOUBLE,
     MOC_15min DOUBLE,
     MOC_30min DOUBLE,
     MOC_45min DOUBLE,
     MOC_60min DOUBLE,
     Afternoon_Move DOUBLE
   );
   ```

3. **spx_highlow table** (from HighLowTimingData interface):
   ```sql
   CREATE TABLE IF NOT EXISTS market.spx_highlow (
     date VARCHAR PRIMARY KEY,
     open DOUBLE,
     high DOUBLE,
     low DOUBLE,
     close DOUBLE,
     High_Time DOUBLE,
     Low_Time DOUBLE,
     High_Before_Low INTEGER,
     High_In_First_Hour INTEGER,
     Low_In_First_Hour INTEGER,
     High_In_Last_Hour INTEGER,
     Low_In_Last_Hour INTEGER,
     Reversal_Type INTEGER,
     High_Low_Spread DOUBLE,
     Early_Extreme INTEGER,
     Late_Extreme INTEGER,
     Intraday_High DOUBLE,
     Intraday_Low DOUBLE
   );
   ```

4. **vix_intraday table** (from VixIntradayData interface, first 30 columns):
   ```sql
   CREATE TABLE IF NOT EXISTS market.vix_intraday (
     date VARCHAR PRIMARY KEY,
     open DOUBLE, high DOUBLE, low DOUBLE, close DOUBLE,
     VIX_0930 DOUBLE, VIX_1000 DOUBLE, VIX_1030 DOUBLE, VIX_1100 DOUBLE,
     VIX_1130 DOUBLE, VIX_1200 DOUBLE, VIX_1230 DOUBLE, VIX_1300 DOUBLE,
     VIX_1330 DOUBLE, VIX_1400 DOUBLE, VIX_1430 DOUBLE, VIX_1500 DOUBLE,
     VIX_1530 DOUBLE, VIX_1545 DOUBLE,
     VIX_Day_High DOUBLE, VIX_Day_Low DOUBLE,
     VIX_Morning_Move DOUBLE, VIX_Afternoon_Move DOUBLE,
     VIX_Power_Hour_Move DOUBLE, VIX_Last_30min_Move DOUBLE,
     VIX_Full_Day_Move DOUBLE, VIX_First_Hour_Move DOUBLE,
     VIX_Intraday_Range_Pct DOUBLE, VIX_Spike_From_Open DOUBLE,
     VIX_Spike_Flag INTEGER, VIX_Crush_From_Open DOUBLE,
     VIX_Crush_Flag INTEGER, VIX_Close_In_Range DOUBLE
   );
   ```

5. **Update connection.ts** to call `ensureMarketDataTables(connection)` after `ensureTradeDataTable(connection)`.

The function should execute all CREATE TABLE statements.
  </action>
  <verify>
- `npm run build` succeeds
- `ensureMarketDataTables` creates all four market data tables
- Tables have date as PRIMARY KEY for merge strategy
  </verify>
  <done>Market data table schemas defined with date as primary key for merge operations.</done>
</task>

<task type="auto">
  <name>Task 2: Implement market data sync logic</name>
  <files>
    packages/mcp-server/src/sync/market-sync.ts
    packages/mcp-server/src/sync/index.ts
  </files>
  <action>
Create `packages/mcp-server/src/sync/market-sync.ts`:

1. **Types and config:**
   ```typescript
   // Map CSV filenames to table names and column mappings
   const MARKET_DATA_FILES: Record<string, { table: string; dateColumn: string }> = {
     'spx_daily.csv': { table: 'market.spx_daily', dateColumn: 'time' },
     'spx_15min.csv': { table: 'market.spx_15min', dateColumn: 'time' },
     'spx_highlow.csv': { table: 'market.spx_highlow', dateColumn: 'time' },
     'vix_intraday.csv': { table: 'market.vix_intraday', dateColumn: 'time' },
   };

   export interface MarketSyncResult {
     file: string;
     status: 'synced' | 'unchanged' | 'error';
     rowsInserted?: number;
     rowsSkipped?: number;
     error?: string;
   }
   ```

2. **`parseTimestampToDate(timestamp: string): string`**
   Convert Unix timestamp (from TradingView) to YYYY-MM-DD:
   - The CSV "time" column contains Unix timestamps (seconds since epoch)
   - Convert to Date, format as YYYY-MM-DD in Eastern Time
   - Reference existing parseTimestamp logic in market-data.ts

3. **`syncMarketFile(conn, marketDataPath, fileName): Promise<MarketSyncResult>`**
   Sync a single market data file:
   - Hash the file with `hashFileContent()`
   - Get existing metadata with `getMarketSyncMetadata(conn, fileName)`
   - If hash matches, return `{ status: 'unchanged' }`
   - If hash differs or no metadata:
     a. Parse CSV
     b. Convert each row's "time" column to date string
     c. INSERT INTO table ... ON CONFLICT (date) DO NOTHING
     d. Track inserted vs skipped counts
     e. Update metadata with new hash and max date
     f. Return result

4. **`mergeMarketDataRows(conn, tableName, records, headers): Promise<{inserted: number, skipped: number}>`**
   Insert rows using ON CONFLICT DO NOTHING:
   - Build column list from headers (excluding 'time', adding 'date')
   - For each record batch (500 rows):
     - Build INSERT ... ON CONFLICT (date) DO NOTHING
     - Count actual insertions (may need to SELECT COUNT before/after or check result)
   - DuckDB INSERT ... ON CONFLICT returns the number of rows actually inserted

5. **`syncMarketDataInternal(conn, baseDir): Promise<MarketSyncResult[]>`**
   Sync all market data files:
   - Get _marketdata path: `path.join(baseDir, '_marketdata')`
   - Check if directory exists (return empty results if not)
   - For each file in MARKET_DATA_FILES that exists:
     - Call syncMarketFile()
     - Collect results
   - Return array of results

Update `packages/mcp-server/src/sync/index.ts`:

1. Import from market-sync.ts
2. Implement `syncMarketData()`:
   ```typescript
   export async function syncMarketData(baseDir: string): Promise<{
     filesProcessed: number;
     synced: number;
     unchanged: number;
     errors: string[];
   }> {
     const conn = await getConnection(baseDir);
     const results = await syncMarketDataInternal(conn, baseDir);

     return {
       filesProcessed: results.length,
       synced: results.filter(r => r.status === 'synced').length,
       unchanged: results.filter(r => r.status === 'unchanged').length,
       errors: results.filter(r => r.status === 'error').map(r => `${r.file}: ${r.error}`)
     };
   }
   ```
3. Remove the placeholder `throw new Error('Not implemented')` from syncMarketData.

**Per CONTEXT.md decisions:**
- Merge/preserve strategy: INSERT only new rows, preserve existing
- Use date as primary key for conflict detection
- Accumulates history as rolling window exports are processed over time
  </action>
  <verify>
- Files exist: sync/market-sync.ts
- `npm run build` succeeds
- `syncMarketData()` no longer throws "Not implemented"
- Market data files are mapped to correct tables
  </verify>
  <done>Market data sync implemented with date-based merge strategy.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds in packages/mcp-server
2. Market data table schemas created (spx_daily, spx_15min, spx_highlow, vix_intraday)
3. syncMarketData() syncs all files in _marketdata/ folder
4. Merge strategy: new dates inserted, existing dates preserved
5. Hash-based change detection for market data files
</verification>

<success_criteria>
- All four market data tables have schemas in DuckDB
- syncMarketData() detects and processes files in _marketdata/
- Date-based merge preserves historical data while adding new dates
- Sync metadata tracks file hashes for change detection
</success_criteria>

<output>
After completion, create `.planning/phases/42-sync-layer/42-03-SUMMARY.md`
</output>
