---
phase: 34-report-tools-fixes
plan: 01
type: execute
---

<objective>
Fix Zod default parameters not applying in MCP SDK CLI mode for report tools.

Purpose: Several report tools crash or behave incorrectly when optional parameters with defaults are omitted because the MCP SDK CLI handler doesn't apply Zod `.default()` values.

Output: All report tools work correctly when optional parameters are omitted, using proper runtime defaults.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-find-predictive-fields/32-01-SUMMARY.md

**Bug discovered during Phase 32:**
The MCP SDK CLI handler (`--call` mode) doesn't apply Zod `.default()` values. Parameters defined with `.default(x)` arrive as `undefined` when omitted by the user.

**Root cause:** The MCP SDK parses JSON input directly without running Zod's `.parse()` which would apply defaults. This is a known SDK limitation.

**Pattern established in Phase 32:** Rename destructured params to `rawParam` and apply defaults at runtime: `const param = rawParam ?? defaultValue`.

**Tools already fixed:**
- `find_predictive_fields` (Phase 32)
- `filter_curve` (Phase 33)

**Tools needing fix:**
1. `aggregate_by_field` - `metrics`, `includeOutOfRange` - CRASHES with "Cannot read properties of undefined (reading 'includes')"
2. `run_filtered_query` - `logic`, `includeSampleTrades`, `sampleSize` - Returns unexpected results
3. `get_field_statistics` - `histogramBuckets` - May crash or produce wrong bucket count
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix aggregate_by_field runtime defaults</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
In aggregate_by_field handler (around line 875):
1. Rename destructured params: `metrics` -> `rawMetrics`, `includeOutOfRange` -> `rawIncludeOutOfRange`
2. Add runtime defaults inside try block:
   ```typescript
   const metrics = rawMetrics ?? ["count", "winRate", "avgPl", "totalPl"];
   const includeOutOfRange = rawIncludeOutOfRange ?? true;
   ```
3. Update all usages to use the new const names (should already be correct since we're shadowing)
  </action>
  <verify>
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call aggregate_by_field '{"blockId":"main-port-2026","groupByField":"openingVix","bucketEdges":[15,20,25,30]}'
```
Should return valid JSON with default metrics (count, winRate, avgPl, totalPl) without crashing.
  </verify>
  <done>aggregate_by_field works when metrics and includeOutOfRange params are omitted</done>
</task>

<task type="auto">
  <name>Task 2: Fix run_filtered_query runtime defaults</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
In run_filtered_query handler (around line 581):
1. Rename destructured params: `logic` -> `rawLogic`, `includeSampleTrades` -> `rawIncludeSampleTrades`, `sampleSize` -> `rawSampleSize`
2. Add runtime defaults inside try block:
   ```typescript
   const logic = rawLogic ?? "and";
   const includeSampleTrades = rawIncludeSampleTrades ?? true;
   const sampleSize = rawSampleSize ?? 5;
   ```
3. Verify code uses const names (should already be correct)
  </action>
  <verify>
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_filtered_query '{"blockId":"main-port-2026","conditions":[{"field":"openingVix","operator":"lt","value":20}]}' | jq '.sampleTrades | length'
```
Should return 5 (default sampleSize) instead of null.
  </verify>
  <done>run_filtered_query returns sample trades by default and uses "and" logic when params omitted</done>
</task>

<task type="auto">
  <name>Task 3: Fix get_field_statistics runtime defaults</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
In get_field_statistics handler (around line 719):
1. Rename destructured param: `histogramBuckets` -> `rawHistogramBuckets`
2. Add runtime default inside try block:
   ```typescript
   const histogramBuckets = rawHistogramBuckets ?? 10;
   ```
3. Verify code uses const name (should already be correct)
  </action>
  <verify>
```bash
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call get_field_statistics '{"blockId":"main-port-2026","field":"openingVix"}' | jq '.histogram | length'
```
Should return 10 (default histogramBuckets).
  </verify>
  <done>get_field_statistics produces 10 histogram buckets by default</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call aggregate_by_field '{"blockId":"main-port-2026","groupByField":"openingVix","bucketEdges":[15,20,25,30]}'` returns valid JSON
- [ ] `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call run_filtered_query '{"blockId":"main-port-2026","conditions":[{"field":"openingVix","operator":"lt","value":20}]}'` returns sampleTrades (not null)
- [ ] `TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call get_field_statistics '{"blockId":"main-port-2026","field":"openingVix"}'` returns histogram with 10 buckets
- [ ] `npm run typecheck` passes in packages/mcp-server
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- All report tools work correctly when optional parameters are omitted
</success_criteria>

<output>
After completion, create `.planning/phases/34-report-tools-fixes/34-01-SUMMARY.md`:

# Phase 34 Plan 01: Report Tools Fixes Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `packages/mcp-server/src/tools/reports.ts` - Added runtime defaults for Zod parameters

## Decisions Made

[None - straightforward bug fix]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 34 complete, ready for milestone completion
</output>
