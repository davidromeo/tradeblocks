---
phase: 37-discrepancy-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/reports.ts
  - packages/mcp-server/package.json
autonomous: true

must_haves:
  truths:
    - "Model can classify slippage into 5 categories (entry price, exit price, size, timing, unexplained)"
    - "Model can identify strategies with systematic slippage patterns (direction bias, category concentration)"
    - "Model can correlate slippage with market conditions (VIX levels, time-of-day)"
  artifacts:
    - path: "packages/mcp-server/src/tools/reports.ts"
      provides: "analyze_discrepancies MCP tool"
      exports: ["analyze_discrepancies"]
    - path: "packages/mcp-server/package.json"
      provides: "Version bump for new tool"
      contains: "0.4.5"
  key_links:
    - from: "packages/mcp-server/src/tools/reports.ts"
      to: "compare_backtest_to_actual logic"
      via: "Reuses trade matching and DetailedComparison-like structure"
      pattern: "loadBlock.*loadReportingLog"
    - from: "packages/mcp-server/src/tools/reports.ts"
      to: "@tradeblocks/lib statistical utils"
      via: "Correlation functions"
      pattern: "pearsonCorrelation|kendallTau"
---

<objective>
Implement the `analyze_discrepancies` MCP tool that classifies slippage sources, identifies systematic patterns, and correlates slippage with market conditions.

Purpose: Enable Claude to understand WHY slippage occurs (not just that it occurs), by decomposing slippage into component sources, detecting patterns across strategies, and correlating with available market data.

Output: A single new MCP tool in reports.ts with comprehensive slippage analysis capabilities.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-discrepancy-analysis/37-CONTEXT.md
@.planning/phases/37-discrepancy-analysis/37-RESEARCH.md
@.planning/phases/36-enhanced-comparison/36-01-SUMMARY.md

# Key reference files:
@packages/mcp-server/src/tools/reports.ts - Add new tool here (aggregate_by_field pattern)
@packages/mcp-server/src/tools/performance.ts - compare_backtest_to_actual implementation to reference
@packages/lib/calculations/statistical-utils.ts - pearsonCorrelation, kendallTau functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement analyze_discrepancies MCP tool</name>
  <files>packages/mcp-server/src/tools/reports.ts</files>
  <action>
Add a new MCP tool `analyze_discrepancies` to reports.ts. The tool should:

**Input Schema:**
```typescript
inputSchema: z.object({
  blockId: z.string().describe("Block folder name"),
  strategy: z.string().optional().describe("Filter to specific strategy name"),
  dateRange: z.object({
    from: z.string().optional().describe("Start date YYYY-MM-DD"),
    to: z.string().optional().describe("End date YYYY-MM-DD"),
  }).optional().describe("Filter trades to date range"),
  scaling: z.enum(["raw", "perContract", "toReported"]).default("toReported")
    .describe("Scaling mode for P/L comparison (default: toReported)"),
  correlationMethod: z.enum(["pearson", "kendall"]).default("pearson")
    .describe("Correlation method for market condition analysis"),
  minSamples: z.number().min(5).default(10)
    .describe("Minimum samples required for pattern detection"),
  patternThreshold: z.number().min(0.5).max(0.95).default(0.7)
    .describe("Threshold for detecting systematic patterns (0.7 = 70% consistency)"),
  includePerStrategy: z.boolean().default(true)
    .describe("Include per-strategy breakdown in output"),
})
```

**Core Logic:**

1. **Load and Match Trades** (reuse logic from compare_backtest_to_actual):
   - Load backtest (Trade[]) and actual (ReportingTrade[]) trades
   - Apply strategy and dateRange filters
   - Match trades by date|strategy|timeOpened (minute precision)
   - Apply scaling per the scaling parameter

2. **Slippage Attribution** - For each matched trade, decompose total slippage:
   ```typescript
   interface SlippageAttribution {
     date: string;
     strategy: string;
     timeOpened: string;
     totalSlippage: number;
     // Category breakdown (all in dollars)
     entryPriceSlippage: number;  // (bt.openingPrice - actual.openingPrice) * actualContracts * multiplier
     exitPriceSlippage: number;   // (bt.closingPrice - actual.closingPrice) * actualContracts * multiplier
     sizeSlippage: number;        // P/L difference due to different contract counts
     timingSlippage: number;      // Flag only - set to 0 but note reasonForClose differences
     unexplainedResidual: number; // totalSlippage - (entry + exit + size)
     // Context for correlation
     openingVix?: number;
     closingVix?: number;
     gap?: number;
     movement?: number;
     hourOfDay: number;  // Parsed from timeOpened
     contracts: number;  // Actual contracts for size analysis
   }
   ```

   **Attribution Logic (sequential):**
   - Entry slippage: Use backtest openingPrice vs actual openingPrice, scaled by actual contracts
   - Exit slippage: Use backtest closingPrice vs actual closingPrice, scaled by actual contracts
   - Size slippage: Difference in P/L from different contract counts (backtest P/L at backtest size - backtest P/L at actual size)
   - Timing: If reasonForClose differs, flag it but don't attempt dollar attribution
   - Unexplained: Whatever remains after accounting for entry, exit, and size

3. **Pattern Detection** - Identify systematic patterns:
   ```typescript
   interface PatternInsight {
     pattern: string;           // Human-readable description
     metric: string;            // What was measured
     value: number;             // The measured value
     sampleSize: number;        // How many observations
     confidence: "low" | "moderate" | "high";  // Based on sample size (low <10, moderate 10-30, high >30)
   }
   ```

   Patterns to detect:
   - **Direction bias**: If >patternThreshold of slippages are same sign (positive or negative)
   - **Category concentration**: If one category accounts for >patternThreshold of total absolute slippage
   - **Time-of-day clustering**: If >patternThreshold of outlier trades occur in same hour bucket (morning/midday/afternoon)
   - **VIX sensitivity**: Correlation coefficient between slippage and openingVix (if available)

4. **Market Correlations** - Using pearsonCorrelation or kendallTau from @tradeblocks/lib:
   - Import: `import { pearsonCorrelation, kendallTau } from "@tradeblocks/lib";`
   - Calculate correlations between slippage and: openingVix, closingVix, gap, movement, hourOfDay, contracts
   - Only report correlations where sample size >= minSamples

5. **Output Structure:**
   ```typescript
   {
     summary: {
       matchedTrades: number;
       unmatchedBacktest: number;
       unmatchedActual: number;
       totalSlippage: number;
       avgSlippagePerTrade: number;
       dateRange: { from: string; to: string };
     },
     attribution: {
       byCategory: {
         entryPrice: { total: number; pctOfTotal: number; avgPerTrade: number; };
         exitPrice: { total: number; pctOfTotal: number; avgPerTrade: number; };
         size: { total: number; pctOfTotal: number; avgPerTrade: number; };
         timing: { flaggedCount: number; pctWithTimingDifference: number; };
         unexplained: { total: number; pctOfTotal: number; avgPerTrade: number; };
       };
     },
     patterns: PatternInsight[];  // Array of detected patterns
     correlations: {
       method: "pearson" | "kendall";
       results: Array<{
         field: string;
         coefficient: number;
         sampleSize: number;
         interpretation: string;  // "weak positive", "moderate negative", etc.
       }>;
     },
     perStrategy?: Array<{  // Only if includePerStrategy: true
       strategy: string;
       tradeCount: number;
       totalSlippage: number;
       avgSlippage: number;
       dominantCategory: string;
       patterns: PatternInsight[];
     }>;
   }
   ```

**Implementation Notes:**
- Use `createToolOutput()` for JSON-first MCP response formatting
- Use formatCurrency/formatPercent from output-formatter.js for readable numbers
- Parse hourOfDay from timeOpened using simple string parsing (avoid Date object timezone issues)
- Multiplier for options is typically 100 (standard option contract)
- Handle missing VIX data gracefully - exclude from correlations, note in output

**Error Handling:**
- Return error if no reportinglog.csv exists
- Return error if no trades match filters
- Handle cases where all trades are unmatched (no correlation data)
  </action>
  <verify>
Run typecheck: `npm run typecheck`
Run lint: `npm run lint`
Verify tool is exported by checking reports.ts exports the tool registration
  </verify>
  <done>
New analyze_discrepancies tool registered in reports.ts with:
- All 5 slippage categories computed and attributed
- Pattern detection for direction bias, category concentration, time clustering, VIX sensitivity
- Market correlations using specified method
- Per-strategy breakdown when requested
- Proper error handling for missing data
  </done>
</task>

<task type="auto">
  <name>Task 2: Bump MCP server version</name>
  <files>packages/mcp-server/package.json</files>
  <action>
Bump the MCP server version from 0.4.4 to 0.4.5 in packages/mcp-server/package.json.

This is a minor version bump (patch) for the new analyze_discrepancies tool.
  </action>
  <verify>
Verify version is 0.4.5: `grep '"version"' packages/mcp-server/package.json`
  </verify>
  <done>
packages/mcp-server/package.json has version "0.4.5"
  </done>
</task>

<task type="auto">
  <name>Task 3: Test tool with CLI mode</name>
  <files>None (verification only)</files>
  <action>
Test the new tool using the CLI test mode:

```bash
cd /Users/davidromeo/Code/tradeblocks
npm run build -w @tradeblocks/mcp-server

# Find a block with reportinglog.csv
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call list_blocks '{}'

# Test the tool (use a real block ID from list_blocks output that has hasReportingLog: true)
TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call analyze_discrepancies '{"blockId": "BLOCK_ID_HERE"}'
```

Verify:
1. Tool returns valid JSON
2. Summary section shows matched/unmatched counts
3. Attribution section shows all 5 categories
4. Patterns array is populated (may be empty if no patterns detected)
5. Correlations section shows method and results array
6. No errors in output
  </action>
  <verify>
CLI test returns valid JSON output with all expected sections.
No errors in console output.
  </verify>
  <done>
analyze_discrepancies tool works correctly via CLI test mode, returning structured slippage analysis data.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npm run typecheck`
2. ESLint passes: `npm run lint`
3. MCP server builds: `npm run build -w @tradeblocks/mcp-server`
4. CLI test returns valid output with all sections (summary, attribution, patterns, correlations)
5. Version is 0.4.5 in package.json
</verification>

<success_criteria>
- analyze_discrepancies MCP tool is registered and callable
- Tool decomposes slippage into 5 categories (entry, exit, size, timing, unexplained)
- Tool detects systematic patterns (direction bias, category concentration, time clustering, VIX sensitivity)
- Tool calculates correlations with market conditions using specified method
- Tool provides per-strategy breakdown when requested
- MCP server version bumped to 0.4.5
- All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/37-discrepancy-analysis/37-01-SUMMARY.md`
</output>
