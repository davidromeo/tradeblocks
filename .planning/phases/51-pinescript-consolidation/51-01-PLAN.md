---
phase: 51-pinescript-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/spx-daily.pine
autonomous: true

must_haves:
  truths:
    - "spx-daily.pine computes highlow timing via request.security_lower_tf() with 5-min intrabar data"
    - "spx-daily.pine exports all 13 highlow fields as plot() lines with display.data_window"
    - "spx-daily.pine exports all 7 enriched VIX fields (VIX_Gap_Pct, VIX9D_Open, VIX9D_Change_Pct, VIX_High, VIX_Low, VIX3M_Open, VIX3M_Change_Pct) as plot() lines"
    - "Dead code from lines 68-97 (getIntradayPrice helper and approximate checkpoint section) is removed"
    - "All existing plot labels remain unchanged (no renames)"
    - "Total plot count is 56 of 64 (36 existing + 13 highlow + 7 VIX)"
  artifacts:
    - path: "scripts/spx-daily.pine"
      provides: "Combined daily + highlow + enriched VIX export script"
      contains: "request.security_lower_tf"
  key_links:
    - from: "scripts/spx-daily.pine"
      to: "TradingView CSV export"
      via: "plot() with display.data_window"
      pattern: 'plot\(.*"(High_Time|VIX_Gap_Pct)"'
---

<objective>
Merge highlow timing computation and enriched VIX field exports into the daily PineScript.

Purpose: Consolidate the daily script so a single CSV export contains daily data, highlow timing, and all VIX fields -- eliminating the need for a separate highlow script and making 7 already-computed VIX fields available in the CSV.

Output: Updated `scripts/spx-daily.pine` with 20 new plot lines (13 highlow + 7 VIX) and dead code removed.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-pinescript-consolidation/51-RESEARCH.md
@scripts/spx-daily.pine
@scripts/poc-highlow-daily-ltf.pine
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add highlow timing computation and all new export plots to spx-daily.pine</name>
  <files>scripts/spx-daily.pine</files>
  <action>
Modify `scripts/spx-daily.pine` with three changes:

**Change 1: Remove dead code (lines 68-97)**

Delete the entire "INTRADAY PRICE CHECKPOINTS" section (lines 68-97) which contains the `getIntradayPrice()` helper and approximate checkpoint variables (`price_open`, `price_high`, `price_low`, `price_close`, `price_midday_est`, `morningRangeEst`, `afternoonMove`, `afternoonMovePct`). This is dead code -- these variables are never referenced by any plot() call or other computation. The comment block starting with `// INTRADAY PRICE CHECKPOINTS` and ending before `// VIX TERM STRUCTURE` should be removed entirely.

**Change 2: Add highlow timing computation section**

Insert a new section AFTER the "PRIOR DAY CONTEXT" section (after line 265) and BEFORE the "EXPORT PLOTS - Core Price Data" section. Use the exact code from the research document's "Example 1: Complete Highlow Section for Daily Script". This adds:

- 3 `request.security_lower_tf()` calls for 5-min high, low, time arrays
- Loop to find max high and min low with their timestamps (first-occurrence matching: `h > maxH` and `l < minL` -- strict greater/less, NOT `>=`/`<=`)
- Hour/minute extraction using `hour(time, "America/New_York")` and `minute(time, "America/New_York")`
- Derived metrics: `highTimeHL`, `lowTimeHL`, `highBeforeLowHL`, `highInFirstHourHL`, `lowInFirstHourHL`, `highInLastHourHL`, `lowInLastHourHL`, `reversalTypeHL`, `highLowSpreadHL`, `earlyExtremeHL`, `lateExtremeHL`
- All variable names use `HL` suffix to avoid collisions with Pine built-ins

**Change 3: Add 20 new export plot lines**

Add two new EXPORT PLOTS sections AFTER the existing "EXPORT PLOTS - Prior Day Context" section and BEFORE the "VISUAL DISPLAY" section:

Section A -- "EXPORT PLOTS - Enriched VIX Fields" (7 plots):
```pine
plot(vixGapPct, "VIX_Gap_Pct", display=display.data_window)
plot(vix9dOpen, "VIX9D_Open", display=display.data_window)
plot(vix9dChangePct, "VIX9D_Change_Pct", display=display.data_window)
plot(vixHigh, "VIX_High", display=display.data_window)
plot(vixLow, "VIX_Low", display=display.data_window)
plot(vix3mOpen, "VIX3M_Open", display=display.data_window)
plot(vix3mChangePct, "VIX3M_Change_Pct", display=display.data_window)
```

Section B -- "EXPORT PLOTS - High/Low Timing" (13 plots):
```pine
plot(highTimeHL, "High_Time", display=display.data_window)
plot(lowTimeHL, "Low_Time", display=display.data_window)
plot(highBeforeLowHL ? 1 : 0, "High_Before_Low", display=display.data_window)
plot(highInFirstHourHL ? 1 : 0, "High_In_First_Hour", display=display.data_window)
plot(lowInFirstHourHL ? 1 : 0, "Low_In_First_Hour", display=display.data_window)
plot(highInLastHourHL ? 1 : 0, "High_In_Last_Hour", display=display.data_window)
plot(lowInLastHourHL ? 1 : 0, "Low_In_Last_Hour", display=display.data_window)
plot(reversalTypeHL, "Reversal_Type", display=display.data_window)
plot(highLowSpreadHL, "High_Low_Spread", display=display.data_window)
plot(earlyExtremeHL ? 1 : 0, "Early_Extreme", display=display.data_window)
plot(lateExtremeHL ? 1 : 0, "Late_Extreme", display=display.data_window)
plot(intradayHighHL, "Intraday_High", display=display.data_window)
plot(intradayLowHL, "Intraday_Low", display=display.data_window)
```

**Important constraints:**
- Do NOT change any existing plot labels (e.g., "VIX_Open" must stay "VIX_Open")
- Do NOT include debug plots from the PoC (Debug_Intrabar_Count, Debug_NewDay)
- Do NOT touch the visual display section (hline, bgcolor) at the bottom
- Update the script header comment to mention highlow timing and enriched VIX fields
  </action>
  <verify>
Verify the completed file by checking:
1. Count plot() calls -- should be 51 (31 existing + 7 VIX + 13 highlow)
2. Count hline() calls -- should be 4 (unchanged)
3. Count bgcolor() calls -- should be 1 (unchanged)
4. Total plot count budget: 51 + 4 + 1 = 56 of 64
5. Grep for `request.security_lower_tf` -- should find exactly 3 calls
6. Grep for `getIntradayPrice` -- should find 0 occurrences (dead code removed)
7. Grep for `price_midday_est` -- should find 0 occurrences (dead code removed)
8. All 13 highlow CSV column names present: High_Time, Low_Time, High_Before_Low, High_In_First_Hour, Low_In_First_Hour, High_In_Last_Hour, Low_In_Last_Hour, Reversal_Type, High_Low_Spread, Early_Extreme, Late_Extreme, Intraday_High, Intraday_Low
9. All 7 VIX CSV column names present: VIX_Gap_Pct, VIX9D_Open, VIX9D_Change_Pct, VIX_High, VIX_Low, VIX3M_Open, VIX3M_Change_Pct
  </verify>
  <done>
spx-daily.pine contains highlow timing computation via request.security_lower_tf(), exports all 13 highlow fields and 7 enriched VIX fields, dead code is removed, and all existing plot labels are unchanged. Total plot count is 56 of 64.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "^plot(" scripts/spx-daily.pine` returns 51
2. `grep -c "^hline(" scripts/spx-daily.pine` returns 4
3. `grep -c "^bgcolor(" scripts/spx-daily.pine` returns 1
4. `grep -c "request.security_lower_tf" scripts/spx-daily.pine` returns 3
5. `grep "getIntradayPrice" scripts/spx-daily.pine` returns no matches
6. All 20 new CSV column names present in plot() labels
</verification>

<success_criteria>
- spx-daily.pine compiles conceptually (correct PineScript v6 syntax)
- 56 total plot counts (within 64 limit)
- ~15 total request.*() calls (within 40 limit)
- Dead code removed, no new dead code introduced
- All existing plot labels unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/51-pinescript-consolidation/51-01-SUMMARY.md`
</output>
