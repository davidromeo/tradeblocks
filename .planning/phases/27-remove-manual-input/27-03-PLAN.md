---
phase: 27-remove-manual-input
plan: 03
type: execute
---

<objective>
Remove riskFreeRate from MCP server and update all test files.

Purpose: Complete the cleanup by updating the MCP server API and fixing all tests that reference riskFreeRate.

Output: MCP server no longer accepts riskFreeRate parameter. All tests pass without riskFreeRate references.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./27-03-summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-remove-manual-input/27-01-PLAN.md
@.planning/phases/27-remove-manual-input/27-02-PLAN.md

# Depends on Plan 01 and Plan 02 completing first

# Files to modify:
@packages/mcp-server/src/tools/performance.ts
@tests/unit/portfolio-stats.test.ts
@tests/unit/performance-store.test.ts
@tests/unit/performance-snapshot-cache.test.ts
@tests/unit/portfolio-stats-risk-free.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove riskFreeRate from MCP server</name>
  <files>packages/mcp-server/src/tools/performance.ts</files>
  <action>
1. In `packages/mcp-server/src/tools/performance.ts`:

   a. Remove riskFreeRate from the `buildRollingMetrics` function signature (line ~676):
      - Change `riskFreeRate: number = 2.0` parameter to remove it
      - Update the Sharpe calculation inside to use a fixed rate or remove it
      - NOTE: Rolling metrics Sharpe is trade-based, not date-based, so this is a simplification
      - Either use a fixed 2.0 constant inline, or remove Sharpe from rolling metrics entirely

   b. Remove riskFreeRate from the `get_chart_data` tool schema (lines ~1156-1161):
      - Remove the `riskFreeRate: z.number().default(2.0)...` parameter
      - Remove from the tool's parameter destructuring (~1199)
      - Remove from the buildRollingMetrics call (~1321, ~1437)

   c. After removal, rolling_metrics Sharpe calculation should either:
      - Use inline constant: `const dailyRfr = 2.0 / 100 / 252;` (simplest)
      - Or skip Sharpe in rolling metrics since it's a simplification anyway
      - Choose option A (inline constant) to maintain backward compatibility

Note: The MCP server's rolling metrics Sharpe is an approximation for quick visualization.
The accurate date-based Sharpe is computed by portfolio-stats.ts for actual statistics.
  </action>
  <verify>npm run build --workspace=packages/mcp-server compiles without errors</verify>
  <done>MCP server no longer accepts riskFreeRate in its API schema</done>
</task>

<task type="auto">
  <name>Task 2: Update test files to remove riskFreeRate references</name>
  <files>tests/unit/portfolio-stats.test.ts, tests/unit/performance-store.test.ts, tests/unit/performance-snapshot-cache.test.ts, tests/unit/portfolio-stats-risk-free.test.ts</files>
  <action>
1. In `tests/unit/portfolio-stats.test.ts`:
   - Remove `riskFreeRate: 2.0,` from test config objects (line ~24)
   - Use `new PortfolioStatsCalculator()` without passing riskFreeRate

2. In `tests/unit/performance-store.test.ts`:
   - Remove `riskFreeRate: 2` from test config (line ~90)

3. In `tests/unit/performance-snapshot-cache.test.ts`:
   - Remove all `riskFreeRate: 2.0,` from test calls (lines ~82, ~107, ~130, ~151, ~176, ~222, ~246, ~263)
   - These are in various test case configurations

4. In `tests/unit/portfolio-stats-risk-free.test.ts`:
   - Update the test "should ignore config.riskFreeRate when calculating ratios" (lines ~447-460)
   - This test was checking that the config value is ignored
   - Update to just verify that Sharpe/Sortino use date-based rates
   - Remove references to passing riskFreeRate config to constructor
   - Keep the test valuable by verifying the date-based behavior works correctly

For all test files: Just remove riskFreeRate from any PortfolioStatsCalculator or AnalysisConfig objects.
  </action>
  <verify>npm test passes all tests</verify>
  <done>All tests updated and passing without riskFreeRate references</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `packages/mcp-server/src/tools/performance.ts` - No riskFreeRate in schema or function params
- [ ] `tests/unit/portfolio-stats.test.ts` - No riskFreeRate in config
- [ ] `tests/unit/performance-store.test.ts` - No riskFreeRate in config
- [ ] `tests/unit/performance-snapshot-cache.test.ts` - No riskFreeRate in test calls
- [ ] `tests/unit/portfolio-stats-risk-free.test.ts` - Test updated to not use riskFreeRate config
- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] `npm test` passes all tests
</verification>

<success_criteria>
- MCP server API no longer has riskFreeRate parameter
- All test files pass
- No TypeScript errors in entire codebase
- Full build succeeds
- Phase 27 complete
</success_criteria>

<output>
After completion, create `.planning/phases/27-remove-manual-input/27-03-SUMMARY.md`:

# Phase 27 Plan 03: MCP & Tests Summary

**Completed cleanup of riskFreeRate from MCP server and test suites**

## Accomplishments
- MCP server get_chart_data tool no longer accepts riskFreeRate parameter
- Rolling metrics Sharpe uses inline constant (simplification for visualization)
- All test files updated to not pass riskFreeRate config
- Full test suite passes

## Files Modified
- packages/mcp-server/src/tools/performance.ts
- tests/unit/portfolio-stats.test.ts
- tests/unit/performance-store.test.ts
- tests/unit/performance-snapshot-cache.test.ts
- tests/unit/portfolio-stats-risk-free.test.ts

## Next Step
Phase 27 complete, ready for Phase 28: MCP & Tests (final integration testing)
</output>
