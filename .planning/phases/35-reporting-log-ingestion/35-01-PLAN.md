---
phase: 35-reporting-log-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/blocks.ts
  - packages/mcp-server/src/utils/block-loader.ts
autonomous: true

must_haves:
  truths:
    - "Model calling list_blocks sees hasReportingLog flag for each block"
    - "Model calling get_reporting_log_stats receives per-strategy breakdown with tradeCount, winRate, totalPL, avgPL"
    - "Stats are cached in block.json and recomputed only when CSV file changes"
  artifacts:
    - path: "packages/mcp-server/src/tools/blocks.ts"
      provides: "get_reporting_log_stats MCP tool"
      exports: ["registerBlockTools"]
    - path: "packages/mcp-server/src/utils/block-loader.ts"
      provides: "Reporting log stats computation and caching"
      exports: ["loadReportingLogStats", "BlockMetadata"]
  key_links:
    - from: "packages/mcp-server/src/tools/blocks.ts"
      to: "block-loader.ts"
      via: "loadReportingLogStats()"
      pattern: "loadReportingLogStats"
    - from: "packages/mcp-server/src/utils/block-loader.ts"
      to: "block.json"
      via: "reportingLogStats cache"
      pattern: "reportingLogStats"
---

<objective>
Enable AI models to discover which blocks have reporting logs and get detailed statistics about actual trade execution.

Purpose: This is the foundation for v2.5 â€” models need to know which blocks have reporting data before they can run comparisons or discrepancy analysis.

Output:
- `list_blocks` enhanced with `hasReportingLog` flag and basic stats
- New `get_reporting_log_stats` tool for per-strategy breakdown
- Caching infrastructure in block.json with mtime-based invalidation
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-reporting-log-ingestion/35-CONTEXT.md

# Existing infrastructure to build on
@packages/mcp-server/src/utils/block-loader.ts
@packages/mcp-server/src/tools/blocks.ts
@packages/lib/models/reporting-trade.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BlockMetadata and add reporting log stats computation</name>
  <files>packages/mcp-server/src/utils/block-loader.ts</files>
  <action>
  Extend the block-loader module to support reporting log stats:

  1. Add `reportingLogStats` field to `BlockMetadata` interface:
     ```typescript
     reportingLogStats?: {
       totalTrades: number
       totalPL: number
       dateRange: { start: string | null; end: string | null }
       strategies: string[]
       byStrategy: Record<string, {
         tradeCount: number
         winRate: number
         totalPL: number
         avgPL: number
         contractCount: number
       }>
       invalidTrades: number
       calculatedAt: string
     }
     ```

  2. Add `hasReportingLog` field to `BlockInfo` interface:
     ```typescript
     hasReportingLog: boolean
     reportingLogStats?: BlockMetadata['reportingLogStats']
     ```

  3. Create `computeReportingLogStats()` helper function that:
     - Loads reporting trades using existing `loadReportingLog()`
     - Computes per-strategy breakdown (tradeCount, winRate, totalPL, avgPL, contractCount)
     - Returns stats object ready to cache
     - Handles missing file gracefully (returns undefined)

  4. Create `loadReportingLogStats()` export function that:
     - Checks if reportinglog CSV exists (via `csvMappings` or discovery)
     - Checks cached stats mtime vs current file mtime
     - Returns cached stats if valid, otherwise recomputes
     - Saves updated stats to block.json

  5. Update `listBlocks()` to include `hasReportingLog` flag:
     - Check for reportinglog.csv existence (via mappings or discovery)
     - Include basic stats from cache if available (with `stale: true` flag if mtime changed)

  Note: Follow existing patterns for mtime-based cache invalidation (see `isCacheValid()` function).
  </action>
  <verify>
  - TypeScript compiles: `npm run typecheck` passes
  - `BlockMetadata` has `reportingLogStats` field
  - `BlockInfo` has `hasReportingLog` field
  - `loadReportingLogStats()` is exported
  </verify>
  <done>
  Block-loader supports reporting log stats computation with mtime-based caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance list_blocks and add get_reporting_log_stats tool</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
  Update the blocks.ts file to expose reporting log data:

  1. Enhance `list_blocks` response to include reporting log info:
     - Add `hasReportingLog: boolean` to each block in the response
     - If reporting log exists and stats are cached, include basic summary:
       ```typescript
       reportingLog?: {
         tradeCount: number
         strategyCount: number
         totalPL: number
         dateRange: { start: string | null; end: string | null }
         stale: boolean  // true if CSV modified since last calculation
       }
       ```

  2. Add `hasReportingLog` filter parameter to `list_blocks`:
     ```typescript
     hasReportingLog: z.boolean().optional()
       .describe("Filter to blocks with (true) or without (false) reporting log data")
     ```

  3. Create new `get_reporting_log_stats` tool:
     ```typescript
     server.registerTool(
       "get_reporting_log_stats",
       {
         description: "Get detailed statistics about actual trade execution from reporting log. Returns per-strategy breakdown with trade counts, win rates, P&L, and contract counts. Use blockId from list_blocks.",
         inputSchema: z.object({
           blockId: z.string().describe("Block ID from list_blocks"),
         }),
       },
       async ({ blockId }) => {
         // Implementation:
         // 1. Call loadReportingLogStats(baseDir, blockId)
         // 2. Return structured response with:
         //    - summary: brief text overview
         //    - structuredData: full per-strategy breakdown
         // 3. Handle "no reporting log" gracefully
       }
     );
     ```

  Response structure for `get_reporting_log_stats`:
  ```typescript
  {
    blockId: string
    totalTrades: number
    invalidTrades: number
    totalPL: number
    dateRange: { start: string | null; end: string | null }
    strategyCount: number
    byStrategy: {
      [strategyName]: {
        tradeCount: number
        winRate: number
        totalPL: number
        avgPL: number
        contractCount: number
      }
    }
  }
  ```
  </action>
  <verify>
  - TypeScript compiles: `npm run typecheck` passes
  - CLI test mode works:
    ```bash
    TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call list_blocks '{}'
    # Should show hasReportingLog field for each block

    TRADEBLOCKS_DATA_DIR=~/backtests tradeblocks-mcp --call get_reporting_log_stats '{"blockId":"<block-with-reporting-log>"}'
    # Should return per-strategy stats
    ```
  </verify>
  <done>
  `list_blocks` shows `hasReportingLog` flag and `get_reporting_log_stats` tool provides full per-strategy breakdown.
  </done>
</task>

<task type="auto">
  <name>Task 3: Version bump and verification</name>
  <files>packages/mcp-server/package.json</files>
  <action>
  1. Bump MCP server patch version in `packages/mcp-server/package.json`
     (e.g., 1.0.17 -> 1.0.18)

  2. Run full typecheck to ensure no type errors:
     ```bash
     npm run typecheck
     ```

  3. Run MCP server tests if they exist:
     ```bash
     npm test -- packages/mcp-server
     ```
     (If no tests exist, skip this step)

  4. Verify CLI test mode with a real block:
     - Use a block that has a reportinglog.csv file
     - If no such block exists locally, note this in the summary

  Note: The user will run the application to validate. Do NOT run the dev server.
  </action>
  <verify>
  - `npm run typecheck` passes
  - Version bumped in package.json
  - CLI test mode shows expected output (or documented why not testable)
  </verify>
  <done>
  MCP server version bumped, all checks pass, reporting log ingestion ready for use.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no errors
2. `list_blocks` includes `hasReportingLog` flag for each block
3. `get_reporting_log_stats` returns per-strategy breakdown
4. Stats are cached in block.json and invalidated when CSV mtime changes
5. Graceful handling when reporting log doesn't exist (no error, just flag as false)
</verification>

<success_criteria>
- Model can call `list_blocks` and see which blocks have reporting logs
- Model can call `get_reporting_log_stats` and receive full per-strategy breakdown
- Stats computation is cached with mtime-based invalidation
- All existing tests pass
- MCP server version bumped
</success_criteria>

<output>
After completion, create `.planning/phases/35-reporting-log-ingestion/35-01-SUMMARY.md`
</output>
