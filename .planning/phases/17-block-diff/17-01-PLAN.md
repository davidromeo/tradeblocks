---
phase: 17-block-diff
plan: 01
type: execute
domain: mcp-server
---

<objective>
Implement the `block_diff` MCP tool to compare two blocks with strategy overlap analysis and P/L attribution.

Purpose: Enable users to understand what changed between two portfolio versions - which strategies are shared vs unique, and how each strategy contributed to performance differences.
Output: New `block_diff` tool in the MCP server with JSON-first output pattern.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Relevant source files:**
@packages/mcp-server/src/index.ts
@packages/mcp-server/src/tools/blocks.ts
@packages/mcp-server/src/utils/output-formatter.ts
@packages/mcp-server/src/utils/block-loader.ts
@lib/calculations/portfolio-stats.ts

**Established patterns (from v2.0):**
- MCP tools use `server.registerTool()` with Zod schema validation
- Output uses `createToolOutput(summary, structuredData)` for JSON-first pattern
- Block loading via `loadBlock(baseDir, blockId)` returns trades and dailyLogs
- Strategy stats via `calculator.calculateStrategyStats(trades)`
- Filter helpers: `filterByStrategy()`, `filterByDateRange()`

**Key constraint:** Strategy filtering MUST use trade-based calculations only (not daily logs) because daily logs represent full portfolio performance.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement block_diff tool with strategy overlap analysis</name>
  <files>packages/mcp-server/src/tools/blocks.ts</files>
  <action>
Add a new `block_diff` MCP tool that compares two blocks. Register it after `compare_blocks` in blocks.ts.

**Input schema (Zod):**
- `blockIdA: z.string()` - First block (baseline)
- `blockIdB: z.string()` - Second block (comparison)
- `startDate?: z.string()` - Optional date filter (YYYY-MM-DD)
- `endDate?: z.string()` - Optional date filter
- `metricsToCompare?: z.array(z.enum([...]))` - Specific metrics to include (default: all)

**Implementation:**
1. Load both blocks via `loadBlock(baseDir, blockId)`
2. Apply date filters if provided using existing `filterByDateRange()`
3. Extract strategy names from each block's trades
4. Categorize strategies:
   - `shared`: strategies present in both blocks
   - `uniqueToA`: strategies only in block A
   - `uniqueToB`: strategies only in block B
5. For each strategy, calculate stats using `calculator.calculateStrategyStats()` (trade-based only)
6. Build structured output with:
   - `summary`: Overview section
   - `strategyOverlap`: { shared: string[], uniqueToA: string[], uniqueToB: string[] }
   - `perStrategyComparison`: Array of { strategy, blockA: stats | null, blockB: stats | null, delta: { pl, winRate, trades } }
   - `portfolioComparison`: Side-by-side portfolio-level metrics

**Output structure:**
```typescript
{
  blockA: { id, tradeCount, strategies: string[] },
  blockB: { id, tradeCount, strategies: string[] },
  strategyOverlap: {
    shared: string[],
    uniqueToA: string[],
    uniqueToB: string[],
    overlapPercent: number  // shared / total unique strategies
  },
  perStrategyComparison: [{
    strategy: string,
    blockA: { trades, pl, winRate, profitFactor } | null,
    blockB: { trades, pl, winRate, profitFactor } | null,
    delta: { pl, winRate, trades } | null  // only for shared strategies
  }],
  portfolioTotals: {
    blockA: { totalTrades, netPl, winRate, sharpeRatio, maxDrawdown },
    blockB: { totalTrades, netPl, winRate, sharpeRatio, maxDrawdown },
    delta: { netPl, winRate, sharpeRatio, maxDrawdown }
  }
}
```

Use `createToolOutput()` for JSON-first output with a brief summary line.
  </action>
  <verify>TypeScript compiles without errors: `npm run typecheck -w packages/mcp-server`</verify>
  <done>Tool registered, schema validated, output follows JSON-first pattern</done>
</task>

<task type="auto">
  <name>Task 2: Register block_diff in index and add integration test</name>
  <files>packages/mcp-server/src/index.ts, packages/mcp-server/tests/integration/block-diff.test.ts</files>
  <action>
1. Verify `registerBlockTools` is already called in index.ts (no change needed - tools auto-register)

2. Create integration test file `packages/mcp-server/tests/integration/block-diff.test.ts`:
   - Use existing test fixtures in `packages/mcp-server/tests/fixtures/`
   - Create two test blocks with overlapping and unique strategies
   - Test cases:
     a. Two blocks with some shared strategies - verify overlap categorization
     b. Two blocks with completely different strategies - verify uniqueToA/B populated
     c. Date filtering - verify trades are filtered correctly
     d. Empty block handling - verify graceful error
   - Assert JSON output structure matches expected schema
   - Follow existing test patterns from `packages/mcp-server/tests/integration/`

**Test fixtures approach:**
- Check existing fixtures in tests/fixtures/
- If needed, create minimal CSV data inline for test blocks
- Use the existing PortfolioStatsCalculator for expected values
  </action>
  <verify>`npm test -w packages/mcp-server -- --testPathPattern=block-diff`</verify>
  <done>Integration test passes, covers overlap detection, delta calculation, and edge cases</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run typecheck -w packages/mcp-server` passes
- [ ] `npm test -w packages/mcp-server` passes (all tests including new ones)
- [ ] Manual test: Run MCP server and call `block_diff` with two test blocks
- [ ] JSON output includes strategyOverlap, perStrategyComparison, portfolioTotals
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- block_diff tool callable and returns correct JSON structure
- Strategy overlap detection works correctly (shared, uniqueToA, uniqueToB)
- Per-strategy P/L attribution shows delta for shared strategies
</success_criteria>

<output>
After completion, create `.planning/phases/17-block-diff/17-01-SUMMARY.md` using the summary template with frontmatter.
</output>
