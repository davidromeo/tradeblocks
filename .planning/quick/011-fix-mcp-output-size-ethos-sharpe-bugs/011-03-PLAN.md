---
phase: quick-011
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/tools/blocks/analysis.ts
  - packages/mcp-server/src/tools/blocks/comparison.ts
  - packages/mcp-server/src/tools/blocks/similarity.ts
autonomous: true

must_haves:
  truths:
    - "block_diff uses daily-log-based Sharpe when daily logs are available"
    - "marginal_contribution uses daily-log-based Sharpe when daily logs are available"
    - "what_if_scaling uses daily-log-based Sharpe when daily logs are available"
    - "All three tools fall back to trade-based Sharpe when daily logs are NOT available"
    - "Sharpe values from these tools match get_statistics output"
    - "marginal_contribution has no interpretation field"
  artifacts:
    - path: "packages/mcp-server/src/tools/blocks/analysis.ts"
      provides: "marginal_contribution with daily-log-based Sharpe and no interpretation field"
    - path: "packages/mcp-server/src/tools/blocks/comparison.ts"
      provides: "block_diff with daily-log-based Sharpe"
    - path: "packages/mcp-server/src/tools/blocks/similarity.ts"
      provides: "what_if_scaling with daily-log-based Sharpe"
---

<objective>
Fix Sharpe ratio inconsistency across MCP tools and remove interpretation field from marginal_contribution. block_diff, marginal_contribution, and what_if_scaling use trade-based Sharpe (5.35/7.17) while get_statistics uses daily-log-based Sharpe (4.91/5.79). When daily logs are available, all tools should use the same calculation path.

Purpose: Users comparing Sharpe across tools get conflicting numbers for the same portfolio. The interpretation field in marginal_contribution violates the data-only ethos.
Output: Consistent Sharpe values across all tools that match get_statistics. No interpretive labels.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/mcp-server/src/tools/blocks/analysis.ts
@packages/mcp-server/src/tools/blocks/comparison.ts
@packages/mcp-server/src/tools/blocks/similarity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix block_diff to use daily-log-based Sharpe (Issue 3)</name>
  <files>packages/mcp-server/src/tools/blocks/comparison.ts</files>
  <action>
In the block_diff tool (starting ~line 389), the portfolio-level stats are calculated with:
```typescript
const portfolioStatsA = calculator.calculatePortfolioStats(
  tradesA,
  undefined, // Don't use daily logs for comparison - trades only
  true // Force trade-based calculations
);
```

Change this so that when the block has daily logs, they are used for the portfolio-level Sharpe calculation:

1. The block data is loaded via `loadBlock`. Check if `block.dailyLogs` exists and has entries.
2. For portfolio-level stats (the `portfolioTotals` section), use daily logs when available:
```typescript
// Use daily logs for portfolio-level stats when available (consistent with get_statistics)
// But still use trade-based for per-strategy stats since daily logs are portfolio-wide
const portfolioStatsA = calculator.calculatePortfolioStats(
  tradesA,
  blockA.dailyLogs && blockA.dailyLogs.length > 0 ? blockA.dailyLogs : undefined,
);
const portfolioStatsB = calculator.calculatePortfolioStats(
  tradesB,
  blockB.dailyLogs && blockB.dailyLogs.length > 0 ? blockB.dailyLogs : undefined,
);
```

3. Remove the `true` (force trade-based) parameter. When daily logs are available and no strategy filter is active, the calculator will use daily-log-based Sharpe, matching get_statistics.

4. IMPORTANT: When `startDate`/`endDate` filters are applied, daily logs should also be filtered to the same date range. If there are date filters, filter dailyLogs to the same range before passing them in. If daily logs don't have dates in the filtered range, fall back to trade-based (pass undefined).

5. Per-strategy stats (via `calculateStrategyStats`) should remain trade-based since daily logs represent the full portfolio, not individual strategies. This is already correct.
  </action>
  <verify>Run `npm run typecheck` to confirm no type errors.</verify>
  <done>block_diff uses daily-log-based Sharpe for portfolio-level stats when daily logs are available, falling back to trade-based when not.</done>
</task>

<task type="auto">
  <name>Task 2: Fix marginal_contribution and what_if_scaling Sharpe + remove interpretation (Issues 3, 6b)</name>
  <files>
    packages/mcp-server/src/tools/blocks/analysis.ts
    packages/mcp-server/src/tools/blocks/similarity.ts
  </files>
  <action>
**marginal_contribution (analysis.ts) -- Sharpe fix (Issue 3):**

The baseline stats and "without" stats are calculated with `calculator.calculatePortfolioStats(trades, undefined, true)` (force trade-based). Change the BASELINE calculation to use daily logs when available:

1. Load daily logs from the block: `block.dailyLogs`. The block is loaded at line ~512.
2. For the baseline stats calculation (line ~589), pass daily logs:
```typescript
const baselineStats = calculator.calculatePortfolioStats(
  trades,
  block.dailyLogs && block.dailyLogs.length > 0 ? block.dailyLogs : undefined,
);
```

3. For the "without" stats (line ~628), we CANNOT use daily logs because removing a strategy's trades doesn't remove their contribution from daily portfolio values. Keep the "without" calculations as trade-based:
```typescript
const withoutStats = calculator.calculatePortfolioStats(
  tradesWithout,
  undefined,
  true // Force trade-based - daily logs include the removed strategy's impact
);
```

4. The single-strategy edge case (line ~551) can also use daily logs for baseline.

5. Note: The marginal contribution is `baseline - without`. If baseline uses daily-log Sharpe and without uses trade-based, this is a mixed comparison. However, the key issue from the user's perspective is that the BASELINE Sharpe reported by marginal_contribution should match get_statistics. The marginal contribution values (deltas) will adjust accordingly. Add a comment explaining this.

**marginal_contribution (analysis.ts) -- Interpretation removal (Issue 6b):**

- Remove the `interpretation` field from the Contribution type (line ~603) and the interpretation calculation logic (lines ~641-650). Remove interpretation from the contributions push (line ~657). Keep marginalSharpe, marginalSortino, strategy, trades.
- Also handle the single-strategy edge case at line ~574: remove `interpretation: "only-strategy"` from the contributions array entry. The consumer can infer from `marginalSharpe: null` that it's the only strategy.

**what_if_scaling (similarity.ts) -- Sharpe fix (Issue 3):**

Similar pattern. The baseline stats use `calculator.calculatePortfolioStats(trades, undefined, true)` (line ~428).

1. Load daily logs from block (block is loaded at line ~364).
2. For baseline stats:
```typescript
const baselineStats = calculator.calculatePortfolioStats(
  trades,
  block.dailyLogs && block.dailyLogs.length > 0 ? block.dailyLogs : undefined,
);
```

3. For scaled stats (line ~511), keep trade-based since the trades have been modified (P/L scaled) and daily logs would not reflect the scaling:
```typescript
const scaledStats = calculator.calculatePortfolioStats(
  modifiedTrades,
  undefined,
  true // Trade-based: daily logs don't reflect the scaling
);
```

4. Add comments explaining why baseline uses daily logs but scaled uses trade-based.
  </action>
  <verify>Run `npm run typecheck` to confirm no type errors.</verify>
  <done>marginal_contribution and what_if_scaling use daily-log-based Sharpe for baseline when available. Derived calculations (without/scaled) remain trade-based with explanation. marginal_contribution has no interpretation field.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- All three tools compile without errors
- Grep for "interpretation" in analysis.ts shows zero results in output objects
</verification>

<success_criteria>
- block_diff baseline Sharpe matches get_statistics when daily logs are available
- marginal_contribution baseline Sharpe matches get_statistics
- what_if_scaling baseline Sharpe matches get_statistics
- All three tools fall back to trade-based when no daily logs
- marginal_contribution has no interpretation field
</success_criteria>

<output>
After completion, create `.planning/quick/011-fix-mcp-output-size-ethos-sharpe-bugs/011-03-SUMMARY.md`
</output>
