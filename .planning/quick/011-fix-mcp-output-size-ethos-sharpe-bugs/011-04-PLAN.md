---
phase: quick-011
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/lib/calculations/live-alignment.ts
  - packages/mcp-server/src/tools/market-data.ts
autonomous: true

must_haves:
  truths:
    - "Strategy names containing pipe characters are not truncated in direction agreement"
    - "No underperforming boolean in live alignment output"
    - "analyze_regime_performance has no insight field"
    - "analyze_regime_performance reports unmatched trade count and dates"
  artifacts:
    - path: "packages/lib/calculations/live-alignment.ts"
      provides: "Pipe-safe strategy name parsing in direction agreement, no underperforming boolean"
    - path: "packages/mcp-server/src/tools/market-data.ts"
      provides: "analyze_regime_performance without insight field, with tradesUnmatched and unmatchedDates"
---

<objective>
Fix pipe-character strategy name truncation in live alignment, remove underperforming boolean, remove insight field from regime performance, and add unmatched trade reporting to regime performance.

Purpose: Pipe characters in strategy names cause silent data corruption. The underperforming boolean and insight field violate the data-only ethos. Missing unmatched count hides data quality info.
Output: Correct strategy names, no interpretive fields, transparent unmatched reporting.
</objective>

<execution_context>
@/Users/davidromeo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davidromeo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/lib/calculations/live-alignment.ts
@packages/mcp-server/src/tools/market-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pipe truncation and remove underperforming in live-alignment.ts (Issues 8, 6)</name>
  <files>packages/lib/calculations/live-alignment.ts</files>
  <action>
**Issue 8 - Fix pipe-character strategy name truncation:**

Strategy names containing `|` (e.g., "DC 2/7 | Mon, Wed - v2") are truncated because the code uses `|` as a delimiter in composite keys, then splits on `|` to extract strategy names.

The key is built at line ~168:
```typescript
const key = `${dateKey}|${trade.strategy}|${timeKey}`
```
And parsed at line ~356:
```typescript
const strategy = key.split('|')[1]
```

The fix: Change ALL key-building and key-parsing in live-alignment.ts to use `\t` (tab) instead of `|`. Tab cannot appear in strategy names, dates, or times.

Changes in live-alignment.ts:
1. Line ~168: `const key = \`${dateKey}\t${trade.strategy}\t${timeKey}\``
2. Line ~188: `const key = \`${dateKey}\t${btTrade.strategy}\t${timeKey}\``
3. Line ~343: `const key = \`${pair.date}\t${pair.strategy}\``
4. Line ~356: `const strategy = key.split('\t')[1]` (now safe since strategy won't contain tabs)

Search for ALL occurrences of pipe-delimited key construction and parsing in this file to ensure none are missed.

**Issue 6 - Remove underperforming boolean:**

Remove the `underperforming` field from the ExecutionEfficiencyResult byStrategy interface (line ~74) and from the efficiencyByStrategy push (line ~431). The consumer can compare efficiency to 1.0 themselves.
  </action>
  <verify>Run `npm run typecheck` to confirm no type errors. Run `npm test` to ensure no test failures.</verify>
  <done>Strategy names containing pipe characters are preserved correctly. No underperforming boolean in output.</done>
</task>

<task type="auto">
  <name>Task 2: Remove insight field and add unmatched reporting in market-data.ts (Issues 4, 10)</name>
  <files>packages/mcp-server/src/tools/market-data.ts</files>
  <action>
**Issue 4 - Remove insight field from analyze_regime_performance:**

Remove the `insight` field from the output (lines ~856-862, ~877). Delete the `insight` variable construction and remove it from the createToolOutput call. The `segments` array already has `vsOverallWinRate` and `vsOverallAvgPl` deltas -- the consuming LLM can derive any insights from that data.

**Issue 10 - Add unmatched trade count and dates:**

The tool reports `tradesMatched` which is less than total trades because some trades fall on dates without market data.

1. Track unmatched trades and their dates. Before the main loop (line ~734), add:
```typescript
const unmatchedDates: string[] = [];
```

2. When a trade doesn't match market data (after `if (!marketData) continue;` at line ~738), track it:
```typescript
if (!marketData) {
  unmatchedDates.push(tradeDate);
  continue;
}
```

3. Deduplicate unmatchedDates and sort them.

4. Add to the output (in the createToolOutput structuredData, line ~867):
```typescript
tradesTotal: trades.length,
tradesMatched: totalMatched,
tradesUnmatched: trades.length - totalMatched,
unmatchedDates: [...new Set(unmatchedDates)].sort(),
```

Keep the existing `tradesMatched` field for backward compatibility but also add `tradesTotal` and `tradesUnmatched` for clarity.
  </action>
  <verify>Run `npm run typecheck` to confirm no type errors. Run `npm test` to ensure no test failures.</verify>
  <done>No insight field in regime performance output. Unmatched trade count and dates reported.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm test` passes
- Strategy names with pipes are not truncated in live alignment output
- Grep for "insight" in analyze_regime_performance output shows zero results
- Grep for "underperforming" in live-alignment.ts output shows zero results
</verification>

<success_criteria>
- Strategy "DC 2/7 | Mon, Wed - v2" appears fully in directionAgreement.byStrategy
- No underperforming boolean in executionEfficiency.byStrategy
- No insight field in analyze_regime_performance output
- analyze_regime_performance includes tradesUnmatched count and unmatchedDates array
</success_criteria>

<output>
After completion, create `.planning/quick/011-fix-mcp-output-size-ethos-sharpe-bugs/011-04-SUMMARY.md`
</output>
